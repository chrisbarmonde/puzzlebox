"use strict";var BABYLON=BABYLON||{};!function(){BABYLON.Ray=function(e,t){this.origin=e,this.direction=t},BABYLON.Ray.prototype.intersectsBox=function(e){var t=0,i=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<e.minimum.x||this.origin.x>e.maximum.x)return!1}else{var r=1/this.direction.x,n=(e.minimum.x-this.origin.x)*r,o=(e.maximum.x-this.origin.x)*r;if(n>o){var s=n;n=o,o=s}if(t=Math.max(n,t),i=Math.min(o,i),t>i)return!1}if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<e.minimum.y||this.origin.y>e.maximum.y)return!1}else{var r=1/this.direction.y,n=(e.minimum.y-this.origin.y)*r,o=(e.maximum.y-this.origin.y)*r;if(n>o){var s=n;n=o,o=s}if(t=Math.max(n,t),i=Math.min(o,i),t>i)return!1}if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<e.minimum.z||this.origin.z>e.maximum.z)return!1}else{var r=1/this.direction.z,n=(e.minimum.z-this.origin.z)*r,o=(e.maximum.z-this.origin.z)*r;if(n>o){var s=n;n=o,o=s}if(t=Math.max(n,t),i=Math.min(o,i),t>i)return!1}return!0},BABYLON.Ray.prototype.intersectsSphere=function(e){var t=e.center.x-this.origin.x,i=e.center.y-this.origin.y,r=e.center.z-this.origin.z,n=t*t+i*i+r*r,o=e.radius*e.radius;if(o>=n)return!0;var s=t*this.direction.x+i*this.direction.y+r*this.direction.z;if(0>s)return!1;var a=n-s*s;return o>=a},BABYLON.Ray.prototype.intersectsTriangle=function(e,t,i){this._edge1||(this._edge1=BABYLON.Vector3.Zero(),this._edge2=BABYLON.Vector3.Zero(),this._pvec=BABYLON.Vector3.Zero(),this._tvec=BABYLON.Vector3.Zero(),this._qvec=BABYLON.Vector3.Zero()),t.subtractToRef(e,this._edge1),i.subtractToRef(e,this._edge2),BABYLON.Vector3.CrossToRef(this.direction,this._edge2,this._pvec);var r=BABYLON.Vector3.Dot(this._edge1,this._pvec);if(0===r)return null;var n=1/r;this.origin.subtractToRef(e,this._tvec);var o=BABYLON.Vector3.Dot(this._tvec,this._pvec)*n;if(0>o||o>1)return null;BABYLON.Vector3.CrossToRef(this._tvec,this._edge1,this._qvec);var s=BABYLON.Vector3.Dot(this.direction,this._qvec)*n;return 0>s||o+s>1?null:{bu:o,bv:s,distance:BABYLON.Vector3.Dot(this._edge2,this._qvec)*n}},BABYLON.Ray.CreateNew=function(e,t,i,r,n,o,s){var a=BABYLON.Vector3.Unproject(new BABYLON.Vector3(e,t,0),i,r,n,o,s),h=BABYLON.Vector3.Unproject(new BABYLON.Vector3(e,t,1),i,r,n,o,s),c=h.subtract(a);return c.normalize(),new BABYLON.Ray(a,c)},BABYLON.Ray.Transform=function(e,t){var i=BABYLON.Vector3.TransformCoordinates(e.origin,t),r=BABYLON.Vector3.TransformNormal(e.direction,t);return new BABYLON.Ray(i,r)},BABYLON.Color3=function(e,t,i){this.r=e,this.g=t,this.b=i},BABYLON.Color3.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},BABYLON.Color3.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},BABYLON.Color3.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b},BABYLON.Color3.prototype.multiply=function(e){return new BABYLON.Color3(this.r*e.r,this.g*e.g,this.b*e.b)},BABYLON.Color3.prototype.multiplyToRef=function(e,t){t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b},BABYLON.Color3.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b},BABYLON.Color3.prototype.scale=function(e){return new BABYLON.Color3(this.r*e,this.g*e,this.b*e)},BABYLON.Color3.prototype.scaleToRef=function(e,t){t.r=this.r*e,t.g=this.g*e,t.b=this.b*e},BABYLON.Color3.prototype.clone=function(){return new BABYLON.Color3(this.r,this.g,this.b)},BABYLON.Color3.prototype.copyFrom=function(e){this.r=e.r,this.g=e.g,this.b=e.b},BABYLON.Color3.prototype.copyFromFloats=function(e,t,i){this.r=e,this.g=t,this.b=i},BABYLON.Color3.FromArray=function(e){return new BABYLON.Color3(e[0],e[1],e[2])},BABYLON.Color3.FromInts=function(e,t,i){return new BABYLON.Color3(e/255,t/255,i/255)},BABYLON.Color4=function(e,t,i,r){this.r=e,this.g=t,this.b=i,this.a=r},BABYLON.Color4.prototype.addInPlace=function(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a},BABYLON.Color4.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},BABYLON.Color4.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a},BABYLON.Color4.prototype.add=function(e){return new BABYLON.Color4(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},BABYLON.Color4.prototype.subtract=function(e){return new BABYLON.Color4(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},BABYLON.Color4.prototype.subtractToRef=function(e,t){t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a},BABYLON.Color4.prototype.scale=function(e){return new BABYLON.Color4(this.r*e,this.g*e,this.b*e,this.a*e)},BABYLON.Color4.prototype.scaleToRef=function(e,t){t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e},BABYLON.Color4.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},BABYLON.Color4.prototype.clone=function(){return new BABYLON.Color4(this.r,this.g,this.b,this.a)},BABYLON.Color4.Lerp=function(e,t,i){var r=new BABYLON.Color4(0,0,0,0);return BABYLON.Color4.LerpToRef(e,t,i,r),r},BABYLON.Color4.LerpToRef=function(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i},BABYLON.Color4.FromArray=function(e,t){return t||(t=0),new BABYLON.Color4(e[t],e[t+1],e[t+2],e[t+3])},BABYLON.Color4.FromInts=function(e,t,i,r){return new BABYLON.Color4(e/255,t/255,i/255,r/255)},BABYLON.Vector2=function(e,t){this.x=e,this.y=t},BABYLON.Vector2.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},BABYLON.Vector2.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},BABYLON.Vector2.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y},BABYLON.Vector2.prototype.add=function(e){return new BABYLON.Vector2(this.x+e.x,this.y+e.y)},BABYLON.Vector2.prototype.subtract=function(e){return new BABYLON.Vector2(this.x-e.x,this.y-e.y)},BABYLON.Vector2.prototype.negate=function(){return new BABYLON.Vector2(-this.x,-this.y)},BABYLON.Vector2.prototype.scaleInPlace=function(e){this.x*=e,this.y*=e},BABYLON.Vector2.prototype.scale=function(e){return new BABYLON.Vector2(this.x*e,this.y*e)},BABYLON.Vector2.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y},BABYLON.Vector2.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},BABYLON.Vector2.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},BABYLON.Vector2.prototype.normalize=function(){var e=this.length();if(0!==e){var t=1/e;this.x*=t,this.y*=t}},BABYLON.Vector2.prototype.clone=function(){return new BABYLON.Vector2(this.x,this.y)},BABYLON.Vector2.Zero=function(){return new BABYLON.Vector2(0,0)},BABYLON.Vector2.CatmullRom=function(e,t,i,r,n){var o=n*n,s=n*o,a=.5*(2*t.x+(-e.x+i.x)*n+(2*e.x-5*t.x+4*i.x-r.x)*o+(-e.x+3*t.x-3*i.x+r.x)*s),h=.5*(2*t.y+(-e.y+i.y)*n+(2*e.y-5*t.y+4*i.y-r.y)*o+(-e.y+3*t.y-3*i.y+r.y)*s);return new BABYLON.Vector2(a,h)},BABYLON.Vector2.Clamp=function(e,t,i){var r=e.x;r=r>i.x?i.x:r,r=r<t.x?t.x:r;var n=e.y;return n=n>i.y?i.y:n,n=n<t.y?t.y:n,new BABYLON.Vector2(r,n)},BABYLON.Vector2.Hermite=function(e,t,i,r,n){var o=n*n,s=n*o,a=2*s-3*o+1,h=-2*s+3*o,c=s-2*o+n,l=s-o,u=e.x*a+i.x*h+t.x*c+r.x*l,f=e.y*a+i.y*h+t.y*c+r.y*l;return new BABYLON.Vector2(u,f)},BABYLON.Vector2.Lerp=function(e,t,i){var r=e.x+(t.x-e.x)*i,n=e.y+(t.y-e.y)*i;return new BABYLON.Vector2(r,n)},BABYLON.Vector2.Dot=function(e,t){return e.x*t.x+e.y*t.y},BABYLON.Vector2.Normalize=function(e){var t=e.clone();return t.normalize(),t},BABYLON.Vector2.Minimize=function(e,t){var i=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new BABYLON.Vector2(i,r)},BABYLON.Vector2.Maximize=function(e,t){var i=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new BABYLON.Vector2(i,r)},BABYLON.Vector2.Transform=function(e,t){var i=e.x*t.m[0]+e.y*t.m[4],r=e.x*t.m[1]+e.y*t.m[5];return new BABYLON.Vector2(i,r)},BABYLON.Vector2.Distance=function(e,t){return Math.sqrt(BABYLON.Vector2.DistanceSquared(e,t))},BABYLON.Vector2.DistanceSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y;return i*i+r*r},BABYLON.Vector3=function(e,t,i){this.x=e,this.y=t,this.z=i},BABYLON.Vector3.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},BABYLON.Vector3.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},BABYLON.Vector3.prototype.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z},BABYLON.Vector3.prototype.addInPlace=function(e){this.x+=e.x,this.y+=e.y,this.z+=e.z},BABYLON.Vector3.prototype.add=function(e){return new BABYLON.Vector3(this.x+e.x,this.y+e.y,this.z+e.z)},BABYLON.Vector3.prototype.addToRef=function(e,t){t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z},BABYLON.Vector3.prototype.subtractInPlace=function(e){this.x-=e.x,this.y-=e.y,this.z-=e.z},BABYLON.Vector3.prototype.subtract=function(e){return new BABYLON.Vector3(this.x-e.x,this.y-e.y,this.z-e.z)},BABYLON.Vector3.prototype.subtractToRef=function(e,t){t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},BABYLON.Vector3.prototype.subtractFromFloats=function(e,t,i){return new BABYLON.Vector3(this.x-e,this.y-t,this.z-i)},BABYLON.Vector3.prototype.subtractFromFloatsToRef=function(e,t,i,r){r.x=this.x-e,r.y=this.y-t,r.z=this.z-i},BABYLON.Vector3.prototype.negate=function(){return new BABYLON.Vector3(-this.x,-this.y,-this.z)},BABYLON.Vector3.prototype.scaleInPlace=function(e){this.x*=e,this.y*=e,this.z*=e},BABYLON.Vector3.prototype.scale=function(e){return new BABYLON.Vector3(this.x*e,this.y*e,this.z*e)},BABYLON.Vector3.prototype.scaleToRef=function(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e},BABYLON.Vector3.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z},BABYLON.Vector3.prototype.equalsToFloats=function(e,t,i){return this.x===e&&this.y===t&&this.z===i},BABYLON.Vector3.prototype.multiplyInPlace=function(e){this.x*=e.x,this.y*=e.y,this.z*=e.z},BABYLON.Vector3.prototype.multiply=function(e){return new BABYLON.Vector3(this.x*e.x,this.y*e.y,this.z*e.z)},BABYLON.Vector3.prototype.multiplyToRef=function(e,t){t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z},BABYLON.Vector3.prototype.multiplyByFloats=function(e,t,i){return new BABYLON.Vector3(this.x*e,this.y*t,this.z*i)},BABYLON.Vector3.prototype.divide=function(e){return new BABYLON.Vector3(this.x/e.x,this.y/e.y,this.z/e.z)},BABYLON.Vector3.prototype.divideToRef=function(e,t){t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z},BABYLON.Vector3.prototype.MinimizeInPlace=function(e){e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z)},BABYLON.Vector3.prototype.MaximizeInPlace=function(e){e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z)},BABYLON.Vector3.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},BABYLON.Vector3.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},BABYLON.Vector3.prototype.normalize=function(){var e=this.length();if(0!==e){var t=1/e;this.x*=t,this.y*=t,this.z*=t}},BABYLON.Vector3.prototype.clone=function(){return new BABYLON.Vector3(this.x,this.y,this.z)},BABYLON.Vector3.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z},BABYLON.Vector3.prototype.copyFromFloats=function(e,t,i){this.x=e,this.y=t,this.z=i},BABYLON.Vector3.FromArray=function(e,t){return t||(t=0),new BABYLON.Vector3(e[t],e[t+1],e[t+2])},BABYLON.Vector3.FromArrayToRef=function(e,t,i){t||(t=0),i.x=e[t],i.y=e[t+1],i.z=e[t+2]},BABYLON.Vector3.FromFloatsToRef=function(e,t,i,r){r.x=e,r.y=t,r.z=i},BABYLON.Vector3.Zero=function(){return new BABYLON.Vector3(0,0,0)},BABYLON.Vector3.Up=function(){return new BABYLON.Vector3(0,1,0)},BABYLON.Vector3.TransformCoordinates=function(e,t){var i=BABYLON.Vector3.Zero();return BABYLON.Vector3.TransformCoordinatesToRef(e,t,i),i},BABYLON.Vector3.TransformCoordinatesToRef=function(e,t,i){var r=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8]+t.m[12],n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9]+t.m[13],o=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10]+t.m[14],s=e.x*t.m[3]+e.y*t.m[7]+e.z*t.m[11]+t.m[15];i.x=r/s,i.y=n/s,i.z=o/s},BABYLON.Vector3.TransformCoordinatesFromFloatsToRef=function(e,t,i,r,n){var o=e*r.m[0]+t*r.m[4]+i*r.m[8]+r.m[12],s=e*r.m[1]+t*r.m[5]+i*r.m[9]+r.m[13],a=e*r.m[2]+t*r.m[6]+i*r.m[10]+r.m[14],h=e*r.m[3]+t*r.m[7]+i*r.m[11]+r.m[15];n.x=o/h,n.y=s/h,n.z=a/h},BABYLON.Vector3.TransformNormal=function(e,t){var i=BABYLON.Vector3.Zero();return BABYLON.Vector3.TransformNormalToRef(e,t,i),i},BABYLON.Vector3.TransformNormalToRef=function(e,t,i){i.x=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8],i.y=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9],i.z=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10]},BABYLON.Vector3.TransformNormalFromFloatsToRef=function(e,t,i,r,n){n.x=e*r.m[0]+t*r.m[4]+i*r.m[8],n.y=e*r.m[1]+t*r.m[5]+i*r.m[9],n.z=e*r.m[2]+t*r.m[6]+i*r.m[10]},BABYLON.Vector3.CatmullRom=function(e,t,i,r,n){var o=n*n,s=n*o,a=.5*(2*t.x+(-e.x+i.x)*n+(2*e.x-5*t.x+4*i.x-r.x)*o+(-e.x+3*t.x-3*i.x+r.x)*s),h=.5*(2*t.y+(-e.y+i.y)*n+(2*e.y-5*t.y+4*i.y-r.y)*o+(-e.y+3*t.y-3*i.y+r.y)*s),c=.5*(2*t.z+(-e.z+i.z)*n+(2*e.z-5*t.z+4*i.z-r.z)*o+(-e.z+3*t.z-3*i.z+r.z)*s);return new BABYLON.Vector3(a,h,c)},BABYLON.Vector3.Clamp=function(e,t,i){var r=e.x;r=r>i.x?i.x:r,r=r<t.x?t.x:r;var n=e.y;n=n>i.y?i.y:n,n=n<t.y?t.y:n;var o=e.z;return o=o>i.z?i.z:o,o=o<t.z?t.z:o,new BABYLON.Vector3(r,n,o)},BABYLON.Vector3.Hermite=function(e,t,i,r,n){var o=n*n,s=n*o,a=2*s-3*o+1,h=-2*s+3*o,c=s-2*o+n,l=s-o,u=e.x*a+i.x*h+t.x*c+r.x*l,f=e.y*a+i.y*h+t.y*c+r.y*l,B=e.z*a+i.z*h+t.z*c+r.z*l;return new BABYLON.Vector3(u,f,B)},BABYLON.Vector3.Lerp=function(e,t,i){var r=e.x+(t.x-e.x)*i,n=e.y+(t.y-e.y)*i,o=e.z+(t.z-e.z)*i;return new BABYLON.Vector3(r,n,o)},BABYLON.Vector3.Dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},BABYLON.Vector3.Cross=function(e,t){var i=BABYLON.Vector3.Zero();return BABYLON.Vector3.CrossToRef(e,t,i),i},BABYLON.Vector3.CrossToRef=function(e,t,i){i.x=e.y*t.z-e.z*t.y,i.y=e.z*t.x-e.x*t.z,i.z=e.x*t.y-e.y*t.x},BABYLON.Vector3.Normalize=function(e){var t=BABYLON.Vector3.Zero();return BABYLON.Vector3.NormalizeToRef(e,t),t},BABYLON.Vector3.NormalizeToRef=function(e,t){t.copyFrom(e),t.normalize()},BABYLON.Vector3.Project=function(e,t,i,r){var n=r.width,o=r.height,s=r.x,a=r.y,h=BABYLON.Matrix.FromValues(n/2,0,0,0,0,-o/2,0,0,0,0,1,0,s+n/2,o/2+a,0,1),c=t.multiply(i).multiply(h);return BABYLON.Vector3.TransformCoordinates(e,c)},BABYLON.Vector3.Unproject=function(e,t,i,r,n,o){var s=r.multiply(n).multiply(o);s.invert(),e.x=e.x/t*2-1,e.y=-(e.y/i*2-1);var a=BABYLON.Vector3.TransformCoordinates(e,s),h=e.x*s.m[3]+e.y*s.m[7]+e.z*s.m[11]+s.m[15];return BABYLON.Tools.WithinEpsilon(h,1)&&(a=a.scale(1/h)),a},BABYLON.Vector3.Minimize=function(e,t){var i=e.clone();return i.MinimizeInPlace(t),i},BABYLON.Vector3.Maximize=function(e,t){var i=e.clone();return i.MaximizeInPlace(t),i},BABYLON.Vector3.Distance=function(e,t){return Math.sqrt(BABYLON.Vector3.DistanceSquared(e,t))},BABYLON.Vector3.DistanceSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y,n=e.z-t.z;return i*i+r*r+n*n},BABYLON.Vector3.Center=function(e,t){var i=e.add(t);return i.scaleInPlace(.5),i},BABYLON.Quaternion=function(e,t,i,r){this.x=e,this.y=t,this.z=i,this.w=r},BABYLON.Quaternion.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},BABYLON.Quaternion.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},BABYLON.Quaternion.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},BABYLON.Quaternion.prototype.clone=function(){return new BABYLON.Quaternion(this.x,this.y,this.z,this.w)},BABYLON.Quaternion.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w},BABYLON.Quaternion.prototype.add=function(e){return new BABYLON.Quaternion(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},BABYLON.Quaternion.prototype.scale=function(e){return new BABYLON.Quaternion(this.x*e,this.y*e,this.z*e,this.w*e)},BABYLON.Quaternion.prototype.multiply=function(e){var t=new BABYLON.Quaternion(0,0,0,1);return this.multiplyToRef(e,t),t},BABYLON.Quaternion.prototype.multiplyToRef=function(e,t){t.x=this.x*e.w+this.y*e.z-this.z*e.y+this.w*e.x,t.y=-this.x*e.z+this.y*e.w+this.z*e.x+this.w*e.y,t.z=this.x*e.y-this.y*e.x+this.z*e.w+this.w*e.z,t.w=-this.x*e.x-this.y*e.y-this.z*e.z+this.w*e.w},BABYLON.Quaternion.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},BABYLON.Quaternion.prototype.normalize=function(){var e=1/this.length();this.x*=e,this.y*=e,this.z*=e,this.w*=e},BABYLON.Quaternion.prototype.toEulerAngles=function(){var e=this.x,t=this.y,i=this.z,r=this.w,n=e*e,o=t*t,s=i*i,a=Math.atan2(2*(t*r-e*i),1-2*(o+s)),h=Math.asin(2*(e*t+i*r)),c=Math.atan2(2*(e*r-t*i),1-2*(n+s)),l=e*t+i*r;return l>.499?(a=2*Math.atan2(e,r),c=0):-.499>l&&(a=-2*Math.atan2(e,r),c=0),new BABYLON.Vector3(h,a,c)},BABYLON.Quaternion.prototype.toRotationMatrix=function(e){var t=this.x*this.x,i=this.y*this.y,r=this.z*this.z,n=this.x*this.y,o=this.z*this.w,s=this.z*this.x,a=this.y*this.w,h=this.y*this.z,c=this.x*this.w;e.m[0]=1-2*(i+r),e.m[1]=2*(n+o),e.m[2]=2*(s-a),e.m[3]=0,e.m[4]=2*(n-o),e.m[5]=1-2*(r+t),e.m[6]=2*(h+c),e.m[7]=0,e.m[8]=2*(s+a),e.m[9]=2*(h-c),e.m[10]=1-2*(i+t),e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e.m[15]=1},BABYLON.Quaternion.RotationAxis=function(e,t){var i=new BABYLON.Quaternion,r=Math.sin(t/2);return i.w=Math.cos(t/2),i.x=e.x*r,i.y=e.y*r,i.z=e.z*r,i},BABYLON.Quaternion.FromArray=function(e,t){return t||(t=0),new BABYLON.Quaternion(e[t],e[t+1],e[t+2],e[t+3])},BABYLON.Quaternion.RotationYawPitchRoll=function(e,t,i){var r=new BABYLON.Quaternion;return BABYLON.Quaternion.RotationYawPitchRollToRef(e,t,i,r),r},BABYLON.Quaternion.RotationYawPitchRollToRef=function(e,t,i,r){var n=.5*i,o=.5*t,s=.5*e,a=Math.sin(n),h=Math.cos(n),c=Math.sin(o),l=Math.cos(o),u=Math.sin(s),f=Math.cos(s);r.x=f*c*h+u*l*a,r.y=u*l*h-f*c*a,r.z=f*l*a-u*c*h,r.w=f*l*h+u*c*a},BABYLON.Quaternion.Slerp=function(e,t,i){var r,n,o=i,s=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,a=!1;if(0>s&&(a=!0,s=-s),s>.999999)n=1-o,r=a?-o:o;else{var h=Math.acos(s),c=1/Math.sin(h);n=Math.sin((1-o)*h)*c,r=a?-Math.sin(o*h)*c:Math.sin(o*h)*c}return new BABYLON.Quaternion(n*e.x+r*t.x,n*e.y+r*t.y,n*e.z+r*t.z,n*e.w+r*t.w)},BABYLON.MatrixType||(BABYLON.MatrixType="undefined"!=typeof Float32Array?Float32Array:Array),BABYLON.Matrix=function(){this.m=new BABYLON.MatrixType(16)},BABYLON.Matrix.prototype.isIdentity=function(){return 1!=this.m[0]||1!=this.m[5]||1!=this.m[10]||1!=this.m[15]?!1:0!=this.m[1]||0!=this.m[2]||0!=this.m[3]||0!=this.m[4]||0!=this.m[6]||0!=this.m[7]||0!=this.m[8]||0!=this.m[9]||0!=this.m[11]||0!=this.m[12]||0!=this.m[13]||0!=this.m[14]?!1:!0},BABYLON.Matrix.prototype.determinant=function(){var e=this.m[10]*this.m[15]-this.m[11]*this.m[14],t=this.m[9]*this.m[15]-this.m[11]*this.m[13],i=this.m[9]*this.m[14]-this.m[10]*this.m[13],r=this.m[8]*this.m[15]-this.m[11]*this.m[12],n=this.m[8]*this.m[14]-this.m[10]*this.m[12],o=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*e-this.m[6]*t+this.m[7]*i)-this.m[1]*(this.m[4]*e-this.m[6]*r+this.m[7]*n)+this.m[2]*(this.m[4]*t-this.m[5]*r+this.m[7]*o)-this.m[3]*(this.m[4]*i-this.m[5]*n+this.m[6]*o)},BABYLON.Matrix.prototype.toArray=function(){return this.m},BABYLON.Matrix.prototype.asArray=function(){return this.toArray()},BABYLON.Matrix.prototype.invert=function(){this.invertToRef(this)},BABYLON.Matrix.prototype.invertToRef=function(e){var t=this.m[0],i=this.m[1],r=this.m[2],n=this.m[3],o=this.m[4],s=this.m[5],a=this.m[6],h=this.m[7],c=this.m[8],l=this.m[9],u=this.m[10],f=this.m[11],B=this.m[12],p=this.m[13],d=this.m[14],m=this.m[15],A=u*m-f*d,_=l*m-f*p,v=l*d-u*p,g=c*m-f*B,L=c*d-u*B,O=c*p-l*B,N=s*A-a*_+h*v,y=-(o*A-a*g+h*L),x=o*_-s*g+h*O,Y=-(o*v-s*L+a*O),M=1/(t*N+i*y+r*x+n*Y),T=a*m-h*d,S=s*m-h*p,E=s*d-a*p,C=o*m-h*B,P=o*d-a*B,b=o*p-s*B,w=a*f-h*u,D=s*f-h*l,V=s*u-a*l,I=o*f-h*c,R=o*u-a*c,F=o*l-s*c;e.m[0]=N*M,e.m[4]=y*M,e.m[8]=x*M,e.m[12]=Y*M,e.m[1]=-(i*A-r*_+n*v)*M,e.m[5]=(t*A-r*g+n*L)*M,e.m[9]=-(t*_-i*g+n*O)*M,e.m[13]=(t*v-i*L+r*O)*M,e.m[2]=(i*T-r*S+n*E)*M,e.m[6]=-(t*T-r*C+n*P)*M,e.m[10]=(t*S-i*C+n*b)*M,e.m[14]=-(t*E-i*P+r*b)*M,e.m[3]=-(i*w-r*D+n*V)*M,e.m[7]=(t*w-r*I+n*R)*M,e.m[11]=-(t*D-i*I+n*F)*M,e.m[15]=(t*V-i*R+r*F)*M},BABYLON.Matrix.prototype.setTranslation=function(e){this.m[12]=e.x,this.m[13]=e.y,this.m[14]=e.z},BABYLON.Matrix.prototype.multiply=function(e){var t=new BABYLON.Matrix;return this.multiplyToRef(e,t),t},BABYLON.Matrix.prototype.copyFrom=function(e){for(var t=0;16>t;t++)this.m[t]=e.m[t]},BABYLON.Matrix.prototype.multiplyToRef=function(e,t){this.multiplyToArray(e,t.m,0)},BABYLON.Matrix.prototype.multiplyToArray=function(e,t,i){var r=this.m[0],n=this.m[1],o=this.m[2],s=this.m[3],a=this.m[4],h=this.m[5],c=this.m[6],l=this.m[7],u=this.m[8],f=this.m[9],B=this.m[10],p=this.m[11],d=this.m[12],m=this.m[13],A=this.m[14],_=this.m[15],v=e.m[0],g=e.m[1],L=e.m[2],O=e.m[3],N=e.m[4],y=e.m[5],x=e.m[6],Y=e.m[7],M=e.m[8],T=e.m[9],S=e.m[10],E=e.m[11],C=e.m[12],P=e.m[13],b=e.m[14],w=e.m[15];t[i]=r*v+n*N+o*M+s*C,t[i+1]=r*g+n*y+o*T+s*P,t[i+2]=r*L+n*x+o*S+s*b,t[i+3]=r*O+n*Y+o*E+s*w,t[i+4]=a*v+h*N+c*M+l*C,t[i+5]=a*g+h*y+c*T+l*P,t[i+6]=a*L+h*x+c*S+l*b,t[i+7]=a*O+h*Y+c*E+l*w,t[i+8]=u*v+f*N+B*M+p*C,t[i+9]=u*g+f*y+B*T+p*P,t[i+10]=u*L+f*x+B*S+p*b,t[i+11]=u*O+f*Y+B*E+p*w,t[i+12]=d*v+m*N+A*M+_*C,t[i+13]=d*g+m*y+A*T+_*P,t[i+14]=d*L+m*x+A*S+_*b,t[i+15]=d*O+m*Y+A*E+_*w},BABYLON.Matrix.prototype.equals=function(e){return e&&this.m[0]===e.m[0]&&this.m[1]===e.m[1]&&this.m[2]===e.m[2]&&this.m[3]===e.m[3]&&this.m[4]===e.m[4]&&this.m[5]===e.m[5]&&this.m[6]===e.m[6]&&this.m[7]===e.m[7]&&this.m[8]===e.m[8]&&this.m[9]===e.m[9]&&this.m[10]===e.m[10]&&this.m[11]===e.m[11]&&this.m[12]===e.m[12]&&this.m[13]===e.m[13]&&this.m[14]===e.m[14]&&this.m[15]===e.m[15]},BABYLON.Matrix.prototype.clone=function(){return BABYLON.Matrix.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},BABYLON.Matrix.FromArray=function(e,t){var i=new BABYLON.Matrix;return BABYLON.Matrix.FromArrayToRef(e,t,i),i},BABYLON.Matrix.FromArrayToRef=function(e,t,i){t||(t=0);for(var r=0;16>r;r++)i.m[r]=e[r+t]},BABYLON.Matrix.FromValuesToRef=function(e,t,i,r,n,o,s,a,h,c,l,u,f,B,p,d,m){m.m[0]=e,m.m[1]=t,m.m[2]=i,m.m[3]=r,m.m[4]=n,m.m[5]=o,m.m[6]=s,m.m[7]=a,m.m[8]=h,m.m[9]=c,m.m[10]=l,m.m[11]=u,m.m[12]=f,m.m[13]=B,m.m[14]=p,m.m[15]=d},BABYLON.Matrix.FromValues=function(e,t,i,r,n,o,s,a,h,c,l,u,f,B,p,d){var m=new BABYLON.Matrix;return m.m[0]=e,m.m[1]=t,m.m[2]=i,m.m[3]=r,m.m[4]=n,m.m[5]=o,m.m[6]=s,m.m[7]=a,m.m[8]=h,m.m[9]=c,m.m[10]=l,m.m[11]=u,m.m[12]=f,m.m[13]=B,m.m[14]=p,m.m[15]=d,m},BABYLON.Matrix.Identity=function(){return BABYLON.Matrix.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},BABYLON.Matrix.IdentityToRef=function(e){BABYLON.Matrix.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e)},BABYLON.Matrix.Zero=function(){return BABYLON.Matrix.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},BABYLON.Matrix.RotationX=function(e){var t=new BABYLON.Matrix;return BABYLON.Matrix.RotationXToRef(e,t),t},BABYLON.Matrix.RotationXToRef=function(e,t){var i=Math.sin(e),r=Math.cos(e);t.m[0]=1,t.m[15]=1,t.m[5]=r,t.m[10]=r,t.m[9]=-i,t.m[6]=i,t.m[1]=0,t.m[2]=0,t.m[3]=0,t.m[4]=0,t.m[7]=0,t.m[8]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0},BABYLON.Matrix.RotationY=function(e){var t=new BABYLON.Matrix;return BABYLON.Matrix.RotationYToRef(e,t),t},BABYLON.Matrix.RotationYToRef=function(e,t){var i=Math.sin(e),r=Math.cos(e);t.m[5]=1,t.m[15]=1,t.m[0]=r,t.m[2]=-i,t.m[8]=i,t.m[10]=r,t.m[1]=0,t.m[3]=0,t.m[4]=0,t.m[6]=0,t.m[7]=0,t.m[9]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0},BABYLON.Matrix.RotationZ=function(e){var t=new BABYLON.Matrix;return BABYLON.Matrix.RotationZToRef(e,t),t},BABYLON.Matrix.RotationZToRef=function(e,t){var i=Math.sin(e),r=Math.cos(e);t.m[10]=1,t.m[15]=1,t.m[0]=r,t.m[1]=i,t.m[4]=-i,t.m[5]=r,t.m[2]=0,t.m[3]=0,t.m[6]=0,t.m[7]=0,t.m[8]=0,t.m[9]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0},BABYLON.Matrix.RotationAxis=function(e,t){var i=Math.sin(-t),r=Math.cos(-t),n=1-r;e.normalize();var o=BABYLON.Matrix.Zero();return o.m[0]=e.x*e.x*n+r,o.m[1]=e.x*e.y*n-e.z*i,o.m[2]=e.x*e.z*n+e.y*i,o.m[3]=0,o.m[4]=e.y*e.x*n+e.z*i,o.m[5]=e.y*e.y*n+r,o.m[6]=e.y*e.z*n-e.x*i,o.m[7]=0,o.m[8]=e.z*e.x*n-e.y*i,o.m[9]=e.z*e.y*n+e.x*i,o.m[10]=e.z*e.z*n+r,o.m[11]=0,o.m[15]=1,o},BABYLON.Matrix.RotationYawPitchRoll=function(e,t,i){var r=new BABYLON.Matrix;return BABYLON.Matrix.RotationYawPitchRollToRef(e,t,i,r),r};var e=new BABYLON.Quaternion;BABYLON.Matrix.RotationYawPitchRollToRef=function(t,i,r,n){BABYLON.Quaternion.RotationYawPitchRollToRef(t,i,r,e),e.toRotationMatrix(n)},BABYLON.Matrix.Scaling=function(e,t,i){var r=BABYLON.Matrix.Zero();return BABYLON.Matrix.ScalingToRef(e,t,i,r),r},BABYLON.Matrix.ScalingToRef=function(e,t,i,r){r.m[0]=e,r.m[1]=0,r.m[2]=0,r.m[3]=0,r.m[4]=0,r.m[5]=t,r.m[6]=0,r.m[7]=0,r.m[8]=0,r.m[9]=0,r.m[10]=i,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},BABYLON.Matrix.Translation=function(e,t,i){var r=BABYLON.Matrix.Identity();return BABYLON.Matrix.TranslationToRef(e,t,i,r),r},BABYLON.Matrix.TranslationToRef=function(e,t,i,r){BABYLON.Matrix.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,r)},BABYLON.Matrix.LookAtLH=function(e,t,i){var r=BABYLON.Matrix.Zero();return BABYLON.Matrix.LookAtLHToRef(e,t,i,r),r};var t=BABYLON.Vector3.Zero(),i=BABYLON.Vector3.Zero(),r=BABYLON.Vector3.Zero();BABYLON.Matrix.LookAtLHToRef=function(e,n,o,s){n.subtractToRef(e,r),r.normalize(),BABYLON.Vector3.CrossToRef(o,r,t),t.normalize(),BABYLON.Vector3.CrossToRef(r,t,i),i.normalize();var a=-BABYLON.Vector3.Dot(t,e),h=-BABYLON.Vector3.Dot(i,e),c=-BABYLON.Vector3.Dot(r,e);return BABYLON.Matrix.FromValuesToRef(t.x,i.x,r.x,0,t.y,i.y,r.y,0,t.z,i.z,r.z,0,a,h,c,1,s)},BABYLON.Matrix.OrthoLH=function(e,t,i,r){var n=2/e,o=2/t,s=1/(r-i),a=i/(i-r);return BABYLON.Matrix.FromValues(n,0,0,0,0,o,0,0,0,0,s,0,0,0,a,1)},BABYLON.Matrix.OrthoOffCenterLH=function(e,t,i,r,n,o){var s=BABYLON.Matrix.Zero();return BABYLON.Matrix.OrthoOffCenterLHToRef(e,t,i,r,n,o,s),s},BABYLON.Matrix.OrthoOffCenterLHToRef=function(e,t,i,r,n,o,s){s.m[0]=2/(t-e),s.m[1]=s.m[2]=s.m[3]=0,s.m[5]=2/(r-i),s.m[4]=s.m[6]=s.m[7]=0,s.m[10]=-1/(n-o),s.m[8]=s.m[9]=s.m[11]=0,s.m[12]=(e+t)/(e-t),s.m[13]=(r+i)/(i-r),s.m[14]=n/(n-o),s.m[15]=1},BABYLON.Matrix.PerspectiveLH=function(e,t,i,r){var n=BABYLON.Matrix.Zero();return n.m[0]=2*i/e,n.m[1]=n.m[2]=n.m[3]=0,n.m[5]=2*i/t,n.m[4]=n.m[6]=n.m[7]=0,n.m[10]=-r/(i-r),n.m[8]=n.m[9]=0,n.m[11]=1,n.m[12]=n.m[13]=n.m[15]=0,n.m[14]=i*r/(i-r),n},BABYLON.Matrix.PerspectiveFovLH=function(e,t,i,r){var n=BABYLON.Matrix.Zero();return BABYLON.Matrix.PerspectiveFovLHToRef(e,t,i,r,n),n},BABYLON.Matrix.PerspectiveFovLHToRef=function(e,t,i,r,n){var o=1/Math.tan(.5*e);n.m[0]=o/t,n.m[1]=n.m[2]=n.m[3]=0,n.m[5]=o,n.m[4]=n.m[6]=n.m[7]=0,n.m[8]=n.m[9]=0,n.m[10]=-r/(i-r),n.m[11]=1,n.m[12]=n.m[13]=n.m[15]=0,n.m[14]=i*r/(i-r)},BABYLON.Matrix.AffineTransformation=function(e,t,i,r){return BABYLON.Matrix.Scaling(e,e,e)*BABYLON.Matrix.Translation(-t)*BABYLON.Matrix.RotationQuaternion(i)*BABYLON.Matrix.Translation(t)*BABYLON.Matrix.Translation(r)},BABYLON.Matrix.GetFinalMatrix=function(e,t,i,r,n,o){var s=e.width,a=e.height,h=e.x,c=e.y,l=new BABYLON.Matrix(s/2,0,0,0,0,-a/2,0,0,0,0,o-n,0,h+s/2,a/2+c,n,1);return t.multiply(i).multiply(r).multiply(l)},BABYLON.Matrix.Transpose=function(e){var t=new BABYLON.Matrix;return t.m[0]=e.m[0],t.m[1]=e.m[4],t.m[2]=e.m[8],t.m[3]=e.m[12],t.m[4]=e.m[1],t.m[5]=e.m[5],t.m[6]=e.m[9],t.m[7]=e.m[13],t.m[8]=e.m[2],t.m[9]=e.m[6],t.m[10]=e.m[10],t.m[11]=e.m[14],t.m[12]=e.m[3],t.m[13]=e.m[7],t.m[14]=e.m[11],t.m[15]=e.m[15],t},BABYLON.Matrix.Reflection=function(e){var t=new BABYLON.Matrix;return BABYLON.Matrix.ReflectionToRef(e,t),t},BABYLON.Matrix.ReflectionToRef=function(e,t){e.normalize();var i=e.normal.x,r=e.normal.y,n=e.normal.z,o=-2*i,s=-2*r,a=-2*n;t.m[0]=o*i+1,t.m[1]=s*i,t.m[2]=a*i,t.m[3]=0,t.m[4]=o*r,t.m[5]=s*r+1,t.m[6]=a*r,t.m[7]=0,t.m[8]=o*n,t.m[9]=s*n,t.m[10]=a*n+1,t.m[11]=0,t.m[12]=o*e.d,t.m[13]=s*e.d,t.m[14]=a*e.d,t.m[15]=1},BABYLON.Plane=function(e,t,i,r){this.normal=new BABYLON.Vector3(e,t,i),this.d=r},BABYLON.Plane.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},BABYLON.Plane.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;0!=e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t},BABYLON.Plane.prototype.transform=function(e){var t=BABYLON.Matrix.Transpose(e),i=this.normal.x,r=this.normal.y,n=this.normal.z,o=this.d,s=i*t.m[0]+r*t.m[1]+n*t.m[2]+o*t.m[3],a=i*t.m[4]+r*t.m[5]+n*t.m[6]+o*t.m[7],h=i*t.m[8]+r*t.m[9]+n*t.m[10]+o*t.m[11],c=i*t.m[12]+r*t.m[13]+n*t.m[14]+o*t.m[15];return new BABYLON.Plane(s,a,h,c)},BABYLON.Plane.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},BABYLON.Plane.prototype.copyFromPoints=function(e,t,i){var r,n=t.x-e.x,o=t.y-e.y,s=t.z-e.z,a=i.x-e.x,h=i.y-e.y,c=i.z-e.z,l=o*c-s*h,u=s*a-n*c,f=n*h-o*a,B=Math.sqrt(l*l+u*u+f*f);r=0!=B?1/B:0,this.normal.x=l*r,this.normal.y=u*r,this.normal.z=f*r,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z)},BABYLON.Plane.prototype.isFrontFacingTo=function(e,t){var i=BABYLON.Vector3.Dot(this.normal,e);return t>=i},BABYLON.Plane.prototype.signedDistanceTo=function(e){return BABYLON.Vector3.Dot(e,this.normal)+this.d},BABYLON.Plane.FromArray=function(e){return new BABYLON.Plane(e[0],e[1],e[2],e[3])},BABYLON.Plane.FromPoints=function(e,t,i){var r=new BABYLON.Plane(0,0,0,0);return r.copyFromPoints(e,t,i),r},BABYLON.Plane.FromPositionAndNormal=function(e,t){var i=new BABYLON.Plane(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i},BABYLON.Plane.SignedDistanceToPlaneFromPositionAndNormal=function(e,t,i){var r=-(t.x*e.x+t.y*e.y+t.z*e.z);return BABYLON.Vector3.Dot(i,t)+r},BABYLON.Frustum={},BABYLON.Frustum.GetPlanes=function(e){for(var t=[],i=0;6>i;i++)t.push(new BABYLON.Plane(0,0,0,0));return BABYLON.Frustum.GetPlanesToRef(e,t),t},BABYLON.Frustum.GetPlanesToRef=function(e,t){t[0].normal.x=e.m[3]+e.m[2],t[0].normal.y=e.m[7]+e.m[6],t[0].normal.z=e.m[10]+e.m[10],t[0].d=e.m[15]+e.m[14],t[0].normalize(),t[1].normal.x=e.m[3]-e.m[2],t[1].normal.y=e.m[7]-e.m[6],t[1].normal.z=e.m[11]-e.m[10],t[1].d=e.m[15]-e.m[14],t[1].normalize(),t[2].normal.x=e.m[3]+e.m[0],t[2].normal.y=e.m[7]+e.m[4],t[2].normal.z=e.m[11]+e.m[8],t[2].d=e.m[15]+e.m[12],t[2].normalize(),t[3].normal.x=e.m[3]-e.m[0],t[3].normal.y=e.m[7]-e.m[4],t[3].normal.z=e.m[11]-e.m[8],t[3].d=e.m[15]-e.m[12],t[3].normalize(),t[4].normal.x=e.m[3]-e.m[1],t[4].normal.y=e.m[7]-e.m[5],t[4].normal.z=e.m[11]-e.m[9],t[4].d=e.m[15]-e.m[13],t[4].normalize(),t[5].normal.x=e.m[3]+e.m[1],t[5].normal.y=e.m[7]+e.m[5],t[5].normal.z=e.m[11]+e.m[9],t[5].d=e.m[15]+e.m[13],t[5].normalize()},BABYLON.Viewport={},BABYLON.Viewport=function(e,t,i,r){this.width=i,this.height=r,this.x=e,this.y=t},BABYLON.Viewport.prototype.toGlobal=function(e){var t=e.getRenderWidth()*e.getHardwareScalingLevel(),i=e.getRenderHeight()*e.getHardwareScalingLevel();return new BABYLON.Viewport(this.x*t,this.y*i,this.width*t,this.height*i)}}();var BABYLON=BABYLON||{};!function(){function e(e){var t=document.createElement("a");t.href=e;var i=e.substring(e.lastIndexOf("/")+1,e.length),r=e.substring(0,e.indexOf(i,0));return r}{var t=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange}BABYLON.Database=function(e){this.currentSceneUrl=BABYLON.Database.ReturnFullUrlLocation(e),this.db=null,this.enableSceneOffline=!1,this.enableTexturesOffline=!1,this.manifestVersionFound=0,this.mustUpdateRessources=!1,this.hasReachedQuota=!1,this.checkManifestFile()},BABYLON.Database.isUASupportingBlobStorage=!0,BABYLON.Database.ReturnFullUrlLocation=function(t){return-1===t.indexOf("http:/")?e(window.location.href)+t:t},BABYLON.Database.prototype.checkManifestFile=function(){function e(){console.log("Valid manifest file not found. Scene & textures will be loaded directly from the web server."),t.enableSceneOffline=!1,t.enableTexturesOffline=!1
}var t=this,i=this.currentSceneUrl+".manifest",r=new XMLHttpRequest;r.open("GET",i,!1),r.addEventListener("load",function(){if(200===r.status)try{var i=JSON.parse(r.response);t.enableSceneOffline=i.enableSceneOffline,t.enableTexturesOffline=i.enableTexturesOffline,i.version&&!isNaN(parseInt(i.version))&&(t.manifestVersionFound=i.version)}catch(n){e()}else e()},!1),r.addEventListener("error",function(){e()},!1);try{r.send()}catch(n){console.log("Error on XHR send request.")}},BABYLON.Database.prototype.openAsync=function(e,i){function r(){n.isSupported=!1,i&&i()}var n=this;if(t&&(this.enableSceneOffline||this.enableTexturesOffline))if(this.db)e&&e();else{this.hasReachedQuota=!1,this.isSupported=!0;var o=t.open("babylonjs",1);o.onerror=function(){r()},o.onblocked=function(){console.log("IDB request blocked. Please reload the page."),r()},o.onsuccess=function(){n.db=o.result,e()},o.onupgradeneeded=function(e){n.db=e.target.result;try{{n.db.createObjectStore("scenes",{keyPath:"sceneUrl"}),n.db.createObjectStore("versions",{keyPath:"sceneUrl"}),n.db.createObjectStore("textures",{keyPath:"textureUrl"})}}catch(t){console.log("Error while creating object stores. Exception: "+t.message),r()}}}else this.isSupported=!1,i&&i()},BABYLON.Database.prototype.loadImageFromDB=function(e,t){var i=this,r=BABYLON.Database.ReturnFullUrlLocation(e),n=function(){i.hasReachedQuota||null===i.db?t.src=e:i._saveImageIntoDBAsync(r,t)};this.mustUpdateRessources?n():this._loadImageFromDBAsync(r,t,n)},BABYLON.Database.prototype._loadImageFromDBAsync=function(e,t,i){if(this.isSupported&&null!==this.db){var r,n=this.db.transaction(["textures"]);n.onabort=function(){t.src=e},n.oncomplete=function(){var e;if(r){var n=window.URL||window.webkitURL;e=n.createObjectURL(r.data,{oneTimeOnly:!0}),t.src=e}else i()};var o=n.objectStore("textures").get(e);o.onsuccess=function(e){r=e.target.result},o.onerror=function(){console.log("Error loading texture "+e+" from DB."),t.src=e}}else console.log("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e},BABYLON.Database.prototype._saveImageIntoDBAsync=function(e,t){if(this.isSupported){var i=function(){var e;if(r){var i=window.URL||window.webkitURL;try{e=i.createObjectURL(r,{oneTimeOnly:!0})}catch(n){e=i.createObjectURL(r)}}t.src=e};if(BABYLON.Database.isUASupportingBlobStorage){var r,n=this,o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.addEventListener("load",function(){if(200===o.status){r=o.response;var s=n.db.transaction(["textures"],"readwrite");s.onabort=function(e){try{"QuotaExceededError"===e.srcElement.error.name&&(n.hasReachedQuota=!0)}catch(t){}i()},s.oncomplete=function(){i()};var a={};a.textureUrl=e,a.data=r;try{var h=s.objectStore("textures").put(a);h.onsuccess=function(){console.log("")},h.onerror=function(){i()}}catch(c){25===c.code&&(BABYLON.Database.isUASupportingBlobStorage=!1),t.src=e}}else t.src=e},!1),o.addEventListener("error",function(){console.log("Error in XHR request in BABYLON.Database."),t.src=e},!1),o.send()}else t.src=e}else console.log("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e},BABYLON.Database.prototype._checkVersionFromDB=function(e,t){var i=this,r=function(){i._saveVersionIntoDBAsync(e,t)};this._loadVersionFromDBAsync(e,t,r)},BABYLON.Database.prototype._loadVersionFromDBAsync=function(e,t,i){if(this.isSupported){var r,n=this;try{var o=this.db.transaction(["versions"]);o.oncomplete=function(){r?n.manifestVersionFound>r.data?(n.mustUpdateRessources=!0,i()):t(r.data):(n.mustUpdateRessources=!0,i())},o.onabort=function(){t(-1)};var s=o.objectStore("versions").get(e);s.onsuccess=function(e){r=e.target.result},s.onerror=function(){console.log("Error loading version for scene "+e+" from DB."),t(-1)}}catch(a){console.log("Error while accessing 'versions' object store (READ OP). Exception: "+a.message),t(-1)}}else console.log("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t(-1)},BABYLON.Database.prototype._saveVersionIntoDBAsync=function(e,t){if(this.isSupported&&!this.hasReachedQuota){var i=this;try{var r=this.db.transaction(["versions"],"readwrite");r.onabort=function(e){try{"QuotaExceededError"===e.srcElement.error.name&&(i.hasReachedQuota=!0)}catch(r){}t(-1)},r.oncomplete=function(){t(i.manifestVersionFound)};var n={};n.sceneUrl=e,n.data=this.manifestVersionFound;var o=r.objectStore("versions").put(n);o.onsuccess=function(){console.log("")},o.onerror=function(){console.log("Error in DB add version request in BABYLON.Database.")}}catch(s){console.log("Error while accessing 'versions' object store (WRITE OP). Exception: "+s.message),t(-1)}}else t(-1)},BABYLON.Database.prototype.loadSceneFromDB=function(e,t,i,r){var n=this,o=BABYLON.Database.ReturnFullUrlLocation(e),s=function(){n._saveSceneIntoDBAsync(o,t,i)};this._checkVersionFromDB(o,function(e){-1!==e?n.mustUpdateRessources?n._saveSceneIntoDBAsync(o,t,i):n._loadSceneFromDBAsync(o,t,s):r()})},BABYLON.Database.prototype._loadSceneFromDBAsync=function(e,t,i){if(this.isSupported){var r,n=this.db.transaction(["scenes"]);n.oncomplete=function(){r?t(r.data):i()},n.onabort=function(){i()};var o=n.objectStore("scenes").get(e);o.onsuccess=function(e){r=e.target.result},o.onerror=function(){console.log("Error loading scene "+e+" from DB."),i()}}else console.log("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()},BABYLON.Database.prototype._saveSceneIntoDBAsync=function(e,t,i){if(this.isSupported){var r,n=new XMLHttpRequest,o=this;n.open("GET",e,!0),n.onprogress=i,n.addEventListener("load",function(){if(200===n.status)if(r=n.responseText,o.hasReachedQuota)t(r);else{var i=o.db.transaction(["scenes"],"readwrite");i.onabort=function(e){try{"QuotaExceededError"===e.srcElement.error.name&&(o.hasReachedQuota=!0)}catch(i){}t(r)},i.oncomplete=function(){t(r)};var s={};s.sceneUrl=e,s.data=r,s.version=o.manifestVersionFound;try{var a=i.objectStore("scenes").put(s);a.onsuccess=function(){console.log("")},a.onerror=function(){console.log("Error in DB add scene request in BABYLON.Database.")}}catch(h){t(r)}}else t()},!1),n.addEventListener("error",function(){console.log("error on XHR request."),t()},!1),n.send()}else console.log("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}}();var BABYLON=BABYLON||{};!function(){function e(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function t(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}BABYLON.Tools=BABYLON.Tools||{};var i=542327876,r=131072,n=4,o=e("DXT1"),s=e("DXT3"),a=e("DXT5"),h=31,c=0,l=1,u=2,f=3,B=4,p=7,d=20,m=21;BABYLON.Tools.GetDDSInfo=function(e){var t=new Int32Array(e,0,h),i=1;return t[u]&r&&(i=Math.max(1,t[p])),{width:t[B],height:t[f],mipmapCount:i}},BABYLON.Tools.UploadDDSLevels=function(e,A,_,v){var g,L,O,N,y,x,Y,M,T,S,E=new Int32Array(_,0,h);if(E[c]!=i)return void console.error("Invalid magic number in DDS header");if(!E[d]&n)return void console.error("Unsupported format, must contain a FourCC code");switch(g=E[m]){case o:L=8,O=A.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case s:L=16,O=A.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case a:L=16,O=A.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return void console.error("Unsupported FourCC code:",t(g))}for(T=1,E[u]&r&&v!==!1&&(T=Math.max(1,E[p])),N=E[B],y=E[f],Y=E[l]+4,S=0;T>S;++S)x=Math.max(4,N)/4*Math.max(4,y)/4*L,M=new Uint8Array(_,Y,x),e.compressedTexImage2D(e.TEXTURE_2D,S,O,N,y,0,M),Y+=x,N*=.5,y*=.5}}();var BABYLON=BABYLON||{};!function(){BABYLON.Tools=BABYLON.Tools||{},BABYLON.Tools.GetFilename=function(e){var t=e.lastIndexOf("/");return 0>t?e:e.substring(t+1)},BABYLON.Tools.GetDOMTextContent=function(e){for(var t="",i=e.firstChild;i;)3==i.nodeType&&(t+=i.textContent),i=i.nextSibling;return t},BABYLON.Tools.ToDegrees=function(e){return 180*e/Math.PI},BABYLON.Tools.ToRadians=function(e){return e*Math.PI/180},BABYLON.Tools.ExtractMinAndMax=function(e,t,i){for(var r=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o=t;t+i>o;o++){var s=new BABYLON.Vector3(e[3*o],e[3*o+1],e[3*o+2]);r=BABYLON.Vector3.Minimize(s,r),n=BABYLON.Vector3.Maximize(s,n)}return{minimum:r,maximum:n}},BABYLON.Tools.SmartArray=function(e){this.data=new Array(e),this.length=0},BABYLON.Tools.SmartArray.prototype.push=function(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)},BABYLON.Tools.SmartArray.prototype.pushNoDuplicate=function(e){this.indexOf(e)>-1||this.push(e)},BABYLON.Tools.SmartArray.prototype.sort=function(e){this.data.sort(e)},BABYLON.Tools.SmartArray.prototype.reset=function(){this.length=0},BABYLON.Tools.SmartArray.prototype.concat=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}},BABYLON.Tools.SmartArray.prototype.concatWithNoDuplicate=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++){var i=(e.data||e)[t],r=this.data.indexOf(i);(-1===r||r>=this.length)&&(this.data[this.length++]=i)}}},BABYLON.Tools.SmartArray.prototype.indexOf=function(e){var t=this.data.indexOf(e);return t>=this.length?-1:t},BABYLON.Tools.GetPointerPrefix=function(){var e="pointer";return navigator.pointerEnabled||(e="mouse"),e},BABYLON.Tools.QueueNewFrame=function(e){window.requestAnimationFrame?window.requestAnimationFrame(e):window.msRequestAnimationFrame?window.msRequestAnimationFrame(e):window.webkitRequestAnimationFrame?window.webkitRequestAnimationFrame(e):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(e):window.oRequestAnimationFrame?window.oRequestAnimationFrame(e):window.setTimeout(e,16)},BABYLON.Tools.RequestFullscreen=function(e){e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen()},BABYLON.Tools.ExitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()},BABYLON.Tools.BaseUrl="",BABYLON.Tools.LoadImage=function(e,t,i,r){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){t(n)},n.onerror=function(e){i(n,e)};var o=function(){n.src=e},s=function(){r.loadImageFromDB(e,n)};if(r&&r.enableTexturesOffline&&BABYLON.Database.isUASupportingBlobStorage)r.openAsync(s,o);else if(-1===e.indexOf("file:"))o();else try{var a,h=e.substring(5);try{a=URL.createObjectURL(BABYLON.FilesTextures[h],{oneTimeOnly:!0})}catch(c){a=URL.createObjectURL(BABYLON.FilesTextures[h])}n.src=a}catch(l){console.log("Error while trying to load texture: "+h),n.src=null}return n},BABYLON.Tools.LoadFile=function(e,t,i,r,n){var o=function(){var r=new XMLHttpRequest,o=BABYLON.Tools.BaseUrl+e;r.open("GET",o,!0),n&&(r.responseType="arraybuffer"),r.onprogress=i,r.onreadystatechange=function(){if(4==r.readyState){if(200!=r.status)throw new Error(r.status,"Unable to load "+o);t(n?r.response:r.responseText)}},r.send(null)},s=function(){r.loadSceneFromDB(e,t,i,o)};r&&-1!==e.indexOf(".babylon")&&r.enableSceneOffline?r.openAsync(s,o):o()},BABYLON.Tools.ReadFile=function(e,t,i){var r=new FileReader;r.onload=function(e){t(e.target.result)},r.onprogress=i,r.readAsText(e)},BABYLON.Tools.WithinEpsilon=function(e,t){var i=e-t;return i>=-1.401298e-45&&1.401298e-45>=i};var e=function(e,t){return e?e instanceof BABYLON.Mesh?null:e instanceof BABYLON.SubMesh?e.clone(t):e.clone?e.clone():null:null};BABYLON.Tools.DeepCopy=function(t,i,r,n){for(var o in t)if(("_"!==o[0]||n&&-1!==n.indexOf(o))&&(!r||-1===r.indexOf(o))){var s=t[o],a=typeof s;if("function"!=a)if("object"==a)if(s instanceof Array){if(i[o]=[],s.length>0)if("object"==typeof s[0])for(var h=0;h<s.length;h++){var c=e(s[h],i);-1===i[o].indexOf(c)&&i[o].push(c)}else i[o]=s.slice(0)}else i[o]=e(s,i);else i[o]=s}},BABYLON.Tools.IsEmpty=function(e){for(var t in e)return!1;return!0};var t=60,i=[],r=60,n=0;BABYLON.Tools.GetFps=function(){return r},BABYLON.Tools.GetDeltaTime=function(){return n},BABYLON.Tools._MeasureFps=function(){i.push((new Date).getTime());var e=i.length;if(e>=2&&(n=i[e-1]-i[e-2]),e>=t){e>t&&(i.splice(0,1),e=i.length);for(var o=0,s=0;e-1>s;s++)o+=i[s+1]-i[s];r=1e3/(o/(e-1))}}}();var BABYLON=BABYLON||{};!function(){BABYLON.Engine=function(e,t,i){var r=this;this._renderingCanvas=e,i=i||{},i.antialias=t;try{this._gl=e.getContext("webgl",i)||e.getContext("experimental-webgl",i)}catch(n){throw new Error("WebGL not supported")}if(!this._gl)throw new Error("WebGL not supported");this._windowIsBackground=!1,this._onBlur=function(){r._windowIsBackground=!0},this._onFocus=function(){r._windowIsBackground=!1},window.addEventListener("blur",this._onBlur),window.addEventListener("focus",this._onFocus),this.forceWireframe=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.scenes=[],this._workingCanvas=document.createElement("canvas"),this._workingContext=this._workingCanvas.getContext("2d"),this._hardwareScalingLevel=1/(window.devicePixelRatio||1),this.resize(),this._caps={},this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),this._caps.standardDerivatives=null!==this._gl.getExtension("OES_standard_derivatives"),this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc"),this._caps.textureFloat=null!==this._gl.getExtension("OES_texture_float"),this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._loadedTexturesCache=[],this._activeTexturesCache=[],this._currentEffect=null,this._currentState={culling:null},this._compiledEffects={},this._gl.enable(this._gl.DEPTH_TEST),this._gl.depthFunc(this._gl.LEQUAL),this.isFullscreen=!1,this._onFullscreenChange=function(){void 0!==document.fullscreen?r.isFullscreen=document.fullscreen:void 0!==document.mozFullScreen?r.isFullscreen=document.mozFullScreen:void 0!==document.webkitIsFullScreen?r.isFullscreen=document.webkitIsFullScreen:void 0!==document.msIsFullScreen&&(r.isFullscreen=document.msIsFullScreen),r.isFullscreen&&r._pointerLockRequested&&(e.requestPointerLock=e.requestPointerLock||e.msRequestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock&&e.requestPointerLock())},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1),this.isPointerLock=!1,this._onPointerLockChange=function(){r.isPointerLock=document.mozPointerLockElement===e||document.webkitPointerLockElement===e||document.msPointerLockElement===e||document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)},BABYLON.Engine.prototype.getAspectRatio=function(e){var t=e.viewport;return this._renderingCanvas.width*t.width/(this._renderingCanvas.height*t.height)},BABYLON.Engine.prototype.getRenderWidth=function(){return this._renderingCanvas.width},BABYLON.Engine.prototype.getRenderHeight=function(){return this._renderingCanvas.height},BABYLON.Engine.prototype.getRenderingCanvas=function(){return this._renderingCanvas},BABYLON.Engine.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},BABYLON.Engine.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},BABYLON.Engine.prototype.getLoadedTexturesCache=function(){return this._loadedTexturesCache},BABYLON.Engine.prototype.getCaps=function(){return this._caps},BABYLON.Engine.prototype.stopRenderLoop=function(){this._renderFunction=null,this._runningLoop=!1},BABYLON.Engine.prototype._renderLoop=function(){var e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e&&(this.beginFrame(),this._renderFunction&&this._renderFunction(),this.endFrame()),this._runningLoop){var t=this;BABYLON.Tools.QueueNewFrame(function(){t._renderLoop()})}},BABYLON.Engine.prototype.runRenderLoop=function(e){this._runningLoop=!0,this._renderFunction=e;var t=this;BABYLON.Tools.QueueNewFrame(function(){t._renderLoop()})},BABYLON.Engine.prototype.switchFullscreen=function(e){this.isFullscreen?BABYLON.Tools.ExitFullscreen():(this._pointerLockRequested=e,BABYLON.Tools.RequestFullscreen(this._renderingCanvas))},BABYLON.Engine.prototype.clear=function(e,t,i){this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),this._gl.clearDepth(1);var r=0;t&&(r|=this._gl.COLOR_BUFFER_BIT),i&&(r|=this._gl.DEPTH_BUFFER_BIT),this._gl.clear(r)},BABYLON.Engine.prototype.setViewport=function(e,t,i){var r=t||this._renderingCanvas.width,n=i||this._renderingCanvas.height,o=e.x||0,s=e.y||0;this._cachedViewport=e,this._gl.viewport(o*r,s*n,r*e.width,n*e.height)},BABYLON.Engine.prototype.setDirectViewport=function(e,t,i,r){this._cachedViewport=null,this._gl.viewport(e,t,i,r)},BABYLON.Engine.prototype.beginFrame=function(){BABYLON.Tools._MeasureFps()},BABYLON.Engine.prototype.endFrame=function(){this.flushFramebuffer()},BABYLON.Engine.prototype.resize=function(){this._renderingCanvas.width=this._renderingCanvas.clientWidth/this._hardwareScalingLevel,this._renderingCanvas.height=this._renderingCanvas.clientHeight/this._hardwareScalingLevel},BABYLON.Engine.prototype.bindFramebuffer=function(e){var t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,e._framebuffer),this._gl.viewport(0,0,e._width,e._height),this.wipeCaches()},BABYLON.Engine.prototype.unBindFramebuffer=function(e){if(e.generateMipMaps){var t=this._gl;t.bindTexture(t.TEXTURE_2D,e),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)}},BABYLON.Engine.prototype.flushFramebuffer=function(){this._gl.flush()},BABYLON.Engine.prototype.restoreDefaultFramebuffer=function(){this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null),this.setViewport(this._cachedViewport),this.wipeCaches()},BABYLON.Engine.prototype.createVertexBuffer=function(e){var t=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null),t.references=1,t},BABYLON.Engine.prototype.createDynamicVertexBuffer=function(e){var t=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null),t.references=1,t},BABYLON.Engine.prototype.updateDynamicVertexBuffer=function(e,t,i){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,e),i?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t,0,i)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t)),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,null)},BABYLON.Engine.prototype.createIndexBuffer=function(e){var t=this._gl.createBuffer();return this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),this._gl.STATIC_DRAW),this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,null),t.references=1,t},BABYLON.Engine.prototype.bindBuffers=function(e,t,i,r,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n,this._gl.bindBuffer(this._gl.ARRAY_BUFFER,e);for(var o=0,s=0;s<i.length;s++){var a=n.getAttribute(s);a>=0&&this._gl.vertexAttribPointer(a,i[s],this._gl.FLOAT,!1,r,o),o+=4*i[s]}}this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t))},BABYLON.Engine.prototype.bindMultiBuffers=function(e,t,i){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i;for(var r=i.getAttributesNames(),n=0;n<r.length;n++){var o=i.getAttribute(n);if(o>=0){var s=e[r[n]],a=s.getStrideSize();this._gl.bindBuffer(this._gl.ARRAY_BUFFER,s._buffer),this._gl.vertexAttribPointer(o,a,this._gl.FLOAT,!1,4*a,0)}}}this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this._gl.bindBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t))},BABYLON.Engine.prototype._releaseBuffer=function(e){e.references--,0===e.references&&this._gl.deleteBuffer(e)},BABYLON.Engine.prototype.draw=function(e,t,i){this._gl.drawElements(e?this._gl.TRIANGLES:this._gl.LINES,i,this._gl.UNSIGNED_SHORT,2*t)},BABYLON.Engine.prototype.createEffect=function(e,t,i,r,n,o){var s=e.vertexElement||e.vertex||e,a=e.fragmentElement||e.fragment||e,h=s+"+"+a+"@"+n;if(this._compiledEffects[h])return this._compiledEffects[h];var c=new BABYLON.Effect(e,t,i,r,this,n,o);return this._compiledEffects[h]=c,c};var e=function(e,t,i,r){var n=e.createShader("vertex"===i?e.VERTEX_SHADER:e.FRAGMENT_SHADER);if(e.shaderSource(n,(r?r+"\n":"")+t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(n));return n};BABYLON.Engine.prototype.createShaderProgram=function(t,i,r){var n=e(this._gl,t,"vertex",r),o=e(this._gl,i,"fragment",r),s=this._gl.createProgram();this._gl.attachShader(s,n),this._gl.attachShader(s,o),this._gl.linkProgram(s);var a=this._gl.getProgramInfoLog(s);if(a)throw new Error(a);return this._gl.deleteShader(n),this._gl.deleteShader(o),s},BABYLON.Engine.prototype.getUniforms=function(e,t){for(var i=[],r=0;r<t.length;r++)i.push(this._gl.getUniformLocation(e,t[r]));return i},BABYLON.Engine.prototype.getAttributes=function(e,t){for(var i=[],r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(e,t[r]))}catch(n){i.push(-1)}return i},BABYLON.Engine.prototype.enableEffect=function(e){if(e&&e.getAttributesCount()&&this._currentEffect!==e){this._gl.useProgram(e.getProgram());for(var t=0;t<e.getAttributesCount();t++){var i=e.getAttribute(t);i>=0&&this._gl.enableVertexAttribArray(e.getAttribute(t))}this._currentEffect=e}},BABYLON.Engine.prototype.setArray=function(e,t){e&&this._gl.uniform1fv(e,t)},BABYLON.Engine.prototype.setMatrices=function(e,t){e&&this._gl.uniformMatrix4fv(e,!1,t)},BABYLON.Engine.prototype.setMatrix=function(e,t){e&&this._gl.uniformMatrix4fv(e,!1,t.toArray())},BABYLON.Engine.prototype.setFloat=function(e,t){e&&this._gl.uniform1f(e,t)},BABYLON.Engine.prototype.setFloat2=function(e,t,i){e&&this._gl.uniform2f(e,t,i)},BABYLON.Engine.prototype.setFloat3=function(e,t,i,r){e&&this._gl.uniform3f(e,t,i,r)},BABYLON.Engine.prototype.setBool=function(e,t){e&&this._gl.uniform1i(e,t)},BABYLON.Engine.prototype.setFloat4=function(e,t,i,r,n){e&&this._gl.uniform4f(e,t,i,r,n)},BABYLON.Engine.prototype.setColor3=function(e,t){e&&this._gl.uniform3f(e,t.r,t.g,t.b)},BABYLON.Engine.prototype.setColor4=function(e,t,i){e&&this._gl.uniform4f(e,t.r,t.g,t.b,i)},BABYLON.Engine.prototype.setState=function(e){this._currentState.culling!==e&&(e?(this._gl.cullFace(this.cullBackFaces?this._gl.BACK:this._gl.FRONT),this._gl.enable(this._gl.CULL_FACE)):this._gl.disable(this._gl.CULL_FACE),this._currentState.culling=e)},BABYLON.Engine.prototype.setDepthBuffer=function(e){e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST)},BABYLON.Engine.prototype.setDepthWrite=function(e){this._gl.depthMask(e)},BABYLON.Engine.prototype.setColorWrite=function(e){this._gl.colorMask(e,e,e,e)},BABYLON.Engine.prototype.setAlphaMode=function(e){switch(e){case BABYLON.Engine.ALPHA_DISABLE:this.setDepthWrite(!0),this._gl.disable(this._gl.BLEND);break;case BABYLON.Engine.ALPHA_COMBINE:this.setDepthWrite(!1),this._gl.blendFuncSeparate(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._gl.enable(this._gl.BLEND);break;case BABYLON.Engine.ALPHA_ADD:this.setDepthWrite(!1),this._gl.blendFuncSeparate(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._gl.enable(this._gl.BLEND)}},BABYLON.Engine.prototype.setAlphaTesting=function(e){this._alphaTest=e},BABYLON.Engine.prototype.getAlphaTesting=function(){return this._alphaTest},BABYLON.Engine.prototype.wipeCaches=function(){this._activeTexturesCache=[],this._currentEffect=null,this._currentState={culling:null},this._cachedVertexBuffers=null,this._cachedVertexBuffers=null,this._cachedEffectForVertexBuffers=null};var t=function(e,t){var i=1;do i*=2;while(e>i);return i>t&&(i=t),i},i=function(e,i,r,n,o,s,a){var h=i.getEngine(),c=t(r,h._caps.maxTextureSize),l=t(n,h._caps.maxTextureSize);h._gl.bindTexture(h._gl.TEXTURE_2D,e),h._gl.pixelStorei(h._gl.UNPACK_FLIP_Y_WEBGL,void 0===o?!0:o),a(c,l),h._gl.texParameteri(h._gl.TEXTURE_2D,h._gl.TEXTURE_MAG_FILTER,h._gl.LINEAR),s?h._gl.texParameteri(h._gl.TEXTURE_2D,h._gl.TEXTURE_MIN_FILTER,h._gl.LINEAR):(h._gl.texParameteri(h._gl.TEXTURE_2D,h._gl.TEXTURE_MIN_FILTER,h._gl.LINEAR_MIPMAP_LINEAR),h._gl.generateMipmap(h._gl.TEXTURE_2D)),h._gl.bindTexture(h._gl.TEXTURE_2D,null),h._activeTexturesCache=[],e._baseWidth=r,e._baseHeight=n,e._width=c,e._height=l,e.isReady=!0,i._removePendingData(e)};BABYLON.Engine.prototype.createTexture=function(e,t,r,n){var o=this._gl.createTexture(),s=this,a=this.getCaps().s3tc&&".dds"===e.substr(e.length-4,4).toLowerCase();if(n._addPendingData(o),o.url=e,o.noMipmap=t,o.references=1,this._loadedTexturesCache.push(o),a)BABYLON.Tools.LoadFile(e,function(e){var a=BABYLON.Tools.GetDDSInfo(e),h=a.mipmapCount>1&&!t;i(o,n,a.width,a.height,r,!h,function(){BABYLON.Tools.UploadDDSLevels(s._gl,s.getCaps().s3tc,e,h)})},null,n.database,!0);else{var h=function(e){i(o,n,e.width,e.height,r,t,function(t,i){var r=e.width==t&&e.height==i;r||(s._workingCanvas.width=t,s._workingCanvas.height=i,s._workingContext.drawImage(e,0,0,e.width,e.height,0,0,t,i)),s._gl.texImage2D(s._gl.TEXTURE_2D,0,s._gl.RGBA,s._gl.RGBA,s._gl.UNSIGNED_BYTE,r?e:s._workingCanvas)})},c=function(){n._removePendingData(o)};BABYLON.Tools.LoadImage(e,h,c,n.database)}return o},BABYLON.Engine.prototype.createDynamicTexture=function(e,i,r){var n=this._gl.createTexture();return e=t(e,this._caps.maxTextureSize),i=t(i,this._caps.maxTextureSize),this._gl.bindTexture(this._gl.TEXTURE_2D,n),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),r?this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR_MIPMAP_LINEAR):this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],n._baseWidth=e,n._baseHeight=i,n._width=e,n._height=i,n.isReady=!1,n.generateMipMaps=r,n.references=1,this._loadedTexturesCache.push(n),n},BABYLON.Engine.prototype.updateDynamicTexture=function(e,t,i){this._gl.bindTexture(this._gl.TEXTURE_2D,e),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],e.isReady=!0},BABYLON.Engine.prototype.updateVideoTexture=function(e,t,i){this._gl.bindTexture(this._gl.TEXTURE_2D,e),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?!1:!0),t.videoWidth!==e._width||t.videoHeight!==e._height?(e._workingCanvas||(e._workingCanvas=document.createElement("canvas"),e._workingContext=e._workingCanvas.getContext("2d"),e._workingCanvas.width=e._width,e._workingCanvas.height=e._height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e._width,e._height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e._workingCanvas)):this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._activeTexturesCache=[],e.isReady=!0},BABYLON.Engine.prototype.createRenderTargetTexture=function(e,t){var i=!1,r=!0,n=BABYLON.Texture.TRILINEAR_SAMPLINGMODE;void 0!==t&&(i=void 0===t.generateMipMaps?t:t.generateMipmaps,r=void 0===t.generateDepthBuffer?!0:t.generateDepthBuffer,void 0!==t.samplingMode&&(n=t.samplingMode));var o=this._gl,s=o.createTexture();o.bindTexture(o.TEXTURE_2D,s);var a=e.width||e,h=e.height||e,c=o.NEAREST,l=o.NEAREST;n===BABYLON.Texture.BILINEAR_SAMPLINGMODE?(c=o.LINEAR,l=i?o.LINEAR_MIPMAP_NEAREST:o.LINEAR):n===BABYLON.Texture.TRILINEAR_SAMPLINGMODE&&(c=o.LINEAR,l=i?o.LINEAR_MIPMAP_LINEAR:o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,c),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,l),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,a,h,0,o.RGBA,o.UNSIGNED_BYTE,null);var u;r&&(u=o.createRenderbuffer(),o.bindRenderbuffer(o.RENDERBUFFER,u),o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,a,h));var f=o.createFramebuffer();return o.bindFramebuffer(o.FRAMEBUFFER,f),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,s,0),r&&o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,u),o.bindTexture(o.TEXTURE_2D,null),o.bindRenderbuffer(o.RENDERBUFFER,null),o.bindFramebuffer(o.FRAMEBUFFER,null),s._framebuffer=f,r&&(s._depthBuffer=u),s._width=a,s._height=h,s.isReady=!0,s.generateMipMaps=i,s.references=1,this._activeTexturesCache=[],this._loadedTexturesCache.push(s),s};var r=function(e,t,i,n,o,s){var a,h=function(){i.push(a),n._removePendingData(a),t!=s.length-1?r(e,t+1,i,n,o,s):o(i)},c=function(){n._removePendingData(a)};a=BABYLON.Tools.LoadImage(e+s[t],h,c,n.database),n._addPendingData(a)};BABYLON.Engine.prototype.createCubeTexture=function(e,i,n,o){var s=this._gl,a=s.createTexture();a.isCube=!0,a.url=e,a.references=1,this._loadedTexturesCache.push(a);var h=this;return r(e,0,[],i,function(e){var i=t(e[0].width,h._caps.maxCubemapTextureSize),r=i;h._workingCanvas.width=i,h._workingCanvas.height=r;var n=[s.TEXTURE_CUBE_MAP_POSITIVE_X,s.TEXTURE_CUBE_MAP_POSITIVE_Y,s.TEXTURE_CUBE_MAP_POSITIVE_Z,s.TEXTURE_CUBE_MAP_NEGATIVE_X,s.TEXTURE_CUBE_MAP_NEGATIVE_Y,s.TEXTURE_CUBE_MAP_NEGATIVE_Z];s.bindTexture(s.TEXTURE_CUBE_MAP,a),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1);for(var c=0;c<n.length;c++)h._workingContext.drawImage(e[c],0,0,e[c].width,e[c].height,0,0,i,r),s.texImage2D(n[c],0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,h._workingCanvas);o||s.generateMipmap(s.TEXTURE_CUBE_MAP),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,o?s.LINEAR:s.LINEAR_MIPMAP_LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.bindTexture(s.TEXTURE_CUBE_MAP,null),h._activeTexturesCache=[],a._width=i,a._height=r,a.isReady=!0},n),a},BABYLON.Engine.prototype._releaseTexture=function(e){var t=this._gl;e._framebuffer&&t.deleteFramebuffer(e._framebuffer),e._depthBuffer&&t.deleteRenderbuffer(e._depthBuffer),t.deleteTexture(e);for(var i=0;i<this._caps.maxTexturesImageUnits;i++)this._gl.activeTexture(this._gl["TEXTURE"+i]),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null),this._activeTexturesCache[i]=null;
var r=this._loadedTexturesCache.indexOf(e);-1!==r&&this._loadedTexturesCache.splice(r,1)},BABYLON.Engine.prototype.bindSamplers=function(e){this._gl.useProgram(e.getProgram());for(var t=e.getSamplers(),i=0;i<t.length;i++){var r=e.getUniform(t[i]);this._gl.uniform1i(r,i)}this._currentEffect=null},BABYLON.Engine.prototype._bindTexture=function(e,t){this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,t),this._activeTexturesCache[e]=null},BABYLON.Engine.prototype.setTextureFromPostProcess=function(e,t){this._bindTexture(e,t._textures.data[t._currentRenderTextureInd])},BABYLON.Engine.prototype.setTexture=function(e,t){if(!(0>e)){if(!t||!t.isReady())return void(null!=this._activeTexturesCache[e]&&(this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,null),this._activeTexturesCache[e]=null));if(t instanceof BABYLON.VideoTexture)t._update()&&(this._activeTexturesCache[e]=null);else if(t.delayLoadState==BABYLON.Engine.DELAYLOADSTATE_NOTLOADED)return void t.delayLoad();if(this._activeTexturesCache[e]!=t){this._activeTexturesCache[e]=t;var i=t.getInternalTexture();if(this._gl.activeTexture(this._gl["TEXTURE"+e]),i.isCube)this._gl.bindTexture(this._gl.TEXTURE_CUBE_MAP,i),i._cachedCoordinatesMode!==t.coordinatesMode&&(i._cachedCoordinatesMode=t.coordinatesMode,this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,t.coordinatesMode!==BABYLON.CubeTexture.CUBIC_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,t.coordinatesMode!==BABYLON.CubeTexture.CUBIC_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE)),this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,t);else{if(this._gl.bindTexture(this._gl.TEXTURE_2D,i),i._cachedWrapU!==t.wrapU)switch(i._cachedWrapU=t.wrapU,t.wrapU){case BABYLON.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case BABYLON.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case BABYLON.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT)}if(i._cachedWrapV!==t.wrapV)switch(i._cachedWrapV=t.wrapV,t.wrapV){case BABYLON.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case BABYLON.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case BABYLON.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT)}this._setAnisotropicLevel(this._gl.TEXTURE_2D,t)}}}},BABYLON.Engine.prototype._setAnisotropicLevel=function(e,t){var i=this._caps.textureAnisotropicFilterExtension;i&&t._cachedAnisotropicFilteringLevel!==t.anisotropicFilteringLevel&&(this._gl.texParameterf(e,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropicFilteringLevel,this._caps.maxAnisotropy)),t._cachedAnisotropicFilteringLevel=t.anisotropicFilteringLevel)},BABYLON.Engine.prototype.dispose=function(){for(;this.scenes.length;)this.scenes[0].dispose();for(var e in this._compiledEffects.length)this._gl.deleteProgram(this._compiledEffects[e]._program);window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)},BABYLON.Engine.ShadersRepository="Babylon/Shaders/",BABYLON.Engine.ALPHA_DISABLE=0,BABYLON.Engine.ALPHA_ADD=1,BABYLON.Engine.ALPHA_COMBINE=2,BABYLON.Engine.DELAYLOADSTATE_NONE=0,BABYLON.Engine.DELAYLOADSTATE_LOADED=1,BABYLON.Engine.DELAYLOADSTATE_LOADING=2,BABYLON.Engine.DELAYLOADSTATE_NOTLOADED=4,BABYLON.Engine.epsilon=.001,BABYLON.Engine.collisionsEpsilon=.001,BABYLON.Engine.isSupported=function(){try{var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");return null!=t&&!!window.WebGLRenderingContext}catch(i){return!1}}}();var BABYLON=BABYLON||{};!function(){BABYLON.Node=function(e){this._scene=e,BABYLON.Node.prototype._initCache.call(this)},BABYLON.Node.prototype.parent=null,BABYLON.Node.prototype._childrenFlag=-1,BABYLON.Node.prototype._isReady=!0,BABYLON.Node.prototype._isEnabled=!0,BABYLON.Node.prototype._currentRenderId=-1,BABYLON.Node.prototype._cache=null,BABYLON.Node.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},BABYLON.Node.prototype.updateCache=function(e){(e||!this.isSynchronized())&&(this._cache.parent=this.parent,this._updateCache())},BABYLON.Node.prototype._updateCache=function(){},BABYLON.Node.prototype._isSynchronized=function(){return!0},BABYLON.Node.prototype.isSynchronizedWithParent=function(){return this.parent?!this.parent._currentRenderId===this._currentRenderId:!0},BABYLON.Node.prototype.isSynchronized=function(e){var t=this.hasNewParent();return t=t||!this.isSynchronizedWithParent(),t=t||!this._isSynchronized(),e&&this.updateCache(!0),!t},BABYLON.Node.prototype.hasNewParent=function(e){return this._cache.parent===this.parent?!1:(e&&(this._cache.parent=this.parent),!0)},BABYLON.Node.prototype.isReady=function(){return this._isReady},BABYLON.Node.prototype.isEnabled=function(){return this.isReady()&&this._isEnabled?this.parent?this.parent.isEnabled():!0:!1},BABYLON.Node.prototype.setEnabled=function(e){this._isEnabled=e},BABYLON.Node.prototype.isDescendantOf=function(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1},BABYLON.Node.prototype._getDescendants=function(e,t){for(var i=0;i<e.length;i++){var r=e[i];r.isDescendantOf(this)&&t.push(r)}},BABYLON.Node.prototype.getDescendants=function(){var e=[];return this._getDescendants(this._scene.meshes,e),this._getDescendants(this._scene.lights,e),this._getDescendants(this._scene.cameras,e),e}}();var BABYLON=BABYLON||{};!function(){function e(){if(r.additionnalRenderLoopLogicCallback&&r.additionnalRenderLoopLogicCallback(),r.currentScene){if(r.textureLoadingCallback){var e=r.currentScene.getWaitingItemsCount();e>0&&r.textureLoadingCallback(e)}r.currentScene.render()}}function t(e){e.stopPropagation(),e.preventDefault()}function i(e){e.stopPropagation(),e.preventDefault(),r.loadFiles(e)}var r;BABYLON.FilesInput=function(t,i,n,o,s,a,h,c){r=this,this.engine=t,this.canvas=n,this.currentScene=i,this.sceneLoadedCallback=o,this.progressCallback=s,this.additionnalRenderLoopLogicCallback=a,this.textureLoadingCallback=h,this.startingProcessingFilesCallback=c,this.engine.runRenderLoop(e)},BABYLON.FilesInput.prototype.monitorElementForDragNDrop=function(e){e&&(this.elementToMonitor=e,this.elementToMonitor.addEventListener("dragenter",t,!1),this.elementToMonitor.addEventListener("dragover",t,!1),this.elementToMonitor.addEventListener("drop",i,!1))},BABYLON.FilesInput.prototype.loadFiles=function(e){r.startingProcessingFilesCallback&&r.startingProcessingFilesCallback();var t,i;if(BABYLON.FilesTextures={},e&&e.dataTransfer&&e.dataTransfer.files&&(i=e.dataTransfer.files),e&&e.target&&e.target.files&&(i=e.target.files),i&&i.length>0){for(var n=0;n<i.length;n++)-1!==i[n].name.indexOf(".babylon")&&-1===i[n].name.indexOf(".manifest")&&-1===i[n].name.indexOf(".incremental")&&-1===i[n].name.indexOf(".babylonmeshdata")?t=i[n]:(0==i[n].type.indexOf("image/jpeg")||0==i[n].type.indexOf("image/png"))&&(BABYLON.FilesTextures[i[n].name]=i[n]);t?(r.currentScene&&r.currentScene.dispose(),BABYLON.SceneLoader.Load("file:",t,r.engine,function(e){r.currentScene=e,r.currentScene.executeWhenReady(function(){r.currentScene.activeCamera.attachControl(r.canvas),r.sceneLoadedCallback&&r.sceneLoadedCallback(t,r.currentScene)})},function(e){r.progressCallback&&r.progressCallback(e)})):console.log("Please provide a valid .babylon file.")}}}();var BABYLON=BABYLON||{};!function(){BABYLON.PickingInfo=function(){},BABYLON.PickingInfo.prototype.hit=!1,BABYLON.PickingInfo.prototype.distance=0,BABYLON.PickingInfo.prototype.pickedPoint=null,BABYLON.PickingInfo.prototype.pickedMesh=null,BABYLON.PickingInfo.prototype.bu=0,BABYLON.PickingInfo.prototype.bv=0,BABYLON.PickingInfo.prototype.faceId=-1,BABYLON.PickingInfo.prototype.getNormal=function(){if(!this.pickedMesh)return null;var e=this.pickedMesh.getIndices(),t=this.pickedMesh.getVerticesData(BABYLON.VertexBuffer.NormalKind),i=BABYLON.Vector3.FromArray(t,e[this.faceId]),r=BABYLON.Vector3.FromArray(t,e[this.faceId+1]),n=BABYLON.Vector3.FromArray(t,e[this.faceId+2]);return i=i.scale(this.bu),r=r.scale(this.bv),n=n.scale(1-this.bu-this.bv),new BABYLON.Vector3(i.x+r.x+n.x,i.y+r.y+n.y,i.z+r.z+n.z)}}();var BABYLON=BABYLON||{};!function(){BABYLON.BoundingSphere=function(e,t){this.minimum=e,this.maximum=t;var i=BABYLON.Vector3.Distance(e,t);this.center=BABYLON.Vector3.Lerp(e,t,.5),this.radius=.5*i,this.centerWorld=BABYLON.Vector3.Zero(),this._update(BABYLON.Matrix.Identity())},BABYLON.BoundingSphere.prototype._update=function(e,t){BABYLON.Vector3.TransformCoordinatesToRef(this.center,e,this.centerWorld),this.radiusWorld=this.radius*t},BABYLON.BoundingSphere.prototype.isInFrustum=function(e){for(var t=0;6>t;t++)if(e[t].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return!1;return!0},BABYLON.BoundingSphere.prototype.intersectsPoint=function(e){var t=this.centerWorld.x-e.x,i=this.centerWorld.y-e.y,r=this.centerWorld.z-e.z,n=Math.sqrt(t*t+i*i+r*r);return this.radiusWorld<n?!1:!0},BABYLON.BoundingSphere.intersects=function(e,t){var i=e.centerWorld.x-t.centerWorld.x,r=e.centerWorld.y-t.centerWorld.y,n=e.centerWorld.z-t.centerWorld.z,o=Math.sqrt(i*i+r*r+n*n);return e.radiusWorld+t.radiusWorld<o?!1:!0}}();var BABYLON=BABYLON||{};!function(){BABYLON.BoundingBox=function(e,t){this.minimum=e,this.maximum=t,this.vectors=[],this.vectors.push(this.minimum.clone()),this.vectors.push(this.maximum.clone()),this.vectors.push(this.minimum.clone()),this.vectors[2].x=this.maximum.x,this.vectors.push(this.minimum.clone()),this.vectors[3].y=this.maximum.y,this.vectors.push(this.minimum.clone()),this.vectors[4].z=this.maximum.z,this.vectors.push(this.maximum.clone()),this.vectors[5].z=this.minimum.z,this.vectors.push(this.maximum.clone()),this.vectors[6].x=this.minimum.x,this.vectors.push(this.maximum.clone()),this.vectors[7].y=this.minimum.y,this.center=this.maximum.add(this.minimum).scale(.5),this.extends=this.maximum.subtract(this.minimum).scale(.5),this.directions=[BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero()],this.vectorsWorld=[];for(var i=0;i<this.vectors.length;i++)this.vectorsWorld[i]=BABYLON.Vector3.Zero();this.minimumWorld=BABYLON.Vector3.Zero(),this.maximumWorld=BABYLON.Vector3.Zero(),this._update(BABYLON.Matrix.Identity())},BABYLON.BoundingBox.prototype._update=function(e){BABYLON.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld),BABYLON.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld);for(var t=0;t<this.vectors.length;t++){var i=this.vectorsWorld[t];BABYLON.Vector3.TransformCoordinatesToRef(this.vectors[t],e,i),i.x<this.minimumWorld.x&&(this.minimumWorld.x=i.x),i.y<this.minimumWorld.y&&(this.minimumWorld.y=i.y),i.z<this.minimumWorld.z&&(this.minimumWorld.z=i.z),i.x>this.maximumWorld.x&&(this.maximumWorld.x=i.x),i.y>this.maximumWorld.y&&(this.maximumWorld.y=i.y),i.z>this.maximumWorld.z&&(this.maximumWorld.z=i.z)}this.maximumWorld.addToRef(this.minimumWorld,this.center),this.center.scaleInPlace(.5),BABYLON.Vector3.FromArrayToRef(e.m,0,this.directions[0]),BABYLON.Vector3.FromArrayToRef(e.m,4,this.directions[1]),BABYLON.Vector3.FromArrayToRef(e.m,8,this.directions[2])},BABYLON.BoundingBox.prototype.isInFrustum=function(e){return BABYLON.BoundingBox.IsInFrustum(this.vectorsWorld,e)},BABYLON.BoundingBox.prototype.intersectsPoint=function(e){return this.maximumWorld.x<e.x||this.minimumWorld.x>e.x?!1:this.maximumWorld.y<e.y||this.minimumWorld.y>e.y?!1:this.maximumWorld.z<e.z||this.minimumWorld.z>e.z?!1:!0},BABYLON.BoundingBox.prototype.intersectsSphere=function(e){var t=BABYLON.Vector3.Clamp(e.centerWorld,this.minimumWorld,this.maximumWorld),i=BABYLON.Vector3.DistanceSquared(e.centerWorld,t);return i<=e.radiusWorld*e.radiusWorld},BABYLON.BoundingBox.prototype.intersectsMinMax=function(e,t){return this.maximumWorld.x<e.x||this.minimumWorld.x>t.x?!1:this.maximumWorld.y<e.y||this.minimumWorld.y>t.y?!1:this.maximumWorld.z<e.z||this.minimumWorld.z>t.z?!1:!0},BABYLON.BoundingBox.intersects=function(e,t){return e.maximumWorld.x<t.minimumWorld.x||e.minimumWorld.x>t.maximumWorld.x?!1:e.maximumWorld.y<t.minimumWorld.y||e.minimumWorld.y>t.maximumWorld.y?!1:e.maximumWorld.z<t.minimumWorld.z||e.minimumWorld.z>t.maximumWorld.z?!1:!0},BABYLON.BoundingBox.IsInFrustum=function(e,t){for(var i=0;6>i;i++){for(var r=8,n=0;8>n&&t[i].dotCoordinate(e[n])<0;n++)--r;if(0==r)return!1}return!0}}();var BABYLON=BABYLON||{};!function(){BABYLON.BoundingInfo=function(e,t){this.boundingBox=new BABYLON.BoundingBox(e,t),this.boundingSphere=new BABYLON.BoundingSphere(e,t)},BABYLON.BoundingInfo.prototype._update=function(e,t){this.boundingBox._update(e),this.boundingSphere._update(e,t)};var e=function(e,t,i,r){return!(e>r||i>t)},t=function(e,t){var i=BABYLON.Vector3.Dot(t.center,e),r=Math.abs(BABYLON.Vector3.Dot(t.directions[0],e))*t.extends.x,n=Math.abs(BABYLON.Vector3.Dot(t.directions[1],e))*t.extends.y,o=Math.abs(BABYLON.Vector3.Dot(t.directions[2],e))*t.extends.z,s=r+n+o;return{min:i-s,max:i+s}},i=function(i,r,n){var o=t(i,r),s=t(i,n);return e(o.min,o.max,s.min,s.max)};BABYLON.BoundingInfo.prototype.isInFrustum=function(e){return this.boundingSphere.isInFrustum(e)?this.boundingBox.isInFrustum(e):!1},BABYLON.BoundingInfo.prototype._checkCollision=function(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},BABYLON.BoundingInfo.prototype.intersectsPoint=function(e){return this.boundingSphere.centerWorld&&this.boundingSphere.intersectsPoint(e)&&this.boundingBox.intersectsPoint(e)?!0:!1},BABYLON.BoundingInfo.prototype.intersects=function(e,t){if(!this.boundingSphere.centerWorld||!e.boundingSphere.centerWorld)return!1;if(!BABYLON.BoundingSphere.intersects(this.boundingSphere,e.boundingSphere))return!1;if(!BABYLON.BoundingBox.intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;var r=this.boundingBox,n=e.boundingBox;return i(r.directions[0],r,n)&&i(r.directions[1],r,n)&&i(r.directions[2],r,n)&&i(n.directions[0],r,n)&&i(n.directions[1],r,n)&&i(n.directions[2],r,n)&&i(BABYLON.Vector3.Cross(r.directions[0],n.directions[0]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[0],n.directions[1]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[0],n.directions[2]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[1],n.directions[0]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[1],n.directions[1]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[1],n.directions[2]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[2],n.directions[0]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[2],n.directions[1]),r,n)&&i(BABYLON.Vector3.Cross(r.directions[2],n.directions[2]),r,n)?!0:!1}}();var BABYLON=BABYLON||{};!function(){BABYLON.Light=function(e,t){BABYLON.Node.call(this,t),this.name=e,this.id=e,t.lights.push(this),this.animations=[],this.excludedMeshes=[]},BABYLON.Light.prototype=Object.create(BABYLON.Node.prototype),BABYLON.Light.prototype.intensity=1,BABYLON.Light.prototype.getScene=function(){return this._scene},BABYLON.Light.prototype.getShadowGenerator=function(){return this._shadowGenerator},BABYLON.Light.prototype.transferToEffect=function(){},BABYLON.Light.prototype.getWorldMatrix=function(){this._currentRenderId=this._scene.getRenderId();var e=this._getWorldMatrix();return this.parent&&this.parent.getWorldMatrix?(this._parentedWorldMatrix||(this._parentedWorldMatrix=BABYLON.Matrix.Identity()),e.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix),this._parentedWorldMatrix):e},BABYLON.Light.prototype.dispose=function(){this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null);var e=this._scene.lights.indexOf(this);this._scene.lights.splice(e,1)}}();var BABYLON=BABYLON||{};!function(){BABYLON.PointLight=function(e,t,i){BABYLON.Light.call(this,e,i),this.position=t,this.diffuse=new BABYLON.Color3(1,1,1),this.specular=new BABYLON.Color3(1,1,1)},BABYLON.PointLight.prototype=Object.create(BABYLON.Light.prototype),BABYLON.PointLight.prototype.transferToEffect=function(e,t){return this.parent&&this.parent.getWorldMatrix?(this._transformedPosition||(this._transformedPosition=BABYLON.Vector3.Zero()),BABYLON.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._transformedPosition),void e.setFloat4(t,this._transformedPosition.x,this._transformedPosition.y,this._transformedPosition.z,0)):void e.setFloat4(t,this.position.x,this.position.y,this.position.z,0)},BABYLON.PointLight.prototype.getShadowGenerator=function(){return null},BABYLON.PointLight.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=BABYLON.Matrix.Identity()),BABYLON.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix}}();var BABYLON=BABYLON||{};!function(){BABYLON.SpotLight=function(e,t,i,r,n,o){BABYLON.Light.call(this,e,o),this.position=t,this.direction=i,this.angle=r,this.exponent=n,this.diffuse=new BABYLON.Color3(1,1,1),this.specular=new BABYLON.Color3(1,1,1)},BABYLON.SpotLight.prototype=Object.create(BABYLON.Light.prototype),BABYLON.SpotLight.prototype.transferToEffect=function(e,t,i){var r;if(this.parent&&this.parent.getWorldMatrix){this._transformedDirection||(this._transformedDirection=BABYLON.Vector3.Zero()),this._transformedPosition||(this._transformedPosition=BABYLON.Vector3.Zero());var n=this.parent.getWorldMatrix();BABYLON.Vector3.TransformCoordinatesToRef(this.position,n,this._transformedPosition),BABYLON.Vector3.TransformNormalToRef(this.direction,n,this._transformedDirection),e.setFloat4(t,this._transformedPosition.x,this._transformedPosition.y,this._transformedPosition.z,this.exponent),r=BABYLON.Vector3.Normalize(this._transformedDirection)}else e.setFloat4(t,this.position.x,this.position.y,this.position.z,this.exponent),r=BABYLON.Vector3.Normalize(this.direction);e.setFloat4(i,r.x,r.y,r.z,Math.cos(.5*this.angle))},BABYLON.SpotLight.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=BABYLON.Matrix.Identity()),BABYLON.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix}}();var BABYLON=BABYLON||{};!function(){BABYLON.HemisphericLight=function(e,t,i){BABYLON.Light.call(this,e,i),this.direction=t,this.diffuse=new BABYLON.Color3(1,1,1),this.specular=new BABYLON.Color3(1,1,1),this.groundColor=new BABYLON.Color3(0,0,0)},BABYLON.HemisphericLight.prototype=Object.create(BABYLON.Light.prototype),BABYLON.HemisphericLight.prototype.getShadowGenerator=function(){return null},BABYLON.HemisphericLight.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=BABYLON.Matrix.Identity()),this._worldMatrix},BABYLON.HemisphericLight.prototype.transferToEffect=function(e,t,i){var r=BABYLON.Vector3.Normalize(this.direction);e.setFloat4(t,r.x,r.y,r.z,0),e.setColor3(i,this.groundColor.scale(this.intensity))}}();var BABYLON=BABYLON||{};!function(){BABYLON.DirectionalLight=function(e,t,i){BABYLON.Light.call(this,e,i),this.position=t.scale(-1),this.direction=t,this.diffuse=new BABYLON.Color3(1,1,1),this.specular=new BABYLON.Color3(1,1,1)},BABYLON.DirectionalLight.prototype=Object.create(BABYLON.Light.prototype),BABYLON.DirectionalLight.prototype._computeTransformedPosition=function(){return this.parent&&this.parent.getWorldMatrix?(this._transformedPosition||(this._transformedPosition=BABYLON.Vector3.Zero()),BABYLON.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._transformedPosition),!0):!1},BABYLON.DirectionalLight.prototype.transferToEffect=function(e,t){return this.parent&&this.parent.getWorldMatrix?(this._transformedDirection||(this._transformedDirection=BABYLON.Vector3.Zero()),BABYLON.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this._transformedDirection),void e.setFloat4(t,this._transformedDirection.x,this._transformedDirection.y,this._transformedDirection.z,1)):void e.setFloat4(t,this.direction.x,this.direction.y,this.direction.z,1)},BABYLON.DirectionalLight.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=BABYLON.Matrix.Identity()),BABYLON.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix}}();var BABYLON=BABYLON||{};!function(){BABYLON.ShadowGenerator=function(e,t){this._light=t,this._scene=t.getScene(),t._shadowGenerator=this,this._shadowMap=new BABYLON.RenderTargetTexture(t.name+"_shadowMap",e,this._scene,!1),this._shadowMap.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE,this._shadowMap.renderParticles=!1,this._darkness=0,this._transparencyShadow=!1;var i=this,r=function(e){var t=e.getMesh(),r=t.getWorldMatrix(),n=i._scene.getEngine();i.isReady(t)&&(n.enableEffect(i._effect),t.skeleton&&t.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)&&t.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)?(i._effect.setMatrix("world",r),i._effect.setMatrix("viewProjection",i.getTransformMatrix()),i._effect.setMatrices("mBones",t.skeleton.getTransformMatrices())):(r.multiplyToRef(i.getTransformMatrix(),i._worldViewProjection),i._effect.setMatrix("worldViewProjection",i._worldViewProjection)),t.bindAndDraw(e,i._effect,!1))};this._shadowMap.customRenderFunction=function(e,t,n){var o;for(o=0;o<e.length;o++)r(e.data[o]);for(o=0;o<t.length;o++)r(t.data[o]);if(i._transparencyShadow)for(o=0;o<n.length;o++)r(n.data[o])},this._viewMatrix=BABYLON.Matrix.Zero(),this._projectionMatrix=BABYLON.Matrix.Zero(),this._transformMatrix=BABYLON.Matrix.Zero(),this._worldViewProjection=BABYLON.Matrix.Zero()},BABYLON.ShadowGenerator.prototype.useVarianceShadowMap=!0,BABYLON.ShadowGenerator.prototype.isReady=function(e){var t=[];this.useVarianceShadowMap&&t.push("#define VSM");var i=[BABYLON.VertexBuffer.PositionKind];e.skeleton&&e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)&&e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)&&(i.push(BABYLON.VertexBuffer.MatricesIndicesKind),i.push(BABYLON.VertexBuffer.MatricesWeightsKind),t.push("#define BONES"),t.push("#define BonesPerMesh "+e.skeleton.bones.length));var r=t.join("\n");return this._cachedDefines!=r&&(this._cachedDefines=r,this._effect=this._scene.getEngine().createEffect("shadowMap",i,["world","mBones","viewProjection","worldViewProjection"],[],r)),this._effect.isReady()},BABYLON.ShadowGenerator.prototype.getShadowMap=function(){return this._shadowMap},BABYLON.ShadowGenerator.prototype.getLight=function(){return this._light},BABYLON.ShadowGenerator.prototype.getTransformMatrix=function(){var e=this._light.position,t=this._light.direction;if(this._light._computeTransformedPosition()&&(e=this._light._transformedPosition),!(this._cachedPosition&&this._cachedDirection&&e.equals(this._cachedPosition)&&t.equals(this._cachedDirection))){this._cachedPosition=e.clone(),this._cachedDirection=t.clone();var i=this._scene.activeCamera;BABYLON.Matrix.LookAtLHToRef(e,this._light.position.add(t),BABYLON.Vector3.Up(),this._viewMatrix),BABYLON.Matrix.PerspectiveFovLHToRef(Math.PI/2,1,i.minZ,i.maxZ,this._projectionMatrix),this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix},BABYLON.ShadowGenerator.prototype.getDarkness=function(){return this._darkness},BABYLON.ShadowGenerator.prototype.setDarkness=function(e){this._darkness=e>=1?1:0>=e?0:e},BABYLON.ShadowGenerator.prototype.setTransparencyShadow=function(e){this._transparencyShadow=e},BABYLON.ShadowGenerator.prototype.dispose=function(){this._shadowMap.dispose()}}();var BABYLON=BABYLON||{};!function(){BABYLON.Collider=function(){this.radius=new BABYLON.Vector3(1,1,1),this.retry=0,this.basePointWorld=BABYLON.Vector3.Zero(),this.velocityWorld=BABYLON.Vector3.Zero(),this.normalizedVelocity=BABYLON.Vector3.Zero(),this._collisionPoint=BABYLON.Vector3.Zero(),this._planeIntersectionPoint=BABYLON.Vector3.Zero(),this._tempVector=BABYLON.Vector3.Zero(),this._tempVector2=BABYLON.Vector3.Zero(),this._tempVector3=BABYLON.Vector3.Zero(),this._tempVector4=BABYLON.Vector3.Zero(),this._edge=BABYLON.Vector3.Zero(),this._baseToVertex=BABYLON.Vector3.Zero(),this._destinationPoint=BABYLON.Vector3.Zero(),this._slidePlaneNormal=BABYLON.Vector3.Zero(),this._displacementVector=BABYLON.Vector3.Zero()},BABYLON.Collider.prototype._initialize=function(e,t,i){this.velocity=t,BABYLON.Vector3.NormalizeToRef(t,this.normalizedVelocity),this.basePoint=e,e.multiplyToRef(this.radius,this.basePointWorld),t.multiplyToRef(this.radius,this.velocityWorld),this.velocityWorldLength=this.velocityWorld.length(),this.epsilon=i,this.collisionFound=!1},BABYLON.Collider.prototype._checkPointInTriangle=function(e,t,i,r,n){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),BABYLON.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var o=BABYLON.Vector3.Dot(this._tempVector4,n);return 0>o?!1:(r.subtractToRef(e,this._tempVector3),BABYLON.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),o=BABYLON.Vector3.Dot(this._tempVector4,n),0>o?!1:(BABYLON.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),o=BABYLON.Vector3.Dot(this._tempVector4,n),o>=0))};var e=function(e,t,i,r){return e.x>i.x+r?!1:i.x-r>t.x?!1:e.y>i.y+r?!1:i.y-r>t.y?!1:e.z>i.z+r?!1:i.z-r>t.z?!1:!0},t=function(e,t,i,r){var n=t*t-4*e*i,o={root:0,found:!1};if(0>n)return o;var s=Math.sqrt(n),a=(-t-s)/(2*e),h=(-t+s)/(2*e);if(a>h){var c=h;h=a,a=c}return a>0&&r>a?(o.root=a,o.found=!0,o):h>0&&r>h?(o.root=h,o.found=!0,o):o};BABYLON.Collider.prototype._canDoCollision=function(t,i,r,n){var o=BABYLON.Vector3.Distance(this.basePointWorld,t),s=Math.max(this.radius.x,this.radius.y);return s=Math.max(s,this.radius.z),o>this.velocityWorldLength+s+i?!1:e(r,n,this.basePointWorld,this.velocityWorldLength+s)?!0:!1},BABYLON.Collider.prototype._testTriangle=function(e,i,r,n,o){var s,a=!1;i._trianglePlanes||(i._trianglePlanes=[]);var h=i._trianglePlanes[e];if(h&&i._meshPosition.equals(h._meshPosition)||(i._trianglePlanes[e]=new BABYLON.Plane(0,0,0,0),i._trianglePlanes[e].copyFromPoints(r,n,o),i._trianglePlanes[e]._meshPosition=i._meshPosition.clone(),h=i._trianglePlanes[e]),i.getMaterial()||h.isFrontFacingTo(this.normalizedVelocity,0)){var c=h.signedDistanceTo(this.basePoint),l=BABYLON.Vector3.Dot(h.normal,this.velocity);if(0==l){if(Math.abs(c)>=1)return;a=!0,s=0}else{s=(-1-c)/l;var u=(1-c)/l;if(s>u){var f=u;u=s,s=f}if(s>1||0>u)return;0>s&&(s=0),s>1&&(s=1)}this._collisionPoint.copyFromFloats(0,0,0);var B=!1,p=1;if(a||(this.basePoint.subtractToRef(h.normal,this._planeIntersectionPoint),this.velocity.scaleToRef(s,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,r,n,o,h.normal)&&(B=!0,p=s,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!B){var d=this.velocity.lengthSquared(),m=d;this.basePoint.subtractToRef(r,this._tempVector);var A=2*BABYLON.Vector3.Dot(this.velocity,this._tempVector),_=this._tempVector.lengthSquared-1,v=t(m,A,_,p);v.found&&(p=v.root,B=!0,this._collisionPoint.copyFrom(r)),this.basePoint.subtractToRef(n,this._tempVector),A=2*BABYLON.Vector3.Dot(this.velocity,this._tempVector),_=this._tempVector.lengthSquared-1,v=t(m,A,_,p),v.found&&(p=v.root,B=!0,this._collisionPoint.copyFrom(n)),this.basePoint.subtractToRef(o,this._tempVector),A=2*BABYLON.Vector3.Dot(this.velocity,this._tempVector),_=this._tempVector.lengthSquared-1,v=t(m,A,_,p),v.found&&(p=v.root,B=!0,this._collisionPoint.copyFrom(o)),n.subtractToRef(r,this._edge),r.subtractToRef(this.basePoint,this._baseToVertex);var g=this._edge.lengthSquared(),L=BABYLON.Vector3.Dot(this._edge,this.velocity),O=BABYLON.Vector3.Dot(this._edge,this._baseToVertex);if(m=g*-d+L*L,A=2*g*BABYLON.Vector3.Dot(this.velocity,this._baseToVertex)-2*L*O,_=g*(1-this._baseToVertex.lengthSquared())+O*O,v=t(m,A,_,p),v.found){var N=(L*v.root-O)/g;N>=0&&1>=N&&(p=v.root,B=!0,this._edge.scaleInPlace(N),r.addToRef(this._edge,this._collisionPoint))}if(o.subtractToRef(n,this._edge),n.subtractToRef(this.basePoint,this._baseToVertex),g=this._edge.lengthSquared(),L=BABYLON.Vector3.Dot(this._edge,this.velocity),O=BABYLON.Vector3.Dot(this._edge,this._baseToVertex),m=g*-d+L*L,A=2*g*BABYLON.Vector3.Dot(this.velocity,this._baseToVertex)-2*L*O,_=g*(1-this._baseToVertex.lengthSquared())+O*O,v=t(m,A,_,p),v.found){var N=(L*v.root-O)/g;N>=0&&1>=N&&(p=v.root,B=!0,this._edge.scaleInPlace(N),n.addToRef(this._edge,this._collisionPoint))}if(r.subtractToRef(o,this._edge),o.subtractToRef(this.basePoint,this._baseToVertex),g=this._edge.lengthSquared(),L=BABYLON.Vector3.Dot(this._edge,this.velocity),O=BABYLON.Vector3.Dot(this._edge,this._baseToVertex),m=g*-d+L*L,A=2*g*BABYLON.Vector3.Dot(this.velocity,this._baseToVertex)-2*L*O,_=g*(1-this._baseToVertex.lengthSquared())+O*O,v=t(m,A,_,p),v.found){var N=(L*v.root-O)/g;N>=0&&1>=N&&(p=v.root,B=!0,this._edge.scaleInPlace(N),o.addToRef(this._edge,this._collisionPoint))}}if(B){var y=p*this.velocity.length();(!this.collisionFound||y<this.nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this.nearestDistance=y,this.collisionFound=!0,this.collidedMesh=i.getMesh())}}},BABYLON.Collider.prototype._collide=function(e,t,i,r,n,o){for(var s=r;n>s;s+=3){var a=t[i[s]-o],h=t[i[s+1]-o],c=t[i[s+2]-o];this._testTriangle(s,e,c,h,a)}},BABYLON.Collider.prototype._getResponse=function(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this.nearestDistance/t.length()),this.basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(BABYLON.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}();var BABYLON=BABYLON||{};!function(){BABYLON.InputControllerTarget=function(){this._position=new BABYLON.Vector3(0,0,0),this._orientation={yaw:0,pitch:0,roll:0}},BABYLON.InputControllerTarget.prototype.getPosition=function(){return this._position},BABYLON.InputControllerTarget.prototype.getOrientation=function(){return this._orientation},BABYLON.InputControllerTarget.prototype.moveRelative=function(){},BABYLON.InputControllerTarget.prototype.rotateRelative=function(){},BABYLON.InputControllerTarget.prototype.getOrientationMatrix=function(){return new BABYLON.Matrix},BABYLON.InputControllerTarget.prototype.getInvertOrientationMatrix=function(){return new BABYLON.Matrix},BABYLON.InputControllerMultiTarget=function(e){this.targets=e;
var t=this.targets[0];t.controllers?t.controllers.push(this):t.controllers=[this]},BABYLON.InputControllerMultiTarget.prototype.getPosition=function(){return this.targets[0].getPosition()},BABYLON.InputControllerMultiTarget.prototype.getOrientation=function(){return this.targets[0].getOrientation()},BABYLON.InputControllerMultiTarget.prototype.getOrientationMatrix=function(){return this.targets[0].getOrientationMatrix()},BABYLON.InputControllerMultiTarget.prototype.getInvertOrientationMatrix=function(){return this.targets[0].getInvertOrientationMatrix()},BABYLON.InputControllerMultiTarget.prototype.moveRelative=function(e){for(var t=0;t<this.targets.length;++t)this.targets[t].moveRelative(e)},BABYLON.InputControllerMultiTarget.prototype.rotateRelative=function(e){for(var t=0;t<this.targets.length;++t)this.targets[t].rotateRelative(e)},BABYLON.InputControllerMultiTarget.prototype.update=function(){if(this.controllers)for(var e=0;e<this.controllers.length;++e)this.controllers[e].update()},BABYLON.InputController=function(e,t){this.scene=e,this.target=t,this.target.controllers?this.target.controllers.push(this):this.target.controllers=[this]},BABYLON.InputController.prototype.attachToCanvas=function(){},BABYLON.InputController.prototype.detachFromCanvas=function(){},BABYLON.InputController.prototype.update=function(){},BABYLON.InputController.prototype.dispose=function(){},BABYLON.inputFilter=function(e,t){BABYLON.InputController.call(this,e,t)},BABYLON.inputFilter.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.inputFilter.prototype.update=function(){if(this.controllers)for(var e=0;e<this.controllers.length;++e)this.controllers[e].update()},BABYLON.inputFilter.prototype.getPosition=function(){return this.target.getPosition()},BABYLON.inputFilter.prototype.getOrientation=function(){return this.target.getOrientation()},BABYLON.inputFilter.prototype.getOrientationMatrix=function(){return this.target.getOrientationMatrix()},BABYLON.inputFilter.prototype.getInvertOrientationMatrix=function(){return this.target.getInvertOrientationMatrix()},BABYLON.inputFilter.prototype.moveRelative=function(e){this.target.moveRelative(e)},BABYLON.inputFilter.prototype.rotateRelative=function(e){this.target.rotateRelative(e)}}();var BABYLON=BABYLON||{};!function(){BABYLON.Camera=function(e,t,i){BABYLON.Node.call(this,i),this.name=e,this.id=e,this.position=t.clone(),this.upVector=BABYLON.Vector3.Up(),i.cameras.push(this),i.activeCamera||(i.activeCamera=this),this._computedViewMatrix=BABYLON.Matrix.Identity(),this._projectionMatrix=new BABYLON.Matrix,this.subCameras=[],this.animations=[],this._postProcesses=[],this._postProcessesTakenIndices=[],this.viewport=new BABYLON.Viewport(0,0,1,1),BABYLON.Camera.prototype._initCache.call(this)},BABYLON.Camera.prototype=Object.create(BABYLON.Node.prototype),BABYLON.Camera.PERSPECTIVE_CAMERA=0,BABYLON.Camera.ORTHOGRAPHIC_CAMERA=1,BABYLON.Camera.prototype.orthoLeft=null,BABYLON.Camera.prototype.orthoRight=null,BABYLON.Camera.prototype.orthoBottom=null,BABYLON.Camera.prototype.orthoTop=null,BABYLON.Camera.prototype.fov=.8,BABYLON.Camera.prototype.minZ=.1,BABYLON.Camera.prototype.maxZ=1e3,BABYLON.Camera.prototype.inertia=.9,BABYLON.Camera.prototype.mode=BABYLON.Camera.PERSPECTIVE_CAMERA,BABYLON.Camera.prototype.isIntermediate=!1,BABYLON.Camera.prototype.getScene=function(){return this._scene},BABYLON.Camera.prototype._initCache=function(){this._cache.position=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},BABYLON.Camera.prototype._updateCache=function(e){e||BABYLON.Node.prototype._updateCache.call(this);var t=this._scene.getEngine();this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector),this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._cache.fov=this.fov,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()},BABYLON.Camera.prototype._updateFromScene=function(){this.updateCache(),this._update()},BABYLON.Camera.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},BABYLON.Camera.prototype._isSynchronizedViewMatrix=function(){return BABYLON.Node.prototype._isSynchronized.call(this)?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1},BABYLON.Camera.prototype._isSynchronizedProjectionMatrix=function(){var e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;var t=this._scene.getEngine();return e=this.mode===BABYLON.Camera.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.aspectRatio===t.getAspectRatio(this):this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight()},BABYLON.Camera.prototype.attachControl=function(){},BABYLON.Camera.prototype.detachControl=function(){},BABYLON.Camera.prototype._update=function(){},BABYLON.Camera.prototype.attachPostProcess=function(e,t){if(!e._reusable&&this._postProcesses.indexOf(e)>-1)return void console.error("You're trying to reuse a post process not defined as reusable.");if(null==t||0>t)return this._postProcesses.push(e),this._postProcessesTakenIndices.push(this._postProcesses.length-1),this._postProcesses.length-1;var i=0;if(this._postProcesses[t]){for(var r=this._postProcesses.length-1,n=r;n>=t+1;--n)this._postProcesses[n+1]=this._postProcesses[n];i=1}for(var n=0;n<this._postProcessesTakenIndices.length;++n)if(!(this._postProcessesTakenIndices[n]<t)){for(var r=this._postProcessesTakenIndices.length-1,o=r;o>=n;--o)this._postProcessesTakenIndices[o+1]=this._postProcessesTakenIndices[o]+i;this._postProcessesTakenIndices[n]=t;break}i||-1!=this._postProcessesTakenIndices.indexOf(t)||this._postProcessesTakenIndices.push(t);var s=t+i;return this._postProcesses[s]=e,s},BABYLON.Camera.prototype.detachPostProcess=function(e,t){var i=[];if(t){t=t instanceof Array?t:[t];for(var r=0;r<t.length;r++){var n=this._postProcesses[t[r]];if(n===e){delete this._postProcesses[t[r]];var o=this._postProcessesTakenIndices.indexOf(t[r]);this._postProcessesTakenIndices.splice(o,1)}else i.push(r)}}else for(var s=this._postProcesses.length,r=0;s>r;r++)if(this._postProcesses[r]===e){delete this._postProcesses[r];var o=this._postProcessesTakenIndices.indexOf(r);this._postProcessesTakenIndices.splice(o,1)}return i},BABYLON.Camera.prototype.getWorldMatrix=function(){this._worldMatrix||(this._worldMatrix=BABYLON.Matrix.Identity());var e=this.getViewMatrix();return e.invertToRef(this._worldMatrix),this._worldMatrix},BABYLON.Camera.prototype._getViewMatrix=function(){return BABYLON.Matrix.Identity()},BABYLON.Camera.prototype.getViewMatrix=function(){return this._computedViewMatrix=this._computeViewMatrix(),this.parent&&this.parent.getWorldMatrix&&!this.isSynchronized()?(this._worldMatrix||(this._worldMatrix=BABYLON.Matrix.Identity()),this._computedViewMatrix.invertToRef(this._worldMatrix),this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._computedViewMatrix),this._computedViewMatrix.invert(),this._computedViewMatrix):this._computedViewMatrix},BABYLON.Camera.prototype._computeViewMatrix=function(e){return!e&&this._isSynchronizedViewMatrix()?(this._currentRenderId=this._scene.getRenderId(),this._computedViewMatrix):(this._computedViewMatrix=this._getViewMatrix(),this._computedViewMatrix)},BABYLON.Camera.prototype.getProjectionMatrix=function(e){if(!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;var t=this._scene.getEngine();if(this.mode===BABYLON.Camera.PERSPECTIVE_CAMERA)return BABYLON.Matrix.PerspectiveFovLHToRef(this.fov,t.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix;var i=t.getRenderWidth()/2,r=t.getRenderHeight()/2;return BABYLON.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-i,this.orthoRight||i,this.orthoBottom||-r,this.orthoTop||r,this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix},BABYLON.Camera.prototype.dispose=function(){var e=this._scene.cameras.indexOf(this);this._scene.cameras.splice(e,1);for(var t=0;t<this._postProcessesTakenIndices.length;++t)this._postProcesses[this._postProcessesTakenIndices[t]].dispose(this)}}();var BABYLON=BABYLON||{};!function(){BABYLON.FreeCamera=function(e,t,i){BABYLON.Camera.call(this,e,t,i),this.cameraDirection=new BABYLON.Vector3(0,0,0),this.cameraRotation=new BABYLON.Vector2(0,0),this.rotation=new BABYLON.Vector3(0,0,0),this.ellipsoid=new BABYLON.Vector3(.5,1,.5),this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this._collider=new BABYLON.Collider,this._needMoveForGravity=!0,this._currentTarget=BABYLON.Vector3.Zero(),this._viewMatrix=BABYLON.Matrix.Zero(),this._camMatrix=BABYLON.Matrix.Zero(),this._cameraTransformMatrix=BABYLON.Matrix.Zero(),this._cameraRotationMatrix=BABYLON.Matrix.Zero(),this._referencePoint=BABYLON.Vector3.Zero(),this._transformedReferencePoint=BABYLON.Vector3.Zero(),this._oldPosition=BABYLON.Vector3.Zero(),this._diffPosition=BABYLON.Vector3.Zero(),this._newPosition=BABYLON.Vector3.Zero(),this._lookAtTemp=BABYLON.Matrix.Zero(),this._tempMatrix=BABYLON.Matrix.Zero(),BABYLON.FreeCamera.prototype._initCache.call(this)},BABYLON.FreeCamera.prototype=Object.create(BABYLON.Camera.prototype),BABYLON.FreeCamera.prototype.speed=2,BABYLON.FreeCamera.prototype.checkCollisions=!1,BABYLON.FreeCamera.prototype.applyGravity=!1,BABYLON.FreeCamera.prototype.noRotationConstraint=!1,BABYLON.FreeCamera.prototype.angularSensibility=2e3,BABYLON.FreeCamera.prototype.lockedTarget=null,BABYLON.FreeCamera.prototype.onCollide=null,BABYLON.FreeCamera.prototype._getLockedTargetPosition=function(){return this.lockedTarget?this.lockedTarget.position||this.lockedTarget:null},BABYLON.FreeCamera.prototype._initCache=function(){this._cache.lockedTarget=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},BABYLON.FreeCamera.prototype._updateCache=function(e){e||BABYLON.Camera.prototype._updateCache.call(this);var t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation)},BABYLON.FreeCamera.prototype._isSynchronizedViewMatrix=function(){if(!BABYLON.Camera.prototype._isSynchronizedViewMatrix.call(this))return!1;var e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&this._cache.rotation.equals(this.rotation)},BABYLON.FreeCamera.prototype._computeLocalCameraSpeed=function(){return this.speed*(BABYLON.Tools.GetDeltaTime()/(10*BABYLON.Tools.GetFps()))},BABYLON.FreeCamera.prototype.setTarget=function(e){this.upVector.normalize(),BABYLON.Matrix.LookAtLHToRef(this.position,e,this.upVector,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var t=e.subtract(this.position);this.rotation.y=t.x>=0?-Math.atan(t.z/t.x)+Math.PI/2:-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=-Math.acos(BABYLON.Vector3.Dot(new BABYLON.Vector3(0,1,0),this.upVector)),isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0)},BABYLON.FreeCamera.prototype.getTarget=function(){return this._currentTarget},BABYLON.FreeCamera.prototype.attachControl=function(e,t){var i,r=this,n=this._scene.getEngine();this._attachedCanvas||(this._attachedCanvas=e,void 0===this._onMouseDown&&(this._onMouseDown=function(e){i={x:e.clientX,y:e.clientY},t||e.preventDefault()},this._onMouseUp=function(e){i=null,t||e.preventDefault()},this._onMouseOut=function(e){i=null,r._keys=[],t||e.preventDefault()},this._onMouseMove=function(e){if(i||n.isPointerLock){var o,s;n.isPointerLock?(o=e.movementX||e.mozMovementX||e.webkitMovementX||e.msMovementX||0,s=e.movementY||e.mozMovementY||e.webkitMovementY||e.msMovementY||0):(o=e.clientX-i.x,s=e.clientY-i.y),r.cameraRotation.y+=o/r.angularSensibility,r.cameraRotation.x+=s/r.angularSensibility,i={x:e.clientX,y:e.clientY},t||e.preventDefault()}},this._onKeyDown=function(e){if(-1!==r.keysUp.indexOf(e.keyCode)||-1!==r.keysDown.indexOf(e.keyCode)||-1!==r.keysLeft.indexOf(e.keyCode)||-1!==r.keysRight.indexOf(e.keyCode)){var i=r._keys.indexOf(e.keyCode);-1===i&&r._keys.push(e.keyCode),t||e.preventDefault()}},this._onKeyUp=function(e){if(-1!==r.keysUp.indexOf(e.keyCode)||-1!==r.keysDown.indexOf(e.keyCode)||-1!==r.keysLeft.indexOf(e.keyCode)||-1!==r.keysRight.indexOf(e.keyCode)){var i=r._keys.indexOf(e.keyCode);i>=0&&r._keys.splice(i,1),t||e.preventDefault()}},this._onLostFocus=function(){r._keys=[]},this._reset=function(){r._keys=[],i=null,r.cameraDirection=new BABYLON.Vector3(0,0,0),r.cameraRotation=new BABYLON.Vector2(0,0)}),e.addEventListener("mousedown",this._onMouseDown,!1),e.addEventListener("mouseup",this._onMouseUp,!1),e.addEventListener("mouseout",this._onMouseOut,!1),e.addEventListener("mousemove",this._onMouseMove,!1),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1),window.addEventListener("blur",this._onLostFocus,!1))},BABYLON.FreeCamera.prototype.detachControl=function(e){this._attachedCanvas==e&&(e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp),e.removeEventListener("mouseout",this._onMouseOut),e.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),window.removeEventListener("blur",this._onLostFocus),this._attachedCanvas=null,this._reset&&this._reset())},BABYLON.FreeCamera.prototype._collideWithWorld=function(e){this.position.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._collider.radius=this.ellipsoid,this._scene._getNewPosition(this._oldPosition,e,this._collider,3,this._newPosition),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>BABYLON.Engine.collisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&this.onCollide(this._collider.collidedMesh))},BABYLON.FreeCamera.prototype._checkInputs=function(){this._localDirection||(this._localDirection=BABYLON.Vector3.Zero(),this._transformedDirection=BABYLON.Vector3.Zero());for(var e=0;e<this._keys.length;e++){var t=this._keys[e],i=this._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(t)?this._localDirection.copyFromFloats(-i,0,0):-1!==this.keysUp.indexOf(t)?this._localDirection.copyFromFloats(0,0,i):-1!==this.keysRight.indexOf(t)?this._localDirection.copyFromFloats(i,0,0):-1!==this.keysDown.indexOf(t)&&this._localDirection.copyFromFloats(0,0,-i),this.getViewMatrix().invertToRef(this._cameraTransformMatrix),BABYLON.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection),this.cameraDirection.addInPlace(this._transformedDirection)}},BABYLON.FreeCamera.prototype._update=function(){this._checkInputs();var e=this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0,t=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(e)if(this.checkCollisions&&this._scene.collisionsEnabled){if(this._collideWithWorld(this.cameraDirection),this.applyGravity){var i=this.position;this._collideWithWorld(this._scene.gravity),this._needMoveForGravity=0!=BABYLON.Vector3.DistanceSquared(i,this.position)}}else this.position.addInPlace(this.cameraDirection);if(t&&(this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,!this.noRotationConstraint)){var r=Math.PI/2*.95;this.rotation.x>r&&(this.rotation.x=r),this.rotation.x<-r&&(this.rotation.x=-r)}e&&(Math.abs(this.cameraDirection.x)<BABYLON.Engine.epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<BABYLON.Engine.epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<BABYLON.Engine.epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),t&&(Math.abs(this.cameraRotation.x)<BABYLON.Engine.epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<BABYLON.Engine.epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia))},BABYLON.FreeCamera.prototype._getViewMatrix=function(){return BABYLON.Vector3.FromFloatsToRef(0,0,1,this._referencePoint),this.lockedTarget?this._currentTarget.copyFrom(this._getLockedTargetPosition()):(0!=this.upVector.x||1!=this.upVector.y||0!=this.upVector.z?(BABYLON.Matrix.LookAtLHToRef(BABYLON.Vector3.Zero(),this._referencePoint,this.upVector,this._lookAtTemp),BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),this._lookAtTemp.multiplyToRef(this._cameraRotationMatrix,this._tempMatrix),this._lookAtTemp.invert(),this._tempMatrix.multiplyToRef(this._lookAtTemp,this._cameraRotationMatrix)):BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),BABYLON.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget)),BABYLON.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix),this._viewMatrix}}();var BABYLON=BABYLON||{};!function(){BABYLON.TouchCamera=function(e,t,i){BABYLON.FreeCamera.call(this,e,t,i),this._offsetX=null,this._offsetY=null,this._pointerCount=0,this._pointerPressed=[]},BABYLON.TouchCamera.prototype=Object.create(BABYLON.FreeCamera.prototype),BABYLON.TouchCamera.prototype.angularSensibility=2e5,BABYLON.TouchCamera.prototype.moveSensibility=500,BABYLON.TouchCamera.prototype.attachControl=function(e,t){var i,r=this;this._attachedCanvas||(this._attachedCanvas=e,void 0===this._onPointerDown&&(this._onPointerDown=function(e){t||e.preventDefault(),r._pointerPressed.push(e.pointerId),1===r._pointerPressed.length&&(i={x:e.clientX,y:e.clientY})},this._onPointerUp=function(e){t||e.preventDefault();var n=r._pointerPressed.indexOf(e.pointerId);-1!==n&&(r._pointerPressed.splice(n,1),0==n&&(i=null,r._offsetX=null,r._offsetY=null))},this._onPointerMove=function(e){if(t||e.preventDefault(),i){var n=r._pointerPressed.indexOf(e.pointerId);0==n&&(r._offsetX=e.clientX-i.x,r._offsetY=-(e.clientY-i.y))}},this._onLostFocus=function(){r._offsetX=null,r._offsetY=null}),e.addEventListener("pointerdown",this._onPointerDown),e.addEventListener("pointerup",this._onPointerUp),e.addEventListener("pointerout",this._onPointerUp),e.addEventListener("pointermove",this._onPointerMove),window.addEventListener("blur",this._onLostFocus))},BABYLON.TouchCamera.prototype.detachControl=function(e){this._attachedCanvas==e&&(e.removeEventListener("pointerdown",this._onPointerDown),e.removeEventListener("pointerup",this._onPointerUp),e.removeEventListener("pointerout",this._onPointerUp),e.removeEventListener("pointermove",this._onPointerMove),window.removeEventListener("blur",this._onLostFocus),this._attachedCanvas=null)},BABYLON.TouchCamera.prototype._checkInputs=function(){if(this._offsetX)if(this.cameraRotation.y+=this._offsetX/this.angularSensibility,this._pointerPressed.length>1)this.cameraRotation.x+=-this._offsetY/this.angularSensibility;else{var e=this._computeLocalCameraSpeed(),t=new BABYLON.Vector3(0,0,e*this._offsetY/this.moveSensibility);BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,0,this._cameraRotationMatrix),this.cameraDirection.addInPlace(BABYLON.Vector3.TransformCoordinates(t,this._cameraRotationMatrix))}}}();var BABYLON=BABYLON||{};!function(){var e=BABYLON.Tools.GetPointerPrefix();BABYLON.ArcRotateCamera=function(e,t,i,r,n,o){BABYLON.Camera.call(this,e,BABYLON.Vector3.Zero(),o),this.alpha=t,this.beta=i,this.radius=r,this.target=n,this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this._viewMatrix=new BABYLON.Matrix,BABYLON.ArcRotateCamera.prototype._initCache.call(this),this.getViewMatrix()},BABYLON.ArcRotateCamera.prototype=Object.create(BABYLON.Camera.prototype),BABYLON.ArcRotateCamera.prototype.inertialAlphaOffset=0,BABYLON.ArcRotateCamera.prototype.inertialBetaOffset=0,BABYLON.ArcRotateCamera.prototype.inertialRadiusOffset=0,BABYLON.ArcRotateCamera.prototype.lowerAlphaLimit=null,BABYLON.ArcRotateCamera.prototype.upperAlphaLimit=null,BABYLON.ArcRotateCamera.prototype.lowerBetaLimit=.01,BABYLON.ArcRotateCamera.prototype.upperBetaLimit=Math.PI,BABYLON.ArcRotateCamera.prototype.lowerRadiusLimit=null,BABYLON.ArcRotateCamera.prototype.upperRadiusLimit=null,BABYLON.ArcRotateCamera.prototype.angularSensibility=1e3,BABYLON.ArcRotateCamera.prototype.wheelPrecision=3,BABYLON.ArcRotateCamera.prototype._getTargetPosition=function(){return this.target.position||this.target},BABYLON.ArcRotateCamera.prototype._initCache=function(){this._cache.target=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0},BABYLON.ArcRotateCamera.prototype._updateCache=function(e){e||BABYLON.Camera.prototype._updateCache.call(this),this._cache.target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius},BABYLON.ArcRotateCamera.prototype._isSynchronizedViewMatrix=function(){return BABYLON.Camera.prototype._isSynchronizedViewMatrix.call(this)?this._cache.target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius:!1},BABYLON.ArcRotateCamera.prototype.attachControl=function(t,i){var r,n,o=this;if(!this._attachedCanvas){this._attachedCanvas=t;var s=this._scene.getEngine();void 0===this._onPointerDown&&(this._onPointerDown=function(e){n||(n=e.pointerId,r={x:e.clientX,y:e.clientY},i||e.preventDefault())},this._onPointerUp=function(e){r=null,n=null,i||e.preventDefault()},this._onPointerMove=function(e){if(r&&n===e.pointerId){var t=e.clientX-r.x,s=e.clientY-r.y;o.inertialAlphaOffset-=t/o.angularSensibility,o.inertialBetaOffset-=s/o.angularSensibility,r={x:e.clientX,y:e.clientY},i||e.preventDefault()}},this._onMouseMove=function(e){if(s.isPointerLock){var t=e.movementX||e.mozMovementX||e.webkitMovementX||e.msMovementX||0,r=e.movementY||e.mozMovementY||e.webkitMovementY||e.msMovementY||0;o.inertialAlphaOffset-=t/o.angularSensibility,o.inertialBetaOffset-=r/o.angularSensibility,i||e.preventDefault()}},this._wheel=function(e){var t=0;e.wheelDelta?t=e.wheelDelta/(40*o.wheelPrecision):e.detail&&(t=-e.detail/o.wheelPrecision),t&&(o.inertialRadiusOffset+=t),e.preventDefault&&(i||e.preventDefault())},this._onKeyDown=function(e){if(-1!==o.keysUp.indexOf(e.keyCode)||-1!==o.keysDown.indexOf(e.keyCode)||-1!==o.keysLeft.indexOf(e.keyCode)||-1!==o.keysRight.indexOf(e.keyCode)){var t=o._keys.indexOf(e.keyCode);-1===t&&o._keys.push(e.keyCode),e.preventDefault&&(i||e.preventDefault())}},this._onKeyUp=function(e){if(-1!==o.keysUp.indexOf(e.keyCode)||-1!==o.keysDown.indexOf(e.keyCode)||-1!==o.keysLeft.indexOf(e.keyCode)||-1!==o.keysRight.indexOf(e.keyCode)){var t=o._keys.indexOf(e.keyCode);t>=0&&o._keys.splice(t,1),e.preventDefault&&(i||e.preventDefault())}},this._onLostFocus=function(){o._keys=[],n=null},this._onGestureStart=function(e){void 0!==window.MSGesture&&(o._MSGestureHandler||(o._MSGestureHandler=new MSGesture,o._MSGestureHandler.target=t),o._MSGestureHandler.addPointer(e.pointerId))},this._onGesture=function(e){o.radius*=e.scale,e.preventDefault&&(i||(e.stopPropagation(),e.preventDefault()))},this._reset=function(){o._keys=[],o.inertialAlphaOffset=0,o.inertialBetaOffset=0,r=null,n=null}),t.addEventListener(e+"down",this._onPointerDown,!1),t.addEventListener(e+"up",this._onPointerUp,!1),t.addEventListener(e+"out",this._onPointerUp,!1),t.addEventListener(e+"move",this._onPointerMove,!1),t.addEventListener("mousemove",this._onMouseMove,!1),t.addEventListener("MSPointerDown",this._onGestureStart,!1),t.addEventListener("MSGestureChange",this._onGesture,!1),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1),window.addEventListener("mousewheel",this._wheel,!1),window.addEventListener("DOMMouseScroll",this._wheel,!1),window.addEventListener("blur",this._onLostFocus,!1)}},BABYLON.ArcRotateCamera.prototype.detachControl=function(t){this._attachedCanvas==t&&(t.removeEventListener(e+"down",this._onPointerDown),t.removeEventListener(e+"up",this._onPointerUp),t.removeEventListener(e+"out",this._onPointerUp),t.removeEventListener(e+"move",this._onPointerMove),t.removeEventListener("mousemove",this._onMouseMove),t.removeEventListener("MSPointerDown",this._onGestureStart),t.removeEventListener("MSGestureChange",this._onGesture),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),window.removeEventListener("mousewheel",this._wheel),window.removeEventListener("DOMMouseScroll",this._wheel),window.removeEventListener("blur",this._onLostFocus),this._MSGestureHandler=null,this._attachedCanvas=null,this._reset&&this._reset())},BABYLON.ArcRotateCamera.prototype._update=function(){for(var e=0;e<this._keys.length;e++){var t=this._keys[e];-1!==this.keysLeft.indexOf(t)?this.inertialAlphaOffset-=.01:-1!==this.keysUp.indexOf(t)?this.inertialBetaOffset-=.01:-1!==this.keysRight.indexOf(t)?this.inertialAlphaOffset+=.01:-1!==this.keysDown.indexOf(t)&&(this.inertialBetaOffset+=.01)}(0!=this.inertialAlphaOffset||0!=this.inertialBetaOffset||0!=this.inertialRadiusOffset)&&(this.alpha+=this.inertialAlphaOffset,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<BABYLON.Engine.epsilon&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<BABYLON.Engine.epsilon&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<BABYLON.Engine.epsilon&&(this.inertialRadiusOffset=0)),this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerBetaLimit&&this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit&&this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit)},BABYLON.ArcRotateCamera.prototype.setPosition=function(e){var t=e.subtract(this._getTargetPosition());this.radius=t.length(),this.alpha=Math.atan(t.z/t.x),this.beta=Math.acos(t.y/this.radius)},BABYLON.ArcRotateCamera.prototype._getViewMatrix=function(){var e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta),r=Math.sin(this.beta),n=this._getTargetPosition();return n.addToRef(new BABYLON.Vector3(this.radius*e*r,this.radius*i,this.radius*t*r),this.position),BABYLON.Matrix.LookAtLHToRef(this.position,n,this.upVector,this._viewMatrix),this._viewMatrix},BABYLON.ArcRotateCamera.ZOOM_ON_FACTOR=1,BABYLON.ArcRotateCamera.prototype.zoomOn=function(e){e=e||this._scene.meshes;var t=BABYLON.Mesh.MinMax(e),i=BABYLON.Vector3.Distance(t.min,t.max);this.radius=i*BABYLON.ArcRotateCamera.ZOOM_ON_FACTOR,this.focusOn({min:t.min,max:t.max,distance:i})},BABYLON.ArcRotateCamera.prototype.focusOn=function(e){var t,i;void 0===e.min?(t=e||this._scene.meshes,t=BABYLON.Mesh.MinMax(t),i=BABYLON.Vector3.Distance(t.min,t.max)):(t=e,i=e.distance),this.target=BABYLON.Mesh.Center(t),this.maxZ=2*i}}();var BABYLON=BABYLON||{};!function(){BABYLON.DeviceOrientationCamera=function(e,t,i){BABYLON.FreeCamera.call(this,e,t,i),this._offsetX=null,this._offsetY=null,this._orientationGamma=0,this._orientationBeta=0,this._initialOrientationGamma=0,this._initialOrientationBeta=0},BABYLON.DeviceOrientationCamera.prototype=Object.create(BABYLON.FreeCamera.prototype),BABYLON.DeviceOrientationCamera.prototype.angularSensibility=1e4,BABYLON.DeviceOrientationCamera.prototype.moveSensibility=50,BABYLON.DeviceOrientationCamera.prototype.attachControl=function(e){if(!this._attachedCanvas){this._attachedCanvas=e;var t=this;this._orientationChanged||(this._orientationChanged=function(e){t._initialOrientationGamma||(t._initialOrientationGamma=e.gamma,t._initialOrientationBeta=e.beta),t._orientationGamma=e.gamma,t._orientationBeta=e.beta,t._offsetY=t._initialOrientationBeta-t._orientationBeta,t._offsetX=t._initialOrientationGamma-t._orientationGamma}),window.addEventListener("deviceorientation",this._orientationChanged)}},BABYLON.DeviceOrientationCamera.prototype.detachControl=function(e){this._attachedCanvas==e&&(window.removeEventListener("deviceorientation",this._orientationChanged),this._attachedCanvas=null,this._orientationGamma=0,this._orientationBeta=0,this._initialOrientationGamma=0,this._initialOrientationBeta=0)},BABYLON.DeviceOrientationCamera.prototype._checkInputs=function(){if(this._offsetX){this.cameraRotation.y-=this._offsetX/this.angularSensibility;var e=this._computeLocalCameraSpeed(),t=new BABYLON.Vector3(0,0,e*this._offsetY/this.moveSensibility);BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,0,this._cameraRotationMatrix),this.cameraDirection.addInPlace(BABYLON.Vector3.TransformCoordinates(t,this._cameraRotationMatrix))}}}();var BABYLON=BABYLON||{};!function(){BABYLON.RenderingManager=function(e){this._scene=e,this._renderingGroups=[]},BABYLON.RenderingManager.prototype._renderParticles=function(e,t){if(0!==this._scene._activeParticleSystems.length){for(var i=new Date,r=0;r<this._scene._activeParticleSystems.length;r++){var n=this._scene._activeParticleSystems.data[r];n.renderingGroupId===e&&(this._clearDepthBuffer(),n.emitter.position&&t&&-1===t.indexOf(n.emitter)||(this._scene._activeParticles+=n.render()))}this._scene._particlesDuration+=new Date-i}},BABYLON.RenderingManager.prototype._renderSprites=function(e){if(0!==this._scene.spriteManagers.length){for(var t=new Date,i=0;i<this._scene.spriteManagers.length;i++){var r=this._scene.spriteManagers[i];r.renderingGroupId===e&&(this._clearDepthBuffer(),r.render())}this._scene._spritesDuration+=new Date-t}},BABYLON.RenderingManager.prototype._clearDepthBuffer=function(){this._depthBufferAlreadyCleaned||(this._scene.getEngine().clear(0,!1,!0),this._depthBufferAlreadyCleaned=!0)},BABYLON.RenderingManager.prototype.render=function(e,t,i,r){for(var n=this,o=0;o<BABYLON.RenderingManager.MAX_RENDERINGGROUPS;o++){this._depthBufferAlreadyCleaned=0==o;var s=this._renderingGroups[o];s?(this._clearDepthBuffer(),s.render(e,function(){r&&n._renderSprites(o)})||this._renderingGroups.splice(o,1)):r&&this._renderSprites(o),i&&this._renderParticles(o,t)}},BABYLON.RenderingManager.prototype.reset=function(){for(var e in this._renderingGroups){var t=this._renderingGroups[e];t.prepare()}},BABYLON.RenderingManager.prototype.dispatch=function(e){var t=e.getMesh(),i=t.renderingGroupId||0;
this._renderingGroups[i]||(this._renderingGroups[i]=new BABYLON.RenderingGroup(i,this._scene)),this._renderingGroups[i].dispatch(e)},BABYLON.RenderingManager.MAX_RENDERINGGROUPS=4}();var BABYLON=BABYLON||{};!function(){BABYLON.RenderingGroup=function(e,t){this.index=e,this._scene=t,this._opaqueSubMeshes=new BABYLON.Tools.SmartArray(256),this._transparentSubMeshes=new BABYLON.Tools.SmartArray(256),this._alphaTestSubMeshes=new BABYLON.Tools.SmartArray(256)},BABYLON.RenderingGroup.prototype.render=function(e,t){if(e)return e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,t),!0;if(0===this._opaqueSubMeshes.length&&0===this._alphaTestSubMeshes.length&&0===this._transparentSubMeshes)return!1;var i,r,n=this._scene.getEngine();for(i=0;i<this._opaqueSubMeshes.length;i++)r=this._opaqueSubMeshes.data[i],this._activeVertices+=r.verticesCount,r.render();for(n.setAlphaTesting(!0),i=0;i<this._alphaTestSubMeshes.length;i++)r=this._alphaTestSubMeshes.data[i],this._activeVertices+=r.verticesCount,r.render();if(n.setAlphaTesting(!1),t&&t(),this._transparentSubMeshes.length){for(i=0;i<this._transparentSubMeshes.length;i++)r=this._transparentSubMeshes.data[i],r._distanceToCamera=r.getBoundingInfo().boundingSphere.centerWorld.subtract(this._scene.activeCamera.position).length();var o=this._transparentSubMeshes.data.slice(0,this._transparentSubMeshes.length);for(o.sort(function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}),n.setAlphaMode(BABYLON.Engine.ALPHA_COMBINE),i=0;i<o.length;i++)r=o[i],this._activeVertices+=r.verticesCount,r.render();n.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)}return!0},BABYLON.RenderingGroup.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset()},BABYLON.RenderingGroup.prototype.dispatch=function(e){var t=e.getMaterial(),i=e.getMesh();t.needAlphaBlending()||i.visibility<1?(t.alpha>0||i.visibility<1)&&this._transparentSubMeshes.push(e):t.needAlphaTesting()?this._alphaTestSubMeshes.push(e):this._opaqueSubMeshes.push(e)}}();var BABYLON=BABYLON||{};!function(){BABYLON.Scene=function(e){this._engine=e,this.autoClear=!0,this.clearColor=new BABYLON.Color3(.2,.2,.3),this.ambientColor=new BABYLON.Color3(0,0,0),e.scenes.push(this),this._totalVertices=0,this._activeVertices=0,this._activeParticles=0,this._lastFrameDuration=0,this._evaluateActiveMeshesDuration=0,this._renderTargetsDuration=0,this._renderDuration=0,this._renderId=0,this._executeWhenReadyTimeoutId=-1,this._toBeDisposed=new BABYLON.Tools.SmartArray(256),this._onReadyCallbacks=[],this._pendingData=[],this._onBeforeRenderCallbacks=[],this.fogMode=BABYLON.Scene.FOGMODE_NONE,this.fogColor=new BABYLON.Color3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.lightsEnabled=!0,this.lights=[],this.cameras=[],this.activeCamera=null,this.meshes=[],this._activeMeshes=new BABYLON.Tools.SmartArray(256),this._processedMaterials=new BABYLON.Tools.SmartArray(256),this._renderTargets=new BABYLON.Tools.SmartArray(256),this._activeParticleSystems=new BABYLON.Tools.SmartArray(256),this._activeSkeletons=new BABYLON.Tools.SmartArray(32),this._renderingManager=new BABYLON.RenderingManager(this),this.materials=[],this.multiMaterials=[],this.defaultMaterial=new BABYLON.StandardMaterial("default material",this),this.texturesEnabled=!0,this.textures=[],this.particlesEnabled=!0,this.particleSystems=[],this.spriteManagers=[],this.layers=[],this.skeletons=[],this.lensFlareSystems=[],this.collisionsEnabled=!0,this.gravity=new BABYLON.Vector3(0,-9,0),this._activeAnimatables=[],this._transformMatrix=BABYLON.Matrix.Zero(),this._scaledPosition=BABYLON.Vector3.Zero(),this._scaledVelocity=BABYLON.Vector3.Zero(),this.postProcessesEnabled=!0,this.postProcessManager=new BABYLON.PostProcessManager(this),this.renderTargetsEnabled=!0,this.customRenderTargets=[],this.activeCameras=[]},BABYLON.Scene.prototype.getEngine=function(){return this._engine},BABYLON.Scene.prototype.getTotalVertices=function(){return this._totalVertices},BABYLON.Scene.prototype.getActiveVertices=function(){return this._activeVertices},BABYLON.Scene.prototype.getActiveParticles=function(){return this._activeParticles},BABYLON.Scene.prototype.getLastFrameDuration=function(){return this._lastFrameDuration},BABYLON.Scene.prototype.getEvaluateActiveMeshesDuration=function(){return this._evaluateActiveMeshesDuration},BABYLON.Scene.prototype.getActiveMeshes=function(){return this._activeMeshes},BABYLON.Scene.prototype.getRenderTargetsDuration=function(){return this._renderTargetsDuration},BABYLON.Scene.prototype.getRenderDuration=function(){return this._renderDuration},BABYLON.Scene.prototype.getParticlesDuration=function(){return this._particlesDuration},BABYLON.Scene.prototype.getSpritesDuration=function(){return this._spritesDuration},BABYLON.Scene.prototype.getAnimationRatio=function(){return this._animationRatio},BABYLON.Scene.prototype.getRenderId=function(){return this._renderId},BABYLON.Scene.prototype.isReady=function(){if(this._pendingData.length>0)return!1;for(var e=0;e<this.meshes.length;e++){var t=this.meshes[e],i=t.material;if(t.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADING)return!1;if(i&&!i.isReady(t))return!1}return!0},BABYLON.Scene.prototype.registerBeforeRender=function(e){this._onBeforeRenderCallbacks.push(e)},BABYLON.Scene.prototype.unregisterBeforeRender=function(e){var t=this._onBeforeRenderCallbacks.indexOf(e);t>-1&&this._onBeforeRenderCallbacks.splice(t,1)},BABYLON.Scene.prototype._addPendingData=function(e){this._pendingData.push(e)},BABYLON.Scene.prototype._removePendingData=function(e){var t=this._pendingData.indexOf(e);-1!==t&&this._pendingData.splice(t,1)},BABYLON.Scene.prototype.getWaitingItemsCount=function(){return this._pendingData.length},BABYLON.Scene.prototype.executeWhenReady=function(e){if(this._onReadyCallbacks.push(e),-1===this._executeWhenReadyTimeoutId){var t=this;this._executeWhenReadyTimeoutId=setTimeout(function(){t._checkIsReady()},150)}},BABYLON.Scene.prototype._checkIsReady=function(){if(this.isReady())return this._onReadyCallbacks.forEach(function(e){e()}),this._onReadyCallbacks=[],void(this._executeWhenReadyTimeoutId=-1);var e=this;this._executeWhenReadyTimeoutId=setTimeout(function(){e._checkIsReady()},150)},BABYLON.Scene.prototype.beginAnimation=function(e,t,i,r,n,o){if(void 0===n&&(n=1),e.animations){this.stopAnimation(e);var s=new BABYLON._Animatable(e,t,i,r,n,o);this._activeAnimatables.push(s)}if(e.getAnimatables)for(var a=e.getAnimatables(),h=0;h<a.length;h++)this.beginAnimation(a[h],t,i,r,n,o)},BABYLON.Scene.prototype.stopAnimation=function(e){if(e.animations)for(var t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return void this._activeAnimatables.splice(t,1);if(e.getAnimatables)for(var i=e.getAnimatables(),t=0;t<i.length;t++)this.stopAnimation(i[t])},BABYLON.Scene.prototype._animate=function(){this._animationStartDate||(this._animationStartDate=new Date);for(var e=new Date,t=e-this._animationStartDate,i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i]._animate(t)||(this._activeAnimatables.splice(i,1),i--)},BABYLON.Scene.prototype.getViewMatrix=function(){return this._viewMatrix},BABYLON.Scene.prototype.getProjectionMatrix=function(){return this._projectionMatrix},BABYLON.Scene.prototype.getTransformMatrix=function(){return this._transformMatrix},BABYLON.Scene.prototype.setTransformMatrix=function(e,t){this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)},BABYLON.Scene.prototype.setActiveCameraByID=function(e){var t=this.getCameraByID(e);return t?(this.activeCamera=t,t):null},BABYLON.Scene.prototype.setActiveCameraByName=function(e){var t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null},BABYLON.Scene.prototype.getMaterialByID=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].id===e)return this.materials[t];return null},BABYLON.Scene.prototype.getMaterialByName=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].name===e)return this.materials[t];return null},BABYLON.Scene.prototype.getCameraByID=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null},BABYLON.Scene.prototype.getCameraByName=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null},BABYLON.Scene.prototype.getLightByID=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null},BABYLON.Scene.prototype.getMeshByID=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null},BABYLON.Scene.prototype.getLastMeshByID=function(e){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null},BABYLON.Scene.prototype.getLastEntryByID=function(e){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(var t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(var t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null},BABYLON.Scene.prototype.getMeshByName=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null},BABYLON.Scene.prototype.getLastSkeletonByID=function(e){for(var t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null},BABYLON.Scene.prototype.getSkeletonById=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null},BABYLON.Scene.prototype.getSkeletonByName=function(e){for(var t=0;t<this.skeleton.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null},BABYLON.Scene.prototype.isActiveMesh=function(e){return-1!==this._activeMeshes.indexOf(e)},BABYLON.Scene.prototype._evaluateSubMesh=function(e,t){if(1==t.subMeshes.length||e.isInFrustum(this._frustumPlanes)){var i=e.getMaterial();i&&(i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._renderTargets.concat(i.getRenderTargetTextures())),this._activeVertices+=e.verticesCount,this._renderingManager.dispatch(e))}},BABYLON.Scene.prototype._evaluateActiveMeshes=function(){if(this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._frustumPlanes?BABYLON.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=BABYLON.Frustum.GetPlanes(this._transformMatrix),this._selectionOctree)for(var e=this._selectionOctree.select(this._frustumPlanes),t=0;t<e.length;t++)for(var i=e.data[t],r=0;r<i.meshes.length;r++){var n=i.meshes[r];if(Math.abs(n._renderId)!==this._renderId){if(this._totalVertices+=n.getTotalVertices(),!n.isReady())continue;n.computeWorldMatrix(),n._renderId=0}if(n._renderId===this._renderId||0===n._renderId&&n.isEnabled()&&n.isVisible&&n.visibility>0&&n.isInFrustum(this._frustumPlanes)){0===n._renderId&&this._activeMeshes.push(n),n._renderId=this._renderId,n.skeleton&&this._activeSkeletons.pushNoDuplicate(n.skeleton);for(var o=i.subMeshes[r],s=0;s<o.length;s++){var a=o[s];a._renderId!==this._renderId&&(a._renderId=this._renderId,this._evaluateSubMesh(a,n))}}else n._renderId=-this._renderId}else for(var r=0;r<this.meshes.length;r++){var n=this.meshes[r];if(this._totalVertices+=n.getTotalVertices(),n.isReady()&&(n.computeWorldMatrix(),n.isEnabled()&&n.isVisible&&n.visibility>0&&n.isInFrustum(this._frustumPlanes))){this._activeMeshes.push(n),n.skeleton&&this._activeSkeletons.pushNoDuplicate(n.skeleton);for(var s=0;s<n.subMeshes.length;s++){var a=n.subMeshes[s];this._evaluateSubMesh(a,n)}}}var h=new Date;if(this.particlesEnabled)for(var c=0;c<this.particleSystems.length;c++){var l=this.particleSystems[c];(!l.emitter.position||l.emitter&&l.emitter.isEnabled())&&(this._activeParticleSystems.push(l),l.animate())}this._particlesDuration+=new Date-h},BABYLON.Scene.prototype._renderForCamera=function(e){var t=this._engine;if(this.activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");t.setViewport(this.activeCamera.viewport),this._renderId++,this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix());var i=new Date;this._evaluateActiveMeshes(),this._evaluateActiveMeshesDuration+=new Date-i;for(var r=0;r<this._activeSkeletons.length;r++){var n=this._activeSkeletons.data[r];n.prepare()}for(var o=0;o<this.customRenderTargets.length;o++)this._renderTargets.push(this.customRenderTargets[o]);var s=new Date;if(this.renderTargetsEnabled)for(var a=0;a<this._renderTargets.length;a++){var h=this._renderTargets.data[a];this._renderId++,h.render()}this._renderTargets.length>0&&t.restoreDefaultFramebuffer(),this._renderTargetsDuration=new Date-s,this.postProcessManager._prepareFrame();var c=new Date;if(this.layers.length){t.setDepthBuffer(!1);var l,u;for(l=0;l<this.layers.length;l++)u=this.layers[l],u.isBackground&&u.render();t.setDepthBuffer(!0)}this._renderingManager.render(null,null,!0,!0);for(var f=0;f<this.lensFlareSystems.length;f++)this.lensFlareSystems[f].render();if(this.layers.length){for(t.setDepthBuffer(!1),l=0;l<this.layers.length;l++)u=this.layers[l],u.isBackground||u.render();t.setDepthBuffer(!0)}this._renderDuration+=new Date-c,this.postProcessManager._finalizeFrame(e.isIntermediate),this.activeCamera._updateFromScene(),this._renderTargets.reset()},BABYLON.Scene.prototype._processSubCameras=function(e){if(0==e.subCameras.length)return void this._renderForCamera(e);for(var t=0;t<e.subCameras.length;t++)this._renderForCamera(e.subCameras[t]);this.activeCamera=e,this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix()),this.activeCamera._updateFromScene()},BABYLON.Scene.prototype.render=function(){var e=new Date;this._particlesDuration=0,this._spritesDuration=0,this._activeParticles=0,this._renderDuration=0,this._evaluateActiveMeshesDuration=0,this._totalVertices=0,this._activeVertices=0,this.beforeRender&&this.beforeRender();for(var t=0;t<this._onBeforeRenderCallbacks.length;t++)this._onBeforeRenderCallbacks[t]();var i=BABYLON.Tools.GetDeltaTime();this._animationRatio=.06*i,this._animate(),this._physicsEngine&&this._physicsEngine._runOneStep(i/1e3),this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe,!0);for(var r=0;r<this.lights.length;r++){var n=this.lights[r],o=n.getShadowGenerator();n.isEnabled()&&o&&-1!==o.getShadowMap()._scene.textures.indexOf(o.getShadowMap())&&this._renderTargets.push(o.getShadowMap())}if(this.activeCameras.length>0)for(var s=this._renderId,a=0;a<this.activeCameras.length;a++)this._renderId=s,this._processSubCameras(this.activeCameras[a]);else this._processSubCameras(this.activeCamera);this.afterRender&&this.afterRender();for(var h=0;h<this._toBeDisposed.length;h++)this._toBeDisposed.data[h].dispose(),this._toBeDisposed[h]=null;this._toBeDisposed.reset(),this._lastFrameDuration=new Date-e},BABYLON.Scene.prototype.dispose=function(){this.beforeRender=null,this.afterRender=null,this.skeletons=[];var e,t=this._engine.getRenderingCanvas();for(e=0;e<this.cameras.length;e++)this.cameras[e].detachControl(t);for(;this.lights.length;)this.lights[0].dispose(!0);for(;this.meshes.length;)this.meshes[0].dispose(!0);for(;this.cameras.length;)this.cameras[0].dispose();for(;this.materials.length;)this.materials[0].dispose();for(;this.particleSystems.length;)this.particleSystems[0].dispose();for(;this.spriteManagers.length;)this.spriteManagers[0].dispose();for(;this.layers.length;)this.layers[0].dispose();for(;this.textures.length;)this.textures[0].dispose();this.postProcessManager.dispose(),this._physicsEngine&&this.disablePhysicsEngine(),e=this._engine.scenes.indexOf(this),this._engine.scenes.splice(e,1),this._engine.wipeCaches()},BABYLON.Scene.prototype._getNewPosition=function(e,t,i,r,n){e.divideToRef(i.radius,this._scaledPosition),t.divideToRef(i.radius,this._scaledVelocity),i.retry=0,i.initialVelocity=this._scaledVelocity,i.initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,n),n.multiplyInPlace(i.radius)},BABYLON.Scene.prototype._collideWithWorld=function(e,t,i,r,n){var o=10*BABYLON.Engine.collisionsEpsilon;if(i.retry>=r)return void n.copyFrom(e);i._initialize(e,t,o);for(var s=0;s<this.meshes.length;s++){var a=this.meshes[s];a.isEnabled()&&a.checkCollisions&&a._checkCollision(i)}return i.collisionFound?((0!=t.x||0!=t.y||0!=t.z)&&i._getResponse(e,t),t.length()<=o?void n.copyFrom(e):(i.retry++,void this._collideWithWorld(e,t,i,r,n))):void e.addToRef(t,n)},BABYLON.Scene.prototype.createOrUpdateSelectionOctree=function(){this._selectionOctree||(this._selectionOctree=new BABYLON.Octree);for(var e=function(e,t,i){e.x<t.x&&(t.x=e.x),e.y<t.y&&(t.y=e.y),e.z<t.z&&(t.z=e.z),e.x>i.x&&(i.x=e.x),e.y>i.y&&(i.y=e.y),e.z>i.z&&(i.z=e.z)},t=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),r=0;r<this.meshes.length;r++){var n=this.meshes[r];n.computeWorldMatrix(!0);var o=n.getBoundingInfo().boundingBox.minimumWorld,s=n.getBoundingInfo().boundingBox.maximumWorld;e(o,t,i),e(s,t,i)}this._selectionOctree.update(t,i,this.meshes)},BABYLON.Scene.prototype.createPickingRay=function(e,t,i,r){var n=this._engine;if(!r){if(!this.activeCamera)throw new Error("Active camera not set");r=this.activeCamera}var o=r.viewport.toGlobal(n);return BABYLON.Ray.CreateNew(e*this._engine.getHardwareScalingLevel(),t*this._engine.getHardwareScalingLevel(),o.width,o.height,i?i:BABYLON.Matrix.Identity(),r.getViewMatrix(),r.getProjectionMatrix())},BABYLON.Scene.prototype._internalPick=function(e,t,i){for(var r=null,n=0;n<this.meshes.length;n++){var o=this.meshes[n];if(t){if(!t(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var s=o.getWorldMatrix(),a=e(s),h=o.intersects(a,i);if(h.hit&&(i||null==r||!(h.distance>=r.distance))&&(r=h,i))break}return r||new BABYLON.PickingInfo},BABYLON.Scene.prototype.pick=function(e,t,i,r,n){var o=this;return this._internalPick(function(i){return o.createPickingRay(e,t,i,n)},i,r)},BABYLON.Scene.prototype.pickWithRay=function(e,t,i){var r=this;return this._internalPick(function(t){return r._pickWithRayInverseMatrix||(r._pickWithRayInverseMatrix=BABYLON.Matrix.Identity()),t.invertToRef(r._pickWithRayInverseMatrix),BABYLON.Ray.Transform(e,r._pickWithRayInverseMatrix)},t,i)},BABYLON.Scene.prototype.enablePhysics=function(e,t){return this._physicsEngine?!0:BABYLON.PhysicsEngine.IsSupported()?(this._physicsEngine=new BABYLON.PhysicsEngine(e,t||10),!0):!1},BABYLON.Scene.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=void 0)},BABYLON.Scene.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},BABYLON.Scene.prototype.setGravity=function(e){this._physicsEngine&&this._physicsEngine._setGravity(e)},BABYLON.Scene.prototype.createCompoundImpostor=function(e){if(!this._physicsEngine)return null;for(var t=0;t<e.parts.length;t++){var i=e.parts[t].mesh;i._physicImpostor=e.parts[t].impostor,i._physicsMass=e.mass/e.parts.length,i._physicsFriction=e.friction,i._physicRestitution=e.restitution}return this._physicsEngine._registerCompound(e)},BABYLON.Scene.prototype.deleteCompoundImpostor=function(e){for(var t=0;t<e.parts.length;t++){var i=e.parts[t].mesh;i._physicImpostor=BABYLON.PhysicsEngine.NoImpostor,this._scene._physicsEngine._unregisterMesh(i)}},BABYLON.Scene.prototype._getByTags=function(e,t){if(void 0===t)return e;var i=[];for(var r in e){var n=e[r];BABYLON.Tags.MatchesQuery(n,t)&&i.push(n)}return i},BABYLON.Scene.prototype.getMeshesByTags=function(e){return this._getByTags(this.meshes,e)},BABYLON.Scene.prototype.getCamerasByTags=function(e){return this._getByTags(this.cameras,e)},BABYLON.Scene.prototype.getLightsByTags=function(e){return this._getByTags(this.lights,e)},BABYLON.Scene.prototype.getMaterialByTags=function(e){return this._getByTags(this.materials,e).concat(this._getByTags(this.multiMaterials,e))},BABYLON.Scene.FOGMODE_NONE=0,BABYLON.Scene.FOGMODE_EXP=1,BABYLON.Scene.FOGMODE_EXP2=2,BABYLON.Scene.FOGMODE_LINEAR=3}();var BABYLON=BABYLON||{};!function(){BABYLON.VertexBuffer=function(e,t,i,r){switch(this._mesh=e,this._engine=e.getScene().getEngine(),this._updatable=r,r?(this._buffer=this._engine.createDynamicVertexBuffer(4*t.length),this._engine.updateDynamicVertexBuffer(this._buffer,t)):this._buffer=this._engine.createVertexBuffer(t),this._data=t,this._kind=i,i){case BABYLON.VertexBuffer.PositionKind:this._strideSize=3,this._mesh._resetPointsArrayCache();break;case BABYLON.VertexBuffer.NormalKind:this._strideSize=3;break;case BABYLON.VertexBuffer.UVKind:this._strideSize=2;break;case BABYLON.VertexBuffer.UV2Kind:this._strideSize=2;break;case BABYLON.VertexBuffer.ColorKind:this._strideSize=3;break;case BABYLON.VertexBuffer.MatricesIndicesKind:this._strideSize=4;break;case BABYLON.VertexBuffer.MatricesWeightsKind:this._strideSize=4}},BABYLON.VertexBuffer.prototype.isUpdatable=function(){return this._updatable},BABYLON.VertexBuffer.prototype.getData=function(){return this._data},BABYLON.VertexBuffer.prototype.getStrideSize=function(){return this._strideSize},BABYLON.VertexBuffer.prototype.update=function(e){this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e,this._kind===BABYLON.VertexBuffer.PositionKind&&this._mesh._resetPointsArrayCache()},BABYLON.VertexBuffer.prototype.dispose=function(){this._engine._releaseBuffer(this._buffer)},BABYLON.VertexBuffer.PositionKind="position",BABYLON.VertexBuffer.NormalKind="normal",BABYLON.VertexBuffer.UVKind="uv",BABYLON.VertexBuffer.UV2Kind="uv2",BABYLON.VertexBuffer.ColorKind="color",BABYLON.VertexBuffer.MatricesIndicesKind="matricesIndices",BABYLON.VertexBuffer.MatricesWeightsKind="matricesWeights"}();var BABYLON=BABYLON||{};!function(){BABYLON.Mesh=function(e,t){BABYLON.Node.call(this,t),this.name=e,this.id=e,this._totalVertices=0,this._worldMatrix=BABYLON.Matrix.Identity(),t.meshes.push(this),this.position=new BABYLON.Vector3(0,0,0),this.rotation=new BABYLON.Vector3(0,0,0),this.rotationQuaternion=null,this.scaling=new BABYLON.Vector3(1,1,1),this._pivotMatrix=BABYLON.Matrix.Identity(),this._indices=[],this.subMeshes=[],this._renderId=0,this._onBeforeRenderCallbacks=[],this.animations=[],this._positions=null,BABYLON.Mesh.prototype._initCache.call(this),this._localScaling=BABYLON.Matrix.Zero(),this._localRotation=BABYLON.Matrix.Zero(),this._localTranslation=BABYLON.Matrix.Zero(),this._localBillboard=BABYLON.Matrix.Zero(),this._localPivotScaling=BABYLON.Matrix.Zero(),this._localPivotScalingRotation=BABYLON.Matrix.Zero(),this._localWorld=BABYLON.Matrix.Zero(),this._worldMatrix=BABYLON.Matrix.Zero(),this._rotateYByPI=BABYLON.Matrix.RotationY(Math.PI),this._collisionsTransformMatrix=BABYLON.Matrix.Zero(),this._collisionsScalingMatrix=BABYLON.Matrix.Zero(),this._absolutePosition=BABYLON.Vector3.Zero()},BABYLON.Mesh.prototype=Object.create(BABYLON.Node.prototype),BABYLON.Mesh.BILLBOARDMODE_NONE=0,BABYLON.Mesh.BILLBOARDMODE_X=1,BABYLON.Mesh.BILLBOARDMODE_Y=2,BABYLON.Mesh.BILLBOARDMODE_Z=4,BABYLON.Mesh.BILLBOARDMODE_ALL=7,BABYLON.Mesh.prototype.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NONE,BABYLON.Mesh.prototype.material=null,BABYLON.Mesh.prototype.isVisible=!0,BABYLON.Mesh.prototype.isPickable=!0,BABYLON.Mesh.prototype.visibility=1,BABYLON.Mesh.prototype.billboardMode=BABYLON.Mesh.BILLBOARDMODE_NONE,BABYLON.Mesh.prototype.checkCollisions=!1,BABYLON.Mesh.prototype.receiveShadows=!1,BABYLON.Mesh.prototype._isDisposed=!1,BABYLON.Mesh.prototype.onDispose=null,BABYLON.Mesh.prototype.skeleton=null,BABYLON.Mesh.prototype.renderingGroupId=0,BABYLON.Mesh.prototype.infiniteDistance=!1,BABYLON.Mesh.prototype.getBoundingInfo=function(){return this._boundingInfo},BABYLON.Mesh.prototype.getScene=function(){return this._scene},BABYLON.Mesh.prototype.getWorldMatrix=function(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix},BABYLON.Mesh.prototype.rotate=function(e,t,i){if(this.rotationQuaternion||(this.rotationQuaternion=BABYLON.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation=BABYLON.Vector3.Zero()),i&&i!=BABYLON.Space.LOCAL){if(this.parent){var r=this.parent.getWorldMatrix().clone();r.invert(),e=BABYLON.Vector3.TransformNormal(e,r)}var n=BABYLON.Quaternion.RotationAxis(e,t);this.rotationQuaternion=n.multiply(this.rotationQuaternion)}else{var n=BABYLON.Quaternion.RotationAxis(e,t);this.rotationQuaternion=this.rotationQuaternion.multiply(n)}},BABYLON.Mesh.prototype.translate=function(e,t,i){var r=e.scale(t);if(i&&i!=BABYLON.Space.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(r));else{var n=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(n)}},BABYLON.Mesh.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},BABYLON.Mesh.prototype.setAbsolutePosition=function(e){if(e){var t,i,r;if(void 0===e.x){if(arguments.length<3)return;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){var n=this.parent.getWorldMatrix().clone();n.invert();var o=new BABYLON.Vector3(t,i,r);this.position=BABYLON.Vector3.TransformCoordinates(o,n)}else this.position.x=t,this.position.y=i,this.position.z=r}},BABYLON.Mesh.prototype.getTotalVertices=function(){return this._totalVertices},BABYLON.Mesh.prototype.getVerticesData=function(e){return this._vertexBuffers[e].getData()},BABYLON.Mesh.prototype.getVertexBuffer=function(e){return this._vertexBuffers[e]},BABYLON.Mesh.prototype.isVerticesDataPresent=function(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:this._delayInfo?-1!==this._delayInfo.indexOf(e):!1},BABYLON.Mesh.prototype.getVerticesDataKinds=function(){var e=[];if(!this._vertexBuffers&&this._delayInfo)for(var t in this._delayInfo)e.push(t);else for(var t in this._vertexBuffers)e.push(t);return e},BABYLON.Mesh.prototype.getTotalIndices=function(){return this._indices.length},BABYLON.Mesh.prototype.getIndices=function(){return this._indices},BABYLON.Mesh.prototype.getVertexStrideSize=function(){return this._vertexStrideSize},BABYLON.Mesh.prototype.setPivotMatrix=function(e){this._pivotMatrix=e,this._cache.pivotMatrixUpdated=!0},BABYLON.Mesh.prototype.getPivotMatrix=function(){return this._pivotMatrix},BABYLON.Mesh.prototype._isSynchronized=function(){if(this.billboardMode!==BABYLON.Mesh.BILLBOARDMODE_NONE)return!1;if(this._cache.pivotMatrixUpdated)return!1;if(this.infiniteDistance)return!1;if(!this._cache.position.equals(this.position))return!1;if(this.rotationQuaternion){if(!this._cache.rotationQuaternion.equals(this.rotationQuaternion))return!1}else if(!this._cache.rotation.equals(this.rotation))return!1;return this._cache.scaling.equals(this.scaling)?!0:!1},BABYLON.Mesh.prototype.isReady=function(){return this._isReady},BABYLON.Mesh.prototype.isAnimated=function(){return this._animationStarted},BABYLON.Mesh.prototype.isDisposed=function(){return this._isDisposed},BABYLON.Mesh.prototype._initCache=function(){this._cache.localMatrixUpdated=!1,this._cache.position=BABYLON.Vector3.Zero(),this._cache.scaling=BABYLON.Vector3.Zero(),this._cache.rotation=BABYLON.Vector3.Zero(),this._cache.rotationQuaternion=new BABYLON.Quaternion(0,0,0,0)},BABYLON.Mesh.prototype.markAsDirty=function(e){"rotation"===e&&(this.rotationQuaternion=null),this._currentRenderId=-1},BABYLON.Mesh.prototype.refreshBoundingInfo=function(){var e=this.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(e){var t=BABYLON.Tools.ExtractMinAndMax(e,0,this._totalVertices);this._boundingInfo=new BABYLON.BoundingInfo(t.minimum,t.maximum);for(var i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo();this._updateBoundingInfo()}},BABYLON.Mesh.prototype._updateBoundingInfo=function(){this._boundingInfo=this._boundingInfo||new BABYLON.BoundingInfo(this._absolutePosition,this._absolutePosition),this._scaleFactor=Math.max(this.scaling.x,this.scaling.y),this._scaleFactor=Math.max(this._scaleFactor,this.scaling.z),this.parent&&this.parent._scaleFactor&&(this._scaleFactor=this._scaleFactor*this.parent._scaleFactor),this._boundingInfo._update(this._worldMatrix,this._scaleFactor);for(var e=0;e<this.subMeshes.length;e++){var t=this.subMeshes[e];t.updateBoundingInfo(this._worldMatrix,this._scaleFactor)}},BABYLON.Mesh.prototype.computeWorldMatrix=function(e){if(!e&&(this._currentRenderId==this._scene.getRenderId()||this.isSynchronized(!0)))return this._currentRenderId=this._scene.getRenderId(),this._worldMatrix;if(this._cache.position.copyFrom(this.position),this._cache.scaling.copyFrom(this.scaling),this._cache.pivotMatrixUpdated=!1,this._currentRenderId=this._scene.getRenderId(),BABYLON.Matrix.ScalingToRef(this.scaling.x,this.scaling.y,this.scaling.z,this._localScaling),this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(this._localRotation),this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)):(BABYLON.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._localRotation),this._cache.rotation.copyFrom(this.rotation)),this.infiniteDistance&&!this.parent){var t=this._scene.activeCamera,i=t.getWorldMatrix(),r=new BABYLON.Vector3(i.m[12],i.m[13],i.m[14]);BABYLON.Matrix.TranslationToRef(this.position.x+r.x,this.position.y+r.y,this.position.z+r.z,this._localTranslation)}else BABYLON.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._localTranslation);if(this._pivotMatrix.multiplyToRef(this._localScaling,this._localPivotScaling),this._localPivotScaling.multiplyToRef(this._localRotation,this._localPivotScalingRotation),this.billboardMode!==BABYLON.Mesh.BILLBOARDMODE_NONE){var n=this.position.clone(),o=this._scene.activeCamera.position.clone();this.parent&&this.parent.position&&(n.addInPlace(this.parent.position),BABYLON.Matrix.TranslationToRef(n.x,n.y,n.z,this._localTranslation)),this.billboardMode&BABYLON.Mesh.BILLBOARDMODE_ALL===BABYLON.Mesh.BILLBOARDMODE_ALL?o=this._scene.activeCamera.position:(this.billboardMode&BABYLON.Mesh.BILLBOARDMODE_X&&(o.x=n.x+BABYLON.Engine.epsilon),this.billboardMode&BABYLON.Mesh.BILLBOARDMODE_Y&&(o.y=n.y+BABYLON.Engine.epsilon),this.billboardMode&BABYLON.Mesh.BILLBOARDMODE_Z&&(o.z=n.z+BABYLON.Engine.epsilon)),BABYLON.Matrix.LookAtLHToRef(n,o,BABYLON.Vector3.Up(),this._localBillboard),this._localBillboard.m[12]=this._localBillboard.m[13]=this._localBillboard.m[14]=0,this._localBillboard.invert(),this._localPivotScalingRotation.multiplyToRef(this._localBillboard,this._localWorld),this._rotateYByPI.multiplyToRef(this._localWorld,this._localPivotScalingRotation)}return this._localPivotScalingRotation.multiplyToRef(this._localTranslation,this._localWorld),this.parent&&this.parent.getWorldMatrix&&this.billboardMode===BABYLON.Mesh.BILLBOARDMODE_NONE?this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix):this._worldMatrix.copyFrom(this._localWorld),this._updateBoundingInfo(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._worldMatrix},BABYLON.Mesh.prototype._createGlobalSubMesh=function(){return this._totalVertices&&this._indices?(this.subMeshes=[],new BABYLON.SubMesh(0,0,this._totalVertices,0,this._indices.length,this)):null},BABYLON.Mesh.prototype.subdivide=function(e){if(!(1>e)){var t=this._indices.length/e,i=0;this.subMeshes=[];for(var r=0;e>r;r++)BABYLON.SubMesh.CreateFromIndices(0,i,Math.min(t,this._indices.length-i),this),i+=t}},BABYLON.Mesh.prototype.setVerticesData=function(e,t,i){if(this._vertexBuffers||(this._vertexBuffers={}),this._vertexBuffers[t]&&this._vertexBuffers[t].dispose(),this._vertexBuffers[t]=new BABYLON.VertexBuffer(this,e,t,i),t===BABYLON.VertexBuffer.PositionKind){var r=this._vertexBuffers[t].getStrideSize();
this._totalVertices=e.length/r;var n=BABYLON.Tools.ExtractMinAndMax(e,0,this._totalVertices);this._boundingInfo=new BABYLON.BoundingInfo(n.minimum,n.maximum),this._createGlobalSubMesh()}},BABYLON.Mesh.prototype.updateVerticesData=function(e,t){this._vertexBuffers[e]&&(this._vertexBuffers[e].update(t),e===BABYLON.VertexBuffer.PositionKind&&this._resetPointsArrayCache())},BABYLON.Mesh.prototype.setIndices=function(e){this._indexBuffer&&this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e),this._indices=e,this._createGlobalSubMesh()},BABYLON.Mesh.prototype.bindAndDraw=function(e,t,i){var r=this._scene.getEngine(),n=this._indexBuffer,o=!0;i&&(n=e.getLinesIndexBuffer(this._indices,r),o=!1),r.bindMultiBuffers(this._vertexBuffers,n,t),r.draw(o,o?e.indexStart:0,o?e.indexCount:e.linesIndexCount)},BABYLON.Mesh.prototype.registerBeforeRender=function(e){this._onBeforeRenderCallbacks.push(e)},BABYLON.Mesh.prototype.unregisterBeforeRender=function(e){var t=this._onBeforeRenderCallbacks.indexOf(e);t>-1&&this._onBeforeRenderCallbacks.splice(t,1)},BABYLON.Mesh.prototype.render=function(e){if(this._vertexBuffers&&this._indexBuffer){for(var t=0;t<this._onBeforeRenderCallbacks.length;t++)this._onBeforeRenderCallbacks[t]();var i=this.getWorldMatrix(),r=e.getMaterial();if(r&&r.isReady(this)){r._preBind(),r.bind(i,this);var n=this._scene.getEngine();this.bindAndDraw(e,r.getEffect(),n.forceWireframe||r.wireframe),r.unbind()}}},BABYLON.Mesh.prototype.getEmittedParticleSystems=function(){for(var e=[],t=0;t<this._scene.particleSystems.length;t++){var i=this._scene.particleSystems[t];i.emitter===this&&e.push(i)}return e},BABYLON.Mesh.prototype.getHierarchyEmittedParticleSystems=function(){var e=[],t=this.getDescendants();t.push(this);for(var i=0;i<this._scene.particleSystems.length;i++){var r=this._scene.particleSystems[i];-1!==t.indexOf(r.emitter)&&e.push(r)}return e},BABYLON.Mesh.prototype.getChildren=function(){for(var e=[],t=0;t<this._scene.meshes.length;t++){var i=this._scene.meshes[t];i.parent==this&&e.push(i)}return e},BABYLON.Mesh.prototype.isInFrustum=function(e){if(this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADING)return!1;var t=this._boundingInfo.isInFrustum(e);if(t&&this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NOTLOADED){this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADING;var i=this;this._scene._addPendingData(this),BABYLON.Tools.LoadFile(this.delayLoadingFile,function(e){i._delayLoadingFunction(JSON.parse(e),i),i.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED,i._scene._removePendingData(i)},function(){},this._scene.database)}return t},BABYLON.Mesh.prototype.setMaterialByID=function(e){for(var t=this._scene.materials,i=0;i<t.length;i++)if(t[i].id==e)return void(this.material=t[i]);for(var r=this._scene.multiMaterials,i=0;i<r.length;i++)if(r[i].id==e)return void(this.material=r[i])},BABYLON.Mesh.prototype.getAnimatables=function(){var e=[];return this.material&&e.push(this.material),e},BABYLON.Mesh.prototype.setPositionWithLocalVector=function(e){this.computeWorldMatrix(),this.position=BABYLON.Vector3.TransformNormal(e,this._localWorld)},BABYLON.Mesh.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var e=this._localWorld.clone();return e.invert(),BABYLON.Vector3.TransformNormal(this.position,e)},BABYLON.Mesh.prototype.locallyTranslate=function(e){this.computeWorldMatrix(),this.position=BABYLON.Vector3.TransformCoordinates(e,this._localWorld)},BABYLON.Mesh.prototype.bakeTransformIntoVertices=function(e){if(this.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)){this._resetPointsArrayCache();for(var t=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind].getData(),i=new BABYLON.MatrixType(t.length),r=0;r<t.length;r+=3)BABYLON.Vector3.TransformCoordinates(BABYLON.Vector3.FromArray(t,r),e).toArray(i,r);if(this.setVerticesData(i,BABYLON.VertexBuffer.PositionKind,this._vertexBuffers[BABYLON.VertexBuffer.PositionKind].isUpdatable()),this.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)){t=this._vertexBuffers[BABYLON.VertexBuffer.NormalKind].getData();for(var r=0;r<t.length;r+=3)BABYLON.Vector3.TransformNormal(BABYLON.Vector3.FromArray(t,r),e).toArray(i,r);this.setVerticesData(i,BABYLON.VertexBuffer.NormalKind,this._vertexBuffers[BABYLON.VertexBuffer.NormalKind].isUpdatable())}}},BABYLON.Mesh.prototype.lookAt=function(e,t,i,r){t=t||0,i=i||0,r=r||0;var n=e.subtract(this.position),o=-Math.atan2(n.z,n.x)-Math.PI/2,s=Math.sqrt(n.x*n.x+n.z*n.z),a=Math.atan2(n.y,s);this.rotationQuaternion=BABYLON.Quaternion.RotationYawPitchRoll(o+t,a+i,r)},BABYLON.Mesh.prototype._resetPointsArrayCache=function(){this._positions=null},BABYLON.Mesh.prototype._generatePointsArray=function(){if(!this._positions){this._positions=[];for(var e=this._vertexBuffers[BABYLON.VertexBuffer.PositionKind].getData(),t=0;t<e.length;t+=3)this._positions.push(BABYLON.Vector3.FromArray(e,t))}},BABYLON.Mesh.prototype._collideForSubMesh=function(e,t,i){if(this._generatePointsArray(),!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)||!this.position.equals(e._meshPosition)){e._meshPosition=this.position.clone(),e._lastColliderTransformMatrix=t,e._lastColliderWorldVertices=[];for(var r=e.verticesStart,n=e.verticesStart+e.verticesCount,o=r;n>o;o++)e._lastColliderWorldVertices.push(BABYLON.Vector3.TransformCoordinates(this._positions[o],t))}i._collide(e,e._lastColliderWorldVertices,this._indices,e.indexStart,e.indexStart+e.indexCount,e.verticesStart)},BABYLON.Mesh.prototype._processCollisionsForSubModels=function(e,t){for(var i=0;i<this.subMeshes.length;i++){var r=this.subMeshes[i];this.subMeshes.length>1&&!r._checkCollision(e)||this._collideForSubMesh(r,t,e)}},BABYLON.Mesh.prototype._checkCollision=function(e){this._boundingInfo._checkCollision(e)&&(BABYLON.Matrix.ScalingToRef(1/e.radius.x,1/e.radius.y,1/e.radius.z,this._collisionsScalingMatrix),this._worldMatrix.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix),this._processCollisionsForSubModels(e,this._collisionsTransformMatrix))},BABYLON.Mesh.prototype.intersectsMesh=function(e,t){return this._boundingInfo&&e._boundingInfo?this._boundingInfo.intersects(e._boundingInfo,t):!1},BABYLON.Mesh.prototype.intersectsPoint=function(e){return this._boundingInfo?this._boundingInfo.intersectsPoint(e):!1},BABYLON.Mesh.prototype.intersects=function(e,t){var i=new BABYLON.PickingInfo;if(!this._boundingInfo||!e.intersectsSphere(this._boundingInfo.boundingSphere)||!e.intersectsBox(this._boundingInfo.boundingBox))return i;this._generatePointsArray();for(var r=null,n=0;n<this.subMeshes.length;n++){var o=this.subMeshes[n];if(!(this.subMeshes.length>1)||o.canIntersects(e)){var s=o.intersects(e,this._positions,this._indices,t);if(s&&(t||!r||s.distance<r.distance)&&(r=s,t))break}}if(r){var a=this.getWorldMatrix(),h=BABYLON.Vector3.TransformCoordinates(e.origin,a),c=e.direction.clone();c.normalize(),c=c.scale(r.distance);var l=BABYLON.Vector3.TransformNormal(c,a),u=h.add(l);return i.hit=!0,i.distance=BABYLON.Vector3.Distance(h,u),i.pickedPoint=u,i.pickedMesh=this,i.bu=r.bu,i.bv=r.bv,i.faceId=r.faceId,i}return i},BABYLON.Mesh.prototype.clone=function(e,t,i){var r=new BABYLON.Mesh(e,this._scene);r._vertexBuffers=this._vertexBuffers;for(var n in r._vertexBuffers)r._vertexBuffers[n]._buffer.references++;r._indexBuffer=this._indexBuffer,this._indexBuffer.references++,BABYLON.Tools.DeepCopy(this,r,["name","material","skeleton"],["_indices","_totalVertices"]);var o=BABYLON.Tools.ExtractMinAndMax(this.getVerticesData(BABYLON.VertexBuffer.PositionKind),0,this._totalVertices);if(r._boundingInfo=new BABYLON.BoundingInfo(o.minimum,o.maximum),r.material=this.material,t&&(r.parent=t),!i)for(var s=0;s<this._scene.meshes.length;s++){var a=this._scene.meshes[s];a.parent==this&&a.clone(a.name,r)}for(var s=0;s<this._scene.particleSystems.length;s++){var h=this._scene.particleSystems[s];h.emitter==this&&h.clone(h.name,r)}return r.computeWorldMatrix(!0),r},BABYLON.Mesh.prototype.dispose=function(e){if(this._vertexBuffers){for(var t in this._vertexBuffers)this._vertexBuffers[t].dispose();this._vertexBuffers=null}this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.getPhysicsImpostor()!=BABYLON.PhysicsEngine.NoImpostor&&this.setPhysicsState({impostor:BABYLON.PhysicsEngine.NoImpostor});var i=this._scene.meshes.indexOf(this);if(this._scene.meshes.splice(i,1),e)for(var i=0;i<this._scene.meshes.length;i++){var r=this._scene.meshes[i];r.parent===this&&(r.parent=null,r.computeWorldMatrix(!0))}else{for(var i=0;i<this._scene.particleSystems.length;i++)this._scene.particleSystems[i].emitter==this&&(this._scene.particleSystems[i].dispose(),i--);for(var n=this._scene.meshes.slice(0),i=0;i<n.length;i++)n[i].parent==this&&n[i].dispose()}this._isDisposed=!0,this.onDispose&&this.onDispose()},BABYLON.Mesh.prototype.setPhysicsState=function(e){return this._scene._physicsEngine?(e.impostor=e.impostor||BABYLON.PhysicsEngine.NoImpostor,e.mass=e.mass||0,e.friction=e.friction||.2,e.restitution=e.restitution||.9,this._physicImpostor=e.impostor,this._physicsMass=e.mass,this._physicsFriction=e.friction,this._physicRestitution=e.restitution,e.impostor===BABYLON.PhysicsEngine.NoImpostor?void this._scene._physicsEngine._unregisterMesh(this):void this._scene._physicsEngine._registerMesh(this,e)):void 0},BABYLON.Mesh.prototype.getPhysicsImpostor=function(){return this._physicImpostor?this._physicImpostor:BABYLON.PhysicsEngine.NoImpostor},BABYLON.Mesh.prototype.getPhysicsMass=function(){return this._physicsMass?this._physicsMass:0},BABYLON.Mesh.prototype.getPhysicsFriction=function(){return this._physicsFriction?this._physicsFriction:0},BABYLON.Mesh.prototype.getPhysicsRestitution=function(){return this._physicRestitution?this._physicRestitution:0},BABYLON.Mesh.prototype.applyImpulse=function(e,t){this._physicImpostor&&this._scene._physicsEngine._applyImpulse(this,e,t)},BABYLON.Mesh.prototype.setPhysicsLinkWith=function(e,t,i){this._physicImpostor&&this._scene._physicsEngine._createLink(this,e,t,i)},BABYLON.Mesh.prototype.convertToFlatShadedMesh=function(){for(var e=this.getVerticesDataKinds(),t=[],i=[],r=[],n=!1,o=0;o<e.length;o++){var s=e[o];s!==BABYLON.VertexBuffer.NormalKind?(t[s]=this.getVertexBuffer(s),i[s]=t[s].getData(),r[s]=[]):(n=this.getVertexBuffer(s).isUpdatable(),e.splice(o,1),o--)}for(var a=this.subMeshes.slice(0),h=this.getIndices(),c=0;c<h.length;c++)for(var l=h[c],o=0;o<e.length;o++)for(var s=e[o],u=t[s].getStrideSize(),f=0;u>f;f++)r[s].push(i[s][l*u+f]);for(var B=[],p=r[BABYLON.VertexBuffer.PositionKind],c=0;c<h.length;c+=3){h[c]=c,h[c+1]=c+1,h[c+2]=c+2;for(var d=BABYLON.Vector3.FromArray(p,3*c),m=BABYLON.Vector3.FromArray(p,3*(c+1)),A=BABYLON.Vector3.FromArray(p,3*(c+2)),_=d.subtract(m),v=A.subtract(m),g=BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(_,v)),L=0;3>L;L++)B.push(g.x),B.push(g.y),B.push(g.z)}this.setIndices(h),this.setVerticesData(B,BABYLON.VertexBuffer.NormalKind,n);for(var o=0;o<e.length;o++){var s=e[o];this.setVerticesData(r[s],s,t[s].isUpdatable())}this.subMeshes=[];for(var O=0;O<a.length;O++){var N=a[O];new BABYLON.SubMesh(N.materialIndex,N.indexStart,N.indexCount,N.indexStart,N.indexCount,this)}},BABYLON.Mesh.CreateBox=function(e,t,i,r){var n=new BABYLON.Mesh(e,i),o=BABYLON.VertexData.CreateBox(t);return o.applyToMesh(n,r),n},BABYLON.Mesh.CreateSphere=function(e,t,i,r,n){var o=new BABYLON.Mesh(e,r),s=BABYLON.VertexData.CreateSphere(t,i);return s.applyToMesh(o,n),o},BABYLON.Mesh.CreateCylinder=function(e,t,i,r,n,o,s){var a=new BABYLON.Mesh(e,o),h=BABYLON.VertexData.CreateCylinder(t,i,r,n);return h.applyToMesh(a,s),a},BABYLON.Mesh.CreateTorus=function(e,t,i,r,n,o){var s=new BABYLON.Mesh(e,n),a=BABYLON.VertexData.CreateTorus(t,i,r);return a.applyToMesh(s,o),s},BABYLON.Mesh.CreatePlane=function(e,t,i,r){var n=new BABYLON.Mesh(e,i),o=BABYLON.VertexData.CreatePlane(t);return o.applyToMesh(n,r),n},BABYLON.Mesh.CreateGround=function(e,t,i,r,n,o){var s=new BABYLON.Mesh(e,n),a=BABYLON.VertexData.CreateGround(t,i,r);return a.applyToMesh(s,o),s},BABYLON.Mesh.CreateGroundFromHeightMap=function(e,t,i,r,n,o,s,a,h){var c=new BABYLON.Mesh(e,a),l=function(e){var t,a,l=[],u=[],f=[],B=[],p=document.createElement("canvas"),d=p.getContext("2d"),m=e.width,A=e.height;p.width=m,p.height=A,d.drawImage(e,0,0);var _=d.getImageData(0,0,m,A).data;for(t=0;n>=t;t++)for(a=0;n>=a;a++){var v=new BABYLON.Vector3(a*i/n-i/2,0,(n-t)*r/n-r/2),g=(v.x+i/2)/i*(m-1)|0,L=(1-(v.z+r/2)/r)*(A-1)|0,O=4*(g+L*m),N=_[O]/255,y=_[O+1]/255,x=_[O+2]/255,Y=.3*N+.59*y+.11*x;v.y=o+(s-o)*Y,u.push(v.x,v.y,v.z),f.push(0,0,0),B.push(a/n,1-t/n)}for(t=0;n>t;t++)for(a=0;n>a;a++)l.push(a+1+(t+1)*(n+1)),l.push(a+1+t*(n+1)),l.push(a+t*(n+1)),l.push(a+(t+1)*(n+1)),l.push(a+1+(t+1)*(n+1)),l.push(a+t*(n+1));BABYLON.Mesh.ComputeNormal(u,f,l),c.setVerticesData(u,BABYLON.VertexBuffer.PositionKind,h),c.setVerticesData(f,BABYLON.VertexBuffer.NormalKind,h),c.setVerticesData(B,BABYLON.VertexBuffer.UVKind,h),c.setIndices(l),c._isReady=!0};return BABYLON.Tools.LoadImage(t,l,a.database),c._isReady=!1,c},BABYLON.Mesh.ComputeNormal=function(e,t,i){var r,n=[],o=[];for(r=0;r<e.length;r+=3){var s=new BABYLON.Vector3(e[r],e[r+1],e[r+2]);n.push(s),o.push([])}var a=[];for(r=0;r<i.length/3;r++){var h=i[3*r],c=i[3*r+1],l=i[3*r+2],u=n[h],f=n[c],B=n[l],p=u.subtract(f),d=B.subtract(f);a[r]=BABYLON.Vector3.Normalize(BABYLON.Vector3.Cross(p,d)),o[h].push(r),o[c].push(r),o[l].push(r)}for(r=0;r<n.length;r++){for(var m=o[r],A=BABYLON.Vector3.Zero(),_=0;_<m.length;_++)A.addInPlace(a[m[_]]);A=BABYLON.Vector3.Normalize(A.scale(1/m.length)),t[3*r]=A.x,t[3*r+1]=A.y,t[3*r+2]=A.z}},BABYLON.Mesh.MinMax=function(e){var t,i;for(var r in e){var n=e[r],o=n.getBoundingInfo().boundingBox;t?(t.MinimizeInPlace(o.minimumWorld),i.MaximizeInPlace(o.maximumWorld)):(t=o.minimumWorld,i=o.maximumWorld)}return{min:t,max:i}},BABYLON.Mesh.Center=function(e){var t=void 0!==e.min?e:BABYLON.Mesh.MinMax(e);return BABYLON.Vector3.Center(t.min,t.max)}}();var BABYLON=BABYLON||{};!function(){BABYLON.SubMesh=function(e,t,i,r,n,o){this._mesh=o,o.subMeshes.push(this),this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=n,this.refreshBoundingInfo()},BABYLON.SubMesh.prototype.getBoundingInfo=function(){return this._boundingInfo},BABYLON.SubMesh.prototype.getMesh=function(){return this._mesh},BABYLON.SubMesh.prototype.getMaterial=function(){var e=this._mesh.material;return e&&e.getSubMaterial?e.getSubMaterial(this.materialIndex):e?e:this._mesh._scene.defaultMaterial},BABYLON.SubMesh.prototype.refreshBoundingInfo=function(){var e=this._mesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(e){var t=BABYLON.Tools.ExtractMinAndMax(e,this.verticesStart,this.verticesCount);this._boundingInfo=new BABYLON.BoundingInfo(t.minimum,t.maximum)}},BABYLON.SubMesh.prototype._checkCollision=function(e){return this._boundingInfo._checkCollision(e)},BABYLON.SubMesh.prototype.updateBoundingInfo=function(e,t){this._boundingInfo._update(e,t)},BABYLON.SubMesh.prototype.isInFrustum=function(e){return this._boundingInfo.isInFrustum(e)},BABYLON.SubMesh.prototype.render=function(){this._mesh.render(this)},BABYLON.SubMesh.prototype.getLinesIndexBuffer=function(e,t){if(!this._linesIndexBuffer){for(var i=[],r=this.indexStart;r<this.indexStart+this.indexCount;r+=3)i.push(e[r],e[r+1],e[r+1],e[r+2],e[r+2],e[r]);this._linesIndexBuffer=t.createIndexBuffer(i),this.linesIndexCount=i.length}return this._linesIndexBuffer},BABYLON.SubMesh.prototype.canIntersects=function(e){return e.intersectsBox(this._boundingInfo.boundingBox)},BABYLON.SubMesh.prototype.intersects=function(e,t,i,r){for(var n=null,o=this.indexStart;o<this.indexStart+this.indexCount;o+=3){var s=t[i[o]],a=t[i[o+1]],h=t[i[o+2]],c=e.intersectsTriangle(s,a,h);if(c&&(r||!n||c.distance<n.distance)&&(n=c,n.faceId=o/3,r))break}return n},BABYLON.SubMesh.prototype.clone=function(e){return new BABYLON.SubMesh(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e)},BABYLON.SubMesh.CreateFromIndices=function(e,t,i,r){for(var n=Number.MAX_VALUE,o=-Number.MAX_VALUE,s=r.getIndices(),a=t;t+i>a;a++){var h=s[a];n>h?n=h:h>o&&(o=h)}return new BABYLON.SubMesh(e,n,o-n,t,i,r)}}();var BABYLON=BABYLON||{};!function(){BABYLON.BaseTexture=function(e,t){this._scene=t,this._scene.textures.push(this)},BABYLON.BaseTexture.prototype.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NONE,BABYLON.BaseTexture.prototype.hasAlpha=!1,BABYLON.BaseTexture.prototype.level=1,BABYLON.BaseTexture.prototype._texture=null,BABYLON.BaseTexture.prototype.onDispose=null,BABYLON.BaseTexture.prototype.getInternalTexture=function(){return this._texture},BABYLON.BaseTexture.prototype.isReady=function(){return this.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NOTLOADED?!0:this._texture?this._texture.isReady:!1},BABYLON.BaseTexture.prototype.getSize=function(){return this._texture._width?{width:this._texture._width,height:this._texture._height}:this._texture._size?{width:this._texture._size,height:this._texture._size}:{width:0,height:0}},BABYLON.BaseTexture.prototype.getBaseSize=function(){return this.isReady()?this._texture._size?{width:this._texture._size,height:this._texture._size}:{width:this._texture._baseWidth,height:this._texture._baseHeight}:{width:0,height:0}},BABYLON.BaseTexture.prototype._getFromCache=function(e,t){for(var i=this._scene.getEngine().getLoadedTexturesCache(),r=0;r<i.length;r++){var n=i[r];if(n.url===e&&n.noMipmap===t)return n.references++,n}return null},BABYLON.BaseTexture.prototype.delayLoad=function(){},BABYLON.BaseTexture.prototype.releaseInternalTexture=function(){if(this._texture){var e=this._scene.getEngine().getLoadedTexturesCache();if(this._texture.references--,0==this._texture.references){var t=e.indexOf(this._texture);e.splice(t,1),this._scene.getEngine()._releaseTexture(this._texture),delete this._texture}}},BABYLON.BaseTexture.prototype.dispose=function(){var e=this._scene.textures.indexOf(this);e>=0&&this._scene.textures.splice(e,1),void 0!==this._texture&&(this.releaseInternalTexture(),this.onDispose&&this.onDispose())}}();var BABYLON=BABYLON||{};!function(){BABYLON.Texture=function(e,t,i,r){this._scene=t,this._scene.textures.push(this),this.name=e,this.url=e,this._noMipmap=i,this._invertY=r,this._texture=this._getFromCache(e,i),this._texture||(t.useDelayedTextureLoading?this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=t.getEngine().createTexture(e,i,r,t)),this.animations=[]},BABYLON.Texture.prototype=Object.create(BABYLON.BaseTexture.prototype),BABYLON.Texture.NEAREST_SAMPLINGMODE=1,BABYLON.Texture.BILINEAR_SAMPLINGMODE=2,BABYLON.Texture.TRILINEAR_SAMPLINGMODE=3,BABYLON.Texture.EXPLICIT_MODE=0,BABYLON.Texture.SPHERICAL_MODE=1,BABYLON.Texture.PLANAR_MODE=2,BABYLON.Texture.CUBIC_MODE=3,BABYLON.Texture.PROJECTION_MODE=4,BABYLON.Texture.SKYBOX_MODE=5,BABYLON.Texture.CLAMP_ADDRESSMODE=0,BABYLON.Texture.WRAP_ADDRESSMODE=1,BABYLON.Texture.MIRROR_ADDRESSMODE=2,BABYLON.Texture.prototype.uOffset=0,BABYLON.Texture.prototype.vOffset=0,BABYLON.Texture.prototype.uScale=1,BABYLON.Texture.prototype.vScale=1,BABYLON.Texture.prototype.uAng=0,BABYLON.Texture.prototype.vAng=0,BABYLON.Texture.prototype.wAng=0,BABYLON.Texture.prototype.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE,BABYLON.Texture.prototype.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE,BABYLON.Texture.prototype.coordinatesIndex=0,BABYLON.Texture.prototype.coordinatesMode=BABYLON.Texture.EXPLICIT_MODE,BABYLON.Texture.prototype.anisotropicFilteringLevel=4,BABYLON.Texture.prototype.delayLoad=function(){this.delayLoadState==BABYLON.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this._scene.getEngine().createTexture(this.url,this._noMipmap,this._invertY,this._scene)))},BABYLON.Texture.prototype._prepareRowForTextureGeneration=function(e,t,i,r){e-=this.uOffset+.5,t-=this.vOffset+.5,i-=.5,BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,r),r.x*=this.uScale,r.y*=this.vScale,r.x+=.5,r.y+=.5,r.z+=.5},BABYLON.Texture.prototype._computeTextureMatrix=function(){return this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng?this._cachedTextureMatrix:(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedTextureMatrix||(this._cachedTextureMatrix=BABYLON.Matrix.Zero(),this._rowGenerationMatrix=new BABYLON.Matrix,this._t0=BABYLON.Vector3.Zero(),this._t1=BABYLON.Vector3.Zero(),this._t2=BABYLON.Vector3.Zero()),BABYLON.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),BABYLON.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix.m[0]=this._t1.x,this._cachedTextureMatrix.m[1]=this._t1.y,this._cachedTextureMatrix.m[2]=this._t1.z,this._cachedTextureMatrix.m[4]=this._t2.x,this._cachedTextureMatrix.m[5]=this._t2.y,this._cachedTextureMatrix.m[6]=this._t2.z,this._cachedTextureMatrix.m[8]=this._t0.x,this._cachedTextureMatrix.m[9]=this._t0.y,this._cachedTextureMatrix.m[10]=this._t0.z,this._cachedTextureMatrix)},BABYLON.Texture.prototype._computeReflectionTextureMatrix=function(){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)return this._cachedTextureMatrix;switch(this._cachedTextureMatrix||(this._cachedTextureMatrix=BABYLON.Matrix.Zero(),this._projectionModeMatrix=BABYLON.Matrix.Zero()),this.coordinatesMode){case BABYLON.Texture.SPHERICAL_MODE:BABYLON.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=-.5*this.uScale,this._cachedTextureMatrix[5]=-.5*this.vScale,this._cachedTextureMatrix[12]=.5+this.uOffset,this._cachedTextureMatrix[13]=.5+this.vOffset;break;case BABYLON.Texture.PLANAR_MODE:BABYLON.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break;case BABYLON.Texture.PROJECTION_MODE:BABYLON.Matrix.IdentityToRef(this._projectionModeMatrix),this._projectionModeMatrix.m[0]=.5,this._projectionModeMatrix.m[5]=-.5,this._projectionModeMatrix.m[10]=0,this._projectionModeMatrix.m[12]=.5,this._projectionModeMatrix.m[13]=.5,this._projectionModeMatrix.m[14]=1,this._projectionModeMatrix.m[15]=1,this._scene.getProjectionMatrix().multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:BABYLON.Matrix.IdentityToRef(this._cachedTextureMatrix)}return this._cachedTextureMatrix},BABYLON.Texture.prototype.clone=function(){var e=new BABYLON.Texture(this._texture.url,this._scene,this._noMipmap,this._invertY);return e.hasAlpha=this.hasAlpha,e.level=this.level,e.uOffset=this.uOffset,e.vOffset=this.vOffset,e.uScale=this.uScale,e.vScale=this.vScale,e.uAng=this.uAng,e.vAng=this.vAng,e.wAng=this.wAng,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}}();var BABYLON=BABYLON||{};!function(){BABYLON.CubeTexture=function(e,t,i,r){this._scene=t,this._scene.textures.push(this),this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.coordinatesMode=BABYLON.Texture.CUBIC_MODE,this._texture=this._getFromCache(e,r),i||(i=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._extensions=i,this._texture||(t.useDelayedTextureLoading?this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=t.getEngine().createCubeTexture(e,t,i,r)),this.isCube=!0,this._textureMatrix=BABYLON.Matrix.Identity()},BABYLON.CubeTexture.prototype=Object.create(BABYLON.BaseTexture.prototype),BABYLON.CubeTexture.prototype.delayLoad=function(){this.delayLoadState==BABYLON.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this._scene.getEngine().createCubeTexture(this.url,this._scene,this._extensions)))},BABYLON.CubeTexture.prototype._computeReflectionTextureMatrix=function(){return this._textureMatrix}}();var BABYLON=BABYLON||{};!function(){BABYLON.RenderTargetTexture=function(e,t,i,r){this._scene=i,this._scene.textures.push(this),this.name=e,this._size=t,this._generateMipMaps=r,this._texture=i.getEngine().createRenderTargetTexture(t,r),this.renderList=[],this._renderingManager=new BABYLON.RenderingManager(i)},BABYLON.RenderTargetTexture.prototype=Object.create(BABYLON.Texture.prototype),BABYLON.RenderTargetTexture.prototype.renderParticles=!0,BABYLON.RenderTargetTexture.prototype.renderSprites=!1,BABYLON.RenderTargetTexture.prototype.isRenderTarget=!0,BABYLON.RenderTargetTexture.prototype.coordinatesMode=BABYLON.Texture.PROJECTION_MODE,BABYLON.RenderTargetTexture.prototype.onBeforeRender=null,BABYLON.RenderTargetTexture.prototype.onAfterRender=null,BABYLON.RenderTargetTexture.prototype.resize=function(e,t){this.releaseInternalTexture(),this._texture=this._scene.getEngine().createRenderTargetTexture(e,t)},BABYLON.RenderTargetTexture.prototype.render=function(){this.onBeforeRender&&this.onBeforeRender();var e=this._scene,t=e.getEngine();if(this._waitingRenderList){this.renderList=[];for(var i=0;i<this._waitingRenderList.length;i++){var r=this._waitingRenderList[i];this.renderList.push(this._scene.getMeshByID(r))}delete this._waitingRenderList}if(!this.renderList||0==this.renderList.length)return void(this.onAfterRender&&this.onAfterRender());t.bindFramebuffer(this._texture),t.clear(e.clearColor,!0,!0),this._renderingManager.reset();for(var n=0;n<this.renderList.length;n++){var o=this.renderList[n];if(o&&o.isEnabled()&&o.isVisible)for(var s=0;s<o.subMeshes.length;s++){var a=o.subMeshes[s];e._activeVertices+=a.verticesCount,this._renderingManager.dispatch(a)}}this._renderingManager.render(this.customRenderFunction,this.renderList,this.renderParticles,this.renderSprites),t.unBindFramebuffer(this._texture),this.onAfterRender&&this.onAfterRender()},BABYLON.RenderTargetTexture.prototype.clone=function(){var e=this.getSize(),t=new BABYLON.RenderTargetTexture(this.name,e.width,this._scene,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.renderList=this.renderList.slice(0),t}}();var BABYLON=BABYLON||{};!function(){BABYLON.MirrorTexture=function(e,t,i,r){BABYLON.RenderTargetTexture.call(this,e,t,i,r),this._transformMatrix=BABYLON.Matrix.Zero(),this._mirrorMatrix=BABYLON.Matrix.Zero()},BABYLON.MirrorTexture.prototype=Object.create(BABYLON.RenderTargetTexture.prototype),BABYLON.MirrorTexture.prototype.mirrorPlane=new BABYLON.Plane(0,1,0,1),BABYLON.MirrorTexture.prototype.onBeforeRender=function(){var e=this._scene;BABYLON.Matrix.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._savedViewMatrix=e.getViewMatrix(),this._mirrorMatrix.multiplyToRef(this._savedViewMatrix,this._transformMatrix),e.setTransformMatrix(this._transformMatrix,e.getProjectionMatrix()),BABYLON.clipPlane=this.mirrorPlane,e.getEngine().cullBackFaces=!1},BABYLON.MirrorTexture.prototype.onAfterRender=function(){var e=this._scene;e.setTransformMatrix(this._savedViewMatrix,e.getProjectionMatrix()),e.getEngine().cullBackFaces=!0,delete BABYLON.clipPlane},BABYLON.MirrorTexture.prototype.clone=function(){var e=this.getSize(),t=new BABYLON.MirrorTexture(this.name,e.width,this._scene,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.mirrorPlane=this.mirrorPlane.clone(),t.renderList=this.renderList.slice(0),t}}();var BABYLON=BABYLON||{};!function(){BABYLON.DynamicTexture=function(e,t,i,r){this._scene=i,this._scene.textures.push(this),this.name=e,this.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE,this.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE,this._generateMipMaps=r,t.getContext?(this._canvas=t,this._texture=i.getEngine().createDynamicTexture(t.width,t.height,r)):(this._canvas=document.createElement("canvas"),this._texture=t.width?i.getEngine().createDynamicTexture(t.width,t.height,r):i.getEngine().createDynamicTexture(t,t,r));var n=this.getSize();this._canvas.width=n.width,this._canvas.height=n.height,this._context=this._canvas.getContext("2d")},BABYLON.DynamicTexture.prototype=Object.create(BABYLON.Texture.prototype),BABYLON.DynamicTexture.prototype.getContext=function(){return this._context},BABYLON.DynamicTexture.prototype.update=function(e){this._scene.getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e?!0:e)},BABYLON.DynamicTexture.prototype.drawText=function(e,t,i,r,n,o,s){var a=this.getSize();if(o&&(this._context.fillStyle=o,this._context.fillRect(0,0,a.width,a.height)),this._context.font=r,null===t){var h=this._context.measureText(e);t=(a.width-h.width)/2}this._context.fillStyle=n,this._context.fillText(e,t,i),this.update(s)},BABYLON.DynamicTexture.prototype.clone=function(){var e=this.getSize(),t=new BABYLON.DynamicTexture(this.name,e.width,this._scene,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t}}();var BABYLON=BABYLON||{};!function(){BABYLON.VideoTexture=function(e,t,i,r,n,o){this._scene=r,this._scene.textures.push(this),this.name=e,this._invertY=o,this.wrapU=BABYLON.Texture.WRAP_ADDRESSMODE,this.wrapV=BABYLON.Texture.WRAP_ADDRESSMODE,this._texture=r.getEngine().createDynamicTexture(i,i,n);var s=this.getSize();this.video=document.createElement("video"),this.video.width=s.width,this.video.height=s.height,this.video.autoplay=!1,this.video.loop=!0,this.video.preload=!0,this._autoLaunch=!0;var a=this;this.video.addEventListener("canplaythrough",function(){a._texture&&(a._texture.isReady=!0)}),t.forEach(function(e){var t=document.createElement("source");t.src=e,a.video.appendChild(t)}),this._lastUpdate=new Date},BABYLON.VideoTexture.prototype=Object.create(BABYLON.Texture.prototype),BABYLON.VideoTexture.prototype._update=function(){this._autoLaunch&&(this._autoLaunch=!1,this.video.play());var e=new Date;return e-this._lastUpdate<15?!1:(this._lastUpdate=e,this._scene.getEngine().updateVideoTexture(this._texture,this.video,this._invertY),!0)}}();var BABYLON=BABYLON||{};!function(){BABYLON.Effect=function(e,t,i,r,n,o,s){this._engine=n,this.name=e,this.defines=o,this._uniformsNames=i.concat(r),this._samplers=r,this._isReady=!1,this._compilationError="",this._attributesNames=t;var a,h;e.vertexElement?(a=document.getElementById(e.vertexElement),h=document.getElementById(e.fragmentElement)):(a=e.vertexElement||e.vertex||e,h=e.fragmentElement||e.fragment||e);var c=this;this._loadVertexShader(a,function(e){c._loadFragmentShader(h,function(i){c._prepareEffect(e,i,t,o,s)})}),this._valueCache=[]},BABYLON.Effect.prototype.isReady=function(){return this._isReady},BABYLON.Effect.prototype.getProgram=function(){return this._program},BABYLON.Effect.prototype.getAttributesNames=function(){return this._attributesNames},BABYLON.Effect.prototype.getAttribute=function(e){return this._attributes[e]},BABYLON.Effect.prototype.getAttributesCount=function(){return this._attributes.length},BABYLON.Effect.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},BABYLON.Effect.prototype.getUniform=function(e){return this._uniforms[this._uniformsNames.indexOf(e)]},BABYLON.Effect.prototype.getSamplers=function(){return this._samplers
},BABYLON.Effect.prototype.getCompilationError=function(){return this._compilationError},BABYLON.Effect.prototype._loadVertexShader=function(e,t){if(e instanceof HTMLElement){var i=BABYLON.Tools.GetDOMTextContent(e);return void t(i)}if(BABYLON.Effect.ShadersStore[e+"VertexShader"])return void t(BABYLON.Effect.ShadersStore[e+"VertexShader"]);var r;r="."===e[0]?e:BABYLON.Engine.ShadersRepository+e,BABYLON.Tools.LoadFile(r+".vertex.fx",t)},BABYLON.Effect.prototype._loadFragmentShader=function(e,t){if(e instanceof HTMLElement){var i=BABYLON.Tools.GetDOMTextContent(e);return void t(i)}if(BABYLON.Effect.ShadersStore[e+"PixelShader"])return void t(BABYLON.Effect.ShadersStore[e+"PixelShader"]);var r;r="."===e[0]?e:BABYLON.Engine.ShadersRepository+e,BABYLON.Tools.LoadFile(r+".fragment.fx",t)},BABYLON.Effect.prototype._prepareEffect=function(e,t,i,r,n,o){try{var s=this._engine;this._program=s.createShaderProgram(e,t,r),this._uniforms=s.getUniforms(this._program,this._uniformsNames),this._attributes=s.getAttributes(this._program,i);for(var a=0;a<this._samplers.length;a++){var h=this.getUniform(this._samplers[a]);null==h&&(this._samplers.splice(a,1),a--)}s.bindSamplers(this),this._isReady=!0}catch(c){if(!o&&n){for(var a=0;a<n.length;a++)r=r.replace(n[a],"");this._prepareEffect(e,t,i,r,n,!0)}else console.error("Unable to compile effect: "+this.name),console.error("Defines: "+r),console.error("Optional defines: "+n),this._compilationError=c.message}},BABYLON.Effect.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers.indexOf(e),t)},BABYLON.Effect.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers.indexOf(e),t)},BABYLON.Effect.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers.indexOf(e),t)},BABYLON.Effect.prototype._cacheFloat2=function(e,t,i){return this._valueCache[e]?(this._valueCache[e][0]=t,void(this._valueCache[e][1]=i)):void(this._valueCache[e]=[t,i])},BABYLON.Effect.prototype._cacheFloat3=function(e,t,i,r){return this._valueCache[e]?(this._valueCache[e][0]=t,this._valueCache[e][1]=i,void(this._valueCache[e][2]=r)):void(this._valueCache[e]=[t,i,r])},BABYLON.Effect.prototype._cacheFloat4=function(e,t,i,r,n){return this._valueCache[e]?(this._valueCache[e][0]=t,this._valueCache[e][1]=i,this._valueCache[e][2]=r,void(this._valueCache[e][3]=n)):void(this._valueCache[e]=[t,i,r,n])},BABYLON.Effect.prototype.setArray=function(e,t){return this._engine.setArray(this.getUniform(e),t),this},BABYLON.Effect.prototype.setMatrices=function(e,t){return this._engine.setMatrices(this.getUniform(e),t),this},BABYLON.Effect.prototype.setMatrix=function(e,t){return this._engine.setMatrix(this.getUniform(e),t),this},BABYLON.Effect.prototype.setFloat=function(e,t){return this._valueCache[e]&&this._valueCache[e]===t?this:(this._valueCache[e]=t,this._engine.setFloat(this.getUniform(e),t),this)},BABYLON.Effect.prototype.setBool=function(e,t){return this._valueCache[e]&&this._valueCache[e]===t?this:(this._valueCache[e]=t,this._engine.setBool(this.getUniform(e),t),this)},BABYLON.Effect.prototype.setVector2=function(e,t){return this._valueCache[e]&&this._valueCache[e][0]==t.x&&this._valueCache[e][1]==t.y?this:(this._cacheFloat2(e,t.x,t.y),this._engine.setFloat2(this.getUniform(e),t.x,t.y),this)},BABYLON.Effect.prototype.setFloat2=function(e,t,i){return this._valueCache[e]&&this._valueCache[e][0]==t&&this._valueCache[e][1]==i?this:(this._cacheFloat2(e,t,i),this._engine.setFloat2(this.getUniform(e),t,i),this)},BABYLON.Effect.prototype.setVector3=function(e,t){return this._valueCache[e]&&this._valueCache[e][0]==t.x&&this._valueCache[e][1]==t.y&&this._valueCache[e][2]==t.z?this:(this._cacheFloat3(e,t.x,t.y,t.z),this._engine.setFloat3(this.getUniform(e),t.x,t.y,t.z),this)},BABYLON.Effect.prototype.setFloat3=function(e,t,i,r){return this._valueCache[e]&&this._valueCache[e][0]==t&&this._valueCache[e][1]==i&&this._valueCache[e][2]==r?this:(this._cacheFloat3(e,t,i,r),this._engine.setFloat3(this.getUniform(e),t,i,r),this)},BABYLON.Effect.prototype.setFloat4=function(e,t,i,r,n){return this._valueCache[e]&&this._valueCache[e][0]==t&&this._valueCache[e][1]==i&&this._valueCache[e][2]==r&&this._valueCache[e][3]==n?this:(this._cacheFloat4(e,t,i,r,n),this._engine.setFloat4(this.getUniform(e),t,i,r,n),this)},BABYLON.Effect.prototype.setColor3=function(e,t){return this._valueCache[e]&&this._valueCache[e][0]==t.r&&this._valueCache[e][1]==t.g&&this._valueCache[e][2]==t.b?this:(this._cacheFloat3(e,t.r,t.g,t.b),this._engine.setColor3(this.getUniform(e),t),this)},BABYLON.Effect.prototype.setColor4=function(e,t,i){return this._valueCache[e]&&this._valueCache[e][0]==t.r&&this._valueCache[e][1]==t.g&&this._valueCache[e][2]==t.b&&this._valueCache[e][3]==i?this:(this._cacheFloat4(e,t.r,t.g,t.b,i),this._engine.setColor4(this.getUniform(e),t,i),this)},BABYLON.Effect.ShadersStore={}}(),BABYLON.Effect.ShadersStore={anaglyphPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\n\nvoid main(void)\n{\n    vec4 leftFrag = texture2D(leftSampler, vUV);\n    leftFrag = vec4(1.0, leftFrag.g, leftFrag.b, 1.0);\n\n	vec4 rightFrag = texture2D(textureSampler, vUV);\n    rightFrag = vec4(rightFrag.r, 1.0, 1.0, 1.0);\n\n    gl_FragColor = vec4(rightFrag.rgb * leftFrag.rgb, 1.0);\n}",blackAndWhitePixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nvoid main(void) \n{\n	float luminance = dot(texture2D(textureSampler, vUV).rgb, vec3(0.3, 0.59, 0.11));\n	gl_FragColor = vec4(luminance, luminance, luminance, 1.0);\n}",blurPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\n// Parameters\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\n\nvoid main(void)\n{\n	float weights[7];\n	weights[0] = 0.05;\n	weights[1] = 0.1;\n	weights[2] = 0.2;\n	weights[3] = 0.3;\n	weights[4] = 0.2;\n	weights[5] = 0.1;\n	weights[6] = 0.05;\n\n	vec2 texelSize = vec2(1.0 / screenSize.x, 1.0 / screenSize.y);\n	vec2 texelStep = texelSize * direction * blurWidth;\n	vec2 start = vUV - 3.0 * texelStep;\n\n	vec4 baseColor = vec4(0., 0., 0., 0.);\n	vec2 texelOffset = vec2(0., 0.);\n\n	for (int i = 0; i < 7; i++)\n	{\n		baseColor += texture2D(textureSampler, start + texelOffset) * weights[i];\n		texelOffset += texelStep;\n	}\n\n	gl_FragColor = baseColor;\n}",convolutionPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform float kernel[9];\n\nvoid main(void)\n{\n	vec2 onePixel = vec2(1.0, 1.0) / screenSize;\n	vec4 colorSum =\n		texture2D(textureSampler, vUV + onePixel * vec2(-1, -1)) * kernel[0] +\n		texture2D(textureSampler, vUV + onePixel * vec2(0, -1)) * kernel[1] +\n		texture2D(textureSampler, vUV + onePixel * vec2(1, -1)) * kernel[2] +\n		texture2D(textureSampler, vUV + onePixel * vec2(-1, 0)) * kernel[3] +\n		texture2D(textureSampler, vUV + onePixel * vec2(0, 0)) * kernel[4] +\n		texture2D(textureSampler, vUV + onePixel * vec2(1, 0)) * kernel[5] +\n		texture2D(textureSampler, vUV + onePixel * vec2(-1, 1)) * kernel[6] +\n		texture2D(textureSampler, vUV + onePixel * vec2(0, 1)) * kernel[7] +\n		texture2D(textureSampler, vUV + onePixel * vec2(1, 1)) * kernel[8];\n\n	float kernelWeight =\n		kernel[0] +\n		kernel[1] +\n		kernel[2] +\n		kernel[3] +\n		kernel[4] +\n		kernel[5] +\n		kernel[6] +\n		kernel[7] +\n		kernel[8];\n\n	if (kernelWeight <= 0.0) {\n		kernelWeight = 1.0;\n	}\n\n	gl_FragColor = vec4((colorSum / kernelWeight).rgb, 1);\n}",defaultPixelShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n#define MAP_EXPLICIT	0.\r\n#define MAP_SPHERICAL	1.\r\n#define MAP_PLANAR		2.\r\n#define MAP_CUBIC		3.\r\n#define MAP_PROJECTION	4.\r\n#define MAP_SKYBOX		5.\r\n\r\n// Constants\r\nuniform vec3 vEyePosition;\r\nuniform vec3 vAmbientColor;\r\nuniform vec4 vDiffuseColor;\r\nuniform vec4 vSpecularColor;\r\nuniform vec3 vEmissiveColor;\r\n\r\n// Input\r\nvarying vec3 vPositionW;\r\nvarying vec3 vNormalW;\r\n\r\n#ifdef VERTEXCOLOR\r\nvarying vec3 vColor;\r\n#endif\r\n\r\n// Lights\r\n#ifdef LIGHT0\r\nuniform vec4 vLightData0;\r\nuniform vec3 vLightDiffuse0;\r\nuniform vec3 vLightSpecular0;\r\n#ifdef SHADOW0\r\nvarying vec4 vPositionFromLight0;\r\nuniform sampler2D shadowSampler0;\r\nuniform float darkness0;\r\n#endif\r\n#ifdef SPOTLIGHT0\r\nuniform vec4 vLightDirection0;\r\n#endif\r\n#ifdef HEMILIGHT0\r\nuniform vec3 vLightGround0;\r\n#endif\r\n#endif\r\n\r\n#ifdef LIGHT1\r\nuniform vec4 vLightData1;\r\nuniform vec3 vLightDiffuse1;\r\nuniform vec3 vLightSpecular1;\r\n#ifdef SHADOW1\r\nvarying vec4 vPositionFromLight1;\r\nuniform sampler2D shadowSampler1;\r\nuniform float darkness1;\r\n#endif\r\n#ifdef SPOTLIGHT1\r\nuniform vec4 vLightDirection1;\r\n#endif\r\n#ifdef HEMILIGHT1\r\nuniform vec3 vLightGround1;\r\n#endif\r\n#endif\r\n\r\n#ifdef LIGHT2\r\nuniform vec4 vLightData2;\r\nuniform vec3 vLightDiffuse2;\r\nuniform vec3 vLightSpecular2;\r\n#ifdef SHADOW2\r\nvarying vec4 vPositionFromLight2;\r\nuniform sampler2D shadowSampler2;\r\nuniform float darkness2;\r\n#endif\r\n#ifdef SPOTLIGHT2\r\nuniform vec4 vLightDirection2;\r\n#endif\r\n#ifdef HEMILIGHT2\r\nuniform vec3 vLightGround2;\r\n#endif\r\n#endif\r\n\r\n#ifdef LIGHT3\r\nuniform vec4 vLightData3;\r\nuniform vec3 vLightDiffuse3;\r\nuniform vec3 vLightSpecular3;\r\n#ifdef SHADOW3\r\nvarying vec4 vPositionFromLight3;\r\nuniform sampler2D shadowSampler3;\r\nuniform float darkness3;\r\n#endif\r\n#ifdef SPOTLIGHT3\r\nuniform vec4 vLightDirection3;\r\n#endif\r\n#ifdef HEMILIGHT3\r\nuniform vec3 vLightGround3;\r\n#endif\r\n#endif\r\n\r\n// Samplers\r\n#ifdef DIFFUSE\r\nvarying vec2 vDiffuseUV;\r\nuniform sampler2D diffuseSampler;\r\nuniform vec2 vDiffuseInfos;\r\n#endif\r\n\r\n#ifdef AMBIENT\r\nvarying vec2 vAmbientUV;\r\nuniform sampler2D ambientSampler;\r\nuniform vec2 vAmbientInfos;\r\n#endif\r\n\r\n#ifdef OPACITY	\r\nvarying vec2 vOpacityUV;\r\nuniform sampler2D opacitySampler;\r\nuniform vec2 vOpacityInfos;\r\n#endif\r\n\r\n#ifdef EMISSIVE\r\nvarying vec2 vEmissiveUV;\r\nuniform vec2 vEmissiveInfos;\r\nuniform sampler2D emissiveSampler;\r\n#endif\r\n\r\n#ifdef SPECULAR\r\nvarying vec2 vSpecularUV;\r\nuniform vec2 vSpecularInfos;\r\nuniform sampler2D specularSampler;\r\n#endif\r\n\r\n// Reflection\r\n#ifdef REFLECTION\r\nvarying vec3 vPositionUVW;\r\nuniform samplerCube reflectionCubeSampler;\r\nuniform sampler2D reflection2DSampler;\r\nuniform vec3 vReflectionInfos;\r\nuniform mat4 reflectionMatrix;\r\nuniform mat4 view;\r\n\r\nvec3 computeReflectionCoords(float mode, vec4 worldPos, vec3 worldNormal)\r\n{\r\n	if (mode == MAP_SPHERICAL)\r\n	{\r\n		vec3 coords = vec3(view * vec4(worldNormal, 0.0));\r\n\r\n		return vec3(reflectionMatrix * vec4(coords, 1.0));\r\n	}\r\n	else if (mode == MAP_PLANAR)\r\n	{\r\n		vec3 viewDir = worldPos.xyz - vEyePosition;\r\n		vec3 coords = normalize(reflect(viewDir, worldNormal));\r\n\r\n		return vec3(reflectionMatrix * vec4(coords, 1));\r\n	}\r\n	else if (mode == MAP_CUBIC)\r\n	{\r\n		vec3 viewDir = worldPos.xyz - vEyePosition;\r\n		vec3 coords = reflect(viewDir, worldNormal);\r\n\r\n		return vec3(reflectionMatrix * vec4(coords, 0));\r\n	}\r\n	else if (mode == MAP_PROJECTION)\r\n	{\r\n		return vec3(reflectionMatrix * (view * worldPos));\r\n	}\r\n	else if (mode == MAP_SKYBOX)\r\n	{\r\n		return vPositionUVW;\r\n	}\r\n\r\n	return vec3(0, 0, 0);\r\n}\r\n#endif\r\n\r\n// Shadows\r\n#ifdef SHADOWS\r\n\r\nfloat unpack(vec4 color)\r\n{\r\n	const vec4 bitShift = vec4(1. / (255. * 255. * 255.), 1. / (255. * 255.), 1. / 255., 1.);\r\n	return dot(color, bitShift);\r\n}\r\n\r\nfloat unpackHalf(vec2 color)\r\n{\r\n	return color.x + (color.y / 255.0);\r\n}\r\n\r\nfloat computeShadow(vec4 vPositionFromLight, sampler2D shadowSampler, float darkness)\r\n{\r\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\r\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\r\n\r\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\r\n	{\r\n		return 1.0;\r\n	}\r\n\r\n	float shadow = unpack(texture2D(shadowSampler, uv));\r\n\r\n	if (depth.z > shadow)\r\n	{\r\n		return darkness;\r\n	}\r\n	return 1.;\r\n}\r\n\r\n// Thanks to http://devmaster.net/\r\nfloat ChebychevInequality(vec2 moments, float t)\r\n{\r\n	if (t <= moments.x)\r\n	{\r\n		return 1.0;\r\n	}\r\n\r\n	float variance = moments.y - (moments.x * moments.x);\r\n	variance = max(variance, 0.);\r\n\r\n	float d = t - moments.x;\r\n	return variance / (variance + d * d);\r\n}\r\n\r\nfloat computeShadowWithVSM(vec4 vPositionFromLight, sampler2D shadowSampler)\r\n{\r\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\r\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\r\n\r\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\r\n	{\r\n		return 1.0;\r\n	}\r\n\r\n	vec4 texel = texture2D(shadowSampler, uv);\r\n\r\n	vec2 moments = vec2(unpackHalf(texel.xy), unpackHalf(texel.zw));\r\n	return clamp(1.3 - ChebychevInequality(moments, depth.z), 0., 1.0);\r\n}\r\n#endif\r\n\r\n// Bump\r\n#ifdef BUMP\r\n#extension GL_OES_standard_derivatives : enable\r\nvarying vec2 vBumpUV;\r\nuniform vec2 vBumpInfos;\r\nuniform sampler2D bumpSampler;\r\n\r\n// Thanks to http://www.thetenthplanet.de/archives/1180\r\nmat3 cotangent_frame(vec3 normal, vec3 p, vec2 uv)\r\n{\r\n	// get edge vectors of the pixel triangle\r\n	vec3 dp1 = dFdx(p);\r\n	vec3 dp2 = dFdy(p);\r\n	vec2 duv1 = dFdx(uv);\r\n	vec2 duv2 = dFdy(uv);\r\n\r\n	// solve the linear system\r\n	vec3 dp2perp = cross(dp2, normal);\r\n	vec3 dp1perp = cross(normal, dp1);\r\n	vec3 tangent = dp2perp * duv1.x + dp1perp * duv2.x;\r\n	vec3 binormal = dp2perp * duv1.y + dp1perp * duv2.y;\r\n\r\n	// construct a scale-invariant frame \r\n	float invmax = inversesqrt(max(dot(tangent, tangent), dot(binormal, binormal)));\r\n	return mat3(tangent * invmax, binormal * invmax, normal);\r\n}\r\n\r\nvec3 perturbNormal(vec3 viewDir)\r\n{\r\n	vec3 map = texture2D(bumpSampler, vBumpUV).xyz * vBumpInfos.y;\r\n	map = map * 255. / 127. - 128. / 127.;\r\n	mat3 TBN = cotangent_frame(vNormalW, -viewDir, vBumpUV);\r\n	return normalize(TBN * map);\r\n}\r\n#endif\r\n\r\n#ifdef CLIPPLANE\r\nvarying float fClipDistance;\r\n#endif\r\n\r\n// Fog\r\n#ifdef FOG\r\n\r\n#define FOGMODE_NONE    0.\r\n#define FOGMODE_EXP     1.\r\n#define FOGMODE_EXP2    2.\r\n#define FOGMODE_LINEAR  3.\r\n#define E 2.71828\r\n\r\nuniform vec4 vFogInfos;\r\nuniform vec3 vFogColor;\r\nvarying float fFogDistance;\r\n\r\nfloat CalcFogFactor()\r\n{\r\n	float fogCoeff = 1.0;\r\n	float fogStart = vFogInfos.y;\r\n	float fogEnd = vFogInfos.z;\r\n	float fogDensity = vFogInfos.w;\r\n\r\n	if (FOGMODE_LINEAR == vFogInfos.x)\r\n	{\r\n		fogCoeff = (fogEnd - fFogDistance) / (fogEnd - fogStart);\r\n	}\r\n	else if (FOGMODE_EXP == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fogDensity);\r\n	}\r\n	else if (FOGMODE_EXP2 == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fFogDistance * fogDensity * fogDensity);\r\n	}\r\n\r\n	return clamp(fogCoeff, 0.0, 1.0);\r\n}\r\n#endif\r\n\r\n// Light Computing\r\nstruct lightingInfo\r\n{\r\n	vec3 diffuse;\r\n	vec3 specular;\r\n};\r\n\r\nlightingInfo computeLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec3 diffuseColor, vec3 specularColor) {\r\n	lightingInfo result;\r\n\r\n	vec3 lightVectorW;\r\n	if (lightData.w == 0.)\r\n	{\r\n		lightVectorW = normalize(lightData.xyz - vPositionW);\r\n	}\r\n	else\r\n	{\r\n		lightVectorW = normalize(-lightData.xyz);\r\n	}\r\n\r\n	// diffuse\r\n	float ndl = max(0., dot(vNormal, lightVectorW));\r\n\r\n	// Specular\r\n	vec3 angleW = normalize(viewDirectionW + lightVectorW);\r\n	float specComp = max(0., dot(vNormal, angleW));\r\n	specComp = pow(specComp, vSpecularColor.a);\r\n\r\n	result.diffuse = ndl * diffuseColor;\r\n	result.specular = specComp * specularColor;\r\n\r\n	return result;\r\n}\r\n\r\nlightingInfo computeSpotLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec4 lightDirection, vec3 diffuseColor, vec3 specularColor) {\r\n	lightingInfo result;\r\n\r\n	vec3 lightVectorW = normalize(lightData.xyz - vPositionW);\r\n\r\n	// diffuse\r\n	float cosAngle = max(0., dot(-lightDirection.xyz, lightVectorW));\r\n	float spotAtten = 0.0;\r\n\r\n	if (cosAngle >= lightDirection.w)\r\n	{\r\n		cosAngle = max(0., pow(cosAngle, lightData.w));\r\n		spotAtten = max(0., (cosAngle - lightDirection.w) / (1. - cosAngle));\r\n\r\n		// Diffuse\r\n		float ndl = max(0., dot(vNormal, -lightDirection.xyz));\r\n\r\n		// Specular\r\n		vec3 angleW = normalize(viewDirectionW - lightDirection.xyz);\r\n		float specComp = max(0., dot(vNormal, angleW));\r\n		specComp = pow(specComp, vSpecularColor.a);\r\n\r\n		result.diffuse = ndl * spotAtten * diffuseColor;\r\n		result.specular = specComp * specularColor * spotAtten;\r\n\r\n		return result;\r\n	}\r\n\r\n	result.diffuse = vec3(0.);\r\n	result.specular = vec3(0.);\r\n\r\n	return result;\r\n}\r\n\r\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec3 diffuseColor, vec3 specularColor, vec3 groundColor) {\r\n	lightingInfo result;\r\n\r\n	// Diffuse\r\n	float ndl = dot(vNormal, lightData.xyz) * 0.5 + 0.5;\r\n\r\n	// Specular\r\n	vec3 angleW = normalize(viewDirectionW + lightData.xyz);\r\n	float specComp = max(0., dot(vNormal, angleW));\r\n	specComp = pow(specComp, vSpecularColor.a);\r\n\r\n	result.diffuse = mix(groundColor, diffuseColor, ndl);\r\n	result.specular = specComp * specularColor;\r\n\r\n	return result;\r\n}\r\n\r\nvoid main(void) {\r\n	// Clip plane\r\n#ifdef CLIPPLANE\r\n	if (fClipDistance > 0.0)\r\n		discard;\r\n#endif\r\n\r\n	vec3 viewDirectionW = normalize(vEyePosition - vPositionW);\r\n\r\n	// Base color\r\n	vec4 baseColor = vec4(1., 1., 1., 1.);\r\n	vec3 diffuseColor = vDiffuseColor.rgb;\r\n\r\n#ifdef VERTEXCOLOR\r\n	diffuseColor *= vColor;\r\n#endif\r\n\r\n#ifdef DIFFUSE\r\n	baseColor = texture2D(diffuseSampler, vDiffuseUV);\r\n\r\n#ifdef ALPHATEST\r\n	if (baseColor.a < 0.4)\r\n		discard;\r\n#endif\r\n\r\n	baseColor.rgb *= vDiffuseInfos.y;\r\n#endif\r\n\r\n	// Bump\r\n	vec3 normalW = vNormalW;\r\n\r\n#ifdef BUMP\r\n	normalW = perturbNormal(viewDirectionW);\r\n#endif\r\n\r\n	// Ambient color\r\n	vec3 baseAmbientColor = vec3(1., 1., 1.);\r\n\r\n#ifdef AMBIENT\r\n	baseAmbientColor = texture2D(ambientSampler, vAmbientUV).rgb * vAmbientInfos.y;\r\n#endif\r\n\r\n	// Lighting\r\n	vec3 diffuseBase = vec3(0., 0., 0.);\r\n	vec3 specularBase = vec3(0., 0., 0.);\r\n	float shadow = 1.;\r\n\r\n#ifdef LIGHT0\r\n#ifdef SPOTLIGHT0\r\n	lightingInfo info = computeSpotLighting(viewDirectionW, normalW, vLightData0, vLightDirection0, vLightDiffuse0, vLightSpecular0);\r\n#endif\r\n#ifdef HEMILIGHT0\r\n	lightingInfo info = computeHemisphericLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0, vLightSpecular0, vLightGround0);\r\n#endif\r\n#ifdef POINTDIRLIGHT0\r\n	lightingInfo info = computeLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0, vLightSpecular0);\r\n#endif\r\n#ifdef SHADOW0\r\n#ifdef SHADOWVSM0\r\n	shadow = computeShadowWithVSM(vPositionFromLight0, shadowSampler0);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight0, shadowSampler0, darkness0);\r\n#endif\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n#ifdef LIGHT1\r\n#ifdef SPOTLIGHT1\r\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData1, vLightDirection1, vLightDiffuse1, vLightSpecular1);\r\n#endif\r\n#ifdef HEMILIGHT1\r\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1, vLightSpecular1, vLightGround1);\r\n#endif\r\n#ifdef POINTDIRLIGHT1\r\n	info = computeLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1, vLightSpecular1);\r\n#endif\r\n#ifdef SHADOW1\r\n#ifdef SHADOWVSM1\r\n	shadow = computeShadowWithVSM(vPositionFromLight1, shadowSampler1);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight1, shadowSampler1, darkness1);\r\n#endif\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n#ifdef LIGHT2\r\n#ifdef SPOTLIGHT2\r\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData2, vLightDirection2, vLightDiffuse2, vLightSpecular2);\r\n#endif\r\n#ifdef HEMILIGHT2\r\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2, vLightSpecular2, vLightGround2);\r\n#endif\r\n#ifdef POINTDIRLIGHT2\r\n	info = computeLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2, vLightSpecular2);\r\n#endif\r\n#ifdef SHADOW2\r\n#ifdef SHADOWVSM2\r\n	shadow = computeShadowWithVSM(vPositionFromLight2, shadowSampler2);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight2, shadowSampler2, darkness2);\r\n#endif	\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n#ifdef LIGHT3\r\n#ifdef SPOTLIGHT3\r\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData3, vLightDirection3, vLightDiffuse3, vLightSpecular3);\r\n#endif\r\n#ifdef HEMILIGHT3\r\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3, vLightSpecular3, vLightGround3);\r\n#endif\r\n#ifdef POINTDIRLIGHT3\r\n	info = computeLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3, vLightSpecular3);\r\n#endif\r\n#ifdef SHADOW3\r\n#ifdef SHADOWVSM3\r\n	shadow = computeShadowWithVSM(vPositionFromLight3, shadowSampler3);\r\n#else\r\n	shadow = computeShadow(vPositionFromLight3, shadowSampler3, darkness3);\r\n#endif	\r\n#else\r\n	shadow = 1.;\r\n#endif\r\n	diffuseBase += info.diffuse * shadow;\r\n	specularBase += info.specular * shadow;\r\n#endif\r\n\r\n	// Reflection\r\n	vec3 reflectionColor = vec3(0., 0., 0.);\r\n\r\n#ifdef REFLECTION\r\n	vec3 vReflectionUVW = computeReflectionCoords(vReflectionInfos.x, vec4(vPositionW, 1.0), normalW);\r\n\r\n	if (vReflectionInfos.z != 0.0)\r\n	{\r\n		reflectionColor = textureCube(reflectionCubeSampler, vReflectionUVW).rgb * vReflectionInfos.y;\r\n	}\r\n	else\r\n	{\r\n		vec2 coords = vReflectionUVW.xy;\r\n\r\n		if (vReflectionInfos.x == MAP_PROJECTION)\r\n		{\r\n			coords /= vReflectionUVW.z;\r\n		}\r\n\r\n		coords.y = 1.0 - coords.y;\r\n\r\n		reflectionColor = texture2D(reflection2DSampler, coords).rgb * vReflectionInfos.y;\r\n	}\r\n#endif\r\n\r\n	// Alpha\r\n	float alpha = vDiffuseColor.a;\r\n\r\n#ifdef OPACITY\r\n	vec4 opacityMap = texture2D(opacitySampler, vOpacityUV);\r\n	opacityMap.rgb = opacityMap.rgb * vec3(0.3, 0.59, 0.11) * opacityMap.a;\r\n	alpha *= (opacityMap.x + opacityMap.y + opacityMap.z)* vOpacityInfos.y;\r\n#endif\r\n\r\n	// Emissive\r\n	vec3 emissiveColor = vEmissiveColor;\r\n#ifdef EMISSIVE\r\n	emissiveColor += texture2D(emissiveSampler, vEmissiveUV).rgb * vEmissiveInfos.y;\r\n#endif\r\n\r\n	// Specular map\r\n	vec3 specularColor = vSpecularColor.rgb;\r\n#ifdef SPECULAR\r\n	specularColor = texture2D(specularSampler, vSpecularUV).rgb * vSpecularInfos.y;\r\n#endif\r\n\r\n	// Composition\r\n	vec3 finalDiffuse = clamp(diffuseBase * diffuseColor + emissiveColor + vAmbientColor, 0.0, 1.0) * baseColor.rgb;\r\n	vec3 finalSpecular = specularBase * specularColor;\r\n\r\n	vec4 color = vec4(finalDiffuse * baseAmbientColor + finalSpecular + reflectionColor, alpha);\r\n\r\n#ifdef FOG\r\n	float fog = CalcFogFactor();\r\n	color.rgb = fog * color.rgb + (1.0 - fog) * vFogColor;\r\n#endif\r\n\r\n	gl_FragColor = color;\r\n}",defaultVertexShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\n#ifdef UV1\r\nattribute vec2 uv;\r\n#endif\r\n#ifdef UV2\r\nattribute vec2 uv2;\r\n#endif\r\n#ifdef VERTEXCOLOR\r\nattribute vec3 color;\r\n#endif\r\n#ifdef BONES\r\nattribute vec4 matricesIndices;\r\nattribute vec4 matricesWeights;\r\n#endif\r\n\r\n// Uniforms\r\nuniform mat4 world;\r\nuniform mat4 view;\r\nuniform mat4 viewProjection;\r\n\r\n#ifdef DIFFUSE\r\nvarying vec2 vDiffuseUV;\r\nuniform mat4 diffuseMatrix;\r\nuniform vec2 vDiffuseInfos;\r\n#endif\r\n\r\n#ifdef AMBIENT\r\nvarying vec2 vAmbientUV;\r\nuniform mat4 ambientMatrix;\r\nuniform vec2 vAmbientInfos;\r\n#endif\r\n\r\n#ifdef OPACITY\r\nvarying vec2 vOpacityUV;\r\nuniform mat4 opacityMatrix;\r\nuniform vec2 vOpacityInfos;\r\n#endif\r\n\r\n#ifdef EMISSIVE\r\nvarying vec2 vEmissiveUV;\r\nuniform vec2 vEmissiveInfos;\r\nuniform mat4 emissiveMatrix;\r\n#endif\r\n\r\n#ifdef SPECULAR\r\nvarying vec2 vSpecularUV;\r\nuniform vec2 vSpecularInfos;\r\nuniform mat4 specularMatrix;\r\n#endif\r\n\r\n#ifdef BUMP\r\nvarying vec2 vBumpUV;\r\nuniform vec2 vBumpInfos;\r\nuniform mat4 bumpMatrix;\r\n#endif\r\n\r\n#ifdef BONES\r\nuniform mat4 mBones[BonesPerMesh];\r\n#endif\r\n\r\n// Output\r\nvarying vec3 vPositionW;\r\nvarying vec3 vNormalW;\r\n\r\n#ifdef VERTEXCOLOR\r\nvarying vec3 vColor;\r\n#endif\r\n\r\n#ifdef CLIPPLANE\r\nuniform vec4 vClipPlane;\r\nvarying float fClipDistance;\r\n#endif\r\n\r\n#ifdef FOG\r\nvarying float fFogDistance;\r\n#endif\r\n\r\n#ifdef SHADOWS\r\n#ifdef LIGHT0\r\nuniform mat4 lightMatrix0;\r\nvarying vec4 vPositionFromLight0;\r\n#endif\r\n#ifdef LIGHT1\r\nuniform mat4 lightMatrix1;\r\nvarying vec4 vPositionFromLight1;\r\n#endif\r\n#ifdef LIGHT2\r\nuniform mat4 lightMatrix2;\r\nvarying vec4 vPositionFromLight2;\r\n#endif\r\n#ifdef LIGHT3\r\nuniform mat4 lightMatrix3;\r\nvarying vec4 vPositionFromLight3;\r\n#endif\r\n#endif\r\n\r\n#ifdef REFLECTION\r\nvarying vec3 vPositionUVW;\r\n#endif\r\n\r\nvoid main(void) {\r\n	mat4 finalWorld;\r\n\r\n#ifdef REFLECTION\r\n	vPositionUVW = position;\r\n#endif \r\n\r\n#ifdef BONES\r\n	mat4 m0 = mBones[int(matricesIndices.x)] * matricesWeights.x;\r\n	mat4 m1 = mBones[int(matricesIndices.y)] * matricesWeights.y;\r\n	mat4 m2 = mBones[int(matricesIndices.z)] * matricesWeights.z;\r\n\r\n#ifdef BONES4\r\n	mat4 m3 = mBones[int(matricesIndices.w)] * matricesWeights.w;\r\n	finalWorld = world * (m0 + m1 + m2 + m3);\r\n#else\r\n	finalWorld = world * (m0 + m1 + m2);\r\n#endif \r\n\r\n#else\r\n	finalWorld = world;\r\n#endif\r\n	gl_Position = viewProjection * finalWorld * vec4(position, 1.0);\r\n\r\n	vec4 worldPos = finalWorld * vec4(position, 1.0);\r\n	vPositionW = vec3(worldPos);\r\n	vNormalW = normalize(vec3(finalWorld * vec4(normal, 0.0)));\r\n\r\n	// Texture coordinates\r\n#ifndef UV1\r\n	vec2 uv = vec2(0., 0.);\r\n#endif\r\n#ifndef UV2\r\n	vec2 uv2 = vec2(0., 0.);\r\n#endif\r\n\r\n#ifdef DIFFUSE\r\n	if (vDiffuseInfos.x == 0.)\r\n	{\r\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef AMBIENT\r\n	if (vAmbientInfos.x == 0.)\r\n	{\r\n		vAmbientUV = vec2(ambientMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vAmbientUV = vec2(ambientMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef OPACITY\r\n	if (vOpacityInfos.x == 0.)\r\n	{\r\n		vOpacityUV = vec2(opacityMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vOpacityUV = vec2(opacityMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef EMISSIVE\r\n	if (vEmissiveInfos.x == 0.)\r\n	{\r\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef SPECULAR\r\n	if (vSpecularInfos.x == 0.)\r\n	{\r\n		vSpecularUV = vec2(specularMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vSpecularUV = vec2(specularMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n#ifdef BUMP\r\n	if (vBumpInfos.x == 0.)\r\n	{\r\n		vBumpUV = vec2(bumpMatrix * vec4(uv, 1.0, 0.0));\r\n	}\r\n	else\r\n	{\r\n		vBumpUV = vec2(bumpMatrix * vec4(uv2, 1.0, 0.0));\r\n	}\r\n#endif\r\n\r\n	// Clip plane\r\n#ifdef CLIPPLANE\r\n	fClipDistance = dot(worldPos, vClipPlane);\r\n#endif\r\n\r\n	// Fog\r\n#ifdef FOG\r\n	fFogDistance = (view * worldPos).z;\r\n#endif\r\n\r\n	// Shadows\r\n#ifdef SHADOWS\r\n#ifdef LIGHT0\r\n	vPositionFromLight0 = lightMatrix0 * vec4(position, 1.0);\r\n#endif\r\n#ifdef LIGHT1\r\n	vPositionFromLight1 = lightMatrix1 * vec4(position, 1.0);\r\n#endif\r\n#ifdef LIGHT2\r\n	vPositionFromLight2 = lightMatrix2 * vec4(position, 1.0);\r\n#endif\r\n#ifdef LIGHT3\r\n	vPositionFromLight3 = lightMatrix3 * vec4(position, 1.0);\r\n#endif\r\n#endif\r\n\r\n	// Vertex color\r\n#ifdef VERTEXCOLOR\r\n	vColor = color;\r\n#endif\r\n}",filterPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform mat4 kernelMatrix;\n\nvoid main(void)\n{\n	vec3 baseColor = texture2D(textureSampler, vUV).rgb;\n	vec3 updatedColor = (kernelMatrix * vec4(baseColor, 1.0)).rgb;\n\n	gl_FragColor = vec4(updatedColor, 1.0);\n}",fxaaPixelShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n#define FXAA_REDUCE_MIN   (1.0/128.0)\r\n#define FXAA_REDUCE_MUL   (1.0/8.0)\r\n#define FXAA_SPAN_MAX     8.0\r\n\r\nvarying vec2 vUV;\r\nuniform sampler2D textureSampler;\r\nuniform vec2 texelSize;\r\n\r\nvoid main(){\r\n	vec2 localTexelSize = texelSize;\r\n	vec3 rgbNW = texture2D(textureSampler, (vUV + vec2(-1.0, -1.0) * localTexelSize)).xyz;\r\n	vec3 rgbNE = texture2D(textureSampler, (vUV + vec2(1.0, -1.0) * localTexelSize)).xyz;\r\n	vec3 rgbSW = texture2D(textureSampler, (vUV + vec2(-1.0, 1.0) * localTexelSize)).xyz;\r\n	vec3 rgbSE = texture2D(textureSampler, (vUV + vec2(1.0, 1.0) * localTexelSize)).xyz;\r\n	vec3 rgbM = texture2D(textureSampler, vUV ).xyz;\r\n	vec3 luma = vec3(0.299, 0.587, 0.114);\r\n	float lumaNW = dot(rgbNW, luma);\r\n	float lumaNE = dot(rgbNE, luma);\r\n	float lumaSW = dot(rgbSW, luma);\r\n	float lumaSE = dot(rgbSE, luma);\r\n	float lumaM = dot(rgbM, luma);\r\n	float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\r\n	float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\r\n\r\n	vec2 dir = vec2(-((lumaNW + lumaNE) - (lumaSW + lumaSE)), ((lumaNW + lumaSW) - (lumaNE + lumaSE)));\r\n\r\n	float dirReduce = max(\r\n		(lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),\r\n		FXAA_REDUCE_MIN);\r\n\r\n	float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\r\n	dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\r\n		max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\r\n		dir * rcpDirMin)) * localTexelSize;\r\n\r\n	vec3 rgbA = 0.5 * (\r\n		texture2D(textureSampler, vUV + dir * (1.0 / 3.0 - 0.5)).xyz +\r\n		texture2D(textureSampler, vUV + dir * (2.0 / 3.0 - 0.5)).xyz);\r\n\r\n	vec3 rgbB = rgbA * 0.5 + 0.25 * (\r\n		texture2D(textureSampler, vUV + dir *  -0.5).xyz +\r\n		texture2D(textureSampler, vUV + dir * 0.5).xyz);\r\n	float lumaB = dot(rgbB, luma);\r\n	if ((lumaB < lumaMin) || (lumaB > lumaMax)) {\r\n		gl_FragColor = vec4(rgbA, 1.0);\r\n	}\r\n	else {\r\n		gl_FragColor = vec4(rgbB, 1.0);\r\n	}\r\n}",layerPixelShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Samplers\r\nvarying vec2 vUV;\r\nuniform sampler2D textureSampler;\r\n\r\n// Color\r\nuniform vec4 color;\r\n\r\nvoid main(void) {\r\n	vec4 baseColor = texture2D(textureSampler, vUV);\r\n\r\n	gl_FragColor = baseColor * color;\r\n}",layerVertexShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec2 position;\r\n\r\n// Uniforms\r\nuniform mat4 textureMatrix;\r\n\r\n// Output\r\nvarying vec2 vUV;\r\n\r\nconst vec2 madd = vec2(0.5, 0.5);\r\n\r\nvoid main(void) {	\r\n\r\n	vUV = vec2(textureMatrix * vec4(position * madd + madd, 1.0, 0.0));\r\n	gl_Position = vec4(position, 0.0, 1.0);\r\n}",legacydefaultPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n#define MAP_PROJECTION	4.\n\n// Constants\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vDiffuseColor;\nuniform vec4 vSpecularColor;\nuniform vec3 vEmissiveColor;\n\n// Input\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\n\n#ifdef VERTEXCOLOR\nvarying vec3 vColor;\n#endif\n\n// Lights\n#ifdef LIGHT0\nuniform vec4 vLightData0;\nuniform vec3 vLightDiffuse0;\nuniform vec3 vLightSpecular0;\n#ifdef SHADOW0\nvarying vec4 vPositionFromLight0;\nuniform sampler2D shadowSampler0;\n#endif\n#ifdef SPOTLIGHT0\nuniform vec4 vLightDirection0;\n#endif\n#ifdef HEMILIGHT0\nuniform vec3 vLightGround0;\n#endif\n#endif\n\n#ifdef LIGHT1\nuniform vec4 vLightData1;\nuniform vec3 vLightDiffuse1;\nuniform vec3 vLightSpecular1;\n#ifdef SHADOW1\nvarying vec4 vPositionFromLight1;\nuniform sampler2D shadowSampler1;\n#endif\n#ifdef SPOTLIGHT1\nuniform vec4 vLightDirection1;\n#endif\n#ifdef HEMILIGHT1\nuniform vec3 vLightGround1;\n#endif\n#endif\n\n#ifdef LIGHT2\nuniform vec4 vLightData2;\nuniform vec3 vLightDiffuse2;\nuniform vec3 vLightSpecular2;\n#ifdef SHADOW2\nvarying vec4 vPositionFromLight2;\nuniform sampler2D shadowSampler2;\n#endif\n#ifdef SPOTLIGHT2\nuniform vec4 vLightDirection2;\n#endif\n#ifdef HEMILIGHT2\nuniform vec3 vLightGround2;\n#endif\n#endif\n\n#ifdef LIGHT3\nuniform vec4 vLightData3;\nuniform vec3 vLightDiffuse3;\nuniform vec3 vLightSpecular3;\n#ifdef SHADOW3\nvarying vec4 vPositionFromLight3;\nuniform sampler2D shadowSampler3;\n#endif\n#ifdef SPOTLIGHT3\nuniform vec4 vLightDirection3;\n#endif\n#ifdef HEMILIGHT3\nuniform vec3 vLightGround3;\n#endif\n#endif\n\n// Samplers\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform sampler2D diffuseSampler;\nuniform vec2 vDiffuseInfos;\n#endif\n\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform sampler2D ambientSampler;\nuniform vec2 vAmbientInfos;\n#endif\n\n#ifdef OPACITY	\nvarying vec2 vOpacityUV;\nuniform sampler2D opacitySampler;\nuniform vec2 vOpacityInfos;\n#endif\n\n#ifdef REFLECTION\nvarying vec3 vReflectionUVW;\nuniform samplerCube reflectionCubeSampler;\nuniform sampler2D reflection2DSampler;\nuniform vec3 vReflectionInfos;\n#endif\n\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform sampler2D emissiveSampler;\n#endif\n\n#ifdef SPECULAR\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform sampler2D specularSampler;\n#endif\n\n// Shadows\n#ifdef SHADOWS\n\nfloat unpack(vec4 color)\n{\n	const vec4 bitShift = vec4(1. / (255. * 255. * 255.), 1. / (255. * 255.), 1. / 255., 1.);\n	return dot(color, bitShift);\n}\n\nfloat unpackHalf(vec2 color)\n{\n	return color.x + (color.y / 255.0);\n}\n\nfloat computeShadow(vec4 vPositionFromLight, sampler2D shadowSampler)\n{\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\n\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\n	{\n		return 1.0;\n	}\n\n	float shadow = unpack(texture2D(shadowSampler, uv));\n\n	if (depth.z > shadow)\n	{\n		return 0.;\n	}\n	return 1.;\n}\n\n// Thanks to http://devmaster.net/\nfloat ChebychevInequality(vec2 moments, float t)\n{\n	if (t <= moments.x)\n	{\n		return 1.0;\n	}\n\n	float variance = moments.y - (moments.x * moments.x);\n	variance = max(variance, 0.);\n\n	float d = t - moments.x;\n	return variance / (variance + d * d);\n}\n\nfloat computeShadowWithVSM(vec4 vPositionFromLight, sampler2D shadowSampler)\n{\n	vec3 depth = vPositionFromLight.xyz / vPositionFromLight.w;\n	vec2 uv = 0.5 * depth.xy + vec2(0.5, 0.5);\n\n	if (uv.x < 0. || uv.x > 1.0 || uv.y < 0. || uv.y > 1.0)\n	{\n		return 1.0;\n	}\n\n	vec4 texel = texture2D(shadowSampler, uv);\n\n	vec2 moments = vec2(unpackHalf(texel.xy), unpackHalf(texel.zw));\n	return clamp(1.3 - ChebychevInequality(moments, depth.z), 0., 1.0);\n}\n#endif\n\n#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\n\n// Fog\n#ifdef FOG\n\n#define FOGMODE_NONE    0.\n#define FOGMODE_EXP     1.\n#define FOGMODE_EXP2    2.\n#define FOGMODE_LINEAR  3.\n#define E 2.71828\n\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying float fFogDistance;\n\nfloat CalcFogFactor()\n{\n	float fogCoeff = 1.0;\n	float fogStart = vFogInfos.y;\n	float fogEnd = vFogInfos.z;\n	float fogDensity = vFogInfos.w;\n\n	if (FOGMODE_LINEAR == vFogInfos.x)\n	{\n		fogCoeff = (fogEnd - fFogDistance) / (fogEnd - fogStart);\n	}\n	else if (FOGMODE_EXP == vFogInfos.x)\n	{\n		fogCoeff = 1.0 / pow(E, fFogDistance * fogDensity);\n	}\n	else if (FOGMODE_EXP2 == vFogInfos.x)\n	{\n		fogCoeff = 1.0 / pow(E, fFogDistance * fFogDistance * fogDensity * fogDensity);\n	}\n\n	return clamp(fogCoeff, 0.0, 1.0);\n}\n#endif\n\n// Light Computing\nmat3 computeLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec3 diffuseColor, vec3 specularColor) {\n	mat3 result;\n\n	vec3 lightVectorW;\n	if (lightData.w == 0.)\n	{\n		lightVectorW = normalize(lightData.xyz - vPositionW);\n	}\n	else\n	{\n		lightVectorW = normalize(-lightData.xyz);\n	}\n\n	// diffuse\n	float ndl = max(0., dot(vNormal, lightVectorW));\n\n	// Specular\n	vec3 angleW = normalize(viewDirectionW + lightVectorW);\n	float specComp = max(0., dot(vNormal, angleW));\n	specComp = max(0., pow(specComp, max(1.0, vSpecularColor.a)));\n\n	result[0] = ndl * diffuseColor;\n	result[1] = specComp * specularColor;\n	result[2] = vec3(0.);\n\n	return result;\n}\n\nmat3 computeSpotLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec4 lightDirection, vec3 diffuseColor, vec3 specularColor) {\n	mat3 result;\n\n	vec3 lightVectorW = normalize(lightData.xyz - vPositionW);\n\n	// diffuse\n	float cosAngle = max(0., dot(-lightDirection.xyz, lightVectorW));\n	float spotAtten = 0.0;\n\n	if (cosAngle >= lightDirection.w)\n	{\n		cosAngle = max(0., pow(cosAngle, lightData.w));\n		spotAtten = max(0., (cosAngle - lightDirection.w) / (1. - cosAngle));\n\n		// Diffuse\n		float ndl = max(0., dot(vNormal, -lightDirection.xyz));\n\n		// Specular\n		vec3 angleW = normalize(viewDirectionW - lightDirection.xyz);\n		float specComp = max(0., dot(vNormal, angleW));\n		specComp = pow(specComp, vSpecularColor.a);\n\n		result[0] = ndl * spotAtten * diffuseColor;\n		result[1] = specComp * specularColor * spotAtten;\n		result[2] = vec3(0.);\n\n		return result;\n	}\n\n	result[0] = vec3(0.);\n	result[1] = vec3(0.);\n	result[2] = vec3(0.);\n\n	return result;\n}\n\nmat3 computeHemisphericLighting(vec3 viewDirectionW, vec3 vNormal, vec4 lightData, vec3 diffuseColor, vec3 specularColor, vec3 groundColor) {\n	mat3 result;\n\n	// Diffuse\n	float ndl = dot(vNormal, lightData.xyz) * 0.5 + 0.5;\n\n	// Specular\n	vec3 angleW = normalize(viewDirectionW + lightData.xyz);\n	float specComp = max(0., dot(vNormal, angleW));\n	specComp = pow(specComp, vSpecularColor.a);\n\n	result[0] = mix(groundColor, diffuseColor, ndl);\n	result[1] = specComp * specularColor;\n	result[2] = vec3(0.);\n\n	return result;\n}\n\nvoid main(void) {\n	// Clip plane\n#ifdef CLIPPLANE\n	if (fClipDistance > 0.0)\n		discard;\n#endif\n\n	vec3 viewDirectionW = normalize(vEyePosition - vPositionW);\n\n	// Base color\n	vec4 baseColor = vec4(1., 1., 1., 1.);\n	vec3 diffuseColor = vDiffuseColor.rgb;\n\n#ifdef VERTEXCOLOR\n	diffuseColor *= vColor;\n#endif\n\n#ifdef DIFFUSE\n	baseColor = texture2D(diffuseSampler, vDiffuseUV);\n\n#ifdef ALPHATEST\n	if (baseColor.a < 0.4)\n		discard;\n#endif\n\n	baseColor.rgb *= vDiffuseInfos.y;\n#endif\n\n	// Bump\n	vec3 normalW = vNormalW;\n\n	// Ambient color\n	vec3 baseAmbientColor = vec3(1., 1., 1.);\n\n#ifdef AMBIENT\n	baseAmbientColor = texture2D(ambientSampler, vAmbientUV).rgb * vAmbientInfos.y;\n#endif\n\n	// Lighting\n	vec3 diffuseBase = vec3(0., 0., 0.);\n	vec3 specularBase = vec3(0., 0., 0.);\n	float shadow = 1.;\n\n#ifdef LIGHT0\n#ifdef SPOTLIGHT0\n	mat3 info = computeSpotLighting(viewDirectionW, normalW, vLightData0, vLightDirection0, vLightDiffuse0, vLightSpecular0);\n#endif\n#ifdef HEMILIGHT0\n	mat3 info = computeHemisphericLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0, vLightSpecular0, vLightGround0);\n#endif\n#ifdef POINTDIRLIGHT0\n	mat3 info = computeLighting(viewDirectionW, normalW, vLightData0, vLightDiffuse0, vLightSpecular0);\n#endif\n#ifdef SHADOW0\n#ifdef SHADOWVSM0\n	shadow = computeShadowWithVSM(vPositionFromLight0, shadowSampler0);\n#else\n	shadow = computeShadow(vPositionFromLight0, shadowSampler0);\n#endif\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n#ifdef LIGHT1\n#ifdef SPOTLIGHT1\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData1, vLightDirection1, vLightDiffuse1, vLightSpecular1);\n#endif\n#ifdef HEMILIGHT1\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1, vLightSpecular1, vLightGround1);\n#endif\n#ifdef POINTDIRLIGHT1\n	info = computeLighting(viewDirectionW, normalW, vLightData1, vLightDiffuse1, vLightSpecular1);\n#endif\n#ifdef SHADOW1\n#ifdef SHADOWVSM1\n	shadow = computeShadowWithVSM(vPositionFromLight1, shadowSampler1);\n#else\n	shadow = computeShadow(vPositionFromLight1, shadowSampler1);\n#endif\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n#ifdef LIGHT2\n#ifdef SPOTLIGHT2\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData2, vLightDirection2, vLightDiffuse2, vLightSpecular2);\n#endif\n#ifdef HEMILIGHT2\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2, vLightSpecular2, vLightGround2);\n#endif\n#ifdef POINTDIRLIGHT2\n	info = computeLighting(viewDirectionW, normalW, vLightData2, vLightDiffuse2, vLightSpecular2);\n#endif\n#ifdef SHADOW2\n#ifdef SHADOWVSM2\n	shadow = computeShadowWithVSM(vPositionFromLight2, shadowSampler2);\n#else\n	shadow = computeShadow(vPositionFromLight2, shadowSampler2);\n#endif	\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n#ifdef LIGHT3\n#ifdef SPOTLIGHT3\n	info = computeSpotLighting(viewDirectionW, normalW, vLightData3, vLightDirection3, vLightDiffuse3, vLightSpecular3);\n#endif\n#ifdef HEMILIGHT3\n	info = computeHemisphericLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3, vLightSpecular3, vLightGround3);\n#endif\n#ifdef POINTDIRLIGHT3\n	info = computeLighting(viewDirectionW, normalW, vLightData3, vLightDiffuse3, vLightSpecular3);\n#endif\n#ifdef SHADOW3\n#ifdef SHADOWVSM3\n	shadow = computeShadowWithVSM(vPositionFromLight3, shadowSampler3);\n#else\n	shadow = computeShadow(vPositionFromLight3, shadowSampler3);\n#endif	\n#else\n	shadow = 1.;\n#endif\n	diffuseBase += info[0] * shadow;\n	specularBase += info[1] * shadow;\n#endif\n\n	// Reflection\n	vec3 reflectionColor = vec3(0., 0., 0.);\n\n#ifdef REFLECTION\n	if (vReflectionInfos.z != 0.0)\n	{\n		reflectionColor = textureCube(reflectionCubeSampler, vReflectionUVW).rgb * vReflectionInfos.y;\n	}\n	else\n	{\n		vec2 coords = vReflectionUVW.xy;\n\n		if (vReflectionInfos.x == MAP_PROJECTION)\n		{\n			coords /= vReflectionUVW.z;\n		}\n\n		coords.y = 1.0 - coords.y;\n\n		reflectionColor = texture2D(reflection2DSampler, coords).rgb * vReflectionInfos.y;\n	}\n#endif\n\n	// Alpha\n	float alpha = vDiffuseColor.a;\n\n#ifdef OPACITY\n	vec4 opacityMap = texture2D(opacitySampler, vOpacityUV);\n	opacityMap.rgb = opacityMap.rgb * vec3(0.3, 0.59, 0.11) * opacityMap.a;\n	alpha *= (opacityMap.x + opacityMap.y + opacityMap.z)* vOpacityInfos.y;\n#endif\n\n	// Emissive\n	vec3 emissiveColor = vEmissiveColor;\n#ifdef EMISSIVE\n	emissiveColor += texture2D(emissiveSampler, vEmissiveUV).rgb * vEmissiveInfos.y;\n#endif\n\n	// Specular map\n	vec3 specularColor = vSpecularColor.rgb;\n#ifdef SPECULAR\n	specularColor = texture2D(specularSampler, vSpecularUV).rgb * vSpecularInfos.y;\n#endif\n\n	// Composition\n	vec3 finalDiffuse = clamp(diffuseBase * diffuseColor + emissiveColor + vAmbientColor, 0.0, 1.0) * baseColor.rgb;\n	vec3 finalSpecular = specularBase * specularColor;\n\n	vec4 color = vec4(finalDiffuse * baseAmbientColor + finalSpecular + reflectionColor, alpha);\n\n#ifdef FOG\n	float fog = CalcFogFactor();\n	color.rgb = fog * color.rgb + (1.0 - fog) * vFogColor;\n#endif\n\n	gl_FragColor = color;\n}",legacydefaultVertexShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n#define MAP_EXPLICIT	0.\n#define MAP_SPHERICAL	1.\n#define MAP_PLANAR		2.\n#define MAP_CUBIC		3.\n#define MAP_PROJECTION	4.\n#define MAP_SKYBOX		5.\n\n// Attributes\nattribute vec3 position;\nattribute vec3 normal;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec3 color;\n#endif\n#ifdef BONES\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#endif\n\n// Uniforms\nuniform mat4 world;\nuniform mat4 view;\nuniform mat4 viewProjection;\n\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n\n#ifdef OPACITY\nvarying vec2 vOpacityUV;\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n\n#ifdef REFLECTION\nuniform vec3 vEyePosition;\nvarying vec3 vReflectionUVW;\nuniform vec3 vReflectionInfos;\nuniform mat4 reflectionMatrix;\n#endif\n\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n\n#ifdef SPECULAR\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n\n#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec2 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n\n#ifdef BONES\nuniform mat4 mBones[BonesPerMesh];\n#endif\n\n// Output\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\n\n#ifdef VERTEXCOLOR\nvarying vec3 vColor;\n#endif\n\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif\n\n#ifdef FOG\nvarying float fFogDistance;\n#endif\n\n#ifdef SHADOWS\n#ifdef LIGHT0\nuniform mat4 lightMatrix0;\nvarying vec4 vPositionFromLight0;\n#endif\n#ifdef LIGHT1\nuniform mat4 lightMatrix1;\nvarying vec4 vPositionFromLight1;\n#endif\n#ifdef LIGHT2\nuniform mat4 lightMatrix2;\nvarying vec4 vPositionFromLight2;\n#endif\n#ifdef LIGHT3\nuniform mat4 lightMatrix3;\nvarying vec4 vPositionFromLight3;\n#endif\n#endif\n\n#ifdef REFLECTION\nvec3 computeReflectionCoords(float mode, vec4 worldPos, vec3 worldNormal)\n{\n	if (mode == MAP_SPHERICAL)\n	{\n		vec3 coords = vec3(view * vec4(worldNormal, 0.0));\n\n		return vec3(reflectionMatrix * vec4(coords, 1.0));\n	}\n	else if (mode == MAP_PLANAR)\n	{\n		vec3 viewDir = worldPos.xyz - vEyePosition;\n		vec3 coords = normalize(reflect(viewDir, worldNormal));\n\n		return vec3(reflectionMatrix * vec4(coords, 1));\n	}\n	else if (mode == MAP_CUBIC)\n	{\n		vec3 viewDir = worldPos.xyz - vEyePosition;\n		vec3 coords = reflect(viewDir, worldNormal);\n\n		return vec3(reflectionMatrix * vec4(coords, 0));\n	}\n	else if (mode == MAP_PROJECTION)\n	{\n		return vec3(reflectionMatrix * (view * worldPos));\n	}\n	else if (mode == MAP_SKYBOX)\n	{\n		return position;\n	}\n\n	return vec3(0, 0, 0);\n}\n#endif\n\nvoid main(void) {\n	mat4 finalWorld;\n\n#ifdef BONES\n	mat4 m0 = mBones[int(matricesIndices.x)] * matricesWeights.x;\n	mat4 m1 = mBones[int(matricesIndices.y)] * matricesWeights.y;\n	mat4 m2 = mBones[int(matricesIndices.z)] * matricesWeights.z;\n\n#ifdef BONES4\n	mat4 m3 = mBones[int(matricesIndices.w)] * matricesWeights.w;\n	finalWorld = world * (m0 + m1 + m2 + m3);\n#else\n	finalWorld = world * (m0 + m1 + m2);\n#endif \n\n#else\n	finalWorld = world;\n#endif\n\n	gl_Position = viewProjection * finalWorld * vec4(position, 1.0);\n\n	vec4 worldPos = finalWorld * vec4(position, 1.0);\n	vPositionW = vec3(worldPos);\n	vNormalW = normalize(vec3(finalWorld * vec4(normal, 0.0)));\n\n	// Texture coordinates\n#ifndef UV1\n	vec2 uv = vec2(0., 0.);\n#endif\n#ifndef UV2\n	vec2 uv2 = vec2(0., 0.);\n#endif\n\n#ifdef DIFFUSE\n	if (vDiffuseInfos.x == 0.)\n	{\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vDiffuseUV = vec2(diffuseMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef AMBIENT\n	if (vAmbientInfos.x == 0.)\n	{\n		vAmbientUV = vec2(ambientMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vAmbientUV = vec2(ambientMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef OPACITY\n	if (vOpacityInfos.x == 0.)\n	{\n		vOpacityUV = vec2(opacityMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vOpacityUV = vec2(opacityMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef REFLECTION\n	vReflectionUVW = computeReflectionCoords(vReflectionInfos.x, vec4(vPositionW, 1.0), vNormalW);\n#endif\n\n#ifdef EMISSIVE\n	if (vEmissiveInfos.x == 0.)\n	{\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vEmissiveUV = vec2(emissiveMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef SPECULAR\n	if (vSpecularInfos.x == 0.)\n	{\n		vSpecularUV = vec2(specularMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vSpecularUV = vec2(specularMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n#ifdef BUMP\n	if (vBumpInfos.x == 0.)\n	{\n		vBumpUV = vec2(bumpMatrix * vec4(uv, 1.0, 0.0));\n	}\n	else\n	{\n		vBumpUV = vec2(bumpMatrix * vec4(uv2, 1.0, 0.0));\n	}\n#endif\n\n	// Clip plane\n#ifdef CLIPPLANE\n	fClipDistance = dot(worldPos, vClipPlane);\n#endif\n\n	// Fog\n#ifdef FOG\n	fFogDistance = (view * worldPos).z;\n#endif\n\n	// Shadows\n#ifdef SHADOWS\n#ifdef LIGHT0\n	vPositionFromLight0 = lightMatrix0 * vec4(position, 1.0);\n#endif\n#ifdef LIGHT1\n	vPositionFromLight1 = lightMatrix1 * vec4(position, 1.0);\n#endif\n#ifdef LIGHT2\n	vPositionFromLight2 = lightMatrix2 * vec4(position, 1.0);\n#endif\n#ifdef LIGHT3\n	vPositionFromLight3 = lightMatrix3 * vec4(position, 1.0);\n#endif\n#endif\n\n	// Vertex color\n#ifdef VERTEXCOLOR\n	vColor = color;\n#endif\n}",lensFlarePixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\n// Color\nuniform vec4 color;\n\nvoid main(void) {\n	vec4 baseColor = texture2D(textureSampler, vUV);\n\n	gl_FragColor = baseColor * color;\n}",lensFlareVertexShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Attributes\nattribute vec2 position;\n\n// Uniforms\nuniform mat4 viewportMatrix;\n\n// Output\nvarying vec2 vUV;\n\nconst vec2 madd = vec2(0.5, 0.5);\n\nvoid main(void) {	\n\n	vUV = position * madd + madd;\n	gl_Position = viewportMatrix * vec4(position, 0.0, 1.0);\n}",oculusDistortionCorrectionPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\n\nvec2 HmdWarp(vec2 in01) {\n\n	vec2 theta = (in01 - LensCenter) * ScaleIn; // Scales to [-1, 1]\n	float rSq = theta.x * theta.x + theta.y * theta.y;\n	vec2 rvector = theta * (HmdWarpParam.x + HmdWarpParam.y * rSq + HmdWarpParam.z * rSq * rSq + HmdWarpParam.w * rSq * rSq * rSq);\n	return LensCenter + Scale * rvector;\n}\n\n\n\nvoid main(void)\n{\n	vec2 tc = HmdWarp(vUV);\n	if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\n		gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n	else{\n		gl_FragColor = vec4(texture2D(textureSampler, tc).rgb, 1.0);\n	}\n}",particlesPixelShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Samplers\r\nvarying vec2 vUV;\r\nvarying vec4 vColor;\r\nuniform vec4 textureMask;\r\nuniform sampler2D diffuseSampler;\r\n\r\n#ifdef CLIPPLANE\r\nvarying float fClipDistance;\r\n#endif\r\n\r\nvoid main(void) {\r\n#ifdef CLIPPLANE\r\n	if (fClipDistance > 0.0)\r\n		discard;\r\n#endif\r\n	vec4 baseColor = texture2D(diffuseSampler, vUV);\r\n\r\n	gl_FragColor = (baseColor * textureMask + (vec4(1., 1., 1., 1.) - textureMask)) * vColor;\r\n}",particlesVertexShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec3 position;\r\nattribute vec4 color;\r\nattribute vec4 options;\r\n\r\n// Uniforms\r\nuniform mat4 view;\r\nuniform mat4 projection;\r\n\r\n// Output\r\nvarying vec2 vUV;\r\nvarying vec4 vColor;\r\n\r\n#ifdef CLIPPLANE\r\nuniform vec4 vClipPlane;\r\nuniform mat4 invView;\r\nvarying float fClipDistance;\r\n#endif\r\n\r\nvoid main(void) {	\r\n	vec3 viewPos = (view * vec4(position, 1.0)).xyz; \r\n	vec3 cornerPos;\r\n	float size = options.y;\r\n	float angle = options.x;\r\n	vec2 offset = options.zw;\r\n\r\n	cornerPos = vec3(offset.x - 0.5, offset.y  - 0.5, 0.) * size;\r\n\r\n	// Rotate\r\n	vec3 rotatedCorner;\r\n	rotatedCorner.x = cornerPos.x * cos(angle) - cornerPos.y * sin(angle);\r\n	rotatedCorner.y = cornerPos.x * sin(angle) + cornerPos.y * cos(angle);\r\n	rotatedCorner.z = 0.;\r\n\r\n	// Position\r\n	viewPos += rotatedCorner;\r\n	gl_Position = projection * vec4(viewPos, 1.0);   \r\n	\r\n	vColor = color;\r\n	vUV = offset;\r\n\r\n	// Clip plane\r\n#ifdef CLIPPLANE\r\n	vec4 worldPos = invView * vec4(viewPos, 1.0);\r\n	fClipDistance = dot(worldPos, vClipPlane);\r\n#endif\r\n}",passPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nvoid main(void) \n{\n	gl_FragColor = texture2D(textureSampler, vUV);\n}",postprocessVertexShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Attributes\nattribute vec2 position;\n\n// Output\nvarying vec2 vUV;\n\nconst vec2 madd = vec2(0.5, 0.5);\n\nvoid main(void) {	\n\n	vUV = position * madd + madd;\n	gl_Position = vec4(position, 0.0, 1.0);\n}",refractionPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Samplers\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\n\n// Parameters\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\n\nvoid main() {\n	float ref = 1.0 - texture2D(refractionSampler, vUV).r;\n\n	vec2 uv = vUV - vec2(0.5);\n	vec2 offset = uv * depth * ref;\n	vec3 sourceColor = texture2D(textureSampler, vUV - offset).rgb;\n\n	gl_FragColor = vec4(sourceColor + sourceColor * ref * colorLevel, 1.0);\n}",shadowMapPixelShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\nvec4 pack(float depth)\n{\n	const vec4 bitOffset = vec4(255. * 255. * 255., 255. * 255., 255., 1.);\n	const vec4 bitMask = vec4(0., 1. / 255., 1. / 255., 1. / 255.);\n	\n	vec4 comp = mod(depth * bitOffset * vec4(254.), vec4(255.)) / vec4(254.);\n	comp -= comp.xxyz * bitMask;\n	\n	return comp;\n}\n\n// Thanks to http://devmaster.net/\nvec2 packHalf(float depth) \n{ \n	const vec2 bitOffset = vec2(1.0 / 255., 0.);\n	vec2 color = vec2(depth, fract(depth * 255.));\n\n	return color - (color.yy * bitOffset);\n}\n\n#ifndef VSM\nvarying vec4 vPosition;\n#endif\n\nvoid main(void)\n{\n#ifdef VSM\n	float moment1 = gl_FragCoord.z / gl_FragCoord.w;\n	float moment2 = moment1 * moment1;\n	gl_FragColor = vec4(packHalf(moment1), packHalf(moment2));\n#else\n	gl_FragColor = pack(vPosition.z / vPosition.w);\n#endif\n}",shadowMapVertexShader:"#ifdef GL_ES\nprecision mediump float;\n#endif\n\n// Attribute\nattribute vec3 position;\n#ifdef BONES\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#endif\n\n// Uniform\n#ifdef BONES\nuniform mat4 world;\nuniform mat4 mBones[BonesPerMesh];\nuniform mat4 viewProjection;\n#else\nuniform mat4 worldViewProjection;\n#endif\n\n#ifndef VSM\nvarying vec4 vPosition;\n#endif\n\nvoid main(void)\n{\n#ifdef BONES\n	mat4 m0 = mBones[int(matricesIndices.x)] * matricesWeights.x;\n	mat4 m1 = mBones[int(matricesIndices.y)] * matricesWeights.y;\n	mat4 m2 = mBones[int(matricesIndices.z)] * matricesWeights.z;\n	mat4 m3 = mBones[int(matricesIndices.w)] * matricesWeights.w;\n	mat4 finalWorld = world * (m0 + m1 + m2 + m3);\n	gl_Position = viewProjection * finalWorld * vec4(position, 1.0);\n#else\n#ifndef VSM\n	vPosition = worldViewProjection * vec4(position, 1.0);\n#endif\n	gl_Position = worldViewProjection * vec4(position, 1.0);\n#endif\n}",spritesPixelShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\nuniform bool alphaTest;\r\n\r\nvarying vec4 vColor;\r\n\r\n// Samplers\r\nvarying vec2 vUV;\r\nuniform sampler2D diffuseSampler;\r\n\r\n// Fog\r\n#ifdef FOG\r\n\r\n#define FOGMODE_NONE    0.\r\n#define FOGMODE_EXP     1.\r\n#define FOGMODE_EXP2    2.\r\n#define FOGMODE_LINEAR  3.\r\n#define E 2.71828\r\n\r\nuniform vec4 vFogInfos;\r\nuniform vec3 vFogColor;\r\nvarying float fFogDistance;\r\n\r\nfloat CalcFogFactor()\r\n{\r\n	float fogCoeff = 1.0;\r\n	float fogStart = vFogInfos.y;\r\n	float fogEnd = vFogInfos.z;\r\n	float fogDensity = vFogInfos.w;\r\n\r\n	if (FOGMODE_LINEAR == vFogInfos.x)\r\n	{\r\n		fogCoeff = (fogEnd - fFogDistance) / (fogEnd - fogStart);\r\n	}\r\n	else if (FOGMODE_EXP == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fogDensity);\r\n	}\r\n	else if (FOGMODE_EXP2 == vFogInfos.x)\r\n	{\r\n		fogCoeff = 1.0 / pow(E, fFogDistance * fFogDistance * fogDensity * fogDensity);\r\n	}\r\n\r\n	return min(1., max(0., fogCoeff));\r\n}\r\n#endif\r\n\r\n\r\nvoid main(void) {\r\n	vec4 baseColor = texture2D(diffuseSampler, vUV);\r\n\r\n	if (alphaTest) \r\n	{\r\n		if (baseColor.a < 0.95)\r\n			discard;\r\n	}\r\n\r\n	baseColor *= vColor;\r\n\r\n#ifdef FOG\r\n	float fog = CalcFogFactor();\r\n	baseColor.rgb = fog * baseColor.rgb + (1.0 - fog) * vFogColor;\r\n#endif\r\n\r\n	gl_FragColor = baseColor;\r\n}",spritesVertexShader:"#ifdef GL_ES\r\nprecision mediump float;\r\n#endif\r\n\r\n// Attributes\r\nattribute vec3 position;\r\nattribute vec4 options;\r\nattribute vec4 cellInfo;\r\nattribute vec4 color;\r\n\r\n// Uniforms\r\nuniform vec2 textureInfos;\r\nuniform mat4 view;\r\nuniform mat4 projection;\r\n\r\n// Output\r\nvarying vec2 vUV;\r\nvarying vec4 vColor;\r\n\r\n#ifdef FOG\r\nvarying float fFogDistance;\r\n#endif\r\n\r\nvoid main(void) {	\r\n	vec3 viewPos = (view * vec4(position, 1.0)).xyz; \r\n	vec3 cornerPos;\r\n	\r\n	float angle = options.x;\r\n	float size = options.y;\r\n	vec2 offset = options.zw;\r\n	vec2 uvScale = textureInfos.xy;\r\n\r\n	cornerPos = vec3(offset.x - 0.5, offset.y  - 0.5, 0.) * size;\r\n\r\n	// Rotate\r\n	vec3 rotatedCorner;\r\n	rotatedCorner.x = cornerPos.x * cos(angle) - cornerPos.y * sin(angle);\r\n	rotatedCorner.y = cornerPos.x * sin(angle) + cornerPos.y * cos(angle);\r\n	rotatedCorner.z = 0.;\r\n\r\n	// Position\r\n	viewPos += rotatedCorner;\r\n	gl_Position = projection * vec4(viewPos, 1.0);   \r\n\r\n	// Color\r\n	vColor = color;\r\n	\r\n	// Texture\r\n	vec2 uvOffset = vec2(abs(offset.x - cellInfo.x), 1.0 - abs(offset.y - cellInfo.y));\r\n\r\n	vUV = (uvOffset + cellInfo.zw) * uvScale;\r\n\r\n	// Fog\r\n#ifdef FOG\r\n	fFogDistance = viewPos.z;\r\n#endif\r\n}"};
var BABYLON=BABYLON||{};!function(){BABYLON.Material=function(e,t){this.name=e,this.id=e,this._scene=t,t.materials.push(this)},BABYLON.Material.prototype.checkReadyOnEveryCall=!0,BABYLON.Material.prototype.checkReadyOnlyOnce=!1,BABYLON.Material.prototype.alpha=1,BABYLON.Material.prototype.wireframe=!1,BABYLON.Material.prototype.backFaceCulling=!0,BABYLON.Material.prototype._effect=null,BABYLON.Material.prototype._wasPreviouslyReady=!1,BABYLON.Material.prototype.onDispose=null,BABYLON.Material.prototype.isReady=function(){return!0},BABYLON.Material.prototype.getEffect=function(){return this._effect},BABYLON.Material.prototype.needAlphaBlending=function(){return this.alpha<1},BABYLON.Material.prototype.needAlphaTesting=function(){return!1},BABYLON.Material.prototype._preBind=function(){var e=this._scene.getEngine();e.enableEffect(this._effect),e.setState(this.backFaceCulling)},BABYLON.Material.prototype.bind=function(){},BABYLON.Material.prototype.unbind=function(){},BABYLON.Material.prototype.baseDispose=function(){var e=this._scene.materials.indexOf(this);this._scene.materials.splice(e,1),this.onDispose&&this.onDispose()},BABYLON.Material.prototype.dispose=function(){this.baseDispose()}}();var BABYLON=BABYLON||{};!function(){BABYLON.StandardMaterial=function(e,t){BABYLON.Material.call(this,e,t),this.diffuseTexture=null,this.ambientTexture=null,this.opacityTexture=null,this.reflectionTexture=null,this.emissiveTexture=null,this.specularTexture=null,this.bumpTexture=null,this.ambientColor=new BABYLON.Color3(0,0,0),this.diffuseColor=new BABYLON.Color3(1,1,1),this.specularColor=new BABYLON.Color3(1,1,1),this.specularPower=64,this.emissiveColor=new BABYLON.Color3(0,0,0),this._cachedDefines=null,this._renderTargets=new BABYLON.Tools.SmartArray(16),this._worldViewProjectionMatrix=BABYLON.Matrix.Zero(),this._lightMatrix=BABYLON.Matrix.Zero(),this._globalAmbientColor=new BABYLON.Color3(0,0,0),this._baseColor=new BABYLON.Color3,this._scaledDiffuse=new BABYLON.Color3,this._scaledSpecular=new BABYLON.Color3},BABYLON.StandardMaterial.prototype=Object.create(BABYLON.Material.prototype),BABYLON.StandardMaterial.prototype.needAlphaBlending=function(){return this.alpha<1||null!=this.opacityTexture},BABYLON.StandardMaterial.prototype.needAlphaTesting=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha},BABYLON.StandardMaterial.prototype.isReady=function(e){if(this.checkReadyOnlyOnce&&this._wasPreviouslyReady)return!0;if(!this.checkReadyOnEveryCall&&this._renderId===this._scene.getRenderId())return!0;var t=this._scene.getEngine(),i=[],r=[];if(this._scene.texturesEnabled){if(this.diffuseTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled){if(!this.diffuseTexture.isReady())return!1;i.push("#define DIFFUSE")}if(this.ambientTexture&&BABYLON.StandardMaterial.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;i.push("#define AMBIENT")}if(this.opacityTexture&&BABYLON.StandardMaterial.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;i.push("#define OPACITY")}if(this.reflectionTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;i.push("#define REFLECTION")}if(this.emissiveTexture&&BABYLON.StandardMaterial.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;i.push("#define EMISSIVE")}if(this.specularTexture&&BABYLON.StandardMaterial.SpecularTextureEnabled){if(!this.specularTexture.isReady())return!1;i.push("#define SPECULAR"),r.push(i[i.length-1])}}if(this._scene.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&BABYLON.StandardMaterial.BumpTextureEnabled){if(!this.bumpTexture.isReady())return!1;i.push("#define BUMP"),r.push(i[i.length-1])}BABYLON.clipPlane&&i.push("#define CLIPPLANE"),t.getAlphaTesting()&&i.push("#define ALPHATEST"),this._scene.fogMode!==BABYLON.Scene.FOGMODE_NONE&&(i.push("#define FOG"),r.push(i[i.length-1]));var n=!1,o=0;if(this._scene.lightsEnabled)for(var s=0;s<this._scene.lights.length;s++){var a=this._scene.lights[s];if(a.isEnabled()&&(!e||-1===a.excludedMeshes.indexOf(e))){i.push("#define LIGHT"+o),o>0&&r.push(i[i.length-1]);var h;h=a instanceof BABYLON.SpotLight?"#define SPOTLIGHT"+o:a instanceof BABYLON.HemisphericLight?"#define HEMILIGHT"+o:"#define POINTDIRLIGHT"+o,i.push(h),o>0&&r.push(i[i.length-1]);var c=a.getShadowGenerator();if(e&&e.receiveShadows&&c&&(i.push("#define SHADOW"+o),o>0&&r.push(i[i.length-1]),n||(i.push("#define SHADOWS"),n=!0),c.useVarianceShadowMap&&(i.push("#define SHADOWVSM"+o),o>0&&r.push(i[i.length-1]))),o++,4==o)break}}var l=[BABYLON.VertexBuffer.PositionKind,BABYLON.VertexBuffer.NormalKind];e&&(e.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)&&(l.push(BABYLON.VertexBuffer.UVKind),i.push("#define UV1")),e.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)&&(l.push(BABYLON.VertexBuffer.UV2Kind),i.push("#define UV2")),e.isVerticesDataPresent(BABYLON.VertexBuffer.ColorKind)&&(l.push(BABYLON.VertexBuffer.ColorKind),i.push("#define VERTEXCOLOR")),e.skeleton&&e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)&&e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)&&(l.push(BABYLON.VertexBuffer.MatricesIndicesKind),l.push(BABYLON.VertexBuffer.MatricesWeightsKind),i.push("#define BONES"),i.push("#define BonesPerMesh "+e.skeleton.bones.length),i.push("#define BONES4"),r.push(i[i.length-1])));var u=i.join("\n");if(this._cachedDefines!=u){this._cachedDefines=u;var f="default";this._scene.getEngine().getCaps().standardDerivatives||(f="legacydefault"),this._effect=this._scene.getEngine().createEffect(f,l,["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vLightData0","vLightDiffuse0","vLightSpecular0","vLightDirection0","vLightGround0","lightMatrix0","vLightData1","vLightDiffuse1","vLightSpecular1","vLightDirection1","vLightGround1","lightMatrix1","vLightData2","vLightDiffuse2","vLightSpecular2","vLightDirection2","vLightGround2","lightMatrix2","vLightData3","vLightDiffuse3","vLightSpecular3","vLightDirection3","vLightGround3","lightMatrix3","vFogInfos","vFogColor","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","darkness0","darkness1","darkness2","darkness3"],["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","shadowSampler0","shadowSampler1","shadowSampler2","shadowSampler3"],u,r)}return this._effect.isReady()?(this._renderId=this._scene.getRenderId(),this._wasPreviouslyReady=!0,!0):!1},BABYLON.StandardMaterial.prototype.getRenderTargetTextures=function(){return this._renderTargets.reset(),this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._renderTargets.push(this.reflectionTexture),this._renderTargets},BABYLON.StandardMaterial.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null)},BABYLON.StandardMaterial.prototype.bind=function(e,t){if(this._baseColor.copyFrom(this.diffuseColor),this._effect.setMatrix("world",e),this._effect.setMatrix("viewProjection",this._scene.getTransformMatrix()),t.skeleton&&t.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)&&t.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)&&this._effect.setMatrices("mBones",t.skeleton.getTransformMatrices()),this.diffuseTexture&&BABYLON.StandardMaterial.DiffuseTextureEnabled&&(this._effect.setTexture("diffuseSampler",this.diffuseTexture),this._effect.setFloat2("vDiffuseInfos",this.diffuseTexture.coordinatesIndex,this.diffuseTexture.level),this._effect.setMatrix("diffuseMatrix",this.diffuseTexture._computeTextureMatrix()),this._baseColor.copyFromFloats(1,1,1)),this.ambientTexture&&BABYLON.StandardMaterial.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat2("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level),this._effect.setMatrix("ambientMatrix",this.ambientTexture._computeTextureMatrix())),this.opacityTexture&&BABYLON.StandardMaterial.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture._computeTextureMatrix())),this.reflectionTexture&&BABYLON.StandardMaterial.ReflectionTextureEnabled&&(this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture._computeReflectionTextureMatrix()),this._effect.setFloat3("vReflectionInfos",this.reflectionTexture.coordinatesMode,this.reflectionTexture.level,this.reflectionTexture.isCube?1:0)),this.emissiveTexture&&BABYLON.StandardMaterial.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture._computeTextureMatrix())),this.specularTexture&&BABYLON.StandardMaterial.SpecularTextureEnabled&&(this._effect.setTexture("specularSampler",this.specularTexture),this._effect.setFloat2("vSpecularInfos",this.specularTexture.coordinatesIndex,this.specularTexture.level),this._effect.setMatrix("specularMatrix",this.specularTexture._computeTextureMatrix())),this.bumpTexture&&this._scene.getEngine().getCaps().standardDerivatives&&BABYLON.StandardMaterial.BumpTextureEnabled&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat2("vBumpInfos",this.bumpTexture.coordinatesIndex,this.bumpTexture.level),this._effect.setMatrix("bumpMatrix",this.bumpTexture._computeTextureMatrix())),this._scene.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),this._effect.setVector3("vEyePosition",this._scene.activeCamera.position),this._effect.setColor3("vAmbientColor",this._globalAmbientColor),this._effect.setColor4("vDiffuseColor",this._baseColor,this.alpha*t.visibility),this._effect.setColor4("vSpecularColor",this.specularColor,this.specularPower),this._effect.setColor3("vEmissiveColor",this.emissiveColor),this._scene.lightsEnabled)for(var i=0,r=0;r<this._scene.lights.length;r++){var n=this._scene.lights[r];if(n.isEnabled()&&(!t||-1===n.excludedMeshes.indexOf(t))){n instanceof BABYLON.PointLight?n.transferToEffect(this._effect,"vLightData"+i):n instanceof BABYLON.DirectionalLight?n.transferToEffect(this._effect,"vLightData"+i):n instanceof BABYLON.SpotLight?n.transferToEffect(this._effect,"vLightData"+i,"vLightDirection"+i):n instanceof BABYLON.HemisphericLight&&n.transferToEffect(this._effect,"vLightData"+i,"vLightGround"+i),n.diffuse.scaleToRef(n.intensity,this._scaledDiffuse),n.specular.scaleToRef(n.intensity,this._scaledSpecular),this._effect.setColor3("vLightDiffuse"+i,this._scaledDiffuse),this._effect.setColor3("vLightSpecular"+i,this._scaledSpecular);var o=n.getShadowGenerator();if(t.receiveShadows&&o&&(e.multiplyToRef(o.getTransformMatrix(),this._lightMatrix),this._effect.setMatrix("lightMatrix"+i,this._lightMatrix),this._effect.setTexture("shadowSampler"+i,o.getShadowMap()),this._effect.setFloat("darkness"+i,o.getDarkness())),i++,4==i)break}}BABYLON.clipPlane&&this._effect.setFloat4("vClipPlane",BABYLON.clipPlane.normal.x,BABYLON.clipPlane.normal.y,BABYLON.clipPlane.normal.z,BABYLON.clipPlane.d),(this._scene.fogMode!==BABYLON.Scene.FOGMODE_NONE||this.reflectionTexture)&&this._effect.setMatrix("view",this._scene.getViewMatrix()),this._scene.fogMode!==BABYLON.Scene.FOGMODE_NONE&&(this._effect.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity),this._effect.setColor3("vFogColor",this._scene.fogColor))},BABYLON.StandardMaterial.prototype.getAnimatables=function(){var e=[];return this.diffuseTexture&&this.diffuseTexture.animations&&this.diffuseTexture.animations.length>0&&e.push(this.diffuseTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&e.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&e.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&e.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&e.push(this.emissiveTexture),this.specularTexture&&this.specularTexture.animations&&this.specularTexture.animations.length>0&&e.push(this.specularTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&e.push(this.bumpTexture),e},BABYLON.StandardMaterial.prototype.dispose=function(){this.diffuseTexture&&this.diffuseTexture.dispose(),this.ambientTexture&&this.ambientTexture.dispose(),this.opacityTexture&&this.opacityTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),this.emissiveTexture&&this.emissiveTexture.dispose(),this.specularTexture&&this.specularTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),this.baseDispose()},BABYLON.StandardMaterial.prototype.clone=function(e){var t=new BABYLON.StandardMaterial(e,this._scene);return t.checkReadyOnEveryCall=this.checkReadyOnEveryCall,t.alpha=this.alpha,t.wireframe=this.wireframe,t.backFaceCulling=this.backFaceCulling,this.diffuseTexture&&this.diffuseTexture.clone&&(t.diffuseTexture=this.diffuseTexture.clone()),this.ambientTexture&&this.ambientTexture.clone&&(t.ambientTexture=this.ambientTexture.clone()),this.opacityTexture&&this.opacityTexture.clone&&(t.opacityTexture=this.opacityTexture.clone()),this.reflectionTexture&&this.reflectionTexture.clone&&(t.reflectionTexture=this.reflectionTexture.clone()),this.emissiveTexture&&this.emissiveTexture.clone&&(t.emissiveTexture=this.emissiveTexture.clone()),this.specularTexture&&this.specularTexture.clone&&(t.specularTexture=this.specularTexture.clone()),this.bumpTexture&&this.bumpTexture.clone&&(t.bumpTexture=this.bumpTexture.clone()),t.ambientColor=this.ambientColor.clone(),t.diffuseColor=this.diffuseColor.clone(),t.specularColor=this.specularColor.clone(),t.specularPower=this.specularPower,t.emissiveColor=this.emissiveColor.clone(),t},BABYLON.StandardMaterial.DiffuseTextureEnabled=!0,BABYLON.StandardMaterial.AmbientTextureEnabled=!0,BABYLON.StandardMaterial.OpacityTextureEnabled=!0,BABYLON.StandardMaterial.ReflectionTextureEnabled=!0,BABYLON.StandardMaterial.EmissiveTextureEnabled=!0,BABYLON.StandardMaterial.SpecularTextureEnabled=!0,BABYLON.StandardMaterial.BumpTextureEnabled=!0}();var BABYLON=BABYLON||{};!function(){BABYLON.MultiMaterial=function(e,t){this.name=e,this.id=e,this._scene=t,t.multiMaterials.push(this),this.subMaterials=[]},BABYLON.MultiMaterial.prototype.getSubMaterial=function(e){return 0>e||e>=this.subMaterials.length?this._scene.defaultMaterial:this.subMaterials[e]},BABYLON.MultiMaterial.prototype.isReady=function(e){for(var t=!0,i=0;i<this.subMaterials.length;i++){var r=this.subMaterials[i];r&&(t&=this.subMaterials[i].isReady(e))}return t}}();var BABYLON=BABYLON||{};!function(){BABYLON.SceneLoader={_registeredPlugins:[],_getPluginForFilename:function(e){for(var t=e.lastIndexOf("."),i=e.substring(t).toLowerCase(),r=0;r<this._registeredPlugins.length;r++){var n=this._registeredPlugins[r];if(-1!==n.extensions.indexOf(i))return n}throw new Error("No plugin found to load this file: "+e)},RegisterPlugin:function(e){e.extensions=e.extensions.toLowerCase(),this._registeredPlugins.push(e)},ImportMesh:function(e,t,i,r,n,o,s){var a=new BABYLON.Database(t+i);r.database=a;var h=this._getPluginForFilename(i);BABYLON.Tools.LoadFile(t+i,function(i){var o=[],a=[],c=[];return h.importMesh(e,r,i,t,o,a,c)?void(n&&n(o,a,c)):void(s&&s(r))},o,a)},Load:function(e,t,i,r,n,o){var s,a=this._getPluginForFilename(t.name||t),h=function(t){var n=new BABYLON.Scene(i);return n.database=s,a.load(n,t,e)?void(r&&r(n)):void(o&&o(n))};-1===e.indexOf("file:")?(s=new BABYLON.Database(e+t),BABYLON.Tools.LoadFile(e+t,h,n,s)):BABYLON.Tools.ReadFile(t,h,n)}}}();var BABYLON=BABYLON||{};!function(){var e=function(e,t,i){var r=new BABYLON.CubeTexture(e+t.name,i);return r.name=t.name,r.hasAlpha=t.hasAlpha,r.level=t.level,r.coordinatesMode=t.coordinatesMode,r},t=function(t,i,r){if(!i.name&&!i.isRenderTarget)return null;if(i.isCube)return e(t,i,r);var n;if(i.mirrorPlane?(n=new BABYLON.MirrorTexture(i.name,i.renderTargetSize,r),n._waitingRenderList=i.renderList,n.mirrorPlane=BABYLON.Plane.FromArray(i.mirrorPlane)):i.isRenderTarget?(n=new BABYLON.RenderTargetTexture(i.name,i.renderTargetSize,r),n._waitingRenderList=i.renderList):n=new BABYLON.Texture(t+i.name,r),n.name=i.name,n.hasAlpha=i.hasAlpha,n.level=i.level,n.coordinatesIndex=i.coordinatesIndex,n.coordinatesMode=i.coordinatesMode,n.uOffset=i.uOffset,n.vOffset=i.vOffset,n.uScale=i.uScale,n.vScale=i.vScale,n.uAng=i.uAng,n.vAng=i.vAng,n.wAng=i.wAng,n.wrapU=i.wrapU,n.wrapV=i.wrapV,i.animations)for(var o=0;o<i.animations.length;o++){var s=i.animations[o];n.animations.push(c(s))}return n},i=function(e,t){for(var i=new BABYLON.Skeleton(e.name,e.id,t),r=0;r<e.bones.length;r++){var n=e.bones[r],o=null;n.parentBoneIndex>-1&&(o=i.bones[n.parentBoneIndex]);var s=new BABYLON.Bone(n.name,i,o,BABYLON.Matrix.FromArray(n.matrix));n.animation&&s.animations.push(c(n.animation))}return i},r=function(e,i,r){var n;return n=new BABYLON.StandardMaterial(e.name,i),n.ambientColor=BABYLON.Color3.FromArray(e.ambient),n.diffuseColor=BABYLON.Color3.FromArray(e.diffuse),n.specularColor=BABYLON.Color3.FromArray(e.specular),n.specularPower=e.specularPower,n.emissiveColor=BABYLON.Color3.FromArray(e.emissive),n.alpha=e.alpha,n.id=e.id,BABYLON.Tags.AddTagsTo(n,e.tags),n.backFaceCulling=e.backFaceCulling,e.diffuseTexture&&(n.diffuseTexture=t(r,e.diffuseTexture,i)),e.ambientTexture&&(n.ambientTexture=t(r,e.ambientTexture,i)),e.opacityTexture&&(n.opacityTexture=t(r,e.opacityTexture,i)),e.reflectionTexture&&(n.reflectionTexture=t(r,e.reflectionTexture,i)),e.emissiveTexture&&(n.emissiveTexture=t(r,e.emissiveTexture,i)),e.specularTexture&&(n.specularTexture=t(r,e.specularTexture,i)),e.bumpTexture&&(n.bumpTexture=t(r,e.bumpTexture,i)),n},n=function(e,t,i,n){for(var o=0;o<t.materials.length;o++){var s=t.materials[o];if(s.id===e)return r(s,i,n)}return null},o=function(e,t){var i=new BABYLON.MultiMaterial(e.name,t);i.id=e.id,BABYLON.Tags.AddTagsTo(i,e.tags);for(var r=0;r<e.materials.length;r++){var n=e.materials[r];i.subMaterials.push(n?t.getMaterialByID(n):null)}return i},s=function(e,t,i){var r=t.getLastEntryByID(e.emitterId),n=new BABYLON.LensFlareSystem("lensFlareSystem#"+e.emitterId,r,t);n.borderLimit=e.borderLimit;for(var o=0;o<e.flares.length;o++){var s=e.flares[o];new BABYLON.LensFlare(s.size,s.position,BABYLON.Color3.FromArray(s.color),i+s.textureName,n)}return n},a=function(e,t,i){var r=t.getLastMeshByID(e.emitterId),n=new BABYLON.ParticleSystem("particles#"+r.name,e.capacity,t);return e.textureName&&(n.particleTexture=new BABYLON.Texture(i+e.textureName,t),n.particleTexture.name=e.textureName),n.minAngularSpeed=e.minAngularSpeed,n.maxAngularSpeed=e.maxAngularSpeed,n.minSize=e.minSize,n.maxSize=e.maxSize,n.minLifeTime=e.minLifeTime,n.maxLifeTime=e.maxLifeTime,n.emitter=r,n.emitRate=e.emitRate,n.minEmitBox=BABYLON.Vector3.FromArray(e.minEmitBox),n.maxEmitBox=BABYLON.Vector3.FromArray(e.maxEmitBox),n.gravity=BABYLON.Vector3.FromArray(e.gravity),n.direction1=BABYLON.Vector3.FromArray(e.direction1),n.direction2=BABYLON.Vector3.FromArray(e.direction2),n.color1=BABYLON.Color4.FromArray(e.color1),n.color2=BABYLON.Color4.FromArray(e.color2),n.colorDead=BABYLON.Color4.FromArray(e.colorDead),n.updateSpeed=e.updateSpeed,n.targetStopDuration=e.targetStopFrame,n.textureMask=BABYLON.Color4.FromArray(e.textureMask),n.blendMode=e.blendMode,n.start(),n},h=function(e,t){for(var i=t.getLightByID(e.lightId),r=new BABYLON.ShadowGenerator(e.mapSize,i),n=0;n<e.renderList.length;n++){var o=t.getMeshByID(e.renderList[n]);r.getShadowMap().renderList.push(o)}return r.useVarianceShadowMap=e.useVarianceShadowMap,r},c=function(e){for(var t=new BABYLON.Animation(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[],n=0;n<e.keys.length;n++){var o,s=e.keys[n];switch(i){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:o=s.values[0];break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:o=BABYLON.Quaternion.FromArray(s.values);break;case BABYLON.Animation.ANIMATIONTYPE_MATRIX:o=BABYLON.Matrix.FromArray(s.values);break;case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:default:o=BABYLON.Vector3.FromArray(s.values)}r.push({frame:s.frame,value:o})}return t.setKeys(r),t},l=function(e,t){var i;switch(e.type){case 0:i=new BABYLON.PointLight(e.name,BABYLON.Vector3.FromArray(e.position),t);break;case 1:i=new BABYLON.DirectionalLight(e.name,BABYLON.Vector3.FromArray(e.direction),t),i.position=BABYLON.Vector3.FromArray(e.position);break;case 2:i=new BABYLON.SpotLight(e.name,BABYLON.Vector3.FromArray(e.position),BABYLON.Vector3.FromArray(e.direction),e.angle,e.exponent,t);break;case 3:i=new BABYLON.HemisphericLight(e.name,BABYLON.Vector3.FromArray(e.direction),t),i.groundColor=BABYLON.Color3.FromArray(e.groundColor)}i.id=e.id,BABYLON.Tags.AddTagsTo(i,e.tags),e.intensity&&(i.intensity=e.intensity),i.diffuse=BABYLON.Color3.FromArray(e.diffuse),i.specular=BABYLON.Color3.FromArray(e.specular)},u=function(e,t){var i=new BABYLON.FreeCamera(e.name,BABYLON.Vector3.FromArray(e.position),t);if(i.id=e.id,BABYLON.Tags.AddTagsTo(i,e.tags),e.parentId&&(i._waitingParentId=e.parentId),e.target?i.setTarget(BABYLON.Vector3.FromArray(e.target)):i.rotation=BABYLON.Vector3.FromArray(e.rotation),e.lockedTargetId&&(i._waitingLockedTargetId=e.lockedTargetId),i.fov=e.fov,i.minZ=e.minZ,i.maxZ=e.maxZ,i.speed=e.speed,i.inertia=e.inertia,i.checkCollisions=e.checkCollisions,i.applyGravity=e.applyGravity,e.ellipsoid&&(i.ellipsoid=BABYLON.Vector3.FromArray(e.ellipsoid)),e.animations)for(var r=0;r<e.animations.length;r++){var n=e.animations[r];i.animations.push(c(n))}return e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,1),i},f=function(e,t,i){var r=new BABYLON.Mesh(e.name,t);if(r.id=e.id,BABYLON.Tags.AddTagsTo(r,e.tags),r.position=BABYLON.Vector3.FromArray(e.position),e.rotation?r.rotation=BABYLON.Vector3.FromArray(e.rotation):e.rotationQuaternion&&(r.rotationQuaternion=BABYLON.Quaternion.FromArray(e.rotationQuaternion)),r.scaling=BABYLON.Vector3.FromArray(e.scaling),e.localMatrix&&r.setPivotMatrix(BABYLON.Matrix.FromArray(e.localMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.receiveShadows=e.receiveShadows,r.billboardMode=e.billboardMode,void 0!==e.visibility&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r._shouldGenerateFlatShading=e.useFlatShading,e.parentId&&(r.parent=t.getLastEntryByID(e.parentId)),e.delayLoadingFile?(r.delayLoadState=BABYLON.Engine.DELAYLOADSTATE_NOTLOADED,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new BABYLON.BoundingInfo(BABYLON.Vector3.FromArray(e.boundingBoxMinimum),BABYLON.Vector3.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(BABYLON.VertexBuffer.UVKind),e.hasUVs2&&r._delayInfo.push(BABYLON.VertexBuffer.UV2Kind),e.hasColors&&r._delayInfo.push(BABYLON.VertexBuffer.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(BABYLON.VertexBuffer.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(BABYLON.VertexBuffer.MatricesWeightsKind),r._delayLoadingFunction=p):p(e,r),e.materialId?r.setMaterialByID(e.materialId):r.material=null,e.skeletonId>-1&&(r.skeleton=t.getLastSkeletonByID(e.skeletonId)),e.physicsImpostor)switch(t.isPhysicsEnabled()||t.enablePhysics(),e.physicsImpostor){case 1:r.setPhysicsState({impostor:BABYLON.PhysicsEngine.BoxImpostor,mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution});break;case 2:r.setPhysicsState({impostor:BABYLON.PhysicsEngine.SphereImpostor,mass:e.physicsMass,friction:e.physicsFriction,restitution:e.physicsRestitution})}if(e.animations)for(var n=0;n<e.animations.length;n++){var o=e.animations[n];r.animations.push(c(o))}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,1),r},B=function(e,t,i){t=t instanceof Array?t:[t];for(var r in t)if(e.name===t[r])return i.push(e.id),!0;return e.parentId&&-1!==i.indexOf(e.parentId)?(i.push(e.id),!0):!1},p=function(e,t){if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(e.positions,BABYLON.VertexBuffer.PositionKind,!1),t.setVerticesData(e.normals,BABYLON.VertexBuffer.NormalKind,!1),e.uvs&&t.setVerticesData(e.uvs,BABYLON.VertexBuffer.UVKind,!1),e.uvs2&&t.setVerticesData(e.uvs2,BABYLON.VertexBuffer.UV2Kind,!1),e.colors&&t.setVerticesData(e.colors,BABYLON.VertexBuffer.ColorKind,!1),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(e.matricesIndices,BABYLON.VertexBuffer.MatricesIndicesKind,!1);else{for(var i=[],r=0;r<e.matricesIndices.length;r++){var n=e.matricesIndices[r];i.push(255&n),i.push((65280&n)>>8),i.push((16711680&n)>>16),i.push(n>>24)}t.setVerticesData(i,BABYLON.VertexBuffer.MatricesIndicesKind,!1)}e.matricesWeights&&t.setVerticesData(e.matricesWeights,BABYLON.VertexBuffer.MatricesWeightsKind,!1),t.setIndices(e.indices)}if(e.subMeshes){t.subMeshes=[];for(var o=0;o<e.subMeshes.length;o++){var s=e.subMeshes[o];new BABYLON.SubMesh(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,t)}}t.computeWorldMatrix(!0),t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),delete t._shouldGenerateFlatShading);var a=t.getScene();a._selectionOctree&&a._selectionOctree.addMesh(t)};BABYLON.SceneLoader.RegisterPlugin({extensions:".babylon",importMesh:function(e,t,r,s,h,c,l){for(var u=JSON.parse(r),p=[],d=[],m=[],A=0;A<u.meshes.length;A++){var _=u.meshes[A];if(!e||B(_,e,m)){if(e instanceof Array&&delete e[e.indexOf(_.name)],_.materialId){var v=-1!==d.indexOf(_.materialId);if(!v)for(var g=0;g<u.multiMaterials.length;g++){var L=u.multiMaterials[g];if(L.id==_.materialId){for(var O=0;O<L.materials.length;O++){var N=L.materials[O];d.push(N),n(N,u,t,s)}d.push(L.id),o(L,t),v=!0;break}}v||(d.push(_.materialId),n(_.materialId,u,t,s))}if(_.skeletonId>-1&&t.skeletons){var y=p.indexOf(_.skeletonId)>-1;if(!y)for(var x=0;x<u.skeletons.length;x++){var Y=u.skeletons[x];Y.id===_.skeletonId&&(l.push(i(Y,t)),p.push(Y.id))}}var M=f(_,t,s);h.push(M)}}if(u.particleSystems)for(var A=0;A<u.particleSystems.length;A++){var T=u.particleSystems[A];-1!==m.indexOf(T.emitterId)&&c.push(a(T,t,s))}return!0},load:function(e,t,n){var c=JSON.parse(t);e.useDelayedTextureLoading=c.useDelayedTextureLoading,e.autoClear=c.autoClear,e.clearColor=BABYLON.Color3.FromArray(c.clearColor),e.ambientColor=BABYLON.Color3.FromArray(c.ambientColor),e.gravity=BABYLON.Vector3.FromArray(c.gravity),c.fogMode&&0!==c.fogMode&&(e.fogMode=c.fogMode,e.fogColor=BABYLON.Color3.FromArray(c.fogColor),e.fogStart=c.fogStart,e.fogEnd=c.fogEnd,e.fogDensity=c.fogDensity);for(var B=0;B<c.lights.length;B++){var p=c.lights[B];l(p,e)}for(var B=0;B<c.cameras.length;B++){var d=c.cameras[B];u(d,e)}if(c.activeCameraID&&e.setActiveCameraByID(c.activeCameraID),c.materials)for(var B=0;B<c.materials.length;B++){var m=c.materials[B];r(m,e,n)}if(c.multiMaterials)for(var B=0;B<c.multiMaterials.length;B++){var A=c.multiMaterials[B];o(A,e)}if(c.skeletons)for(var B=0;B<c.skeletons.length;B++){var _=c.skeletons[B];i(_,e)}for(var B=0;B<c.meshes.length;B++){var v=c.meshes[B];f(v,e,n)}for(var B=0;B<e.cameras.length;B++){var g=e.cameras[B];g._waitingParentId&&(g.parent=e.getLastEntryByID(g._waitingParentId),delete g._waitingParentId),g._waitingLockedTargetId&&(g.lockedTarget=e.getLastEntryByID(g._waitingLockedTargetId),delete g._waitingLockedTargetId)}if(c.particleSystems)for(var B=0;B<c.particleSystems.length;B++){var L=c.particleSystems[B];a(L,e,n)}if(c.lensFlareSystems)for(var B=0;B<c.lensFlareSystems.length;B++){var O=c.lensFlareSystems[B];s(O,e,n)}if(c.shadowGenerators)for(var B=0;B<c.shadowGenerators.length;B++){var N=c.shadowGenerators[B];h(N,e)}return!0}})}();var BABYLON=BABYLON||{};!function(){BABYLON.SpriteManager=function(e,t,i,r,n,o){this.name=e,this._capacity=i,this.cellSize=r,this._spriteTexture=new BABYLON.Texture(t,n,!0,!1),this._spriteTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE,this._spriteTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE,this._epsilon=void 0===o?.01:o,this._scene=n,this._scene.spriteManagers.push(this),this._vertexDeclaration=[3,4,4,4],this._vertexStrideSize=60,this._vertexBuffer=n.getEngine().createDynamicVertexBuffer(i*this._vertexStrideSize*4);for(var s=[],a=0,h=0;i>h;h++)s.push(a),s.push(a+1),s.push(a+2),s.push(a),s.push(a+2),s.push(a+3),a+=4;this._indexBuffer=n.getEngine().createIndexBuffer(s),this._vertices=new Float32Array(i*this._vertexStrideSize),this.sprites=[],this._effectBase=this._scene.getEngine().createEffect("sprites",["position","options","cellInfo","color"],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],""),this._effectFog=this._scene.getEngine().createEffect("sprites",["position","options","cellInfo","color"],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG")},BABYLON.SpriteManager.prototype.renderingGroupId=0,BABYLON.SpriteManager.prototype.onDispose=null,BABYLON.SpriteManager.prototype._appendSpriteVertex=function(e,t,i,r,n){var o=15*e;0==i?i=this._epsilon:1==i&&(i=1-this._epsilon),0==r?r=this._epsilon:1==r&&(r=1-this._epsilon),this._vertices[o]=t.position.x,this._vertices[o+1]=t.position.y,this._vertices[o+2]=t.position.z,this._vertices[o+3]=t.angle,this._vertices[o+4]=t.size,this._vertices[o+5]=i,this._vertices[o+6]=r,this._vertices[o+7]=t.invertU?1:0,this._vertices[o+8]=t.invertV?1:0;var s=t.cellIndex/n>>0;this._vertices[o+9]=t.cellIndex-s*n,this._vertices[o+10]=s,this._vertices[o+11]=t.color.r,this._vertices[o+12]=t.color.g,this._vertices[o+13]=t.color.b,this._vertices[o+14]=t.color.a},BABYLON.SpriteManager.prototype.render=function(){if(!(this._effectBase.isReady()&&this._effectFog.isReady()&&this._spriteTexture&&this._spriteTexture.isReady()))return 0;for(var e=this._scene.getEngine(),t=this._spriteTexture.getBaseSize(),i=BABYLON.Tools.GetDeltaTime(),r=Math.min(this._capacity,this.sprites.length),n=t.width/this.cellSize,o=0,s=0;r>s;s++){var a=this.sprites[s];a&&(a._animate(i),this._appendSpriteVertex(o++,a,0,0,n),this._appendSpriteVertex(o++,a,1,0,n),this._appendSpriteVertex(o++,a,1,1,n),this._appendSpriteVertex(o++,a,0,1,n))}e.updateDynamicVertexBuffer(this._vertexBuffer,this._vertices,r*this._vertexStrideSize);var h=this._effectBase;this._scene.fogMode!==BABYLON.Scene.FOGMODE_NONE&&(h=this._effectFog),e.enableEffect(h);var c=this._scene.getViewMatrix();h.setTexture("diffuseSampler",this._spriteTexture),h.setMatrix("view",c),h.setMatrix("projection",this._scene.getProjectionMatrix()),h.setFloat2("textureInfos",this.cellSize/t.width,this.cellSize/t.height),this._scene.fogMode!==BABYLON.Scene.FOGMODE_NONE&&(h.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity),h.setColor3("vFogColor",this._scene.fogColor)),e.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,h),h.setBool("alphaTest",!0),e.setColorWrite(!1),e.draw(!0,0,6*r),e.setColorWrite(!0),h.setBool("alphaTest",!1),e.setAlphaMode(BABYLON.Engine.ALPHA_COMBINE),e.draw(!0,0,6*r),e.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)},BABYLON.SpriteManager.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._spriteTexture&&(this._spriteTexture.dispose(),this._spriteTexture=null);
var e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1),this.onDispose&&this.onDispose()}}();var BABYLON=BABYLON||{};!function(){BABYLON.Sprite=function(e,t){this.name=e,this._manager=t,this._manager.sprites.push(this),this.position=BABYLON.Vector3.Zero(),this.color=new BABYLON.Color4(1,1,1,1),this._frameCount=0},BABYLON.Sprite.prototype.position=null,BABYLON.Sprite.prototype.size=1,BABYLON.Sprite.prototype.angle=0,BABYLON.Sprite.prototype.cellIndex=0,BABYLON.Sprite.prototype.invertU=0,BABYLON.Sprite.prototype.invertV=0,BABYLON.Sprite.prototype.disposeWhenFinishedAnimating=!1,BABYLON.Sprite.prototype._animationStarted=!1,BABYLON.Sprite.prototype._loopAnimation=!1,BABYLON.Sprite.prototype._fromIndex=!1,BABYLON.Sprite.prototype._toIndex=!1,BABYLON.Sprite.prototype._delay=!1,BABYLON.Sprite.prototype._direction=1,BABYLON.Sprite.prototype.playAnimation=function(e,t,i,r){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r,this._animationStarted=!0,this._direction=t>e?1:-1,this.cellIndex=e,this._time=0},BABYLON.Sprite.prototype.stopAnimation=function(){this._animationStarted=!1},BABYLON.Sprite.prototype._animate=function(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,this.cellIndex==this._toIndex&&(this._loopAnimation?this.cellIndex=this._fromIndex:(this._animationStarted=!1,this.disposeWhenFinishedAnimating&&this.dispose()))))},BABYLON.Sprite.prototype.dispose=function(){for(var e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1)}}();var BABYLON=BABYLON||{};!function(){BABYLON.Layer=function(e,t,i,r,n){this.name=e,this.texture=t?new BABYLON.Texture(t,i,!0):null,this.isBackground=void 0===r?!0:r,this.color=void 0===n?new BABYLON.Color4(1,1,1,1):n,this._scene=i,this._scene.layers.push(this);var o=[];o.push(1,1),o.push(-1,1),o.push(-1,-1),o.push(1,-1),this._vertexDeclaration=[2],this._vertexStrideSize=8,this._vertexBuffer=i.getEngine().createVertexBuffer(o);var s=[];s.push(0),s.push(1),s.push(2),s.push(0),s.push(2),s.push(3),this._indexBuffer=i.getEngine().createIndexBuffer(s),this._effect=this._scene.getEngine().createEffect("layer",["position"],["textureMatrix","color"],["textureSampler"],"")},BABYLON.Layer.prototype.onDispose=null,BABYLON.Layer.prototype.render=function(){if(this._effect.isReady()&&this.texture&&this.texture.isReady()){var e=this._scene.getEngine();e.enableEffect(this._effect),e.setState(!1),this._effect.setTexture("textureSampler",this.texture),this._effect.setMatrix("textureMatrix",this.texture._computeTextureMatrix()),this._effect.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),e.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,this._effect),e.setAlphaMode(BABYLON.Engine.ALPHA_COMBINE),e.draw(!0,0,6),e.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE)}},BABYLON.Layer.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null);var e=this._scene.layers.indexOf(this);this._scene.layers.splice(e,1),this.onDispose&&this.onDispose()}}();var BABYLON=BABYLON||{};!function(){BABYLON.Particle=function(){this.position=BABYLON.Vector3.Zero(),this.direction=BABYLON.Vector3.Zero(),this.color=new BABYLON.Color4(0,0,0,0),this.colorStep=new BABYLON.Color4(0,0,0,0)},BABYLON.Particle.prototype.lifeTime=1,BABYLON.Particle.prototype.age=0,BABYLON.Particle.prototype.size=0,BABYLON.Particle.prototype.angle=0,BABYLON.Particle.prototype.angularSpeed=0}();var BABYLON=BABYLON||{};!function(){var e=function(e,t){if(e==t)return e;var i=Math.random();return i*(t-e)+e};BABYLON.ParticleSystem=function(e,t,i){this.name=e,this.id=e,this._capacity=t,this._scene=i,i.particleSystems.push(this),this.gravity=BABYLON.Vector3.Zero(),this.direction1=new BABYLON.Vector3(0,1,0),this.direction2=new BABYLON.Vector3(0,1,0),this.minEmitBox=new BABYLON.Vector3(-.5,-.5,-.5),this.maxEmitBox=new BABYLON.Vector3(.5,.5,.5),this.color1=new BABYLON.Color4(1,1,1,1),this.color2=new BABYLON.Color4(1,1,1,1),this.colorDead=new BABYLON.Color4(0,0,0,1),this.textureMask=new BABYLON.Color4(1,1,1,1),this.particles=[],this._stockParticles=[],this._newPartsExcess=0,this._vertexDeclaration=[3,4,4],this._vertexStrideSize=44,this._vertexBuffer=i.getEngine().createDynamicVertexBuffer(t*this._vertexStrideSize*4);for(var r=[],n=0,o=0;t>o;o++)r.push(n),r.push(n+1),r.push(n+2),r.push(n),r.push(n+2),r.push(n+3),n+=4;this._indexBuffer=i.getEngine().createIndexBuffer(r),this._vertices=new Float32Array(t*this._vertexStrideSize),this._scaledColorStep=new BABYLON.Color4(0,0,0,0),this._colorDiff=new BABYLON.Color4(0,0,0,0),this._scaledDirection=BABYLON.Vector3.Zero(),this._scaledGravity=BABYLON.Vector3.Zero(),this._currentRenderId=-1},BABYLON.ParticleSystem.prototype.renderingGroupId=0,BABYLON.ParticleSystem.prototype.emitter=null,BABYLON.ParticleSystem.prototype.emitRate=10,BABYLON.ParticleSystem.prototype.manualEmitCount=-1,BABYLON.ParticleSystem.prototype.updateSpeed=.01,BABYLON.ParticleSystem.prototype.targetStopDuration=0,BABYLON.ParticleSystem.prototype.disposeOnStop=!1,BABYLON.ParticleSystem.prototype.minEmitPower=1,BABYLON.ParticleSystem.prototype.maxEmitPower=1,BABYLON.ParticleSystem.prototype.minLifeTime=1,BABYLON.ParticleSystem.prototype.maxLifeTime=1,BABYLON.ParticleSystem.prototype.minSize=1,BABYLON.ParticleSystem.prototype.maxSize=1,BABYLON.ParticleSystem.prototype.minAngularSpeed=0,BABYLON.ParticleSystem.prototype.maxAngularSpeed=0,BABYLON.ParticleSystem.prototype.particleTexture=null,BABYLON.ParticleSystem.prototype.onDispose=null,BABYLON.ParticleSystem.prototype.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE,BABYLON.ParticleSystem.prototype.forceDepthWrite=!1,BABYLON.ParticleSystem.prototype.isAlive=function(){return this._alive},BABYLON.ParticleSystem.prototype.start=function(){this._started=!0,this._stopped=!1,this._actualFrame=0},BABYLON.ParticleSystem.prototype.stop=function(){this._stopped=!0},BABYLON.ParticleSystem.prototype._appendParticleVertex=function(e,t,i,r){var n=11*e;this._vertices[n]=t.position.x,this._vertices[n+1]=t.position.y,this._vertices[n+2]=t.position.z,this._vertices[n+3]=t.color.r,this._vertices[n+4]=t.color.g,this._vertices[n+5]=t.color.b,this._vertices[n+6]=t.color.a,this._vertices[n+7]=t.angle,this._vertices[n+8]=t.size,this._vertices[n+9]=i,this._vertices[n+10]=r},BABYLON.ParticleSystem.prototype._update=function(t){this._alive=this.particles.length>0;for(var i=0;i<this.particles.length;i++){var r=this.particles[i];r.age+=this._scaledUpdateSpeed,r.age>=r.lifeTime?(this._stockParticles.push(this.particles.splice(i,1)[0]),i--):(r.colorStep.scaleToRef(this._scaledUpdateSpeed,this._scaledColorStep),r.color.addInPlace(this._scaledColorStep),r.color.a<0&&(r.color.a=0),r.direction.scaleToRef(this._scaledUpdateSpeed,this._scaledDirection),r.position.addInPlace(this._scaledDirection),r.angle+=r.angularSpeed*this._scaledUpdateSpeed,this.gravity.scaleToRef(this._scaledUpdateSpeed,this._scaledGravity),r.direction.addInPlace(this._scaledGravity))}var n;n=this.emitter.position?this.emitter.getWorldMatrix():BABYLON.Matrix.Translation(this.emitter.x,this.emitter.y,this.emitter.z);for(var i=0;t>i&&this.particles.length!=this._capacity;i++){0!==this._stockParticles.length?(r=this._stockParticles.pop(),r.age=0):r=new BABYLON.Particle,this.particles.push(r);var o=e(this.minEmitPower,this.maxEmitPower),s=e(this.direction1.x,this.direction2.x),a=e(this.direction1.y,this.direction2.y),h=e(this.direction1.z,this.direction2.z);BABYLON.Vector3.TransformNormalFromFloatsToRef(s*o,a*o,h*o,n,r.direction),r.lifeTime=e(this.minLifeTime,this.maxLifeTime),r.size=e(this.minSize,this.maxSize),r.angularSpeed=e(this.minAngularSpeed,this.maxAngularSpeed),s=e(this.minEmitBox.x,this.maxEmitBox.x),a=e(this.minEmitBox.y,this.maxEmitBox.y),h=e(this.minEmitBox.z,this.maxEmitBox.z),BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(s,a,h,n,r.position);var c=e(0,1);BABYLON.Color4.LerpToRef(this.color1,this.color2,c,r.color),this.colorDead.subtractToRef(r.color,this._colorDiff),this._colorDiff.scaleToRef(1/r.lifeTime,r.colorStep)}},BABYLON.ParticleSystem.prototype._getEffect=function(){var e=[];BABYLON.clipPlane&&e.push("#define CLIPPLANE");var t=e.join("\n");return this._cachedDefines!=t&&(this._cachedDefines=t,this._effect=this._scene.getEngine().createEffect("particles",["position","color","options"],["invView","view","projection","vClipPlane","textureMask"],["diffuseSampler"],t)),this._effect},BABYLON.ParticleSystem.prototype.animate=function(){if(this._started){var e=this._getEffect();if(this.emitter&&e.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this._currentRenderId!==this._scene.getRenderId()){this._currentRenderId=this._scene.getRenderId(),this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio();var t;this.manualEmitCount>-1?(t=this.manualEmitCount,this.manualEmitCount=0):t=this.emitRate;var i=t*this._scaledUpdateSpeed>>0;this._newPartsExcess+=t*this._scaledUpdateSpeed-i,this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.disposeOnStop&&this._scene._toBeDisposed.push(this)));for(var r=0,n=0;n<this.particles.length;n++){var o=this.particles[n];this._appendParticleVertex(r++,o,0,0),this._appendParticleVertex(r++,o,1,0),this._appendParticleVertex(r++,o,1,1),this._appendParticleVertex(r++,o,0,1)}var s=this._scene.getEngine();s.updateDynamicVertexBuffer(this._vertexBuffer,this._vertices,this.particles.length*this._vertexStrideSize)}}},BABYLON.ParticleSystem.prototype.render=function(){var e=this._getEffect();if(!(this.emitter&&e.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this.particles.length))return 0;var t=this._scene.getEngine();t.enableEffect(e);var i=this._scene.getViewMatrix();if(e.setTexture("diffuseSampler",this.particleTexture),e.setMatrix("view",i),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),BABYLON.clipPlane){var r=i.clone();r.invert(),e.setMatrix("invView",r),e.setFloat4("vClipPlane",BABYLON.clipPlane.normal.x,BABYLON.clipPlane.normal.y,BABYLON.clipPlane.normal.z,BABYLON.clipPlane.d)}return t.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,e),t.setAlphaMode(this.blendMode===BABYLON.ParticleSystem.BLENDMODE_ONEONE?BABYLON.Engine.ALPHA_ADD:BABYLON.Engine.ALPHA_COMBINE),this.forceDepthWrite&&this.setDepthWrite(!0),t.draw(!0,0,6*this.particles.length),t.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE),this.particles.length},BABYLON.ParticleSystem.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null);var e=this._scene.particleSystems.indexOf(this);this._scene.particleSystems.splice(e,1),this.onDispose&&this.onDispose()},BABYLON.ParticleSystem.prototype.clone=function(e,t){var i=new BABYLON.ParticleSystem(e,this._capacity,this._scene);return BABYLON.Tools.DeepCopy(this,i,["particles"],["_vertexDeclaration","_vertexStrideSize"]),void 0===t&&(t=this.emitter),i.emitter=t,this.particleTexture&&(i.particleTexture=new BABYLON.Texture(this.particleTexture.url,this._scene)),i.start(),i},BABYLON.ParticleSystem.BLENDMODE_ONEONE=0,BABYLON.ParticleSystem.BLENDMODE_STANDARD=1}();var BABYLON=BABYLON||{};!function(){BABYLON.Animation=function(e,t,i,r,n){this.name=e,this.targetProperty=t,this.targetPropertyPath=t.split("."),this.framePerSecond=i,this.dataType=r,this.loopMode=void 0===n?BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:n,this._keys=[],this._offsetsCache={},this._highLimitsCache={}},BABYLON.Animation.prototype.floatInterpolateFunction=function(e,t,i){return e+(t-e)*i},BABYLON.Animation.prototype.quaternionInterpolateFunction=function(e,t,i){return BABYLON.Quaternion.Slerp(e,t,i)},BABYLON.Animation.prototype.vector3InterpolateFunction=function(e,t,i){return BABYLON.Vector3.Lerp(e,t,i)},BABYLON.Animation.prototype.clone=function(){var e=new BABYLON.Animation(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);return e.setKeys(this._keys),e},BABYLON.Animation.prototype.setKeys=function(e){this._keys=e.slice(0),this._offsetsCache={},this._highLimitsCache={}},BABYLON.Animation.prototype._interpolate=function(e,t,i,r,n){if(i===BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT&&t>0)return n.clone?n.clone():n;this.currentFrame=e;for(var o=0;o<this._keys.length;o++)if(this._keys[o+1].frame>=e){var s=this._keys[o].value,a=this._keys[o+1].value,h=(e-this._keys[o].frame)/(this._keys[o+1].frame-this._keys[o].frame);switch(this.dataType){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:switch(i){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return this.floatInterpolateFunction(s,a,h);case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return r*t+this.floatInterpolateFunction(s,a,h)}break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:var c=null;switch(i){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:c=this.quaternionInterpolateFunction(s,a,h);break;case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:c=this.quaternionInterpolateFunction(s,a,h).add(r.scale(t))}return c;case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:switch(i){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:return this.vector3InterpolateFunction(s,a,h);case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return this.vector3InterpolateFunction(s,a,h).add(r.scale(t))}case BABYLON.Animation.ANIMATIONTYPE_MATRIX:switch(i){case BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:case BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT:case BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE:return s}}break}return this._keys[this._keys.length-1].value},BABYLON.Animation.prototype.animate=function(e,t,i,r,n,o){if(!this.targetPropertyPath||this.targetPropertyPath.length<1)return!1;var s=!0;if(0!=this._keys[0].frame){var a={frame:0,value:this._keys[0].value};this._keys.splice(0,0,a)}(i<this._keys[0].frame||i>this._keys[this._keys.length-1].frame)&&(i=this._keys[0].frame),(r<this._keys[0].frame||r>this._keys[this._keys.length-1].frame)&&(r=this._keys[this._keys.length-1].frame);var h=r-i,c=t*this.framePerSecond*o/1e3;if(c>h&&!n)l=0,s=!1;else{var l=0,u=0;if(this.loopMode!=BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE){var f=r.toString()+i.toString();if(!this._offsetsCache[f]){var B=this._interpolate(i,0,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),p=this._interpolate(r,0,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);switch(this.dataType){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:this._offsetsCache[f]=p-B;break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:this._offsetsCache[f]=p.subtract(B);break;case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:this._offsetsCache[f]=p.subtract(B)}this._highLimitsCache[f]=p}u=this._highLimitsCache[f],l=this._offsetsCache[f]}}var d=c/h>>0,m=s?i+c%h:r,A=this._interpolate(m,d,this.loopMode,l,u);if(this.targetPropertyPath.length>1){for(var _=e[this.targetPropertyPath[0]],v=1;v<this.targetPropertyPath.length-1;v++)_=_[this.targetPropertyPath[v]];_[this.targetPropertyPath[this.targetPropertyPath.length-1]]=A}else e[this.targetPropertyPath[0]]=A;return e.markAsDirty&&e.markAsDirty(this.targetProperty),s},BABYLON.Animation.ANIMATIONTYPE_FLOAT=0,BABYLON.Animation.ANIMATIONTYPE_VECTOR3=1,BABYLON.Animation.ANIMATIONTYPE_QUATERNION=2,BABYLON.Animation.ANIMATIONTYPE_MATRIX=3,BABYLON.Animation.ANIMATIONLOOPMODE_RELATIVE=0,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE=1,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT=2}();var BABYLON=BABYLON||{};!function(){BABYLON._Animatable=function(e,t,i,r,n,o){this.target=e,this.fromFrame=t,this.toFrame=i,this.loopAnimation=r,this.speedRatio=n?n:1,this.onAnimationEnd=o},BABYLON._Animatable.prototype.target=null,BABYLON._Animatable.prototype.animationStarted=!1,BABYLON._Animatable.prototype.loopAnimation=!1,BABYLON._Animatable.prototype.fromFrame=0,BABYLON._Animatable.prototype.toFrame=100,BABYLON._Animatable.prototype.speedRatio=1,BABYLON._Animatable.prototype._animate=function(e){this._localDelayOffset||(this._localDelayOffset=e);for(var t=!1,i=this.target.animations,r=0;r<i.length;r++){var n=i[r].animate(this.target,e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this.speedRatio);t=t||n}return!t&&this.onAnimationEnd&&this.onAnimationEnd(),t}}();var BABYLON=BABYLON||{};!function(){BABYLON.Octree=function(e){this.blocks=[],this._maxBlockCapacity=e||64,this._selection=new BABYLON.Tools.SmartArray(256)},BABYLON.Octree.prototype.update=function(e,t,i){BABYLON.Octree._CreateBlocks(e,t,i,this._maxBlockCapacity,this)},BABYLON.Octree.prototype.addMesh=function(e){for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addMesh(e)}},BABYLON.Octree.prototype.select=function(e){this._selection.reset();for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.select(e,this._selection)}return this._selection},BABYLON.Octree._CreateBlocks=function(e,t,i,r,n){n.blocks=[];for(var o=new BABYLON.Vector3((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2),s=0;2>s;s++)for(var a=0;2>a;a++)for(var h=0;2>h;h++){var c=e.add(o.multiplyByFloats(s,a,h)),l=e.add(o.multiplyByFloats(s+1,a+1,h+1)),u=new BABYLON.OctreeBlock(c,l,r);u.addEntries(i),n.blocks.push(u)}}}();var BABYLON=BABYLON||{};!function(){BABYLON.OctreeBlock=function(e,t,i){this.subMeshes=[],this.meshes=[],this._capacity=i,this._minPoint=e,this._maxPoint=t,this._boundingVectors=[],this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y},BABYLON.OctreeBlock.prototype.addMesh=function(e){if(this.blocks)for(var t=0;t<this.blocks.length;t++){var i=this.blocks[t];i.addMesh(e)}else{if(e.getBoundingInfo().boundingBox.intersectsMinMax(this._minPoint,this._maxPoint)){var r=this.meshes.length;this.meshes.push(e),this.subMeshes[r]=[];for(var n=0;n<e.subMeshes.length;n++){var o=e.subMeshes[n];(1===e.subMeshes.length||o.getBoundingInfo().boundingBox.intersectsMinMax(this._minPoint,this._maxPoint))&&this.subMeshes[r].push(o)}}this.subMeshes.length>this._capacity&&BABYLON.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.meshes,this._capacity,this)}},BABYLON.OctreeBlock.prototype.addEntries=function(e){for(var t=0;t<e.length;t++){var i=e[t];this.addMesh(i)}},BABYLON.OctreeBlock.prototype.select=function(e,t){if(this.blocks)for(var i=0;i<this.blocks.length;i++){var r=this.blocks[i];r.select(e,t)}else BABYLON.BoundingBox.IsInFrustum(this._boundingVectors,e)&&t.push(this)}}();var BABYLON=BABYLON||{};!function(){BABYLON.Bone=function(e,t,i,r){this.name=e,this._skeleton=t,this._matrix=r,this._baseMatrix=r,this._worldTransform=new BABYLON.Matrix,this._absoluteTransform=new BABYLON.Matrix,this._invertedAbsoluteTransform=new BABYLON.Matrix,this.children=[],this.animations=[],t.bones.push(this),i?(this._parent=i,i.children.push(this)):this._parent=null,this._updateDifferenceMatrix()},BABYLON.Bone.prototype.getParent=function(){return this._parent},BABYLON.Bone.prototype.getLocalMatrix=function(){return this._matrix},BABYLON.Bone.prototype.getAbsoluteMatrix=function(){for(var e=this._matrix.clone(),t=this._parent;t;)e=e.multiply(t.getLocalMatrix()),t=t.getParent();return e},BABYLON.Bone.prototype.updateMatrix=function(e){this._matrix=e,this._skeleton._markAsDirty(),this._updateDifferenceMatrix()},BABYLON.Bone.prototype._updateDifferenceMatrix=function(){this._parent?this._matrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(this._matrix),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform);for(var e=0;e<this.children.length;e++)this.children[e]._updateDifferenceMatrix()},BABYLON.Bone.prototype.markAsDirty=function(){this._skeleton._markAsDirty()}}();var BABYLON=BABYLON||{};!function(){BABYLON.Skeleton=function(e,t,i){this.id=t,this.name=e,this.bones=[],this._scene=i,i.skeletons.push(this),this._isDirty=!0},BABYLON.Skeleton.prototype.getTransformMatrices=function(){return this._transformMatrices},BABYLON.Skeleton.prototype._markAsDirty=function(){this._isDirty=!0},BABYLON.Skeleton.prototype.prepare=function(){if(this._isDirty){this._transformMatrices&&this._transformMatrices.length===16*this.bones.length||(this._transformMatrices=new BABYLON.MatrixType(16*this.bones.length));for(var e=0;e<this.bones.length;e++){var t=this.bones[e],i=t.getParent();i?t._matrix.multiplyToRef(i._worldTransform,t._worldTransform):t._worldTransform.copyFrom(t._matrix),t._invertedAbsoluteTransform.multiplyToArray(t._worldTransform,this._transformMatrices,16*e)}this._isDirty=!1}},BABYLON.Skeleton.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!=this.bones.length){this._animatables=[];for(var e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables},BABYLON.Skeleton.prototype.clone=function(e,t){for(var i=new BABYLON.Skeleton(e,t||e,this._scene),r=0;r<this.bones.length;r++){var n=this.bones[r],o=null;if(n.getParent()){var s=this.bones.indexOf(n.getParent());o=i.bones[s]}var a=new BABYLON.Bone(n.name,i,o,n._baseMatrix);BABYLON.Tools.DeepCopy(n.animations,a.animations)}return i}}();var BABYLON=BABYLON||{};!function(){BABYLON.PostProcess=function(e,t,i,r,n,o,s,a,h){this.name=e,null!=o?(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine()):this._engine=a,this._renderRatio=n,this.width=-1,this.height=-1,this.renderTargetSamplingMode=s?s:BABYLON.Texture.NEAREST_SAMPLINGMODE,this._reusable=h||!1,this._textures=new BABYLON.Tools.SmartArray(2),this._currentRenderTextureInd=0,r=r||[],r.push("textureSampler"),this._effect=this._engine.createEffect({vertex:"postprocess",fragment:t},["position"],i||[],r,"")},BABYLON.PostProcess.prototype.onApply=null,BABYLON.PostProcess.prototype._onDispose=null,BABYLON.PostProcess.prototype.onSizeChanged=null,BABYLON.PostProcess.prototype.onActivate=null,BABYLON.PostProcess.prototype.activate=function(e){e=e||this._camera;var t=e.getScene(),i=this._engine._renderingCanvas.width*this._renderRatio,r=this._engine._renderingCanvas.height*this._renderRatio;if(this.width!==i||this.height!==r){if(this._textures.length>0){for(var n=0;n<this._textures.length;n++)this._engine._releaseTexture(this._textures.data[n]);this._textures.reset()}this.width=i,this.height=r,this._textures.push(this._engine.createRenderTargetTexture({width:this.width,height:this.height},{generateMipMaps:!1,generateDepthBuffer:e._postProcesses.indexOf(this)===e._postProcessesTakenIndices[0],samplingMode:this.renderTargetSamplingMode})),this._reusable&&this._textures.push(this._engine.createRenderTargetTexture({width:this.width,height:this.height},{generateMipMaps:!1,generateDepthBuffer:e._postProcesses.indexOf(this)===e._postProcessesTakenIndices[0],samplingMode:this.renderTargetSamplingMode})),this.onSizeChanged&&this.onSizeChanged()}this._engine.bindFramebuffer(this._textures.data[this._currentRenderTextureInd]),this.onActivate&&this.onActivate(e),this._engine.clear(t.clearColor,t.autoClear||t.forceWireframe,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2)},BABYLON.PostProcess.prototype.apply=function(){return this._effect.isReady()?(this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._effect._bindTexture("textureSampler",this._textures.data[this._currentRenderTextureInd]),this.onApply&&this.onApply(this._effect),this._effect):null},BABYLON.PostProcess.prototype.dispose=function(e){if(e=e||this._camera,this._onDispose&&this._onDispose(),this._textures.length>0){for(var t=0;t<this._textures.length;t++)this._engine._releaseTexture(this._textures.data[t]);this._textures.reset()}e.detachPostProcess(this);var i=e._postProcesses.indexOf(this);i===e._postProcessesTakenIndices[0]&&e._postProcessesTakenIndices.length>0&&(this._camera._postProcesses[e._postProcessesTakenIndices[0]].width=-1)}}();var BABYLON=BABYLON||{};!function(){BABYLON.PostProcessManager=function(e){this._scene=e;var t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1),this._vertexDeclaration=[2],this._vertexStrideSize=8,this._vertexBuffer=e.getEngine().createVertexBuffer(t);var i=[];i.push(0),i.push(1),i.push(2),i.push(0),i.push(2),i.push(3),this._indexBuffer=e.getEngine().createIndexBuffer(i)},BABYLON.PostProcessManager.prototype._prepareFrame=function(){var e=this._scene.activeCamera._postProcesses,t=this._scene.activeCamera._postProcessesTakenIndices;0!==t.length&&this._scene.postProcessesEnabled&&e[this._scene.activeCamera._postProcessesTakenIndices[0]].activate(this._scene.activeCamera)},BABYLON.PostProcessManager.prototype._finalizeFrame=function(e){var t=this._scene.activeCamera._postProcesses,i=this._scene.activeCamera._postProcessesTakenIndices;if(0!==i.length&&this._scene.postProcessesEnabled){for(var r=this._scene.getEngine(),n=0;n<i.length&&(n<i.length-1?t[i[n+1]].activate(this._scene.activeCamera):r.restoreDefaultFramebuffer(),!e);n++){var o=t[i[n]].apply();o&&(r.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,o),r.draw(!0,0,6))}r.setDepthBuffer(!0),r.setDepthWrite(!0)}},BABYLON.PostProcessManager.prototype.dispose=function(){this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}();var BABYLON=BABYLON||{};!function(){BABYLON.PassPostProcess=function(e,t,i,r,n,o){BABYLON.PostProcess.call(this,e,"pass",null,null,t,i,r,n,o)},BABYLON.PassPostProcess.prototype=Object.create(BABYLON.PostProcess.prototype)}();var BABYLON=BABYLON||{};!function(){BABYLON.BlurPostProcess=function(e,t,i,r,n,o,s,a){void 0===o&&(o=BABYLON.Texture.BILINEAR_SAMPLINGMODE),BABYLON.PostProcess.call(this,e,"blur",["screenSize","direction","blurWidth"],null,r,n,o,s,a),this.direction=t,this.blurWidth=i;var h=this;this.onApply=function(e){e.setFloat2("screenSize",h.width,h.height),e.setVector2("direction",h.direction),e.setFloat("blurWidth",h.blurWidth)}},BABYLON.BlurPostProcess.prototype=Object.create(BABYLON.PostProcess.prototype)}();var BABYLON=BABYLON||{};!function(){BABYLON.RefractionPostProcess=function(e,t,i,r,n,o,s,a,h,c){BABYLON.PostProcess.call(this,e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],o,s,a,h,c),this.color=i,this.depth=r,this.colorLevel=n,this._refRexture=null;var l=this;this.onActivate=function(e){l._refRexture=this._refRexture||new BABYLON.Texture(t,e.getScene())},this.onApply=function(e){e.setColor3("baseColor",l.color),e.setFloat("depth",l.depth),e.setFloat("colorLevel",l.colorLevel),e.setTexture("refractionSampler",l._refRexture)}},BABYLON.RefractionPostProcess.prototype=Object.create(BABYLON.PostProcess.prototype),BABYLON.RefractionPostProcess.prototype._onDispose=function(){this._refRexture&&this._refRexture.dispose()}}();var BABYLON=BABYLON||{};!function(){BABYLON.BlackAndWhitePostProcess=function(e,t,i,r,n,o){BABYLON.PostProcess.call(this,e,"blackAndWhite",null,null,t,i,r,n,o)},BABYLON.BlackAndWhitePostProcess.prototype=Object.create(BABYLON.PostProcess.prototype)}();var BABYLON=BABYLON||{};!function(){BABYLON.ConvolutionPostProcess=function(e,t,i,r,n,o,s){BABYLON.PostProcess.call(this,e,"convolution",["kernel","screenSize"],null,i,r,n,o,s),this.kernel=t;var a=this;this.onApply=function(e){e.setFloat2("screenSize",a.width,a.height),e.setArray("kernel",a.kernel)}},BABYLON.ConvolutionPostProcess.prototype=Object.create(BABYLON.PostProcess.prototype),BABYLON.ConvolutionPostProcess.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],BABYLON.ConvolutionPostProcess.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],BABYLON.ConvolutionPostProcess.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],BABYLON.ConvolutionPostProcess.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],BABYLON.ConvolutionPostProcess.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],BABYLON.ConvolutionPostProcess.GaussianKernel=[0,1,0,1,1,1,0,1,0]}();var BABYLON=BABYLON||{};!function(){BABYLON.FilterPostProcess=function(e,t,i,r,n,o,s){BABYLON.PostProcess.call(this,e,"filter",["kernelMatrix"],null,i,r,n,o,s),this.kernelMatrix=t;var a=this;this.onApply=function(e){e.setMatrix("kernelMatrix",a.kernelMatrix)}},BABYLON.FilterPostProcess.prototype=Object.create(BABYLON.PostProcess.prototype)}();var BABYLON=BABYLON||{};!function(){BABYLON.FxaaPostProcess=function(e,t,i,r,n,o){BABYLON.PostProcess.call(this,e,"fxaa",["texelSize"],null,t,i,r,n,o)},BABYLON.FxaaPostProcess.prototype=Object.create(BABYLON.PostProcess.prototype),BABYLON.FxaaPostProcess.prototype.onSizeChanged=function(){this.texelWidth=1/this.width,this.texelHeight=1/this.height},BABYLON.FxaaPostProcess.prototype.onApply=function(e){e.setFloat2("texelSize",this.texelWidth,this.texelHeight)}}();var BABYLON=BABYLON||{};!function(){BABYLON.LensFlare=function(e,t,i,r,n){this.color=i||new BABYLON.Color3(1,1,1),this.position=t,this.size=e,this.texture=r?new BABYLON.Texture(r,n.getScene(),!0):null,this._system=n,n.lensFlares.push(this)},BABYLON.LensFlare.prototype.position=0,BABYLON.LensFlare.prototype.size=1,BABYLON.LensFlare.prototype.texture=null,BABYLON.LensFlare.prototype.dispose=function(){this.texture&&this.texture.dispose();var e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}();var BABYLON=BABYLON||{};!function(){BABYLON.LensFlareSystem=function(e,t,i){this.lensFlares=[],this._scene=i,this._emitter=t,this.name=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=function(e){return e.material&&e.isVisible&&e.isEnabled()&&e.checkCollisions};var r=[];r.push(1,1),r.push(-1,1),r.push(-1,-1),r.push(1,-1),this._vertexDeclaration=[2],this._vertexStrideSize=8,this._vertexBuffer=i.getEngine().createVertexBuffer(r);var n=[];n.push(0),n.push(1),n.push(2),n.push(0),n.push(2),n.push(3),this._indexBuffer=i.getEngine().createIndexBuffer(n),this._effect=this._scene.getEngine().createEffect("lensFlare",["position"],["color","viewportMatrix"],["textureSampler"],"")},BABYLON.LensFlareSystem.prototype.borderLimit=300,BABYLON.LensFlareSystem.prototype.getScene=function(){return this._scene},BABYLON.LensFlareSystem.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},BABYLON.LensFlareSystem.prototype.computeEffectivePosition=function(e){var t=this.getEmitterPosition();return t=BABYLON.Vector3.Project(t,BABYLON.Matrix.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=BABYLON.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),t.z>0&&this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&this._positionY<e.y+e.height?!0:!1
},BABYLON.LensFlareSystem.prototype._isVisible=function(){var e=this.getEmitterPosition(),t=e.subtract(this._scene.activeCamera.position),i=t.length();t.normalize();var r=new BABYLON.Ray(this._scene.activeCamera.position,t),n=this._scene.pickWithRay(r,this.meshesSelectionPredicate,!0);return!n.hit||n.distance>i},BABYLON.LensFlareSystem.prototype.render=function(){if(!this._effect.isReady())return!1;var e=this._scene.getEngine(),t=this._scene.activeCamera.viewport,i=t.toGlobal(e);if(!this.computeEffectivePosition(i))return!1;if(!this._isVisible())return!1;var r,n;r=this._positionX<this.borderLimit+i.x?this.borderLimit+i.x-this._positionX:this._positionX>i.x+i.width-this.borderLimit?this._positionX-i.x-i.width+this.borderLimit:0,n=this._positionY<this.borderLimit+i.y?this.borderLimit+i.y-this._positionY:this._positionY>i.y+i.height-this.borderLimit?this._positionY-i.y-i.height+this.borderLimit:0;var o=r>n?r:n;o>this.borderLimit&&(o=this.borderLimit);var s=1-o/this.borderLimit;if(0>s)return!1;s>1&&(s=1);var a=i.x+i.width/2,h=i.y+i.height/2,c=a-this._positionX,l=h-this._positionY;e.enableEffect(this._effect),e.setState(!1),e.setDepthBuffer(!1),e.setAlphaMode(BABYLON.Engine.ALPHA_ADD),e.bindBuffers(this._vertexBuffer,this._indexBuffer,this._vertexDeclaration,this._vertexStrideSize,this._effect);for(var u=0;u<this.lensFlares.length;u++){var f=this.lensFlares[u],B=a-c*f.position,p=h-l*f.position,d=f.size,m=f.size*e.getAspectRatio(this._scene.activeCamera),A=2*(B/i.width)-1,_=1-2*(p/i.height),v=BABYLON.Matrix.FromValues(d/2,0,0,0,0,m/2,0,0,0,0,1,0,A,_,0,1);this._effect.setMatrix("viewportMatrix",v),this._effect.setTexture("textureSampler",f.texture),this._effect.setFloat4("color",f.color.r*s,f.color.g*s,f.color.b*s,1),e.draw(!0,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(BABYLON.Engine.ALPHA_DISABLE),!0},BABYLON.LensFlareSystem.prototype.dispose=function(){for(this._vertexBuffer&&(this._scene.getEngine()._releaseBuffer(this._vertexBuffer),this._vertexBuffer=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();var e=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(e,1)}}();var BABYLON=BABYLON||{};!function(){BABYLON.PhysicsEngine=function(e,t){this._world=new CANNON.World,this._world.broadphase=new CANNON.NaiveBroadphase,this._world.solver.iterations=t,this._registeredMeshes=[],this._physicsMaterials=[],this._setGravity(e)},BABYLON.PhysicsEngine.prototype._runOneStep=function(e){e>.1?e=.1:0>=e&&(e=1/60),this._world.step(e);for(var t=0;t<this._registeredMeshes.length;t++){var i=this._registeredMeshes[t];i.isChild||(i.mesh.position.x=i.body.position.x,i.mesh.position.y=i.body.position.z,i.mesh.position.z=i.body.position.y,i.mesh.rotationQuaternion||(i.mesh.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1)),i.mesh.rotationQuaternion.x=i.body.quaternion.x,i.mesh.rotationQuaternion.y=i.body.quaternion.z,i.mesh.rotationQuaternion.z=i.body.quaternion.y,i.mesh.rotationQuaternion.w=-i.body.quaternion.w)}},BABYLON.PhysicsEngine.prototype._addMaterial=function(e,t){var i,r;for(i=0;i<this._physicsMaterials.length;i++)if(r=this._physicsMaterials[i],r.friction===e&&r.restitution===t)return r;var n=new CANNON.Material;for(n.friction=e,n.restitution=t,this._physicsMaterials.push(n),i=0;i<this._physicsMaterials.length;i++){r=this._physicsMaterials[i];var o=new CANNON.ContactMaterial(r,n,r.friction*n.friction,r.restitution*n.restitution);o.contactEquationStiffness=1e10,o.contactEquationRegularizationTime=10,this._world.addContactMaterial(o)}return n},BABYLON.PhysicsEngine.prototype._setGravity=function(e){this.gravity=e||new BABYLON.Vector3(0,-9.82,0),this._world.gravity.set(this.gravity.x,this.gravity.z,this.gravity.y)},BABYLON.PhysicsEngine.prototype._checkWithEpsilon=function(e){return e<BABYLON.PhysicsEngine.Epsilon?BABYLON.PhysicsEngine.Epsilon:e},BABYLON.PhysicsEngine.prototype._registerMesh=function(e,t,i){var r,n=null;switch(e.rotationQuaternion&&(r=e.rotationQuaternion.clone(),e.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1)),this._unregisterMesh(e),e.computeWorldMatrix(!0),t.impostor){case BABYLON.PhysicsEngine.SphereImpostor:var o=e.getBoundingInfo().boundingBox,s=o.maximumWorld.x-o.minimumWorld.x,a=o.maximumWorld.y-o.minimumWorld.y,h=o.maximumWorld.z-o.minimumWorld.z;n=new CANNON.Sphere(Math.max(this._checkWithEpsilon(s),this._checkWithEpsilon(a),this._checkWithEpsilon(h))/2);break;case BABYLON.PhysicsEngine.BoxImpostor:var o=e.getBoundingInfo().boundingBox,c=o.minimumWorld,l=o.maximumWorld,u=l.subtract(c).scale(.5);n=new CANNON.Box(new CANNON.Vec3(this._checkWithEpsilon(u.x),this._checkWithEpsilon(u.z),this._checkWithEpsilon(u.y)));break;case BABYLON.PhysicsEngine.PlaneImpostor:n=new CANNON.Plane;break;case BABYLON.PhysicsEngine.MeshImpostor:var f=e.getVerticesData(BABYLON.VertexBuffer.PositionKind),B=e.getIndices(),p=[],d=[];e.computeWorldMatrix(!0);for(var m=0;m<f.length;m+=3){var A=BABYLON.Vector3.Zero();BABYLON.Vector3.TransformNormalFromFloatsToRef(f[m],f[m+1],f[m+2],e.getWorldMatrix(),A),p.push(new CANNON.Vec3(A.x,A.z,A.y))}for(var _=0;_<B.length;_+=3)d.push([B[_],B[_+2],B[_+1]]);n=new CANNON.ConvexPolyhedron(p,d)}if(i)return n;var v=this._addMaterial(t.friction,t.restitution),g=new CANNON.RigidBody(t.mass,n,v);return r&&(g.quaternion.x=r.x,g.quaternion.z=r.y,g.quaternion.y=r.z,g.quaternion.w=-r.w),g.position.set(e.position.x,e.position.z,e.position.y),this._world.add(g),this._registeredMeshes.push({mesh:e,body:g,material:v}),g},BABYLON.PhysicsEngine.prototype._registerCompound=function(e){for(var t=new CANNON.Compound,i=e.parts[0].mesh,r=i.position,n=0;n<e.parts.length;n++){var o=e.parts[n].mesh,s=this._registerMesh(o,e.parts[n],!0);0==n?t.addChild(s,new CANNON.Vec3(0,0,0)):t.addChild(s,new CANNON.Vec3(o.position.x,o.position.z,o.position.y))}var a=this._addMaterial(e.friction,e.restitution),h=new CANNON.RigidBody(e.mass,t,a);h.position.set(r.x,r.z,r.y),this._world.add(h);for(var n=0;n<e.parts.length;n++){var o=e.parts[n].mesh;this._registeredMeshes.push({mesh:o,body:h,material:a,isChild:0!=n})}return h.parts=e.parts,h},BABYLON.PhysicsEngine.prototype._unbindBody=function(e){for(var t=0;t<this._registeredMeshes.length;t++){var i=this._registeredMeshes[t];i.body===e&&(i.body=null)}},BABYLON.PhysicsEngine.prototype._unregisterMesh=function(e){for(var t=0;t<this._registeredMeshes.length;t++){var i=this._registeredMeshes[t];if(i.mesh===e)return i.body&&(this._world.remove(i.body),this._unbindBody(i.body)),void this._registeredMeshes.splice(t,1)}},BABYLON.PhysicsEngine.prototype._applyImpulse=function(e,t,i){for(var r=new CANNON.Vec3(i.x,i.z,i.y),n=new CANNON.Vec3(t.x,t.z,t.y),o=0;o<this._registeredMeshes.length;o++){var s=this._registeredMeshes[o];if(s.mesh===e)return void s.body.applyImpulse(n,r)}},BABYLON.PhysicsEngine.prototype._createLink=function(e,t,i,r){for(var n,o,s=0;s<this._registeredMeshes.length;s++){var a=this._registeredMeshes[s];a.mesh===e?n=a.body:a.mesh===t&&(o=a.body)}if(n&&o){var h=new CANNON.PointToPointConstraint(n,new CANNON.Vec3(i.x,i.z,i.y),o,new CANNON.Vec3(r.x,r.z,r.y));this._world.addConstraint(h)}},BABYLON.PhysicsEngine.prototype.dispose=function(){for(;this._registeredMeshes.length;)this._unregisterMesh(this._registeredMeshes[0].mesh)},BABYLON.PhysicsEngine.IsSupported=function(){return void 0!==window.CANNON},BABYLON.PhysicsEngine.NoImpostor=0,BABYLON.PhysicsEngine.SphereImpostor=1,BABYLON.PhysicsEngine.BoxImpostor=2,BABYLON.PhysicsEngine.PlaneImpostor=3,BABYLON.PhysicsEngine.CompoundImpostor=4,BABYLON.PhysicsEngine.MeshImpostor=4,BABYLON.PhysicsEngine.Epsilon=.001}();var BABYLON=BABYLON||{};!function(){var e=function(e){var t={};return t.name=e.name,t.id=e.id,t.tags=e._tags,e instanceof BABYLON.PointLight?(t.type=0,t.position=e.position.asArray()):e instanceof BABYLON.DirectionalLight?(t.type=1,t.position=e.position.asArray(),t.direction=e.position.asArray()):e instanceof BABYLON.SpotLight?(t.type=2,t.position=e.position.asArray(),t.direction=e.position.asArray(),t.angle=e.angle,t.exponent=e.exponent):e instanceof BABYLON.HemisphericLight&&(t.type=2,t.groundColor=e.groundColor.asArray()),e.intensity&&(t.intensity=e.intensity),t.diffuse=e.diffuse.asArray(),t.specular=e.specular.asArray(),t},t=function(e){var t={};return t.name=e.name,t.tags=e._tags,t.id=e.id,t.position=e.position.asArray(),e.parent&&(t.parentId=e.parent.id),t.rotation=e.rotation.asArray(),e.lockedTarget&&e.lockedTarget.id&&(t.lockedTargetId=e.lockedTarget.id),t.fov=e.fov,t.minZ=e.minZ,t.maxZ=e.maxZ,t.speed=e.speed,t.inertia=e.inertia,t.checkCollisions=e.checkCollisions,t.applyGravity=e.applyGravity,e.ellipsoid&&(t.ellipsoid=e.ellipsoid.asArray()),i(e,t),t},i=function(e,t){if(e.animations){t.animations=[];for(var i=0;i<e.animations.length;i++){var n=e.animations[i];t.animations.push(r(n))}}},r=function(e){var t={};t.name=e.name,t.property=e.targetProperty,t.framePerSecond=e.framePerSecond,t.dataType=e.dataType,t.loopBehavior=e.loopBehavior;var i=e.dataType;t.keys=[];for(var r=0;r<e._keys.length;r++){var n=e._keys[r],o={};switch(o.frame=n.frame,i){case BABYLON.Animation.ANIMATIONTYPE_FLOAT:o.values=[n.value];break;case BABYLON.Animation.ANIMATIONTYPE_QUATERNION:case BABYLON.Animation.ANIMATIONTYPE_MATRIX:case BABYLON.Animation.ANIMATIONTYPE_VECTOR3:o.values=n.value.asArray()}t.keys.push(o)}return t},n=function(e){var t={};t.name=e.name,t.id=e.id,t.tags=e._tags,t.materials=[];for(var i=0;i<e.subMaterials.length;i++){var r=e.subMaterials[i];t.materials.push(r?r.id:null)}return t},o=function(e){var t={};return t.name=e.name,t.ambient=e.ambientColor.asArray(),t.diffuse=e.diffuseColor.asArray(),t.specular=e.specularColor.asArray(),t.specularPower=e.specularPower,t.emissive=e.emissiveColor.asArray(),t.alpha=e.alpha,t.id=e.id,t.tags=e._tags,t.backFaceCulling=e.backFaceCulling,e.diffuseTexture&&(t.diffuseTexture=s(e.diffuseTexture)),e.ambientTexture&&(t.ambientTexture=s(e.ambientTexture)),e.opacityTexture&&(t.opacityTexture=s(e.opacityTexture)),e.reflectionTexture&&(t.reflectionTexture=s(e.reflectionTexture)),e.emissiveTexture&&(t.emissiveTexture=s(e.emissiveTexture)),e.specularTexture&&(t.specularTexture=s(e.specularTexture)),e.bumpTexture&&(t.bumpTexture=s(e.bumpTexture)),t},s=function(e){var t={};if(!e.name)return null;if(e instanceof BABYLON.CubeTexture)return t.name=e.name,t.hasAlpha=e.hasAlpha,t.level=e.level,t.coordinatesMode=e.coordinatesMode,t;if(e instanceof BABYLON.MirrorTexture){t.renderTargetSize=e.renderTargetSize,t.renderList=[];for(var r=0;r<e.renderList.length;r++)t.renderList.push(e.renderList[r].id);t.mirrorPlane=e.mirrorPlane.asArray()}else if(e instanceof BABYLON.RenderTargetTexture){t.renderTargetSize=e.renderTargetSize,t.renderList=[];for(var r=0;r<e.renderList.length;r++)t.renderList.push(e.renderList[r].id)}return t.name=e.name,t.hasAlpha=e.hasAlpha,t.level=e.level,t.coordinatesIndex=e.coordinatesIndex,t.coordinatesMode=e.coordinatesMode,t.uOffset=e.uOffset,t.vOffset=e.vOffset,t.uScale=e.uScale,t.vScale=e.vScale,t.uAng=e.uAng,t.vAng=e.vAng,t.wAng=e.wAng,t.wrapU=e.wrapU,t.wrapV=e.wrapV,i(e,t),t},a=function(e){var t={};t.name=e.name,t.id=e.id,t.bones=[];for(var i=0;i<e.bones.length;i++){var n=e.bones[i],o={parentBoneIndex:n._parent?n._parent.id:-1,name:n.name,matrix:n._matrix.toArray()};t.bones.push(o),n.animations&&n.animations.length>0&&(o.animation=r(n.animations[0]))}return t},h=function(e){var t={};return t.emitterId=e.emitter.id,t.capacity=e._capacity,e.particleTexture&&(t.textureName=e.particleTexture.name),t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.emitRate=e.emitRate,t.minEmitBox=e.minEmitBox.asArray(),t.maxEmitBox=e.maxEmitBox.asArray(),t.gravity=e.gravity.asArray(),t.direction1=e.direction1.asArray(),t.direction2=e.direction2.asArray(),t.color1=e.color1.asArray(),t.color2=e.color2.asArray(),t.colorDead=e.colorDead.asArray(),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopFrame,t.textureMask=e.textureMask.asArray(),t.blendMode=e.blendMode,t},c=function(e){var t={};t.emitterId=e._emitter.id,t.borderLimit=e.borderLimit,t.flares=[];for(var i=0;i<e.lensFlares.length;i++){var r=e.lensFlares[i];t.flares.push({size:r.size,position:r.position,color:r.color.asArray(),textureName:BABYLON.Tools.GetFilename(r.texture.name)})}return t},l=function(e){var t={},i=e._shadowGenerator;t.lightId=e.id,t.mapSize=i.getShadowMap()._size,t.useVarianceShadowMap=i.useVarianceShadowMap,t.renderList=[];for(var r=0;r<i.getShadowMap().renderList.length;r++){var n=i.getShadowMap().renderList[r];t.renderList.push(n.id)}return t},u=function(e){var t={};if(t.name=e.name,t.id=e.id,t.tags=e._tags,t.position=e.position.asArray(),e.rotation?t.rotation=e.rotation.asArray():e.rotationQuaternion&&(t.rotationQuaternion=e.rotationQuaternion.asArray()),t.scaling=e.scaling.asArray(),t.localMatrix=e.getPivotMatrix().asArray(),t.isEnabled=e.isEnabled(),t.isVisible=e.isVisible,t.infiniteDistance=e.infiniteDistance,t.receiveShadows=e.receiveShadows,t.billboardMode=e.billboardMode,t.visibility=e.visibility,t.checkCollisions=e.checkCollisions,e.parent&&(t.parentId=e.parent.id),e.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)){t.positions=e.getVerticesData(BABYLON.VertexBuffer.PositionKind),t.normals=e.getVerticesData(BABYLON.VertexBuffer.NormalKind),e.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)&&(t.uvs=e.getVerticesData(BABYLON.VertexBuffer.UVKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)&&(t.uvs2=e.getVerticesData(BABYLON.VertexBuffer.UV2Kind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.ColorKind)&&(t.colors=e.getVerticesData(BABYLON.VertexBuffer.ColorKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)&&(t.matricesWeights=e.getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)&&(t.matricesWeights=e.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind),t.matricesWeights._isExpanded=!0),t.indices=e.getIndices(),t.subMeshes=[];for(var r=0;r<e.subMeshes.length;r++){var n=e.subMeshes[r];t.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}}if(e.material?t.materialId=e.material.id:e.material=null,e.skeleton&&(t.skeletonId=e.skeleton.id),e.getPhysicsImpostor()!==BABYLON.PhysicsEngine.NoImpostor)switch(t.physicsMass=e.getPhysicsMass(),t.physicsFriction=e.getPhysicsFriction(),t.physicsRestitution=e.getPhysicsRestitution(),e.getPhysicsImpostor()){case BABYLON.PhysicsEngine.BoxImpostor:t.physicsImpostor=1;break;case BABYLON.PhysicsEngine.SphereImpostor:t.physicsImpostor=2}return i(e,t),t};BABYLON.SceneSerializer={Serialize:function(i){var r={};r.useDelayedTextureLoading=i.useDelayedTextureLoading,r.autoClear=i.autoClear,r.clearColor=i.clearColor.asArray(),r.ambientColor=i.ambientColor.asArray(),r.gravity=i.gravity.asArray(),i.fogMode&&0!==i.fogMode&&(r.fogMode=i.fogMode,r.fogColor=i.fogColor.asArray(),r.fogStart=i.fogStart,r.fogEnd=i.fogEnd,r.fogDensity=i.fogDensity),r.lights=[];for(var s=0;s<i.lights.length;s++){var f=i.lights[s];r.lights.push(e(f))}r.cameras=[];for(var s=0;s<i.cameras.length;s++){var B=i.cameras[s];B instanceof BABYLON.FreeCamera&&r.cameras.push(t(B))}i.activecamera&&(r.activeCameraID=i.activeCamera.id),r.materials=[],r.multiMaterials=[];for(var s=0;s<i.materials.length;s++){var p=i.materials[s];p instanceof BABYLON.StandardMaterial?r.materials.push(o(p)):p instanceof BABYLON.MultiMaterial&&r.multiMaterials.push(n(p))}r.skeletons=[];for(var s=0;s<i.skeletons.length;s++)r.skeletons.push(a(i.skeletons[s]));r.meshes=[];for(var s=0;s<i.meshes.length;s++){var d=i.meshes[s];(d.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_LOADED||d.delayLoadState===BABYLON.Engine.DELAYLOADSTATE_NONE)&&r.meshes.push(u(d))}r.particleSystems=[];for(var s=0;s<i.particleSystems.length;s++)r.particleSystems.push(h(i.particleSystems[s]));r.lensFlareSystems=[];for(var s=0;s<i.lensFlareSystems.length;s++)r.lensFlareSystems.push(c(i.lensFlareSystems[s]));r.shadowGenerators=[];for(var s=0;s<i.lights.length;s++){var f=i.lights[s];f._shadowGenerator&&r.shadowGenerators.push(l(f))}return r}}}();var BABYLON=BABYLON||{};!function(){BABYLON.Space={LOCAL:0,WORLD:1},BABYLON.Axis={X:new BABYLON.Vector3(1,0,0),Y:new BABYLON.Vector3(0,1,0),Z:new BABYLON.Vector3(0,0,1)}}();var BABYLON=BABYLON||{};!function(){var e=0;BABYLON.CSG=function(){this.polygons=[]},BABYLON.CSG.FromMesh=function(t){var i,r,n,o,s,a,h=[];if(!(t instanceof BABYLON.Mesh))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";t.computeWorldMatrix(!0),this.matrix=t.getWorldMatrix(),this.position=t.position.clone(),this.rotation=t.rotation.clone(),this.scaling=t.scaling.clone();for(var c=t.getIndices(),l=t.getVerticesData(BABYLON.VertexBuffer.PositionKind),u=t.getVerticesData(BABYLON.VertexBuffer.NormalKind),f=t.getVerticesData(BABYLON.VertexBuffer.UVKind),B=t.subMeshes,p=0,d=B.length;d>p;p++)for(var m=B[p].indexStart,A=B[p].indexCount+B[p].indexStart;A>m;m+=3){a=[];for(var _=0;3>_;_++)r=new BABYLON.Vector3(u[3*c[m+_]],u[3*c[m+_]+1],u[3*c[m+_]+2]),n=new BABYLON.Vector2(f[2*c[m+_]],f[2*c[m+_]+1]),o=new BABYLON.Vector3(l[3*c[m+_]],l[3*c[m+_]+1],l[3*c[m+_]+2]),o=BABYLON.Vector3.TransformCoordinates(o,this.matrix),r=BABYLON.Vector3.TransformNormal(r,this.matrix),i=new BABYLON.CSG.Vertex(o,r,n),a.push(i);s=new BABYLON.CSG.Polygon(a,{subMeshId:p,meshId:e,materialIndex:B[p].materialIndex}),s.plane&&h.push(s)}var v=BABYLON.CSG.fromPolygons(h);return v.copyTransformAttributes(this),e++,v},BABYLON.CSG.fromPolygons=function(e){var t=new BABYLON.CSG;return t.polygons=e,t},BABYLON.CSG.prototype={clone:function(){var e=new BABYLON.CSG;return e.polygons=this.polygons.map(function(e){return e.clone()}),e.copyTransformAttributes(this),e},toPolygons:function(){return this.polygons},union:function(e){var t=new BABYLON.CSG.Node(this.clone().polygons),i=new BABYLON.CSG.Node(e.clone().polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),BABYLON.CSG.fromPolygons(t.allPolygons()).copyTransformAttributes(this)},subtract:function(e){var t=new BABYLON.CSG.Node(this.clone().polygons),i=new BABYLON.CSG.Node(e.clone().polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),BABYLON.CSG.fromPolygons(t.allPolygons()).copyTransformAttributes(this)},intersect:function(e){var t=new BABYLON.CSG.Node(this.clone().polygons),i=new BABYLON.CSG.Node(e.clone().polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),BABYLON.CSG.fromPolygons(t.allPolygons()).copyTransformAttributes(this)},inverse:function(){var e=this.clone();return e.polygons.map(function(e){e.flip()}),e}},BABYLON.CSG.prototype.copyTransformAttributes=function(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this},BABYLON.CSG.prototype.buildMeshGeometry=function(e,t,i){var r=this.matrix.clone();r.invert();var n,o,s,a,h,c,l=new BABYLON.Mesh(e,t),u=[],f=[],B=[],p=[],d=this.polygons,m=[0,0,0],A={},_=0,v={};i&&d.sort(function(e,t){return e.shared.meshId===t.shared.meshId?e.shared.subMeshId-t.shared.subMeshId:e.shared.meshId-t.shared.meshId});for(var g=0,L=d.length;L>g;g++){a=d[g],v[a.shared.meshId]||(v[a.shared.meshId]={}),v[a.shared.meshId][a.shared.subMeshId]||(v[a.shared.meshId][a.shared.subMeshId]={indexStart:+1/0,indexEnd:-1/0,materialIndex:a.shared.materialIndex}),c=v[a.shared.meshId][a.shared.subMeshId];for(var O=2,N=a.vertices.length;N>O;O++){m[0]=0,m[1]=O-1,m[2]=O;for(var y=0;3>y;y++)n=a.vertices[m[y]].pos,o=a.vertices[m[y]].normal,s=a.vertices[m[y]].uv,n=new BABYLON.Vector3(n.x,n.y,n.z),o=new BABYLON.Vector3(o.x,o.y,o.z),n=BABYLON.Vector3.TransformCoordinates(n,r),o=BABYLON.Vector3.TransformNormal(o,r),h=A[n.x+","+n.y+","+n.z],("undefined"==typeof h||B[3*h]!==o.x||B[3*h+1]!==o.y||B[3*h+2]!==o.z||p[2*h]!==s.x||p[2*h+1]!==s.y)&&(u.push(n.x,n.y,n.z),p.push(s.x,s.y),B.push(o.x,o.y,o.z),h=A[n.x+","+n.y+","+n.z]=u.length/3-1),f.push(h),c.indexStart=Math.min(_,c.indexStart),c.indexEnd=Math.max(_,c.indexEnd),_++}}if(l.setVerticesData(u,BABYLON.VertexBuffer.PositionKind),l.setVerticesData(B,BABYLON.VertexBuffer.NormalKind),l.setVerticesData(p,BABYLON.VertexBuffer.UVKind),l.setIndices(f),i){var x,Y=0;l.subMeshes.length=0;for(var M in v){x=-1;for(var T in v[M])c=v[M][T],BABYLON.SubMesh.CreateFromIndices(c.materialIndex+Y,c.indexStart,c.indexEnd-c.indexStart+1,l),x=Math.max(c.materialIndex,x);Y+=++x}}return l},BABYLON.CSG.prototype.toMesh=function(e,t,i,r){var n=this.buildMeshGeometry(e,i,r);return n.material=t,n.position.copyFrom(this.position),n.rotation.copyFrom(this.rotation),n.scaling.copyFrom(this.scaling),n.computeWorldMatrix(!0),n},BABYLON.CSG.Vector=function(e,t,i){3==arguments.length?(this.x=e,this.y=t,this.z=i):"x"in e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e[0],this.y=e[1],this.z=e[2])},BABYLON.CSG.Vector.prototype={clone:function(){return new BABYLON.CSG.Vector(this.x,this.y,this.z)},negated:function(){return new BABYLON.CSG.Vector(-this.x,-this.y,-this.z)},plus:function(e){return new BABYLON.CSG.Vector(this.x+e.x,this.y+e.y,this.z+e.z)},minus:function(e){return new BABYLON.CSG.Vector(this.x-e.x,this.y-e.y,this.z-e.z)},times:function(e){return new BABYLON.CSG.Vector(this.x*e,this.y*e,this.z*e)},dividedBy:function(e){return new BABYLON.CSG.Vector(this.x/e,this.y/e,this.z/e)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lerp:function(e,t){return this.plus(e.minus(this).times(t))},length:function(){return Math.sqrt(this.dot(this))},lengthSq:function(){return this.dot(this)},unit:function(){return this.dividedBy(this.length())},cross:function(e){return new BABYLON.CSG.Vector(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)}},BABYLON.CSG.Vertex=function(e,t,i){this.pos=new BABYLON.CSG.Vector(e),this.normal=new BABYLON.CSG.Vector(t),this.uv=new BABYLON.CSG.Vector(i.x,i.y,0)},BABYLON.CSG.Vertex.prototype={clone:function(){return new BABYLON.CSG.Vertex(this.pos.clone(),this.normal.clone(),this.uv.clone())},flip:function(){this.normal=this.normal.negated()},interpolate:function(e,t){return new BABYLON.CSG.Vertex(this.pos.lerp(e.pos,t),this.normal.lerp(e.normal,t),this.uv.lerp(e.uv,t))}},BABYLON.CSG.Plane=function(e,t){this.normal=e,this.w=t},BABYLON.CSG.Plane.EPSILON=1e-5,BABYLON.CSG.Plane.fromPoints=function(e,t,i){var r=i.minus(e),n=t.minus(e);if(0===r.lengthSq()||0===n.lengthSq())return null;var o=i.minus(e).cross(t.minus(e)).unit();return new BABYLON.CSG.Plane(o,o.dot(e))},BABYLON.CSG.Plane.prototype={clone:function(){return new BABYLON.CSG.Plane(this.normal.clone(),this.w)},flip:function(){this.normal=this.normal.negated(),this.w=-this.w},splitPolygon:function(e,t,i,r,n){for(var o=0,s=1,a=2,h=3,c=0,l=[],u=0;u<e.vertices.length;u++){var f=this.normal.dot(e.vertices[u].pos)-this.w,B=f<-BABYLON.CSG.Plane.EPSILON?a:f>BABYLON.CSG.Plane.EPSILON?s:o;c|=B,l.push(B)}switch(c){case o:(this.normal.dot(e.plane.normal)>0?t:i).push(e);break;case s:r.push(e);break;case a:n.push(e);break;case h:for(var p=[],d=[],u=0;u<e.vertices.length;u++){var m=(u+1)%e.vertices.length,A=l[u],_=l[m],v=e.vertices[u],g=e.vertices[m];if(A!=a&&p.push(v),A!=s&&d.push(A!=a?v.clone():v),(A|_)==h){var f=(this.w-this.normal.dot(v.pos))/this.normal.dot(g.pos.minus(v.pos)),L=v.interpolate(g,f);p.push(L),d.push(L.clone())}}p.length>=3&&r.push(new BABYLON.CSG.Polygon(p,e.shared)),d.length>=3&&n.push(new BABYLON.CSG.Polygon(d,e.shared))}}},BABYLON.CSG.Polygon=function(e,t){this.vertices=e,this.shared=t,this.plane=BABYLON.CSG.Plane.fromPoints(e[0].pos,e[1].pos,e[2].pos)},BABYLON.CSG.Polygon.prototype={clone:function(){var e=this.vertices.map(function(e){return e.clone()});return new BABYLON.CSG.Polygon(e,this.shared)},flip:function(){this.vertices.reverse().map(function(e){e.flip()}),this.plane.flip()}},BABYLON.CSG.Node=function(e){this.plane=null,this.front=null,this.back=null,this.polygons=[],e&&this.build(e)},BABYLON.CSG.Node.prototype={clone:function(){var e=new BABYLON.CSG.Node;return e.plane=this.plane&&this.plane.clone(),e.front=this.front&&this.front.clone(),e.back=this.back&&this.back.clone(),e.polygons=this.polygons.map(function(e){return e.clone()}),e},invert:function(){for(var e=0;e<this.polygons.length;e++)this.polygons[e].flip();this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();var t=this.front;this.front=this.back,this.back=t},clipPolygons:function(e){if(!this.plane)return e.slice();for(var t=[],i=[],r=0;r<e.length;r++)this.plane.splitPolygon(e[r],t,i,t,i);return this.front&&(t=this.front.clipPolygons(t)),i=this.back?this.back.clipPolygons(i):[],t.concat(i)},clipTo:function(e){this.polygons=e.clipPolygons(this.polygons),this.front&&this.front.clipTo(e),this.back&&this.back.clipTo(e)},allPolygons:function(){var e=this.polygons.slice();return this.front&&(e=e.concat(this.front.allPolygons())),this.back&&(e=e.concat(this.back.allPolygons())),e},build:function(e){if(e.length){this.plane||(this.plane=e[0].plane.clone());for(var t=[],i=[],r=0;r<e.length;r++)this.plane.splitPolygon(e[r],this.polygons,this.polygons,t,i);t.length&&(this.front||(this.front=new BABYLON.CSG.Node),this.front.build(t)),i.length&&(this.back||(this.back=new BABYLON.CSG.Node),this.back.build(i))}}}}();var BABYLON=BABYLON||{};!function(){BABYLON.OculusDistortionCorrectionPostProcess=function(e,t,i,r){BABYLON.PostProcess.call(this,e,"oculusDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.PostProcessScaleFactor,t,BABYLON.Texture.BILINEAR_SAMPLINGMODE,null,null),this._isRightEye=i,this._distortionFactors=r.DistortionK,this._postProcessScaleFactor=r.PostProcessScaleFactor,this._lensCenterOffset=r.LensCenterOffset},BABYLON.OculusDistortionCorrectionPostProcess.prototype=Object.create(BABYLON.PostProcess.prototype),BABYLON.OculusDistortionCorrectionPostProcess.prototype.onSizeChanged=function(){this.aspectRatio=.5*this.width/this.height,this._scaleIn=new BABYLON.Vector2(2,2/this.aspectRatio),this._scaleFactor=new BABYLON.Vector2(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new BABYLON.Vector2(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)},BABYLON.OculusDistortionCorrectionPostProcess.prototype.onApply=function(e){e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])}}(),window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),function(e){var t=function(){function t(t){this._leftJoystick=t?!0:!1,this.joystickIndex=h,h++,this._axisTargetedByLeftAndRight="X",this._axisTargetedByUpAndDown="Y",this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new e.VirtualJoystick.Collection,this.deltaPosition=e.Vector3.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._rotationSpeed=25,this._inverseRotationSpeed=1/(this._rotationSpeed/1e3),this._rotateOnAxisRelativeToMesh=!1;var c=this;i||(window.addEventListener("resize",function(){n=window.innerWidth,o=window.innerHeight,i.width=n,i.height=o,s=n/2,a=o/2},!1),i=document.createElement("canvas"),n=window.innerWidth,o=window.innerHeight,i.width=window.innerWidth,i.height=window.innerHeight,i.style.width="100%",i.style.height="100%",i.style.position="absolute",i.style.backgroundColor="transparent",i.style.top="0px",i.style.left="0px",i.style.zIndex=5,i.style.msTouchAction="none",r=i.getContext("2d"),r.strokeStyle="#ffffff",r.lineWidth=2,document.body.appendChild(i)),s=i.width/2,a=i.height/2,this.pressed=!1,this._joystickColor="cyan",this.joystickPointerID=-1,this.joystickPointerPos=new e.Vector2(0,0),this.joystickPointerStartPos=new e.Vector2(0,0),this.deltaJoystickVector=new e.Vector2(0,0),i.addEventListener("pointerdown",function(e){c.onPointerDown(e)},!1),i.addEventListener("pointermove",function(e){c.onPointerMove(e)},!1),i.addEventListener("pointerup",function(e){c.onPointerUp(e)},!1),i.addEventListener("pointerout",function(e){c.onPointerUp(e)},!1),i.addEventListener("contextmenu",function(e){e.preventDefault()},!1),requestAnimationFrame(function(){c.drawVirtualJoystick()})}var i,r,n,o,s,a,h=0;return t.prototype.setJoystickSensibility=function(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)},t.prototype.onPointerDown=function(e){e.preventDefault();var t,i={identifier:e.pointerId,x:e.clientX,y:e.clientY,type:this.givePointerType(e)};t=this._leftJoystick===!0?e.clientX<s:e.clientX>s,t&&this.joystickPointerID<0?(this.joystickPointerID=e.pointerId,this.joystickPointerStartPos.x=e.clientX,this.joystickPointerStartPos.y=e.clientY,this.joystickPointerPos=this.joystickPointerStartPos.clone(),this.deltaJoystickVector.x=0,this.deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId,i)):2>h&&this._action&&(this._action(),this._touches.add(e.pointerId,i))},t.prototype.onPointerMove=function(e){if(this.joystickPointerID==e.pointerId){this.joystickPointerPos.x=e.clientX,this.joystickPointerPos.y=e.clientY,this.deltaJoystickVector=this.joystickPointerPos.clone(),this.deltaJoystickVector=this.deltaJoystickVector.subtract(this.joystickPointerStartPos);var t=this.reverseLeftRight?-1:1,i=t*this.deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case"X":this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case"Y":this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case"Z":this.deltaPosition.z=Math.min(1,Math.max(-1,i))}var r=this.reverseUpDown?1:-1,n=r*this.deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case"X":this.deltaPosition.x=Math.min(1,Math.max(-1,n));break;case"Y":this.deltaPosition.y=Math.min(1,Math.max(-1,n));break;case"Z":this.deltaPosition.z=Math.min(1,Math.max(-1,n))}}else this._touches.item(e.pointerId)&&(this._touches.item(e.pointerId).x=e.clientX,this._touches.item(e.pointerId).y=e.clientY)},t.prototype.onPointerUp=function(e){this.joystickPointerID==e.pointerId&&(this.joystickPointerID=-1,this.pressed=!1),this.deltaJoystickVector.x=0,this.deltaJoystickVector.y=0,this._touches.remove(e.pointerId)},t.prototype.setJoystickColor=function(e){this._joystickColor=e},t.prototype.setActionOnTouch=function(e){this._action=e},t.prototype.setAxisForLR=function(e){switch(e){case"X":case"Y":case"Z":this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight="X"}},t.prototype.setAxisForUD=function(e){switch(e){case"X":case"Y":case"Z":this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown="Y"}},t.prototype.drawVirtualJoystick=function(){var e=this;e._leftJoystick?r.clearRect(0,0,n/2,o):r.clearRect(n/2,0,n,o),this._touches.forEach(function(t){t.identifier===e.joystickPointerID?(r.beginPath(),r.strokeStyle=e._joystickColor,r.lineWidth=6,r.arc(e.joystickPointerStartPos.x,e.joystickPointerStartPos.y,40,0,2*Math.PI,!0),r.stroke(),r.beginPath(),r.strokeStyle=e._joystickColor,r.lineWidth=2,r.arc(e.joystickPointerStartPos.x,e.joystickPointerStartPos.y,60,0,2*Math.PI,!0),r.stroke(),r.beginPath(),r.strokeStyle=e._joystickColor,r.arc(e.joystickPointerPos.x,e.joystickPointerPos.y,40,0,2*Math.PI,!0),r.stroke()):(r.beginPath(),r.fillStyle="white",r.beginPath(),r.strokeStyle="red",r.lineWidth="6",r.arc(t.x,t.y,40,0,2*Math.PI,!0),r.stroke())}),requestAnimationFrame(function(){e.drawVirtualJoystick()
})},t.prototype.givePointerType=function(e){switch(e.pointerType){case e.POINTER_TYPE_MOUSE:return"MOUSE";case e.POINTER_TYPE_PEN:return"PEN";case e.POINTER_TYPE_TOUCH:return"TOUCH"}},t.prototype.releaseCanvas=function(){i&&(document.body.removeChild(i),i=null)},t}();e.VirtualJoystick=t;var i=function(){function e(){this.count=0,this.collection={}}return e.prototype.add=function(e,t){return void 0!=this.collection[e]?void 0:(this.collection[e]=t,++this.count)},e.prototype.remove=function(e){return void 0==this.collection[e]?void 0:(delete this.collection[e],--this.count)},e.prototype.item=function(e){return this.collection[e]},e.prototype.forEach=function(e){var t;for(t in this.collection)this.collection.hasOwnProperty(t)&&e(this.collection[t])},e}();e.VirtualJoystick.Collection=i}(BABYLON||(BABYLON={}));var BABYLON=BABYLON||{};!function(){BABYLON.OculusController=function(e,t){BABYLON.InputController.call(this,e,t),this._deviceOrientationHandler=this.onOrientationEvent.bind(this),this._tempOrientation={yaw:0,pitch:0,roll:0},this._relativeOrientation={yaw:0,pitch:0,roll:0},window.addEventListener("deviceorientation",this._deviceOrientationHandler)},BABYLON.OculusController.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.OculusController.prototype.onOrientationEvent=function(e){if(this._tempOrientation.yaw=e.alpha/180*Math.PI,this._tempOrientation.pitch=e.beta/180*Math.PI,this._tempOrientation.roll=e.gamma/180*Math.PI,this._lastOrientation){this._relativeOrientation.yaw=this._tempOrientation.yaw-this._lastOrientation.yaw,this._relativeOrientation.pitch=this._tempOrientation.pitch-this._lastOrientation.pitch,this._relativeOrientation.roll=this._tempOrientation.roll-this._lastOrientation.roll;var t=this._tempOrientation;this._tempOrientation=this._lastOrientation,this._lastOrientation=t,this.target.rotateRelative(this._relativeOrientation)}else this._lastOrientation=Object.create(this._tempOrientation)},BABYLON.OculusController.prototype.dispose=function(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)},BABYLON.OculusController.CameraSettings_OculusRiftDevKit2013_Metric={HResolution:1280,VResolution:800,HScreenSize:.149759993,VScreenSize:.0935999975,VScreenCenter:.0467999987,EyeToScreenDistance:.0410000011,LensSeparationDistance:.063500002,InterpupillaryDistance:.064000003,DistortionK:[1,.219999999,.239999995,0],ChromaAbCorrection:[.995999992,-.00400000019,1.01400006,0],PostProcessScaleFactor:1.714605507808412,LensCenterOffset:.151976421}}();var BABYLON=BABYLON||{};!function(){BABYLON.OculusOrientedCamera=function(e,t,i,r,n,o){t=t?new BABYLON.Vector3(t.x,t.y,t.z):null,BABYLON.Camera.call(this,e,t,i),this._referenceDirection=new BABYLON.Vector3(0,0,1),this._referenceUp=new BABYLON.Vector3(0,1,0),this._actualDirection=new BABYLON.Vector3(1,0,0),this._actualUp=new BABYLON.Vector3(0,1,0),this._currentTargetPoint=new BABYLON.Vector3(0,0,0),this._currentOrientation=Object.create(o||{yaw:0,pitch:0,roll:0}),this._currentViewMatrix=new BABYLON.Matrix,this._currentOrientationMatrix=new BABYLON.Matrix,this._currentInvertOrientationMatrix=new BABYLON.Matrix,this._tempMatrix=new BABYLON.Matrix,this.viewport=r?new BABYLON.Viewport(0,0,.5,1):new BABYLON.Viewport(.5,0,.5,1),this._aspectRatioAspectRatio=n.HResolution/(2*n.VResolution),this._aspectRatioFov=2*Math.atan(n.PostProcessScaleFactor*n.VScreenSize/(2*n.EyeToScreenDistance));var s=n.HScreenSize/4-n.LensSeparationDistance/2,a=4*s/n.HScreenSize;this._hMatrix=BABYLON.Matrix.Translation(r?a:-a,0,0),this._projectionMatrix=new BABYLON.Matrix,this._preViewMatrix=BABYLON.Matrix.Translation(r?.5*n.InterpupillaryDistance:-.5*n.InterpupillaryDistance,0,0),new BABYLON.OculusDistortionCorrectionPostProcess("Oculus Distortion",this,!r,n),this.resetProjectionMatrix(),this.resetViewMatrix()},BABYLON.OculusOrientedCamera.BuildOculusStereoCamera=function(e,t,i,r,n,o,s,a,h,c,l){var u=e.getEngine().getRenderingCanvas();n=n||BABYLON.Vector3.Zero(0,0,0),o=o||{yaw:0,pitch:0,roll:0},l=l||BABYLON.OculusController.CameraSettings_OculusRiftDevKit2013_Metric;var f=new BABYLON.OculusOrientedCamera(t+"_left",n,e,!0,l,o);f.minZ=i,f.maxZ=r,s&&new BABYLON.FxaaPostProcess("fxaa_left",1,f);var B=new BABYLON.OculusOrientedCamera(t+"_right",n,e,!1,l,o);B.minZ=i,B.maxZ=r,s&&new BABYLON.FxaaPostProcess("fxaa_right",1,B),e.activeCameras=[],e.activeCameras.push(f),e.activeCameras.push(B),f.attachControl(u),B.attachControl(u);var p=new BABYLON.InputControllerMultiTarget([f,B]),d=new BABYLON.OculusController(e,p),m=p;if(!h){var A=new BABYLON.InputCollisionFilter(e,p,c);m=A}if(!a){{var _=new BABYLON.GlobalAxisFactorsFilter(e,m,1,0,1);new BABYLON.GravityInputController(e,m)}m=_}var v=new BABYLON.KeyboardMoveController(e,m);v.attachToCanvas(u);var g={leftCamera:f,rightCamera:B,intermediateControllerTarget:p,oculusController:d,keyboardController:v};return g.dispose=function(){this.leftCamera.detachControl(u),this.rightCamera.detachControl(u),this.leftCamera.dispose(),this.rightCamera.dispose(),this.oculusController.dispose(),this.keyboardController.detachFromCanvas(u),this.keyboardController.dispose()}.bind(g),g},BABYLON.OculusOrientedCamera.prototype=Object.create(BABYLON.Camera.prototype),BABYLON.OculusOrientedCamera.prototype.resetViewMatrix=function(){return BABYLON.Matrix.RotationYawPitchRollToRef(this._currentOrientation.yaw,this._currentOrientation.pitch,-this._currentOrientation.roll,this._currentOrientationMatrix),this._currentOrientationMatrix.invertToRef(this._currentInvertOrientationMatrix),BABYLON.Vector3.TransformNormalToRef(this._referenceDirection,this._currentOrientationMatrix,this._actualDirection),BABYLON.Vector3.TransformNormalToRef(this._referenceUp,this._currentOrientationMatrix,this._actualUp),BABYLON.Vector3.FromFloatsToRef(this.position.x+this._actualDirection.x,this.position.y+this._actualDirection.y,this.position.z+this._actualDirection.z,this._currentTargetPoint),BABYLON.Matrix.LookAtLHToRef(this.position,this._currentTargetPoint,this._actualUp,this._tempMatrix),this._tempMatrix.multiplyToRef(this._preViewMatrix,this._currentViewMatrix),this._currentViewMatrix},BABYLON.OculusOrientedCamera.prototype.getViewMatrix=function(){return this._currentViewMatrix},BABYLON.OculusOrientedCamera.prototype._update=function(){if(this.controllers)for(var e=0;e<this.controllers.length;++e)this.controllers[e].update()},BABYLON.OculusOrientedCamera.prototype.getOrientationMatrix=function(){return this._currentOrientationMatrix},BABYLON.OculusOrientedCamera.prototype.getInvertOrientationMatrix=function(){return this._currentInvertOrientationMatrix},BABYLON.OculusOrientedCamera.prototype.resetProjectionMatrix=function(){return BABYLON.Matrix.PerspectiveFovLHToRef(this._aspectRatioFov,this._aspectRatioAspectRatio,this.minZ,this.maxZ,this._tempMatrix),this._tempMatrix.multiplyToRef(this._hMatrix,this._projectionMatrix),this._projectionMatrix},BABYLON.OculusOrientedCamera.prototype.getProjectionMatrix=function(){return this._projectionMatrix},BABYLON.OculusOrientedCamera.prototype.getOrientation=function(){return this._currentOrientation},BABYLON.OculusOrientedCamera.prototype.getPosition=function(){return this.position},BABYLON.OculusOrientedCamera.prototype.moveRelative=function(e){this._tempMoveVector||(this._tempMoveVector=new BABYLON.Vector3(0,0,0)),BABYLON.Vector3.TransformNormalToRef(e,this._currentOrientationMatrix,this._tempMoveVector),this.position.addInPlace(this._tempMoveVector),this.resetViewMatrix()},BABYLON.OculusOrientedCamera.prototype.rotateRelative=function(e){this._currentOrientation.yaw+=e.yaw,this._currentOrientation.pitch+=e.pitch,this._currentOrientation.roll+=e.roll,this.resetViewMatrix()}}();var BABYLON=BABYLON||{};!function(){BABYLON.VirtualJoysticksCamera=function(e,t,i){BABYLON.FreeCamera.call(this,e,t,i),this.leftjoystick=new BABYLON.VirtualJoystick(!0),this.leftjoystick.setAxisForUD("Z"),this.leftjoystick.setAxisForLR("X"),this.leftjoystick.setJoystickSensibility(.15),this.rightjoystick=new BABYLON.VirtualJoystick(!1),this.rightjoystick.setAxisForUD("X"),this.rightjoystick.setAxisForLR("Y"),this.rightjoystick.reverseUpDown=!0,this.rightjoystick.setJoystickSensibility(.05),this.rightjoystick.setJoystickColor("yellow")},BABYLON.VirtualJoysticksCamera.prototype=Object.create(BABYLON.FreeCamera.prototype),BABYLON.VirtualJoysticksCamera.prototype._checkInputs=function(){var e=BABYLON.Matrix.RotationYawPitchRoll(this.rotation.y,this.rotation.x,0),t=BABYLON.Vector3.TransformCoordinates(this.leftjoystick.deltaPosition,e);this.cameraDirection=this.cameraDirection.add(t),this.cameraRotation=this.cameraRotation.add(this.rightjoystick.deltaPosition),this.leftjoystick.pressed||(this.leftjoystick.deltaPosition=this.leftjoystick.deltaPosition.scale(.9)),this.rightjoystick.pressed||(this.rightjoystick.deltaPosition=this.rightjoystick.deltaPosition.scale(.9))},BABYLON.VirtualJoysticksCamera.prototype.dispose=function(){this.leftjoystick.releaseCanvas()}}();var BABYLON=BABYLON||{};!function(){BABYLON.KeyboardMoveController=function(e,t){BABYLON.InputController.call(this,e,t),this._keys=[],this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this._currentSpeed=new BABYLON.Vector3(0,0,0),this._lastFrameSpeed=new BABYLON.Vector3(0,0,0),this._currentAcceleration=new BABYLON.Vector3(0,0,0),this._tempSpeed=new BABYLON.Vector3(0,0,0),this._tempSpeed2=new BABYLON.Vector3(0,0,0),this.maxAbsoluteSpeed=2,this.maxAbsoluteAcceleration=5,this._targetSpeed=new BABYLON.Vector3(0,0,0)},BABYLON.KeyboardMoveController.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.KeyboardMoveController.prototype.attachToCanvas=function(e){var t=this;this._canvas=e,this._onKeyDown=function(e){if(-1!==t.keysUp.indexOf(e.keyCode)||-1!==t.keysDown.indexOf(e.keyCode)||-1!==t.keysLeft.indexOf(e.keyCode)||-1!==t.keysRight.indexOf(e.keyCode)){var i=t._keys.indexOf(e.keyCode);-1===i&&t._keys.push(e.keyCode)}},this._onKeyUp=function(e){if(-1!==t.keysUp.indexOf(e.keyCode)||-1!==t.keysDown.indexOf(e.keyCode)||-1!==t.keysLeft.indexOf(e.keyCode)||-1!==t.keysRight.indexOf(e.keyCode)){var i=t._keys.indexOf(e.keyCode);i>=0&&t._keys.splice(i,1)}},this._onLostFocus=function(){t._keys=[]},window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1),window.addEventListener("blur",this._onLostFocus,!1)},BABYLON.KeyboardMoveController.prototype.detachFromCanvas=function(){window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),window.removeEventListener("blur",this._onLostFocus,!1)},BABYLON.KeyboardMoveController.prototype.updateCurrentSpeed=function(){if(this._lastFrameSpeed.x=this._currentSpeed.x,this._lastFrameSpeed.y=this._currentSpeed.y,this._lastFrameSpeed.z=this._currentSpeed.z,this._currentSpeed.equals(this._targetSpeed))return this._currentAcceleration.x=0,this._currentAcceleration.y=0,void(this._currentAcceleration.z=0);var e=BABYLON.Tools.GetDeltaTime()/1e3,t=this._tempSpeed;this._targetSpeed.subtractToRef(this._lastFrameSpeed,t);var i=t.length()/e;i<this.maxAbsoluteAcceleration?(this._currentSpeed.x=this._targetSpeed.x,this._currentSpeed.y=this._targetSpeed.y,this._currentSpeed.z=this._targetSpeed.z,t.normalize(),t.scaleToRef(i,this._currentAcceleration)):(t.normalize(),t.scaleToRef(this.maxAbsoluteAcceleration,this._currentAcceleration),t.scaleInPlace(this.maxAbsoluteAcceleration*e),this._currentSpeed.addInPlace(t))},BABYLON.KeyboardMoveController.prototype.update=function(){this._targetSpeed.x=0,this._targetSpeed.y=0,this._targetSpeed.z=0;for(var e=0;e<this._keys.length;e++){var t=this._keys[e];-1!==this.keysLeft.indexOf(t)?this._targetSpeed.x-=1:-1!==this.keysUp.indexOf(t)?this._targetSpeed.z+=1:-1!==this.keysRight.indexOf(t)?this._targetSpeed.x+=1:-1!==this.keysDown.indexOf(t)&&(this._targetSpeed.z-=1)}if((0!=this._targetSpeed.x||0!=this._targetSpeed.z)&&(this._targetSpeed.normalize(),this._targetSpeed.scaleInPlace(this.maxAbsoluteSpeed)),this.updateCurrentSpeed(),0!=this._lastFrameSpeed.x||0!=this._lastFrameSpeed.z||0!=this._currentAcceleration.x||0!=this._currentAcceleration.z){var i=BABYLON.Tools.GetDeltaTime()/1e3;this._lastFrameSpeed.scaleToRef(i,this._tempSpeed),this._currentAcceleration.scaleToRef(i*i*.5,this._tempSpeed2),this._tempSpeed.addInPlace(this._tempSpeed2),(0!=this._tempSpeed.x||0!=this._tempSpeed.z)&&this.target.moveRelative(this._tempSpeed)}}}();var BABYLON=BABYLON||{};!function(){BABYLON.InputCollisionFilter=function(e,t,i){BABYLON.inputFilter.call(this,e,t),this._transformedDirection=new BABYLON.Vector3,this._tempNewPosition=new BABYLON.Vector3,this._tempNewPosition2=new BABYLON.Vector3,this._ellipsoid=i||new BABYLON.Vector3(.2,.855,.2),this._collider=new BABYLON.Collider,this._collidedPosition=new BABYLON.Vector3(0,0,0),this._cameraHeight=1.7,this._positionBottom=new BABYLON.Vector3(0,0,0)},BABYLON.InputCollisionFilter.prototype=Object.create(BABYLON.inputFilter.prototype),BABYLON.InputCollisionFilter.prototype.moveRelative=function(e){this.getOrientation();BABYLON.Vector3.TransformNormalToRef(e,this.getOrientationMatrix(),this._transformedDirection),this.getPosition().addToRef(this._transformedDirection,this._tempNewPosition),this._collider.radius=this._ellipsoid;var t=this.getPosition();this._positionBottom.x=t.x,this._positionBottom.y=t.y,this._positionBottom.z=t.z,this._positionBottom.y+=this._ellipsoid.y-this._cameraHeight,this.scene._getNewPosition(this._positionBottom,this._transformedDirection,this._collider,3,this._collidedPosition),this._collidedPosition.subtractToRef(this._positionBottom,this._tempNewPosition2),this._tempNewPosition2.length()>2*BABYLON.Engine.collisionsEpsilon&&(BABYLON.Vector3.TransformNormalToRef(this._tempNewPosition2,this.getInvertOrientationMatrix(),this._tempNewPosition),this.target.moveRelative(this._tempNewPosition))}}();var BABYLON=BABYLON||{};!function(){BABYLON.GravityInputController=function(e,t){BABYLON.InputController.call(this,e,t),this._moveVectorGlobal=new BABYLON.Vector3(0,0,0),this._moveVectorLocal=new BABYLON.Vector3(0,0,0),this._fallSpeed=2},BABYLON.GravityInputController.prototype=Object.create(BABYLON.InputController.prototype),BABYLON.GravityInputController.prototype.update=function(){this._moveVectorGlobal.x=0,this._moveVectorGlobal.y=-this._fallSpeed*BABYLON.Tools.GetDeltaTime()/1e3,this._moveVectorGlobal.z=0,BABYLON.Vector3.TransformNormalToRef(this._moveVectorGlobal,this.target.getInvertOrientationMatrix(),this._moveVectorLocal),this.target.moveRelative(this._moveVectorLocal)}}();var BABYLON=BABYLON||{};!function(){BABYLON.GlobalAxisFactorsFilter=function(e,t,i,r,n){BABYLON.inputFilter.call(this,e,t),this.xFactor=i,this.yFactor=r,this.zFactor=n,this._globalMovement=new BABYLON.Vector3(0,0,0)},BABYLON.GlobalAxisFactorsFilter.prototype=Object.create(BABYLON.inputFilter.prototype),BABYLON.GlobalAxisFactorsFilter.prototype.moveRelative=function(e){this.getOrientation();BABYLON.Vector3.TransformNormalToRef(e,this.getOrientationMatrix(),this._globalMovement),this._globalMovement.x*=this.xFactor,this._globalMovement.y*=this.yFactor,this._globalMovement.z*=this.zFactor,BABYLON.Vector3.TransformNormalToRef(this._globalMovement,this.getInvertOrientationMatrix(),e),this.target.moveRelative(e)}}();var BABYLON=BABYLON||{};!function(){BABYLON.ShaderMaterial=function(e,t,i,r){this.name=e,this.id=e,this._shaderPath=i,r.needAlphaBlending=r.needAlphaBlending||!1,r.needAlphaTesting=r.needAlphaTesting||!1,r.attributes=r.attributes||["position","normal","uv"],r.uniforms=r.uniforms||["worldViewProjection"],r.samplers=r.samplers||[],this._options=r,this._scene=t,t.materials.push(this),this._textures=[],this._floats=[],this._floatsArrays=[],this._colors3=[],this._colors4=[],this._vectors2=[],this._vectors3=[],this._vectors4=[],this._matrices=[]},BABYLON.ShaderMaterial.prototype=Object.create(BABYLON.Material.prototype),BABYLON.ShaderMaterial.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending},BABYLON.ShaderMaterial.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},BABYLON.ShaderMaterial.prototype._checkUniform=function(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)},BABYLON.ShaderMaterial.prototype.setTexture=function(e,t){return this._checkUniform(e),this._textures[e]=t,this},BABYLON.ShaderMaterial.prototype.setFloat=function(e,t){return this._checkUniform(e),this._floats[e]=t,this},BABYLON.ShaderMaterial.prototype.setFloats=function(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this},BABYLON.ShaderMaterial.prototype.setColor3=function(e,t){return this._checkUniform(e),this._colors3[e]=t,this},BABYLON.ShaderMaterial.prototype.setColor4=function(e,t){return this._checkUniform(e),this._colors4[e]=t,this},BABYLON.ShaderMaterial.prototype.setVector2=function(e,t){return this._checkUniform(e),this._vectors2[e]=t,this},BABYLON.ShaderMaterial.prototype.setVector3=function(e,t){return this._checkUniform(e),this._vectors3[e]=t,this},BABYLON.ShaderMaterial.prototype.setVector4=function(e,t){return this._checkUniform(e),this._vectors4[e]=t,this},BABYLON.ShaderMaterial.prototype.setMatrix=function(e,t){return this._checkUniform(e),this._matrices[e]=t,this},BABYLON.ShaderMaterial.prototype.isReady=function(){var e=this._scene.getEngine();return this._effect=e.createEffect(this._shaderPath,this._options.attributes,this._options.uniforms,this._options.samplers,""),this._effect.isReady()?!0:!1},BABYLON.ShaderMaterial.prototype.bind=function(e){-1!==this._options.uniforms.indexOf("world")&&this._effect.setMatrix("world",e),-1!==this._options.uniforms.indexOf("view")&&this._effect.setMatrix("view",this._scene.getViewMatrix()),-1!==this._options.uniforms.indexOf("projection")&&this._effect.setMatrix("projection",this._scene.getProjectionMatrix()),-1!==this._options.uniforms.indexOf("worldViewProjection")&&this._effect.setMatrix("worldViewProjection",e.multiply(this._scene.getTransformMatrix()));for(var t in this._textures)this._effect.setTexture(t,this._textures[t]);for(t in this._floats)this._effect.setFloat(t,this._floats[t]);for(t in this._floatsArrays)this._effect.setArray(t,this._floatsArrays[t]);for(t in this._colors3)this._effect.setColor3(t,this._colors3[t]);for(t in this._colors4)this._effect.setColor4(t,this._colors4[t]);for(t in this._vectors2)this._effect.setVector2(t,this._vectors2[t]);for(t in this._vectors3)this._effect.setVector3(t,this._vectors3[t]);for(t in this._vectors4)this._effect.setVector4(t,this._vectors4[t]);for(t in this._matrices)this._effect.setMatrix(t,this._matrices[t])},BABYLON.ShaderMaterial.prototype.dispose=function(){for(var e in this._textures)this._textures[e].dispose();this._textures=[],this.baseDispose()}}();var BABYLON=BABYLON||{};!function(){BABYLON.VertexData=function(){},BABYLON.VertexData.prototype.applyToMesh=function(e,t){this.positions&&e.setVerticesData(this.positions,BABYLON.VertexBuffer.PositionKind,t),this.normals&&e.setVerticesData(this.normals,BABYLON.VertexBuffer.NormalKind,t),this.uvs&&e.setVerticesData(this.uvs,BABYLON.VertexBuffer.UVKind,t),this.uv2s&&e.setVerticesData(this.uv2s,BABYLON.VertexBuffer.UV2Kind,t),this.colors&&e.setVerticesData(this.colors,BABYLON.VertexBuffer.ColorKind,t),this.matricesIndices&&e.setVerticesData(this.matricesIndices,BABYLON.VertexBuffer.MatricesIndicesKind,t),this.matricesWeights&&e.setVerticesData(this.matricesWeights,BABYLON.VertexBuffer.MatricesWeightsKind,t),this.indices&&e.setIndices(this.indices)},BABYLON.VertexData.prototype.transform=function(e){var t=BABYLON.Vector3.Zero();if(this.positions)for(var i=BABYLON.Vector3.Zero(),r=0;r<this.positions.length;r+=3)BABYLON.Vector3.FromArrayToRef(this.positions,r,i),BABYLON.Vector3.TransformCoordinatesToRef(i,e,t),this.positions[r]=t.x,this.positions[r+1]=t.y,this.positions[r+2]=t.z;if(this.normals){var n=BABYLON.Vector3.Zero();for(r=0;r<this.normals.length;r+=3)BABYLON.Vector3.FromArrayToRef(this.normals,r,n),BABYLON.Vector3.TransformNormalToRef(n,e,t),this.normals[r]=t.x,this.normals[r+1]=t.y,this.normals[r+2]=t.z}},BABYLON.VertexData.prototype.merge=function(e){if(e.indices){this.indices||(this.indices=[]);for(var t=this.positions?this.positions.length/3:0,i=0;i<e.indices.length;i++)this.indices.push(e.indices[i]+t)}if(e.positions)for(this.positions||(this.positions=[]),i=0;i<e.positions.length;i++)this.positions.push(e.positions[i]);if(e.normals)for(this.normals||(this.normals=[]),i=0;i<e.normals.length;i++)this.normals.push(e.normals[i]);if(e.uvs)for(this.uvs||(this.uvs=[]),i=0;i<e.uvs.length;i++)this.uvs.push(e.uvs[i]);if(e.uv2s)for(this.uv2s||(this.uv2s=[]),i=0;i<e.uv2s.length;i++)this.uv2s.push(e.uv2s[i]);if(e.matricesIndices)for(this.matricesIndices||(this.matricesIndices=[]),i=0;i<e.matricesIndices.length;i++)this.matricesIndices.push(e.matricesIndices[i]);if(e.matricesWeights)for(this.matricesWeights||(this.matricesWeights=[]),i=0;i<e.matricesWeights.length;i++)this.matricesWeights.push(e.matricesWeights[i]);if(e.colors)for(this.colors||(this.colors=[]),i=0;i<e.colors.length;i++)this.colors.push(e.colors[i])},BABYLON.VertexData.ExtractFromMesh=function(e){var t=new BABYLON.VertexData;return e.isVerticesDataPresent(BABYLON.VertexBuffer.PositionKind)&&(t.positions=e.getVerticesData(BABYLON.VertexBuffer.PositionKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.NormalKind)&&(t.normals=e.getVerticesData(BABYLON.VertexBuffer.NormalKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.UVKind)&&(t.uvs=e.getVerticesData(BABYLON.VertexBuffer.UVKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.UV2Kind)&&(t.uv2s=e.getVerticesData(BABYLON.VertexBuffer.UV2Kind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.ColorKind)&&(t.colors=e.getVerticesData(BABYLON.VertexBuffer.ColorKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesIndicesKind)&&(t.matricesIndices=e.getVerticesData(BABYLON.VertexBuffer.MatricesIndicesKind)),e.isVerticesDataPresent(BABYLON.VertexBuffer.MatricesWeightsKind)&&(t.matricesWeights=e.getVerticesData(BABYLON.VertexBuffer.MatricesWeightsKind)),t.indices=e.getIndices(),t},BABYLON.VertexData.CreateBox=function(e){for(var t=[new BABYLON.Vector3(0,0,1),new BABYLON.Vector3(0,0,-1),new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(-1,0,0),new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,-1,0)],i=[],r=[],n=[],o=[],s=0;s<t.length;s++){var a=t[s],h=new BABYLON.Vector3(a.y,a.z,a.x),c=BABYLON.Vector3.Cross(a,h),l=r.length/3;i.push(l),i.push(l+1),i.push(l+2),i.push(l),i.push(l+2),i.push(l+3);var u=a.subtract(h).subtract(c).scale(e/2);r.push(u.x,u.y,u.z),n.push(a.x,a.y,a.z),o.push(1,1),u=a.subtract(h).add(c).scale(e/2),r.push(u.x,u.y,u.z),n.push(a.x,a.y,a.z),o.push(0,1),u=a.add(h).add(c).scale(e/2),r.push(u.x,u.y,u.z),n.push(a.x,a.y,a.z),o.push(0,0),u=a.add(h).subtract(c).scale(e/2),r.push(u.x,u.y,u.z),n.push(a.x,a.y,a.z),o.push(1,0)}var f=new BABYLON.VertexData;return f.indices=i,f.positions=r,f.normals=n,f.uvs=o,f},BABYLON.VertexData.CreateSphere=function(e,t){for(var i=t/2,r=2+e,n=2*r,o=[],s=[],a=[],h=[],c=0;r>=c;c++){for(var l=c/r,u=l*Math.PI,f=0;n>=f;f++){var B=f/n,p=B*Math.PI*2,d=BABYLON.Matrix.RotationZ(-u),m=BABYLON.Matrix.RotationY(p),A=BABYLON.Vector3.TransformCoordinates(BABYLON.Vector3.Up(),d),_=BABYLON.Vector3.TransformCoordinates(A,m),v=_.scale(i),g=BABYLON.Vector3.Normalize(v);s.push(v.x,v.y,v.z),a.push(g.x,g.y,g.z),h.push(l,B)}if(c>0)for(var L=s.length/3,O=L-2*(n+1);L>O+n+2;O++)o.push(O),o.push(O+1),o.push(O+n+1),o.push(O+n+1),o.push(O+1),o.push(O+n+2)}var N=new BABYLON.VertexData;return N.indices=o,N.positions=s,N.normals=a,N.uvs=h,N},BABYLON.VertexData.CreateCylinder=function(e,t,i,r){var n=t/2,o=i/2,s=[],a=[],h=[],c=[],l=function(e){var t=2*e*Math.PI/r,i=Math.sin(t),n=Math.cos(t);return new BABYLON.Vector3(i,0,n)},u=function(t){var i=t?n:o;if(0!=i){for(var u=0;r-2>u;u++){var f=(u+1)%r,B=(u+2)%r;if(!t){var p=f,f=B;B=p}var d=a.length/3;s.push(d),s.push(d+f),s.push(d+B)}var m=new BABYLON.Vector3(0,-1,0),A=new BABYLON.Vector2(-.5,-.5);t||(m=m.scale(-1),A.x=-A.x);for(var u=0;r>u;u++){var _=l(u),v=_.scale(i).add(m.scale(e)),g=new BABYLON.Vector2(_.x*A.x+.5,_.z*A.y+.5);a.push(v.x,v.y,v.z),h.push(m.x,m.y,m.z),c.push(g.x,g.y)}}};e/=2;for(var f=new BABYLON.Vector3(0,1,0).scale(e),B=r+1,p=0;r>=p;p++){var d=l(p),m=d.scale(o),A=d.scale(n),_=new BABYLON.Vector2(p/r,0),v=m.add(f);a.push(v.x,v.y,v.z),h.push(d.x,d.y,d.z),c.push(_.x,_.y),v=A.subtract(f),_.y+=1,a.push(v.x,v.y,v.z),h.push(d.x,d.y,d.z),c.push(_.x,_.y),s.push(2*p),s.push((2*p+2)%(2*B)),s.push(2*p+1),s.push(2*p+1),s.push((2*p+2)%(2*B)),s.push((2*p+3)%(2*B))}u(!0),u(!1);var g=new BABYLON.VertexData;return g.indices=s,g.positions=a,g.normals=h,g.uvs=c,g},BABYLON.VertexData.CreateTorus=function(e,t,i){for(var r=[],n=[],o=[],s=[],a=i+1,h=0;i>=h;h++)for(var c=h/i,l=h*Math.PI*2/i-Math.PI/2,u=BABYLON.Matrix.Translation(e/2,0,0).multiply(BABYLON.Matrix.RotationY(l)),f=0;i>=f;f++){var B=1-f/i,p=f*Math.PI*2/i+Math.PI,d=Math.cos(p),m=Math.sin(p),A=new BABYLON.Vector3(d,m,0),_=A.scale(t/2),v=new BABYLON.Vector2(c,B);_=BABYLON.Vector3.TransformCoordinates(_,u),A=BABYLON.Vector3.TransformNormal(A,u),n.push(_.x,_.y,_.z),o.push(A.x,A.y,A.z),s.push(v.x,v.y);var g=(h+1)%a,L=(f+1)%a;r.push(h*a+f),r.push(h*a+L),r.push(g*a+f),r.push(h*a+L),r.push(g*a+L),r.push(g*a+f)}var O=new BABYLON.VertexData;return O.indices=r,O.positions=n,O.normals=o,O.uvs=s,O},BABYLON.VertexData.CreateGround=function(e,t,i){var r,n,o=[],s=[],a=[],h=[];for(r=0;i>=r;r++)for(n=0;i>=n;n++){var c=new BABYLON.Vector3(n*e/i-e/2,0,(i-r)*t/i-t/2),l=new BABYLON.Vector3(0,1,0);s.push(c.x,c.y,c.z),a.push(l.x,l.y,l.z),h.push(n/i,1-r/i)}for(r=0;i>r;r++)for(n=0;i>n;n++)o.push(n+1+(r+1)*(i+1)),o.push(n+1+r*(i+1)),o.push(n+r*(i+1)),o.push(n+(r+1)*(i+1)),o.push(n+1+(r+1)*(i+1)),o.push(n+r*(i+1));var u=new BABYLON.VertexData;return u.indices=o,u.positions=s,u.normals=a,u.uvs=h,u},BABYLON.VertexData.CreatePlane=function(e){var t=[],i=[],r=[],n=[],o=e/2;i.push(-o,-o,0),r.push(0,0,-1),n.push(0,0),i.push(o,-o,0),r.push(0,0,-1),n.push(1,0),i.push(o,o,0),r.push(0,0,-1),n.push(1,1),i.push(-o,o,0),r.push(0,0,-1),n.push(0,1),t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3);var s=new BABYLON.VertexData;return s.indices=t,s.positions=i,s.normals=r,s.uvs=n,s}}();